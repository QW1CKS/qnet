# T6.6 Performance Optimization Playbook

This playbook operationalizes T6.6 across code, benches, and CI. Use it to implement and validate performance improvements without guesswork.

## Scope
- Zero-copy AEAD and framing
- HTX handshake and stream fast paths
- QUIC integration (feature: quic)
- Mixnet latency tuning (latency-mode)
- Benchmarks, baselines, profiling, and CI guardrails

## Work Items (checklist)
- [x] Add feature flags: `perf-bench`, `quic` (default off)
- [x] Introduce Criterion benches for core-crypto, core-framing, HTX
- [x] Implement zero-copy paths using `bytes::BytesMut` (pooling TBD)
- [x] Cache HTX key schedule artifacts in-process benches; template cache is part of HTX API
- [x] Integrate `quinn` and libp2p QUIC transport under feature flag
- [x] Add `latency-mode` (low/standard): shaping + 3-hop p95 test
- [x] Add profiling support and docs (cargo-flamegraph, perfetto/ETW)
- [x] Nightly CI perf job (artifacts upload); thresholds wiring pending

## Bench Design
- Sizes: 1KiB, 4KiB, 16KiB, 64KiB, 1MiB
- Concurrency: 1, 8, 64 streams
- Metrics:
  - AEAD: GB/s per core (seal/open)
  - Framing: ns/op; allocations/frame ≤ 1
  - HTX: handshake latency (median/p95), CPU time; stream throughput
  - Mesh: echo p50/p95 throughput and latency (TCP vs QUIC)

## Methodology
- Hardware profile: record CPU/RAM/OS/Kernel
- Env: disable CPU scaling, perf governor, minimize background load
- Runs: `cargo bench --features perf-bench` and record Criterion outputs
- Artifacts: save reports + `templates/perf-summary-template.md` filled as `artifacts/perf-summary.md`

## Quick start (local runs)
- Linux:
  - Use `templates/perf-run-linux.sh` to collect HW info, run benches, and gather artifacts.
- Windows:
  - Run `templates/windows-perf-baseline.ps1` to record HW profile, then `templates/perf-run-windows.ps1` to run benches and gather artifacts.
- Compare to a baseline (optional):
  - Use `templates/perf-compare.sh <baseline_dir> <current_dir>` to flag regressions from Criterion `estimates.json`.

## Profiling guides (brief)
- Linux (flamegraph):
  - Install: `cargo install flamegraph` and `sudo apt-get install linux-perf`.
  - Usage: `sudo cargo flamegraph -p htx --bench handshake --features perf-bench`.
  - Read the SVG to find hotspots; re-run with `-g` to include debug symbols.
- Windows (ETW/PerfView):
  - Install PerfView; run: `PerfView64.exe /CollectKernelStacks /CircularMB:512 run -- cargo bench --features perf-bench`.
  - Open the ETL in PerfView and analyze CPU stacks; filter by process name.

## Acceptance (micro)
- AEAD ≥ 2 GB/s (≥16KiB payloads, x86_64 AVX2 reference)
- HTX handshake median < 50ms (loopback)
- QUIC p50 improves by ≥ 50ms vs TCP under 20ms RTT/1% loss sim
- Mixnet latency-mode=low: added p95 < 100ms vs direct on 3-hop local testbed

## CI Guardrails
- Nightly perf job; upload Criterion reports and perf-summary.md
- Fail on >10% throughput drop or >15% latency increase vs last 7-run median
- Allow manual override with justification in CI annotations

### CI wiring
- Copy `templates/perf-workflow-template.yml` to the code repo `.github/workflows/nightly-perf.yml`.
- Add a compare step using `templates/perf-compare.sh` against stored baselines if desired.

## Acceptance Checklist
- See `specs/001-qnet/T6.6-acceptance-checklist.md` for the final sign-off items and required artifacts.

## File/Module Layout (suggested)
- `crates/core-crypto/benches/aead.rs` (criterion)
- `crates/core-framing/benches/framing.rs`
- `crates/htx/benches/handshake.rs`, `benches/stream.rs`
- `crates/mesh/benches/echo.rs` (TCP/QUIC)

## References
- See `specs/001-qnet/tasks.md` T6.6 section for detailed breakdown and metrics.
- See `templates/criterion-bench-skeleton.rs` for a starting point.
- See `templates/perf-workflow-template.yml` for a GitHub Actions workflow.
