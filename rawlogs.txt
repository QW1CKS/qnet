2025-09-08T23:42:24.0955304Z Current runner version: '2.328.0'
2025-09-08T23:42:24.0988329Z ##[group]Runner Image Provisioner
2025-09-08T23:42:24.0989604Z Hosted Compute Agent
2025-09-08T23:42:24.0990622Z Version: 20250908.385
2025-09-08T23:42:24.0991836Z Commit: cfce01a78eb650f23de9981e2e79cb8dc83e6056
2025-09-08T23:42:24.0992903Z Build Date: 2025-09-08T16:07:37Z
2025-09-08T23:42:24.0993961Z ##[endgroup]
2025-09-08T23:42:24.0994826Z ##[group]Operating System
2025-09-08T23:42:24.0995783Z Ubuntu
2025-09-08T23:42:24.0996656Z 24.04.3
2025-09-08T23:42:24.0997438Z LTS
2025-09-08T23:42:24.0998121Z ##[endgroup]
2025-09-08T23:42:24.0999052Z ##[group]Runner Image
2025-09-08T23:42:24.1000031Z Image: ubuntu-24.04
2025-09-08T23:42:24.1000910Z Version: 20250907.24.1
2025-09-08T23:42:24.1003131Z Included Software: https://github.com/actions/runner-images/blob/ubuntu24/20250907.24/images/ubuntu/Ubuntu2404-Readme.md
2025-09-08T23:42:24.1005881Z Image Release: https://github.com/actions/runner-images/releases/tag/ubuntu24%2F20250907.24
2025-09-08T23:42:24.1007666Z ##[endgroup]
2025-09-08T23:42:24.1009483Z ##[group]GITHUB_TOKEN Permissions
2025-09-08T23:42:24.1012273Z Contents: read
2025-09-08T23:42:24.1013219Z Metadata: read
2025-09-08T23:42:24.1014066Z Packages: read
2025-09-08T23:42:24.1015098Z ##[endgroup]
2025-09-08T23:42:24.1017987Z Secret source: Actions
2025-09-08T23:42:24.1019073Z Prepare workflow directory
2025-09-08T23:42:24.1524821Z Prepare all required actions
2025-09-08T23:42:24.1641559Z Getting action download info
2025-09-08T23:42:24.6265022Z Download action repository 'actions/checkout@v4' (SHA:08eba0b27e820071cde6df949e0beb9ba4906955)
2025-09-08T23:42:24.6973857Z Download action repository 'actions-rs/toolchain@v1' (SHA:16499b5e05bf2e26879000db0c1d13f7e13fa3af)
2025-09-08T23:42:24.9003906Z Download action repository 'actions/setup-go@v4' (SHA:19bb51245e9c80abacb2e91cc42b33fa478b8639)
2025-09-08T23:42:25.1658812Z Download action repository 'actions/upload-artifact@v4' (SHA:ea165f8d65b6e75b540449e92b4886f43607fa02)
2025-09-08T23:42:25.3815704Z Complete job name: build
2025-09-08T23:42:25.4503855Z ##[group]Run actions/checkout@v4
2025-09-08T23:42:25.4504699Z with:
2025-09-08T23:42:25.4505092Z   repository: QW1CKS/qnet
2025-09-08T23:42:25.4505707Z   token: ***
2025-09-08T23:42:25.4506074Z   ssh-strict: true
2025-09-08T23:42:25.4506446Z   ssh-user: git
2025-09-08T23:42:25.4506837Z   persist-credentials: true
2025-09-08T23:42:25.4507270Z   clean: true
2025-09-08T23:42:25.4507647Z   sparse-checkout-cone-mode: true
2025-09-08T23:42:25.4508114Z   fetch-depth: 1
2025-09-08T23:42:25.4508482Z   fetch-tags: false
2025-09-08T23:42:25.4508858Z   show-progress: true
2025-09-08T23:42:25.4509274Z   lfs: false
2025-09-08T23:42:25.4509629Z   submodules: false
2025-09-08T23:42:25.4510022Z   set-safe-directory: true
2025-09-08T23:42:25.4510730Z ##[endgroup]
2025-09-08T23:42:25.5644279Z Syncing repository: QW1CKS/qnet
2025-09-08T23:42:25.5646767Z ##[group]Getting Git version info
2025-09-08T23:42:25.5647755Z Working directory is '/home/runner/work/qnet/qnet'
2025-09-08T23:42:25.5650354Z [command]/usr/bin/git version
2025-09-08T23:42:25.5675636Z git version 2.51.0
2025-09-08T23:42:25.5704100Z ##[endgroup]
2025-09-08T23:42:25.5723783Z Temporarily overriding HOME='/home/runner/work/_temp/c5497c0d-7ce0-4356-938d-ecfd2ff91972' before making global git config changes
2025-09-08T23:42:25.5727709Z Adding repository directory to the temporary git global config as a safe directory
2025-09-08T23:42:25.5729407Z [command]/usr/bin/git config --global --add safe.directory /home/runner/work/qnet/qnet
2025-09-08T23:42:25.5773610Z Deleting the contents of '/home/runner/work/qnet/qnet'
2025-09-08T23:42:25.5776631Z ##[group]Initializing the repository
2025-09-08T23:42:25.5780446Z [command]/usr/bin/git init /home/runner/work/qnet/qnet
2025-09-08T23:42:25.5850497Z hint: Using 'master' as the name for the initial branch. This default branch name
2025-09-08T23:42:25.5852820Z hint: is subject to change. To configure the initial branch name to use in all
2025-09-08T23:42:25.5854444Z hint: of your new repositories, which will suppress this warning, call:
2025-09-08T23:42:25.5856021Z hint:
2025-09-08T23:42:25.5856834Z hint: 	git config --global init.defaultBranch <name>
2025-09-08T23:42:25.5857837Z hint:
2025-09-08T23:42:25.5858810Z hint: Names commonly chosen instead of 'master' are 'main', 'trunk' and
2025-09-08T23:42:25.5860357Z hint: 'development'. The just-created branch can be renamed via this command:
2025-09-08T23:42:25.5861730Z hint:
2025-09-08T23:42:25.5862362Z hint: 	git branch -m <name>
2025-09-08T23:42:25.5863140Z hint:
2025-09-08T23:42:25.5864169Z hint: Disable this message with "git config set advice.defaultBranchName false"
2025-09-08T23:42:25.5865689Z Initialized empty Git repository in /home/runner/work/qnet/qnet/.git/
2025-09-08T23:42:25.5872732Z [command]/usr/bin/git remote add origin https://github.com/QW1CKS/qnet
2025-09-08T23:42:25.5910424Z ##[endgroup]
2025-09-08T23:42:25.5912396Z ##[group]Disabling automatic garbage collection
2025-09-08T23:42:25.5914085Z [command]/usr/bin/git config --local gc.auto 0
2025-09-08T23:42:25.5948293Z ##[endgroup]
2025-09-08T23:42:25.5950252Z ##[group]Setting up auth
2025-09-08T23:42:25.5956180Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-09-08T23:42:25.5996312Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-09-08T23:42:25.6279913Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-09-08T23:42:25.6314569Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-09-08T23:42:25.6557335Z [command]/usr/bin/git config --local http.https://github.com/.extraheader AUTHORIZATION: basic ***
2025-09-08T23:42:25.6598440Z ##[endgroup]
2025-09-08T23:42:25.6600732Z ##[group]Fetching the repository
2025-09-08T23:42:25.6610383Z [command]/usr/bin/git -c protocol.version=2 fetch --no-tags --prune --no-recurse-submodules --depth=1 origin +96c2865f2452ceac1693c4bdc56bcc0fedf39d8a:refs/remotes/origin/main
2025-09-08T23:42:26.2447908Z From https://github.com/QW1CKS/qnet
2025-09-08T23:42:26.2449351Z  * [new ref]         96c2865f2452ceac1693c4bdc56bcc0fedf39d8a -> origin/main
2025-09-08T23:42:26.2482134Z ##[endgroup]
2025-09-08T23:42:26.2483401Z ##[group]Determining the checkout info
2025-09-08T23:42:26.2484897Z ##[endgroup]
2025-09-08T23:42:26.2488526Z [command]/usr/bin/git sparse-checkout disable
2025-09-08T23:42:26.2536734Z [command]/usr/bin/git config --local --unset-all extensions.worktreeConfig
2025-09-08T23:42:26.2569565Z ##[group]Checking out the ref
2025-09-08T23:42:26.2572213Z [command]/usr/bin/git checkout --progress --force -B main refs/remotes/origin/main
2025-09-08T23:42:26.3409225Z Switched to a new branch 'main'
2025-09-08T23:42:26.3414554Z branch 'main' set up to track 'origin/main'.
2025-09-08T23:42:26.3424141Z ##[endgroup]
2025-09-08T23:42:26.3466590Z [command]/usr/bin/git log -1 --format=%H
2025-09-08T23:42:26.3490617Z 96c2865f2452ceac1693c4bdc56bcc0fedf39d8a
2025-09-08T23:42:26.3710519Z ##[group]Run actions-rs/toolchain@v1
2025-09-08T23:42:26.3711156Z with:
2025-09-08T23:42:26.3711902Z   toolchain: stable
2025-09-08T23:42:26.3712369Z   override: true
2025-09-08T23:42:26.3712829Z   components: rustfmt, clippy
2025-09-08T23:42:26.3713372Z   default: false
2025-09-08T23:42:26.3713796Z ##[endgroup]
2025-09-08T23:42:26.4694486Z [command]/home/runner/.cargo/bin/rustup show
2025-09-08T23:42:26.5416254Z Default host: x86_64-unknown-linux-gnu
2025-09-08T23:42:26.5417934Z rustup home:  /home/runner/.rustup
2025-09-08T23:42:26.5419484Z 
2025-09-08T23:42:26.6038684Z installed toolchains
2025-09-08T23:42:26.6040909Z --------------------
2025-09-08T23:42:26.6042081Z stable-x86_64-unknown-linux-gnu (active, default)
2025-09-08T23:42:26.6042971Z 
2025-09-08T23:42:26.6043559Z active toolchain
2025-09-08T23:42:26.6044251Z ----------------
2025-09-08T23:42:26.6045012Z name: stable-x86_64-unknown-linux-gnu
2025-09-08T23:42:26.6046057Z active because: it's the default toolchain
2025-09-08T23:42:26.6047160Z installed targets:
2025-09-08T23:42:26.6047892Z   x86_64-unknown-linux-gnu
2025-09-08T23:42:26.6077680Z [command]/home/runner/.cargo/bin/rustup -V
2025-09-08T23:42:26.6130649Z rustup 1.28.2 (e4f3ad6f8 2025-04-28)
2025-09-08T23:42:26.6192395Z info: This is the version for the rustup toolchain manager, not the rustc compiler.
2025-09-08T23:42:26.9707045Z info: The currently active `rustc` version is `rustc 1.89.0 (29483883e 2025-08-04)`
2025-09-08T23:42:26.9709161Z Installed rustup 1.28.2 support components
2025-09-08T23:42:26.9712731Z [command]/home/runner/.cargo/bin/rustup toolchain install stable --component rustfmt --component clippy
2025-09-08T23:42:27.0518773Z info: syncing channel updates for 'stable-x86_64-unknown-linux-gnu'
2025-09-08T23:42:27.3163057Z info: latest update on 2025-08-07, rust version 1.89.0 (29483883e 2025-08-04)
2025-09-08T23:42:27.3494209Z info: component 'clippy' for target 'x86_64-unknown-linux-gnu' is up to date
2025-09-08T23:42:27.3497248Z info: component 'rustfmt' for target 'x86_64-unknown-linux-gnu' is up to date
2025-09-08T23:42:27.3499092Z 
2025-09-08T23:42:27.3572439Z   stable-x86_64-unknown-linux-gnu unchanged - rustc 1.89.0 (29483883e 2025-08-04)
2025-09-08T23:42:27.3575616Z 
2025-09-08T23:42:27.3602969Z [command]/home/runner/.cargo/bin/rustup override set stable
2025-09-08T23:42:27.3674431Z info: override toolchain for '/home/runner/work/qnet/qnet' set to 'stable-x86_64-unknown-linux-gnu'
2025-09-08T23:42:27.3695340Z ##[group]Gathering installed versions
2025-09-08T23:42:27.3704804Z [command]/home/runner/.cargo/bin/rustc -V
2025-09-08T23:42:27.4188632Z rustc 1.89.0 (29483883e 2025-08-04)
2025-09-08T23:42:27.4237535Z ##[warning]The `set-output` command is deprecated and will be disabled soon. Please upgrade to using Environment Files. For more information see: https://github.blog/changelog/2022-10-11-github-actions-deprecating-save-state-and-set-output-commands/
2025-09-08T23:42:27.4268941Z ##[warning]The `set-output` command is deprecated and will be disabled soon. Please upgrade to using Environment Files. For more information see: https://github.blog/changelog/2022-10-11-github-actions-deprecating-save-state-and-set-output-commands/
2025-09-08T23:42:27.4278470Z [command]/home/runner/.cargo/bin/cargo -V
2025-09-08T23:42:28.6040580Z cargo 1.89.0 (c24e10642 2025-06-23)
2025-09-08T23:42:28.6140555Z ##[warning]The `set-output` command is deprecated and will be disabled soon. Please upgrade to using Environment Files. For more information see: https://github.blog/changelog/2022-10-11-github-actions-deprecating-save-state-and-set-output-commands/
2025-09-08T23:42:28.6148792Z [command]/home/runner/.cargo/bin/rustup -V
2025-09-08T23:42:28.6203072Z rustup 1.28.2 (e4f3ad6f8 2025-04-28)
2025-09-08T23:42:28.6203858Z info: This is the version for the rustup toolchain manager, not the rustc compiler.
2025-09-08T23:42:28.6628957Z info: The currently active `rustc` version is `rustc 1.89.0 (29483883e 2025-08-04)`
2025-09-08T23:42:28.6652299Z ##[warning]The `set-output` command is deprecated and will be disabled soon. Please upgrade to using Environment Files. For more information see: https://github.blog/changelog/2022-10-11-github-actions-deprecating-save-state-and-set-output-commands/
2025-09-08T23:42:28.6656312Z ##[endgroup]
2025-09-08T23:42:28.6795065Z ##[group]Run actions/setup-go@v4
2025-09-08T23:42:28.6795334Z with:
2025-09-08T23:42:28.6795515Z   go-version: 1.21
2025-09-08T23:42:28.6795718Z   check-latest: false
2025-09-08T23:42:28.6796019Z   token: ***
2025-09-08T23:42:28.6796191Z   cache: true
2025-09-08T23:42:28.6796355Z ##[endgroup]
2025-09-08T23:42:28.8607755Z Setup go version spec 1.21
2025-09-08T23:42:28.9002215Z Attempting to download 1.21...
2025-09-08T23:42:29.2641026Z matching 1.21...
2025-09-08T23:42:29.2684891Z Acquiring 1.21.13 from https://github.com/actions/go-versions/releases/download/1.21.13-10277905115/go-1.21.13-linux-x64.tar.gz
2025-09-08T23:42:30.0923272Z Extracting Go...
2025-09-08T23:42:30.1035895Z [command]/usr/bin/tar xz --warning=no-unknown-keyword --overwrite -C /home/runner/work/_temp/ee76fc2e-d47e-408d-862d-f5f37a4595b9 -f /home/runner/work/_temp/9601298c-380f-44ce-ad4b-e1934c479faf
2025-09-08T23:42:31.7804703Z Successfully extracted go to /home/runner/work/_temp/ee76fc2e-d47e-408d-862d-f5f37a4595b9
2025-09-08T23:42:31.7805907Z Adding to the cache ...
2025-09-08T23:42:36.6638679Z Successfully cached go to /opt/hostedtoolcache/go/1.21.13/x64
2025-09-08T23:42:36.6639422Z Added go to the path
2025-09-08T23:42:36.6639883Z Successfully set up Go version 1.21
2025-09-08T23:42:36.7037593Z [command]/opt/hostedtoolcache/go/1.21.13/x64/bin/go env GOMODCACHE
2025-09-08T23:42:36.7068048Z [command]/opt/hostedtoolcache/go/1.21.13/x64/bin/go env GOCACHE
2025-09-08T23:42:36.7128701Z /home/runner/go/pkg/mod
2025-09-08T23:42:36.7152778Z /home/runner/.cache/go-build
2025-09-08T23:42:36.7227759Z ##[warning]Restore cache failed: Dependencies file is not found in /home/runner/work/qnet/qnet. Supported file pattern: go.sum
2025-09-08T23:42:36.7264145Z go version go1.21.13 linux/amd64
2025-09-08T23:42:36.7264431Z 
2025-09-08T23:42:36.7264811Z ##[group]go env
2025-09-08T23:42:36.8703300Z GO111MODULE=''
2025-09-08T23:42:36.8705009Z GOARCH='amd64'
2025-09-08T23:42:36.8706437Z GOBIN=''
2025-09-08T23:42:36.8708151Z GOCACHE='/home/runner/.cache/go-build'
2025-09-08T23:42:36.8708769Z GOENV='/home/runner/.config/go/env'
2025-09-08T23:42:36.8709423Z GOEXE=''
2025-09-08T23:42:36.8709920Z GOEXPERIMENT=''
2025-09-08T23:42:36.8710221Z GOFLAGS=''
2025-09-08T23:42:36.8710499Z GOHOSTARCH='amd64'
2025-09-08T23:42:36.8710793Z GOHOSTOS='linux'
2025-09-08T23:42:36.8711088Z GOINSECURE=''
2025-09-08T23:42:36.8711680Z GOMODCACHE='/home/runner/go/pkg/mod'
2025-09-08T23:42:36.8712098Z GONOPROXY=''
2025-09-08T23:42:36.8712374Z GONOSUMDB=''
2025-09-08T23:42:36.8712646Z GOOS='linux'
2025-09-08T23:42:36.8712952Z GOPATH='/home/runner/go'
2025-09-08T23:42:36.8713279Z GOPRIVATE=''
2025-09-08T23:42:36.8713660Z GOPROXY='https://proxy.golang.org,direct'
2025-09-08T23:42:36.8714173Z GOROOT='/opt/hostedtoolcache/go/1.21.13/x64'
2025-09-08T23:42:36.8714608Z GOSUMDB='sum.golang.org'
2025-09-08T23:42:36.8714926Z GOTMPDIR=''
2025-09-08T23:42:36.8715208Z GOTOOLCHAIN='auto'
2025-09-08T23:42:36.8715712Z GOTOOLDIR='/opt/hostedtoolcache/go/1.21.13/x64/pkg/tool/linux_amd64'
2025-09-08T23:42:36.8716251Z GOVCS=''
2025-09-08T23:42:36.8716515Z GOVERSION='go1.21.13'
2025-09-08T23:42:36.8716824Z GCCGO='gccgo'
2025-09-08T23:42:36.8717102Z GOAMD64='v1'
2025-09-08T23:42:36.8717382Z AR='ar'
2025-09-08T23:42:36.8717638Z CC='gcc'
2025-09-08T23:42:36.8717904Z CXX='g++'
2025-09-08T23:42:36.8718180Z CGO_ENABLED='1'
2025-09-08T23:42:36.8718475Z GOMOD='/dev/null'
2025-09-08T23:42:36.8718773Z GOWORK=''
2025-09-08T23:42:36.8719058Z CGO_CFLAGS='-O2 -g'
2025-09-08T23:42:36.8719380Z CGO_CPPFLAGS=''
2025-09-08T23:42:36.8719687Z CGO_CXXFLAGS='-O2 -g'
2025-09-08T23:42:36.8720049Z CGO_FFLAGS='-O2 -g'
2025-09-08T23:42:36.8720359Z CGO_LDFLAGS='-O2 -g'
2025-09-08T23:42:36.8720702Z PKG_CONFIG='pkg-config'
2025-09-08T23:42:36.8722387Z GOGCCFLAGS='-fPIC -m64 -pthread -Wl,--no-gc-sections -fmessage-length=0 -ffile-prefix-map=/tmp/go-build596201465=/tmp/go-build -gno-record-gcc-switches'
2025-09-08T23:42:36.8723287Z 
2025-09-08T23:42:36.8723725Z ##[endgroup]
2025-09-08T23:42:36.8950247Z ##[group]Run cargo build --workspace --all-targets
2025-09-08T23:42:36.8950897Z [36;1mcargo build --workspace --all-targets[0m
2025-09-08T23:42:36.8951720Z [36;1mcargo build -p htx --features rustls-config --examples[0m
2025-09-08T23:42:36.9019087Z shell: /usr/bin/bash -e {0}
2025-09-08T23:42:36.9019467Z ##[endgroup]
2025-09-08T23:42:39.1905952Z     Updating crates.io index
2025-09-08T23:42:40.8993474Z  Downloading crates ...
2025-09-08T23:42:41.2423554Z   Downloaded autocfg v1.5.0
2025-09-08T23:42:41.3008968Z   Downloaded thiserror v1.0.69
2025-09-08T23:42:41.3067149Z   Downloaded tracing-core v0.1.34
2025-09-08T23:42:41.3461451Z   Downloaded utf8_iter v1.0.4
2025-09-08T23:42:41.3475346Z   Downloaded scopeguard v1.2.0
2025-09-08T23:42:41.3491467Z   Downloaded rand_core v0.6.4
2025-09-08T23:42:41.3508454Z   Downloaded event-listener v5.4.1
2025-09-08T23:42:41.3532324Z   Downloaded displaydoc v0.2.5
2025-09-08T23:42:41.3595933Z   Downloaded webpki-roots v0.25.4
2025-09-08T23:42:41.3636295Z   Downloaded fastrand v2.3.0
2025-09-08T23:42:41.3671079Z   Downloaded smallvec v1.15.1
2025-09-08T23:42:41.3738357Z   Downloaded vcpkg v0.2.15
2025-09-08T23:42:41.4336542Z   Downloaded zeroize v1.8.1
2025-09-08T23:42:41.4370334Z   Downloaded value-bag v1.11.1
2025-09-08T23:42:41.4415485Z   Downloaded zerovec v0.11.4
2025-09-08T23:42:41.4501662Z   Downloaded zerovec-derive v0.11.1
2025-09-08T23:42:41.4529329Z   Downloaded zerofrom v0.1.6
2025-09-08T23:42:41.4549263Z   Downloaded version_check v0.9.5
2025-09-08T23:42:41.4566008Z   Downloaded sha2 v0.10.9
2025-09-08T23:42:41.4597501Z   Downloaded idna v1.1.0
2025-09-08T23:42:41.4639405Z   Downloaded serde v1.0.219
2025-09-08T23:42:41.4679471Z   Downloaded zerotrie v0.2.2
2025-09-08T23:42:41.4720730Z   Downloaded rustls-webpki v0.101.7
2025-09-08T23:42:41.4946371Z   Downloaded typenum v1.18.0
2025-09-08T23:42:41.4981216Z   Downloaded openssl v0.10.73
2025-09-08T23:42:41.5075161Z   Downloaded curve25519-dalek v4.1.3
2025-09-08T23:42:41.5161923Z   Downloaded syn v1.0.109
2025-09-08T23:42:41.5526714Z   Downloaded rustls v0.21.12
2025-09-08T23:42:41.5644720Z   Downloaded tracing v0.1.41
2025-09-08T23:42:41.5685429Z   Downloaded hyper v0.14.32
2025-09-08T23:42:41.5762259Z   Downloaded h2 v0.3.27
2025-09-08T23:42:41.5826655Z   Downloaded httpdate v1.0.3
2025-09-08T23:42:41.5841464Z   Downloaded futures-util v0.3.31
2025-09-08T23:42:41.5971186Z   Downloaded libc v0.2.175
2025-09-08T23:42:41.6245479Z   Downloaded yoke-derive v0.8.0
2025-09-08T23:42:41.6256494Z   Downloaded http v0.2.12
2025-09-08T23:42:41.6293199Z   Downloaded sct v0.7.1
2025-09-08T23:42:41.6331585Z   Downloaded rand_chacha v0.3.1
2025-09-08T23:42:41.6343837Z   Downloaded quote v1.0.40
2025-09-08T23:42:41.6371861Z   Downloaded openssl-sys v0.9.109
2025-09-08T23:42:41.6426215Z   Downloaded encoding_rs v0.8.35
2025-09-08T23:42:41.6629835Z   Downloaded icu_properties_data v2.0.1
2025-09-08T23:42:41.6728604Z   Downloaded zerofrom-derive v0.1.6
2025-09-08T23:42:41.6738710Z   Downloaded ryu v1.0.20
2025-09-08T23:42:41.6770042Z   Downloaded futures-lite v2.6.1
2025-09-08T23:42:41.6787069Z   Downloaded mio v1.0.4
2025-09-08T23:42:41.6845227Z   Downloaded memchr v2.7.5
2025-09-08T23:42:41.6899824Z   Downloaded cc v1.2.36
2025-09-08T23:42:41.6927903Z   Downloaded thiserror-impl v1.0.69
2025-09-08T23:42:41.6941083Z   Downloaded serde_derive v1.0.219
2025-09-08T23:42:41.6965735Z   Downloaded rustls-native-certs v0.6.3
2025-09-08T23:42:41.6987733Z   Downloaded parking_lot_core v0.9.11
2025-09-08T23:42:41.7008803Z   Downloaded linux-raw-sys v0.9.4
2025-09-08T23:42:41.7503122Z   Downloaded icu_collections v2.0.0
2025-09-08T23:42:41.7565760Z   Downloaded yoke v0.8.0
2025-09-08T23:42:41.7582262Z   Downloaded writeable v0.6.1
2025-09-08T23:42:41.7600050Z   Downloaded want v0.3.1
2025-09-08T23:42:41.7609595Z   Downloaded untrusted v0.9.0
2025-09-08T23:42:41.7627230Z   Downloaded tower-service v0.3.3
2025-09-08T23:42:41.7635392Z   Downloaded tinystr v0.8.1
2025-09-08T23:42:41.7655146Z   Downloaded sync_wrapper v0.1.2
2025-09-08T23:42:41.7663766Z   Downloaded socket2 v0.6.0
2025-09-08T23:42:41.7681234Z   Downloaded slab v0.4.11
2025-09-08T23:42:41.7693734Z   Downloaded rustc_version v0.4.1
2025-09-08T23:42:41.7706433Z   Downloaded ring v0.17.14
2025-09-08T23:42:41.8193149Z   Downloaded proc-macro2 v1.0.101
2025-09-08T23:42:41.8221689Z   Downloaded hyper-tls v0.5.0
2025-09-08T23:42:41.8235027Z   Downloaded url v2.5.7
2025-09-08T23:42:41.8261596Z   Downloaded icu_properties v2.0.1
2025-09-08T23:42:41.8282891Z   Downloaded parking_lot v0.12.4
2025-09-08T23:42:41.8307426Z   Downloaded openssl-macros v0.1.1
2025-09-08T23:42:41.8315059Z   Downloaded tokio-native-tls v0.3.1
2025-09-08T23:42:41.8332115Z   Downloaded tokio v1.47.1
2025-09-08T23:42:41.8746408Z   Downloaded syn v2.0.106
2025-09-08T23:42:41.8851889Z   Downloaded polling v3.10.0
2025-09-08T23:42:41.8881802Z   Downloaded pkg-config v0.3.32
2025-09-08T23:42:41.8897177Z   Downloaded litemap v0.8.0
2025-09-08T23:42:41.8919461Z   Downloaded idna_adapter v1.2.1
2025-09-08T23:42:41.8929037Z   Downloaded icu_normalizer v2.0.0
2025-09-08T23:42:41.8962599Z   Downloaded httparse v1.10.1
2025-09-08T23:42:41.8987657Z   Downloaded half v1.8.3
2025-09-08T23:42:41.9009602Z   Downloaded futures-channel v0.3.31
2025-09-08T23:42:41.9028556Z   Downloaded form_urlencoded v1.2.2
2025-09-08T23:42:41.9038615Z   Downloaded crossbeam-utils v0.8.21
2025-09-08T23:42:41.9066241Z   Downloaded zerocopy v0.8.27
2025-09-08T23:42:41.9318315Z   Downloaded tokio-util v0.7.16
2025-09-08T23:42:41.9390992Z   Downloaded tokio-rustls v0.24.1
2025-09-08T23:42:41.9414667Z   Downloaded serde_cbor v0.11.2
2025-09-08T23:42:41.9442655Z   Downloaded parking v2.2.1
2025-09-08T23:42:41.9453565Z   Downloaded native-tls v0.2.14
2025-09-08T23:42:41.9473488Z   Downloaded itoa v1.0.15
2025-09-08T23:42:41.9487462Z   Downloaded ipnet v2.11.0
2025-09-08T23:42:41.9503486Z   Downloaded http-body v0.4.6
2025-09-08T23:42:41.9520314Z   Downloaded hex v0.4.3
2025-09-08T23:42:41.9536235Z   Downloaded getrandom v0.2.16
2025-09-08T23:42:41.9565102Z   Downloaded generic-array v0.14.7
2025-09-08T23:42:41.9579102Z   Downloaded futures-task v0.3.31
2025-09-08T23:42:41.9590615Z   Downloaded futures-sink v0.3.31
2025-09-08T23:42:41.9599051Z   Downloaded futures-macro v0.3.31
2025-09-08T23:42:41.9609164Z   Downloaded futures-io v0.3.31
2025-09-08T23:42:41.9617780Z   Downloaded futures-core v0.3.31
2025-09-08T23:42:41.9630943Z   Downloaded foreign-types v0.3.2
2025-09-08T23:42:41.9638801Z   Downloaded event-listener-strategy v0.5.4
2025-09-08T23:42:41.9650170Z   Downloaded event-listener v2.5.3
2025-09-08T23:42:41.9662436Z   Downloaded errno v0.3.13
2025-09-08T23:42:41.9677526Z   Downloaded curve25519-dalek-derive v0.1.1
2025-09-08T23:42:41.9687737Z   Downloaded crypto-common v0.1.6
2025-09-08T23:42:41.9696731Z   Downloaded cpufeatures v0.2.17
2025-09-08T23:42:41.9710363Z   Downloaded cfg-if v1.0.3
2025-09-08T23:42:41.9723471Z   Downloaded bytes v1.10.1
2025-09-08T23:42:41.9764495Z   Downloaded block-buffer v0.10.4
2025-09-08T23:42:41.9775094Z   Downloaded try-lock v0.2.5
2025-09-08T23:42:41.9784144Z   Downloaded rustix v1.0.8
2025-09-08T23:42:42.0049638Z   Downloaded reqwest v0.11.27
2025-09-08T23:42:42.0121931Z   Downloaded pin-utils v0.1.0
2025-09-08T23:42:42.0134254Z   Downloaded percent-encoding v2.3.2
2025-09-08T23:42:42.0142949Z   Downloaded md5 v0.7.0
2025-09-08T23:42:42.0152638Z   Downloaded lock_api v0.4.13
2025-09-08T23:42:42.0167514Z   Downloaded fnv v1.0.7
2025-09-08T23:42:42.0175770Z   Downloaded serde_json v1.0.143
2025-09-08T23:42:42.0247351Z   Downloaded indexmap v2.11.0
2025-09-08T23:42:42.0289918Z   Downloaded icu_locale_core v2.0.0
2025-09-08T23:42:42.0359073Z   Downloaded hashbrown v0.15.5
2025-09-08T23:42:42.0408959Z   Downloaded concurrent-queue v2.5.0
2025-09-08T23:42:42.0427230Z   Downloaded base64 v0.21.7
2025-09-08T23:42:42.0468715Z   Downloaded async-std v1.13.2
2025-09-08T23:42:42.0759662Z   Downloaded async-channel v1.9.0
2025-09-08T23:42:42.0771485Z   Downloaded unicode-ident v1.0.18
2025-09-08T23:42:42.0799553Z   Downloaded synstructure v0.13.2
2025-09-08T23:42:42.0810944Z   Downloaded stable_deref_trait v1.2.0
2025-09-08T23:42:42.0819898Z   Downloaded serde_urlencoded v0.7.1
2025-09-08T23:42:42.0836937Z   Downloaded serde_bytes v0.11.17
2025-09-08T23:42:42.0853147Z   Downloaded piper v0.2.4
2025-09-08T23:42:42.0869590Z   Downloaded pin-project-lite v0.2.16
2025-09-08T23:42:42.0929356Z   Downloaded mime v0.3.17
2025-09-08T23:42:42.0943490Z   Downloaded log v0.4.28
2025-09-08T23:42:42.0968730Z   Downloaded icu_provider v2.0.0
2025-09-08T23:42:42.0994399Z   Downloaded icu_normalizer_data v2.0.0
2025-09-08T23:42:42.1015177Z   Downloaded hyper-rustls v0.24.2
2025-09-08T23:42:42.1039599Z   Downloaded futures v0.3.31
2025-09-08T23:42:42.1087311Z   Downloaded blocking v1.6.2
2025-09-08T23:42:42.1099962Z   Downloaded subtle v2.6.1
2025-09-08T23:42:42.1111859Z   Downloaded socket2 v0.5.10
2025-09-08T23:42:42.1130060Z   Downloaded ppv-lite86 v0.2.21
2025-09-08T23:42:42.1143281Z   Downloaded find-msvc-tools v0.1.1
2025-09-08T23:42:42.1158998Z   Downloaded bitflags v2.9.4
2025-09-08T23:42:42.1200064Z   Downloaded base32 v0.4.0
2025-09-08T23:42:42.1208775Z   Downloaded atomic-waker v1.1.2
2025-09-08T23:42:42.1220608Z   Downloaded async-lock v3.4.1
2025-09-08T23:42:42.1243197Z   Downloaded async-io v2.5.0
2025-09-08T23:42:42.1272745Z   Downloaded async-global-executor v2.4.1
2025-09-08T23:42:42.1289645Z   Downloaded async-executor v1.13.3
2025-09-08T23:42:42.1308501Z   Downloaded async-channel v2.5.0
2025-09-08T23:42:42.1320755Z   Downloaded shlex v1.3.0
2025-09-08T23:42:42.1333916Z   Downloaded semver v1.0.26
2025-09-08T23:42:42.1357461Z   Downloaded rustls-pemfile v1.0.4
2025-09-08T23:42:42.1379908Z   Downloaded rand v0.8.5
2025-09-08T23:42:42.1415105Z   Downloaded potential_utf v0.1.3
2025-09-08T23:42:42.1425487Z   Downloaded openssl-probe v0.1.6
2025-09-08T23:42:42.1436528Z   Downloaded once_cell v1.21.3
2025-09-08T23:42:42.1461582Z   Downloaded kv-log-macro v1.0.7
2025-09-08T23:42:42.1479729Z   Downloaded futures-executor v0.3.31
2025-09-08T23:42:42.1493521Z   Downloaded foreign-types-shared v0.1.1
2025-09-08T23:42:42.1500197Z   Downloaded equivalent v1.0.2
2025-09-08T23:42:42.1510174Z   Downloaded digest v0.10.7
2025-09-08T23:42:42.1528086Z   Downloaded async-task v4.7.1
2025-09-08T23:42:42.1553295Z   Downloaded async-attributes v1.1.2
2025-09-08T23:42:42.3163490Z    Compiling proc-macro2 v1.0.101
2025-09-08T23:42:42.3164231Z    Compiling unicode-ident v1.0.18
2025-09-08T23:42:48.3447279Z    Compiling cfg-if v1.0.3
2025-09-08T23:42:48.3741073Z    Compiling libc v0.2.175
2025-09-08T23:42:52.2162467Z    Compiling shlex v1.3.0
2025-09-08T23:42:52.8577658Z    Compiling find-msvc-tools v0.1.1
2025-09-08T23:42:53.2112670Z    Compiling quote v1.0.40
2025-09-08T23:42:53.3742215Z    Compiling syn v2.0.106
2025-09-08T23:42:53.4381913Z    Compiling cc v1.2.36
2025-09-08T23:42:55.0463029Z    Compiling pin-project-lite v0.2.16
2025-09-08T23:42:55.0905369Z    Compiling serde v1.0.219
2025-09-08T23:42:55.3295033Z    Compiling getrandom v0.2.16
2025-09-08T23:42:55.5182582Z    Compiling futures-core v0.3.31
2025-09-08T23:42:55.6079192Z    Compiling ring v0.17.14
2025-09-08T23:42:56.0828056Z    Compiling futures-io v0.3.31
2025-09-08T23:42:58.0528023Z    Compiling serde_derive v1.0.219
2025-09-08T23:43:02.0134254Z    Compiling synstructure v0.13.2
2025-09-08T23:43:02.3346294Z    Compiling thiserror v1.0.69
2025-09-08T23:43:02.5281089Z    Compiling zerofrom-derive v0.1.6
2025-09-08T23:43:03.4652829Z    Compiling thiserror-impl v1.0.69
2025-09-08T23:43:04.3259544Z    Compiling bytes v1.10.1
2025-09-08T23:43:04.8001178Z    Compiling untrusted v0.9.0
2025-09-08T23:43:04.8765632Z    Compiling zerofrom v0.1.6
2025-09-08T23:43:04.9348061Z    Compiling yoke-derive v0.8.0
2025-09-08T23:43:05.7067215Z    Compiling slab v0.4.11
2025-09-08T23:43:05.7892355Z    Compiling once_cell v1.21.3
2025-09-08T23:43:05.8954195Z    Compiling stable_deref_trait v1.2.0
2025-09-08T23:43:05.9225305Z    Compiling memchr v2.7.5
2025-09-08T23:43:06.7545593Z    Compiling yoke v0.8.0
2025-09-08T23:43:06.8826002Z    Compiling itoa v1.0.15
2025-09-08T23:43:06.9382549Z    Compiling zerovec-derive v0.11.1
2025-09-08T23:43:07.7376548Z    Compiling futures-sink v0.3.31
2025-09-08T23:43:07.7748580Z    Compiling bitflags v2.9.4
2025-09-08T23:43:07.8891884Z    Compiling value-bag v1.11.1
2025-09-08T23:43:08.1468976Z    Compiling log v0.4.28
2025-09-08T23:43:08.3804553Z    Compiling zerovec v0.11.4
2025-09-08T23:43:09.1343659Z    Compiling displaydoc v0.2.5
2025-09-08T23:43:09.6262401Z    Compiling smallvec v1.15.1
2025-09-08T23:43:09.7273820Z    Compiling zerocopy v0.8.27
2025-09-08T23:43:09.9370046Z    Compiling pin-utils v0.1.0
2025-09-08T23:43:09.9744692Z    Compiling futures-channel v0.3.31
2025-09-08T23:43:10.0789216Z    Compiling futures-macro v0.3.31
2025-09-08T23:43:10.6531887Z    Compiling pkg-config v0.3.32
2025-09-08T23:43:10.9478611Z    Compiling futures-task v0.3.31
2025-09-08T23:43:11.0982533Z    Compiling vcpkg v0.2.15
2025-09-08T23:43:11.5014782Z    Compiling openssl-sys v0.9.109
2025-09-08T23:43:11.9223806Z    Compiling futures-util v0.3.31
2025-09-08T23:43:15.1698652Z    Compiling socket2 v0.6.0
2025-09-08T23:43:15.6650753Z    Compiling mio v1.0.4
2025-09-08T23:43:16.1459683Z    Compiling tokio v1.47.1
2025-09-08T23:43:16.3395813Z    Compiling ppv-lite86 v0.2.21
2025-09-08T23:43:17.0223823Z    Compiling tinystr v0.8.1
2025-09-08T23:43:17.1891982Z    Compiling rand_core v0.6.4
2025-09-08T23:43:17.3341107Z    Compiling writeable v0.6.1
2025-09-08T23:43:17.5935187Z    Compiling cpufeatures v0.2.17
2025-09-08T23:43:17.6279170Z    Compiling litemap v0.8.0
2025-09-08T23:43:17.7990360Z    Compiling icu_locale_core v2.0.0
2025-09-08T23:43:18.9039033Z    Compiling rand_chacha v0.3.1
2025-09-08T23:43:19.4180146Z    Compiling zerotrie v0.2.2
2025-09-08T23:43:19.6534578Z    Compiling potential_utf v0.1.3
2025-09-08T23:43:19.7432395Z    Compiling icu_properties_data v2.0.1
2025-09-08T23:43:19.8919958Z    Compiling serde_json v1.0.143
2025-09-08T23:43:20.0490122Z    Compiling icu_normalizer_data v2.0.0
2025-09-08T23:43:20.1958822Z    Compiling fnv v1.0.7
2025-09-08T23:43:20.2252991Z    Compiling ryu v1.0.20
2025-09-08T23:43:20.3546964Z    Compiling crossbeam-utils v0.8.21
2025-09-08T23:43:20.5508009Z    Compiling http v0.2.12
2025-09-08T23:43:21.0792609Z    Compiling icu_collections v2.0.0
2025-09-08T23:43:21.5577175Z    Compiling icu_provider v2.0.0
2025-09-08T23:43:21.5963152Z    Compiling rand v0.8.5
2025-09-08T23:43:21.7968468Z    Compiling tracing-core v0.1.34
2025-09-08T23:43:22.2632563Z    Compiling hashbrown v0.15.5
2025-09-08T23:43:22.3516568Z    Compiling openssl v0.10.73
2025-09-08T23:43:22.5495637Z    Compiling equivalent v1.0.2
2025-09-08T23:43:22.5872536Z    Compiling foreign-types-shared v0.1.1
2025-09-08T23:43:22.6222793Z    Compiling httparse v1.10.1
2025-09-08T23:43:22.7494000Z    Compiling semver v1.0.26
2025-09-08T23:43:22.9056536Z    Compiling indexmap v2.11.0
2025-09-08T23:43:22.9728880Z    Compiling foreign-types v0.3.2
2025-09-08T23:43:23.0120207Z    Compiling tracing v0.1.41
2025-09-08T23:43:24.1252402Z    Compiling tokio-util v0.7.16
2025-09-08T23:43:25.0792507Z    Compiling openssl-macros v0.1.1
2025-09-08T23:43:25.1507780Z    Compiling native-tls v0.2.14
2025-09-08T23:43:25.3086179Z    Compiling version_check v0.9.5
2025-09-08T23:43:25.4871175Z    Compiling try-lock v0.2.5
2025-09-08T23:43:25.5226549Z    Compiling typenum v1.18.0
2025-09-08T23:43:25.5339246Z    Compiling openssl-probe v0.1.6
2025-09-08T23:43:25.6700273Z    Compiling rustls v0.21.12
2025-09-08T23:43:25.8018675Z    Compiling want v0.3.1
2025-09-08T23:43:25.8196798Z    Compiling generic-array v0.14.7
2025-09-08T23:43:25.9894115Z    Compiling h2 v0.3.27
2025-09-08T23:43:29.4971233Z    Compiling concurrent-queue v2.5.0
2025-09-08T23:43:29.7618499Z    Compiling icu_normalizer v2.0.0
2025-09-08T23:43:29.8069314Z    Compiling icu_properties v2.0.1
2025-09-08T23:43:30.8140082Z    Compiling http-body v0.4.6
2025-09-08T23:43:30.9784179Z    Compiling sct v0.7.1
2025-09-08T23:43:31.0871104Z    Compiling rustls-webpki v0.101.7
2025-09-08T23:43:31.3069776Z    Compiling core-crypto v0.1.0 (/home/runner/work/qnet/qnet/crates/core-crypto)
2025-09-08T23:43:31.7531152Z    Compiling socket2 v0.5.10
2025-09-08T23:43:31.8251983Z    Compiling tower-service v0.3.3
2025-09-08T23:43:31.8660907Z    Compiling httpdate v1.0.3
2025-09-08T23:43:32.0354482Z    Compiling percent-encoding v2.3.2
2025-09-08T23:43:32.1557184Z    Compiling parking v2.2.1
2025-09-08T23:43:32.2404577Z    Compiling form_urlencoded v1.2.2
2025-09-08T23:43:32.2514635Z    Compiling hyper v0.14.32
2025-09-08T23:43:35.0999015Z    Compiling idna_adapter v1.2.1
2025-09-08T23:43:35.1701741Z    Compiling rustc_version v0.4.1
2025-09-08T23:43:36.1867032Z    Compiling base64 v0.21.7
2025-09-08T23:43:36.4539086Z    Compiling utf8_iter v1.0.4
2025-09-08T23:43:36.4948634Z    Compiling half v1.8.3
2025-09-08T23:43:36.5349486Z    Compiling idna v1.1.0
2025-09-08T23:43:36.7212421Z    Compiling serde_cbor v0.11.2
2025-09-08T23:43:37.3447606Z    Compiling rustls-pemfile v1.0.4
2025-09-08T23:43:37.5002146Z    Compiling tokio-native-tls v0.3.1
2025-09-08T23:43:37.5975749Z    Compiling curve25519-dalek v4.1.3
2025-09-08T23:43:37.8083561Z    Compiling tokio-rustls v0.24.1
2025-09-08T23:43:37.8952709Z    Compiling serde_bytes v0.11.17
2025-09-08T23:43:37.9605876Z    Compiling hyper-rustls v0.24.2
2025-09-08T23:43:38.0890311Z    Compiling hyper-tls v0.5.0
2025-09-08T23:43:38.0932270Z    Compiling url v2.5.7
2025-09-08T23:43:38.1976996Z    Compiling serde_urlencoded v0.7.1
2025-09-08T23:43:38.3957819Z    Compiling event-listener v5.4.1
2025-09-08T23:43:38.9242743Z    Compiling curve25519-dalek-derive v0.1.1
2025-09-08T23:43:38.9639533Z    Compiling encoding_rs v0.8.35
2025-09-08T23:43:39.5822323Z    Compiling fastrand v2.3.0
2025-09-08T23:43:39.7492915Z    Compiling zeroize v1.8.1
2025-09-08T23:43:39.8626676Z    Compiling mime v0.3.17
2025-09-08T23:43:40.0692475Z    Compiling webpki-roots v0.25.4
2025-09-08T23:43:40.1238044Z    Compiling subtle v2.6.1
2025-09-08T23:43:40.2115161Z    Compiling ipnet v2.11.0
2025-09-08T23:43:40.7092606Z    Compiling sync_wrapper v0.1.2
2025-09-08T23:43:40.7498068Z    Compiling reqwest v0.11.27
2025-09-08T23:43:42.3922775Z    Compiling event-listener-strategy v0.5.4
2025-09-08T23:43:42.4644783Z    Compiling crypto-common v0.1.6
2025-09-08T23:43:42.5255084Z    Compiling block-buffer v0.10.4
2025-09-08T23:43:42.5985543Z    Compiling rustls-native-certs v0.6.3
2025-09-08T23:43:42.7478824Z    Compiling core-cbor v0.1.0 (/home/runner/work/qnet/qnet/crates/core-cbor)
2025-09-08T23:43:42.8002564Z    Compiling core-framing v0.1.0 (/home/runner/work/qnet/qnet/crates/core-framing)
2025-09-08T23:43:42.9378294Z    Compiling rustix v1.0.8
2025-09-08T23:43:43.2144901Z    Compiling md5 v0.7.0
2025-09-08T23:43:43.3439239Z    Compiling autocfg v1.5.0
2025-09-08T23:43:43.6512775Z    Compiling lock_api v0.4.13
2025-09-08T23:43:43.8584497Z    Compiling digest v0.10.7
2025-09-08T23:43:43.9872817Z    Compiling futures-lite v2.6.1
2025-09-08T23:43:44.7018270Z    Compiling parking_lot_core v0.9.11
2025-09-08T23:43:44.8901089Z    Compiling linux-raw-sys v0.9.4
2025-09-08T23:43:46.2113255Z    Compiling sha2 v0.10.9
2025-09-08T23:43:46.6649570Z    Compiling htx v0.1.0 (/home/runner/work/qnet/qnet/crates/htx)
2025-09-08T23:43:49.0299796Z    Compiling syn v1.0.109
2025-09-08T23:43:49.2763288Z    Compiling hex v0.4.3
2025-09-08T23:43:49.4953410Z    Compiling atomic-waker v1.1.2
2025-09-08T23:43:49.5523308Z    Compiling scopeguard v1.2.0
2025-09-08T23:43:49.5962044Z    Compiling async-task v4.7.1
2025-09-08T23:43:49.9202639Z    Compiling piper v0.2.4
2025-09-08T23:43:50.0802417Z    Compiling polling v3.10.0
2025-09-08T23:43:50.3582956Z    Compiling async-channel v2.5.0
2025-09-08T23:43:50.5023784Z    Compiling async-lock v3.4.1
2025-09-08T23:43:50.5187358Z    Compiling blocking v1.6.2
2025-09-08T23:43:50.7370388Z    Compiling parking_lot v0.12.4
2025-09-08T23:43:51.0842527Z    Compiling async-io v2.5.0
2025-09-08T23:43:51.9027346Z    Compiling async-executor v1.13.3
2025-09-08T23:43:52.2310822Z    Compiling base32 v0.4.0
2025-09-08T23:43:52.3252883Z    Compiling event-listener v2.5.3
2025-09-08T23:43:52.4633346Z    Compiling async-channel v1.9.0
2025-09-08T23:43:52.5669973Z    Compiling async-global-executor v2.4.1
2025-09-08T23:43:53.1646344Z    Compiling futures-executor v0.3.31
2025-09-08T23:43:53.3913686Z    Compiling kv-log-macro v1.0.7
2025-09-08T23:43:53.4573857Z    Compiling futures v0.3.31
2025-09-08T23:43:53.4953792Z    Compiling core-identity v0.1.0 (/home/runner/work/qnet/qnet/crates/core-identity)
2025-09-08T23:43:54.3713593Z    Compiling async-attributes v1.1.2
2025-09-08T23:43:54.6854344Z    Compiling async-std v1.13.2
2025-09-08T23:43:55.0030309Z    Compiling alias-ledger v0.1.0 (/home/runner/work/qnet/qnet/crates/alias-ledger)
2025-09-08T23:43:55.8465437Z    Compiling mixnode v0.1.0 (/home/runner/work/qnet/qnet/crates/mixnode)
2025-09-08T23:43:56.4392281Z    Compiling core-mesh v0.1.0 (/home/runner/work/qnet/qnet/crates/core-mesh)
2025-09-08T23:43:57.4662735Z    Compiling voucher v0.1.0 (/home/runner/work/qnet/qnet/crates/voucher)
2025-09-08T23:43:57.7443019Z    Compiling echo v0.1.0 (/home/runner/work/qnet/qnet/examples/echo)
2025-09-08T23:43:57.8873221Z    Compiling qnet_c v0.1.0 (/home/runner/work/qnet/qnet/crates/c-lib)
2025-09-08T23:43:59.8787679Z    Compiling core-mix v0.1.0 (/home/runner/work/qnet/qnet/crates/core-mix)
2025-09-08T23:44:01.6349466Z    Compiling core-routing v0.1.0 (/home/runner/work/qnet/qnet/crates/core-routing)
2025-09-08T23:44:04.1142075Z    Compiling core-governance v0.1.0 (/home/runner/work/qnet/qnet/crates/core-governance)
2025-09-08T23:44:05.0934031Z     Finished `dev` profile [unoptimized + debuginfo] target(s) in 1m 28s
2025-09-08T23:44:05.3230598Z    Compiling log v0.4.28
2025-09-08T23:44:05.3232489Z    Compiling futures-io v0.3.31
2025-09-08T23:44:05.4210243Z    Compiling futures-util v0.3.31
2025-09-08T23:44:05.4510807Z    Compiling bitflags v2.9.4
2025-09-08T23:44:05.5962681Z    Compiling openssl v0.10.73
2025-09-08T23:44:07.6089382Z    Compiling h2 v0.3.27
2025-09-08T23:44:09.5703774Z    Compiling futures-channel v0.3.31
2025-09-08T23:44:09.7051277Z    Compiling rustls v0.21.12
2025-09-08T23:44:11.1049613Z    Compiling hyper v0.14.32
2025-09-08T23:44:13.9684595Z    Compiling native-tls v0.2.14
2025-09-08T23:44:13.9957625Z    Compiling tokio-rustls v0.24.1
2025-09-08T23:44:14.1467664Z    Compiling tokio-native-tls v0.3.1
2025-09-08T23:44:14.1958824Z    Compiling hyper-rustls v0.24.2
2025-09-08T23:44:14.2314526Z    Compiling hyper-tls v0.5.0
2025-09-08T23:44:14.3155104Z    Compiling reqwest v0.11.27
2025-09-08T23:44:15.1716152Z    Compiling htx v0.1.0 (/home/runner/work/qnet/qnet/crates/htx)
2025-09-08T23:44:20.5133522Z     Finished `dev` profile [unoptimized + debuginfo] target(s) in 15.30s
2025-09-08T23:44:20.5329572Z ##[group]Run cd linter
2025-09-08T23:44:20.5329840Z [36;1mcd linter[0m
2025-09-08T23:44:20.5330064Z [36;1mgo build -o qnet-lint ./cmd/qnet-lint/[0m
2025-09-08T23:44:20.5360755Z shell: /usr/bin/bash -e {0}
2025-09-08T23:44:20.5360975Z ##[endgroup]
2025-09-08T23:44:20.5465013Z go: downloading github.com/spf13/cobra v1.8.0
2025-09-08T23:44:20.8219626Z go: downloading github.com/spf13/pflag v1.0.5
2025-09-08T23:44:30.8897402Z ##[group]Run cargo test --workspace --all-features
2025-09-08T23:44:30.8898043Z [36;1mcargo test --workspace --all-features[0m
2025-09-08T23:44:30.8898598Z [36;1mcargo test -p htx --features rustls-config[0m
2025-09-08T23:44:30.8943719Z shell: /usr/bin/bash -e {0}
2025-09-08T23:44:30.8944104Z ##[endgroup]
2025-09-08T23:44:31.0347914Z  Downloading crates ...
2025-09-08T23:44:31.3095588Z   Downloaded asn1-rs v0.6.2
2025-09-08T23:44:31.3270083Z   Downloaded aes v0.8.4
2025-09-08T23:44:31.3311210Z   Downloaded arrayref v0.3.9
2025-09-08T23:44:31.3332184Z   Downloaded allocator-api2 v0.2.21
2025-09-08T23:44:31.3415596Z   Downloaded cfg_aliases v0.2.1
2025-09-08T23:44:31.3432919Z   Downloaded asn1-rs-derive v0.5.1
2025-09-08T23:44:31.3454279Z   Downloaded async-trait v0.1.89
2025-09-08T23:44:31.3499145Z   Downloaded aho-corasick v1.1.3
2025-09-08T23:44:31.3558068Z   Downloaded asynchronous-codec v0.7.0
2025-09-08T23:44:31.3586575Z   Downloaded anyhow v1.0.99
2025-09-08T23:44:31.3632581Z   Downloaded async-std-resolver v0.24.4
2025-09-08T23:44:31.3649999Z   Downloaded async-lock v2.8.0
2025-09-08T23:44:31.3707516Z   Downloaded aead v0.5.2
2025-09-08T23:44:31.3742682Z   Downloaded bitflags v1.3.2
2025-09-08T23:44:31.3788271Z   Downloaded aes-gcm v0.10.3
2025-09-08T23:44:31.3856641Z   Downloaded base-x v0.2.11
2025-09-08T23:44:31.3884505Z   Downloaded base64 v0.22.1
2025-09-08T23:44:31.3931069Z   Downloaded async-signal v0.2.12
2025-09-08T23:44:31.3954306Z   Downloaded num-traits v0.2.19
2025-09-08T23:44:31.3990024Z   Downloaded socket2 v0.4.10
2025-09-08T23:44:31.4017710Z   Downloaded yamux v0.12.1
2025-09-08T23:44:31.4038812Z   Downloaded signature v2.2.0
2025-09-08T23:44:31.4061845Z   Downloaded num-integer v0.1.46
2025-09-08T23:44:31.4089865Z   Downloaded tracing-attributes v0.1.30
2025-09-08T23:44:31.4130382Z   Downloaded time v0.3.43
2025-09-08T23:44:31.4264007Z   Downloaded x509-parser v0.16.0
2025-09-08T23:44:31.4353107Z   Downloaded yasna v0.5.2
2025-09-08T23:44:31.4398708Z   Downloaded tinyvec v1.10.0
2025-09-08T23:44:31.4453008Z   Downloaded x25519-dalek v2.0.1
2025-09-08T23:44:31.4489750Z   Downloaded rand v0.9.2
2025-09-08T23:44:31.4547673Z   Downloaded rustix v0.37.28
2025-09-08T23:44:31.4828352Z   Downloaded netlink-packet-route v0.17.1
2025-09-08T23:44:31.4968690Z   Downloaded waker-fn v1.2.0
2025-09-08T23:44:31.4987422Z   Downloaded rustc-hash v2.1.1
2025-09-08T23:44:31.5013512Z   Downloaded resolv-conf v0.7.4
2025-09-08T23:44:31.5043424Z   Downloaded thiserror-impl v2.0.16
2025-09-08T23:44:31.5069859Z   Downloaded zeroize_derive v1.4.2
2025-09-08T23:44:31.5093767Z   Downloaded unsigned-varint v0.8.0
2025-09-08T23:44:31.5124581Z   Downloaded hickory-proto v0.24.4
2025-09-08T23:44:31.5313973Z   Downloaded signal-hook-registry v1.4.6
2025-09-08T23:44:31.5335220Z   Downloaded time-macros v0.2.24
2025-09-08T23:44:31.5382121Z   Downloaded yamux v0.13.6
2025-09-08T23:44:31.5404047Z   Downloaded spin v0.5.2
2025-09-08T23:44:31.5429330Z   Downloaded num-bigint v0.4.6
2025-09-08T23:44:31.5504479Z   Downloaded rusticata-macros v4.1.0
2025-09-08T23:44:31.5521574Z   Downloaded netlink-sys v0.8.7
2025-09-08T23:44:31.5544111Z   Downloaded nom v7.1.3
2025-09-08T23:44:31.5597072Z   Downloaded num_cpus v1.17.0
2025-09-08T23:44:31.5630558Z   Downloaded rustls-pki-types v1.12.0
2025-09-08T23:44:31.5678670Z   Downloaded hkdf v0.12.4
2025-09-08T23:44:31.5706845Z   Downloaded minimal-lexical v0.2.1
2025-09-08T23:44:31.5754093Z   Downloaded linux-raw-sys v0.3.8
2025-09-08T23:44:31.5929235Z   Downloaded pin-project v1.1.10
2025-09-08T23:44:31.6068513Z   Downloaded libp2p-gossipsub v0.46.1
2025-09-08T23:44:31.6109169Z   Downloaded multiaddr v0.18.2
2025-09-08T23:44:31.6126806Z   Downloaded hickory-resolver v0.24.4
2025-09-08T23:44:31.6169272Z   Downloaded quick-protobuf-codec v0.3.1
2025-09-08T23:44:31.6182318Z   Downloaded quick-protobuf v0.8.1
2025-09-08T23:44:31.6278740Z   Downloaded nohash-hasher v0.2.0
2025-09-08T23:44:31.6289180Z   Downloaded multistream-select v0.13.0
2025-09-08T23:44:31.6303652Z   Downloaded libp2p-tls v0.4.1
2025-09-08T23:44:31.6316214Z   Downloaded libp2p-tcp v0.41.0
2025-09-08T23:44:31.6328808Z   Downloaded nix v0.26.4
2025-09-08T23:44:31.6429670Z   Downloaded libp2p-request-response v0.26.3
2025-09-08T23:44:31.6446564Z   Downloaded libp2p-metrics v0.14.1
2025-09-08T23:44:31.6461529Z   Downloaded libp2p-identify v0.44.2
2025-09-08T23:44:31.6476558Z   Downloaded libp2p-connection-limits v0.3.1
2025-09-08T23:44:31.6485460Z   Downloaded libp2p-allow-block-list v0.3.0
2025-09-08T23:44:31.6494053Z   Downloaded instant v0.1.13
2025-09-08T23:44:31.6508211Z   Downloaded fastrand v1.9.0
2025-09-08T23:44:31.6521763Z   Downloaded cipher v0.4.4
2025-09-08T23:44:31.6537550Z   Downloaded static_assertions v1.1.0
2025-09-08T23:44:31.6552354Z   Downloaded regex-automata v0.4.10
2025-09-08T23:44:31.7583242Z   Downloaded paste v1.0.15
2025-09-08T23:44:31.7615634Z   Downloaded netlink-proto v0.11.5
2025-09-08T23:44:31.7638584Z   Downloaded netlink-packet-utils v0.5.2
2025-09-08T23:44:31.7654505Z   Downloaded netlink-packet-core v0.7.0
2025-09-08T23:44:31.7674274Z   Downloaded multihash v0.19.3
2025-09-08T23:44:31.7693516Z   Downloaded lru-slab v0.1.2
2025-09-08T23:44:31.7702686Z   Downloaded lru-cache v0.1.2
2025-09-08T23:44:31.7713574Z   Downloaded lru v0.12.5
2025-09-08T23:44:31.7726358Z   Downloaded libp2p-yamux v0.45.2
2025-09-08T23:44:31.7736331Z   Downloaded libp2p-identity v0.2.12
2025-09-08T23:44:31.7761158Z   Downloaded libp2p-dns v0.41.1
2025-09-08T23:44:31.7771657Z   Downloaded libp2p v0.53.2
2025-09-08T23:44:31.7800858Z   Downloaded io-lifetimes v1.0.11
2025-09-08T23:44:31.7824186Z   Downloaded futures-ticker v0.0.3
2025-09-08T23:44:31.7841457Z   Downloaded futures-lite v1.13.0
2025-09-08T23:44:31.7858358Z   Downloaded foldhash v0.1.5
2025-09-08T23:44:31.7871219Z   Downloaded ed25519-dalek v2.2.0
2025-09-08T23:44:31.7906650Z   Downloaded regex-syntax v0.8.6
2025-09-08T23:44:31.7976393Z   Downloaded ed25519 v2.2.3
2025-09-08T23:44:31.7994803Z   Downloaded der-parser v9.0.0
2025-09-08T23:44:31.8028394Z   Downloaded data-encoding-macro-internal v0.1.16
2025-09-08T23:44:31.8036762Z   Downloaded data-encoding v2.9.0
2025-09-08T23:44:31.8047309Z   Downloaded multibase v0.9.1
2025-09-08T23:44:31.8062276Z   Downloaded linked-hash-map v0.5.6
2025-09-08T23:44:31.8073260Z   Downloaded libp2p-swarm-derive v0.34.2
2025-09-08T23:44:31.8081860Z   Downloaded libp2p-swarm v0.44.2
2025-09-08T23:44:31.8122906Z   Downloaded libp2p-ping v0.44.1
2025-09-08T23:44:31.8133668Z   Downloaded lazy_static v1.5.0
2025-09-08T23:44:31.8151660Z   Downloaded inout v0.1.4
2025-09-08T23:44:31.8162972Z   Downloaded hex_fmt v0.3.0
2025-09-08T23:44:31.8172634Z   Downloaded ghash v0.5.1
2025-09-08T23:44:31.8184043Z   Downloaded enum-as-inner v0.6.1
2025-09-08T23:44:31.8200221Z   Downloaded either v1.15.0
2025-09-08T23:44:31.8215469Z   Downloaded data-encoding-macro v0.1.18
2025-09-08T23:44:31.8223477Z   Downloaded libp2p-noise v0.44.0
2025-09-08T23:44:31.8240491Z   Downloaded libp2p-mdns v0.45.1
2025-09-08T23:44:31.8257666Z   Downloaded chacha20 v0.9.1
2025-09-08T23:44:31.8276649Z   Downloaded if-watch v3.2.1
2025-09-08T23:44:31.8293357Z   Downloaded getrandom v0.3.3
2025-09-08T23:44:31.8327520Z   Downloaded ring v0.16.20
2025-09-08T23:44:31.9120605Z   Downloaded universal-hash v0.5.1
2025-09-08T23:44:31.9129995Z   Downloaded spki v0.7.3
2025-09-08T23:44:31.9147872Z   Downloaded snow v0.9.6
2025-09-08T23:44:31.9260999Z   Downloaded rustls-webpki v0.103.4
2025-09-08T23:44:31.9292369Z   Downloaded rand_chacha v0.9.0
2025-09-08T23:44:31.9304677Z   Downloaded powerfmt v0.2.0
2025-09-08T23:44:31.9317135Z   Downloaded num-conv v0.1.0
2025-09-08T23:44:31.9325727Z   Downloaded futures-bounded v0.2.4
2025-09-08T23:44:31.9337471Z   Downloaded der v0.7.10
2025-09-08T23:44:31.9389901Z   Downloaded quinn-proto v0.11.13
2025-09-08T23:44:31.9459357Z   Downloaded thiserror v2.0.16
2025-09-08T23:44:31.9523392Z   Downloaded rw-stream-sink v0.4.0
2025-09-08T23:44:31.9530930Z   Downloaded rustls v0.23.31
2025-09-08T23:44:31.9650290Z   Downloaded rand_core v0.9.3
2025-09-08T23:44:31.9664932Z   Downloaded quinn v0.11.9
2025-09-08T23:44:31.9698022Z   Downloaded pem v3.0.5
2025-09-08T23:44:31.9712097Z   Downloaded opaque-debug v0.3.1
2025-09-08T23:44:31.9721057Z   Downloaded heck v0.5.0
2025-09-08T23:44:31.9733911Z   Downloaded ctr v0.9.2
2025-09-08T23:44:31.9755083Z   Downloaded web-time v1.1.0
2025-09-08T23:44:31.9772871Z   Downloaded unsigned-varint v0.7.2
2025-09-08T23:44:31.9793121Z   Downloaded tinyvec_macros v0.1.1
2025-09-08T23:44:31.9801925Z   Downloaded regex v1.11.2
2025-09-08T23:44:31.9872149Z   Downloaded rcgen v0.11.3
2025-09-08T23:44:31.9899254Z   Downloaded quinn-udp v0.5.14
2025-09-08T23:44:31.9917182Z   Downloaded polyval v0.6.2
2025-09-08T23:44:31.9933838Z   Downloaded polling v2.8.0
2025-09-08T23:44:31.9961657Z   Downloaded libp2p-quic v0.10.3
2025-09-08T23:44:31.9979580Z   Downloaded libp2p-core v0.41.3
2025-09-08T23:44:32.0012963Z   Downloaded futures-timer v3.0.3
2025-09-08T23:44:32.0030971Z   Downloaded dtoa v1.0.10
2025-09-08T23:44:32.0046427Z   Downloaded core2 v0.4.0
2025-09-08T23:44:32.0065931Z   Downloaded const-oid v0.9.6
2025-09-08T23:44:32.0084869Z   Downloaded void v1.0.2
2025-09-08T23:44:32.0091489Z   Downloaded time-core v0.1.6
2025-09-08T23:44:32.0102373Z   Downloaded rtnetlink v0.13.1
2025-09-08T23:44:32.0161487Z   Downloaded prometheus-client v0.22.3
2025-09-08T23:44:32.0196778Z   Downloaded oid-registry v0.7.1
2025-09-08T23:44:32.0208320Z   Downloaded hmac v0.12.1
2025-09-08T23:44:32.0227638Z   Downloaded futures-rustls v0.26.0
2025-09-08T23:44:32.0244389Z   Downloaded chacha20poly1305 v0.10.1
2025-09-08T23:44:32.0261619Z   Downloaded bs58 v0.5.1
2025-09-08T23:44:32.0284164Z   Downloaded base64ct v1.8.0
2025-09-08T23:44:32.0308299Z   Downloaded pin-project-internal v1.1.10
2025-09-08T23:44:32.0324517Z   Downloaded asn1-rs-impl v0.2.0
2025-09-08T23:44:32.0332100Z   Downloaded prometheus-client-derive-encode v0.4.2
2025-09-08T23:44:32.0339367Z   Downloaded poly1305 v0.8.0
2025-09-08T23:44:32.0363764Z   Downloaded async-io v1.13.0
2025-09-08T23:44:32.0384947Z   Downloaded untrusted v0.7.1
2025-09-08T23:44:32.0395702Z   Downloaded pkcs8 v0.10.2
2025-09-08T23:44:32.0424713Z   Downloaded blake2 v0.10.6
2025-09-08T23:44:32.0449865Z   Downloaded byteorder v1.5.0
2025-09-08T23:44:32.0465862Z   Downloaded deranged v0.5.3
2025-09-08T23:44:32.0479965Z   Downloaded async-process v2.4.0
2025-09-08T23:44:32.1257615Z    Compiling libc v0.2.175
2025-09-08T23:44:32.1258323Z    Compiling syn v2.0.106
2025-09-08T23:44:34.0873085Z    Compiling getrandom v0.2.16
2025-09-08T23:44:34.2220351Z    Compiling rand_core v0.6.4
2025-09-08T23:44:34.3758213Z    Compiling rand_chacha v0.3.1
2025-09-08T23:44:34.8736621Z    Compiling rand v0.8.5
2025-09-08T23:44:35.5104818Z    Compiling synstructure v0.13.2
2025-09-08T23:44:36.0036350Z    Compiling subtle v2.6.1
2025-09-08T23:44:36.1080627Z    Compiling digest v0.10.7
2025-09-08T23:44:36.2599704Z    Compiling ring v0.17.14
2025-09-08T23:44:37.2450080Z    Compiling serde_derive v1.0.219
2025-09-08T23:44:38.9350918Z    Compiling thiserror-impl v1.0.69
2025-09-08T23:44:40.2394903Z    Compiling thiserror v1.0.69
2025-09-08T23:44:40.2774444Z    Compiling futures-macro v0.3.31
2025-09-08T23:44:40.5558300Z    Compiling serde v1.0.219
2025-09-08T23:44:41.1230285Z    Compiling futures-util v0.3.31
2025-09-08T23:44:43.1202457Z    Compiling zerofrom-derive v0.1.6
2025-09-08T23:44:43.7387185Z    Compiling yoke-derive v0.8.0
2025-09-08T23:44:44.6050718Z    Compiling zerofrom v0.1.6
2025-09-08T23:44:44.6773538Z    Compiling zerovec-derive v0.11.1
2025-09-08T23:44:44.8958680Z    Compiling yoke v0.8.0
2025-09-08T23:44:45.0254594Z    Compiling displaydoc v0.2.5
2025-09-08T23:44:45.7569328Z    Compiling zerotrie v0.2.2
2025-09-08T23:44:45.8857626Z    Compiling zerovec v0.11.4
2025-09-08T23:44:45.9851883Z    Compiling tracing-attributes v0.1.30
2025-09-08T23:44:46.7903457Z    Compiling tinystr v0.8.1
2025-09-08T23:44:46.9384788Z    Compiling icu_locale_core v2.0.0
2025-09-08T23:44:47.4242161Z    Compiling potential_utf v0.1.3
2025-09-08T23:44:47.5115307Z    Compiling icu_collections v2.0.0
2025-09-08T23:44:47.8023324Z    Compiling tracing v0.1.41
2025-09-08T23:44:47.9615439Z    Compiling icu_provider v2.0.0
2025-09-08T23:44:48.2278167Z    Compiling icu_normalizer v2.0.0
2025-09-08T23:44:48.8486298Z    Compiling icu_properties v2.0.1
2025-09-08T23:44:50.1672918Z    Compiling idna_adapter v1.2.1
2025-09-08T23:44:50.2382426Z    Compiling idna v1.1.0
2025-09-08T23:44:50.2442454Z    Compiling curve25519-dalek v4.1.3
2025-09-08T23:44:50.4399103Z    Compiling zeroize_derive v1.4.2
2025-09-08T23:44:51.0183642Z    Compiling url v2.5.7
2025-09-08T23:44:51.1323002Z    Compiling zeroize v1.8.1
2025-09-08T23:44:51.2805061Z    Compiling parking_lot_core v0.9.11
2025-09-08T23:44:51.5019183Z    Compiling curve25519-dalek-derive v0.1.1
2025-09-08T23:44:51.9015424Z    Compiling parking_lot v0.12.4
2025-09-08T23:44:52.2422229Z    Compiling event-listener v5.4.1
2025-09-08T23:44:52.4489560Z    Compiling num_cpus v1.17.0
2025-09-08T23:44:52.7804008Z    Compiling futures-executor v0.3.31
2025-09-08T23:44:53.3027331Z    Compiling event-listener-strategy v0.5.4
2025-09-08T23:44:53.3742826Z    Compiling foldhash v0.1.5
2025-09-08T23:44:53.4814138Z    Compiling byteorder v1.5.0
2025-09-08T23:44:53.5284560Z    Compiling allocator-api2 v0.2.21
2025-09-08T23:44:53.6692443Z    Compiling futures v0.3.31
2025-09-08T23:44:53.7083546Z    Compiling sha2 v0.10.9
2025-09-08T23:44:53.8535037Z    Compiling hashbrown v0.15.5
2025-09-08T23:44:54.0592424Z    Compiling async-lock v3.4.1
2025-09-08T23:44:54.3803492Z    Compiling thiserror v2.0.16
2025-09-08T23:44:54.5637197Z    Compiling async-io v2.5.0
2025-09-08T23:44:54.6814465Z    Compiling thiserror-impl v2.0.16
2025-09-08T23:44:55.4969634Z    Compiling data-encoding v2.9.0
2025-09-08T23:44:56.2002022Z    Compiling pin-project-internal v1.1.10
2025-09-08T23:44:56.4173674Z    Compiling async-channel v2.5.0
2025-09-08T23:44:56.5643511Z    Compiling socket2 v0.5.10
2025-09-08T23:44:57.0753290Z    Compiling static_assertions v1.1.0
2025-09-08T23:44:57.1082862Z    Compiling signature v2.2.0
2025-09-08T23:44:57.1752973Z    Compiling unsigned-varint v0.8.0
2025-09-08T23:44:57.4543396Z    Compiling pin-project v1.1.10
2025-09-08T23:44:57.4904752Z    Compiling ed25519 v2.2.3
2025-09-08T23:44:57.6173437Z    Compiling quick-protobuf v0.8.1
2025-09-08T23:44:57.8553230Z    Compiling hmac v0.12.1
2025-09-08T23:44:57.8995832Z    Compiling data-encoding-macro-internal v0.1.16
2025-09-08T23:44:57.9268572Z    Compiling core2 v0.4.0
2025-09-08T23:44:58.0842609Z    Compiling multihash v0.19.3
2025-09-08T23:44:58.1730644Z    Compiling hkdf v0.12.4
2025-09-08T23:44:58.2487446Z    Compiling ed25519-dalek v2.2.0
2025-09-08T23:44:58.3736644Z    Compiling data-encoding-macro v0.1.18
2025-09-08T23:44:58.4081242Z    Compiling blocking v1.6.2
2025-09-08T23:44:58.4547889Z    Compiling bs58 v0.5.1
2025-09-08T23:44:58.6005606Z    Compiling futures-timer v3.0.3
2025-09-08T23:44:58.6381915Z    Compiling base-x v0.2.11
2025-09-08T23:44:58.7174903Z    Compiling multibase v0.9.1
2025-09-08T23:44:58.8755946Z    Compiling libp2p-identity v0.2.12
2025-09-08T23:44:58.9674604Z    Compiling async-global-executor v2.4.1
2025-09-08T23:44:59.3328643Z    Compiling heck v0.5.0
2025-09-08T23:44:59.4984459Z    Compiling arrayref v0.3.9
2025-09-08T23:44:59.5304993Z    Compiling web-time v1.1.0
2025-09-08T23:44:59.5346297Z    Compiling unsigned-varint v0.7.2
2025-09-08T23:44:59.5695701Z    Compiling multiaddr v0.18.2
2025-09-08T23:44:59.5999345Z    Compiling multistream-select v0.13.0
2025-09-08T23:44:59.9002591Z    Compiling rw-stream-sink v0.4.0
2025-09-08T23:44:59.9580186Z    Compiling signal-hook-registry v1.4.6
2025-09-08T23:45:00.2926947Z    Compiling void v1.0.2
2025-09-08T23:45:00.3143267Z    Compiling either v1.15.0
2025-09-08T23:45:00.3499657Z    Compiling async-signal v0.2.12
2025-09-08T23:45:00.4834866Z    Compiling libp2p-core v0.41.3
2025-09-08T23:45:00.4986340Z    Compiling socket2 v0.6.0
2025-09-08T23:45:01.0162424Z    Compiling mio v1.0.4
2025-09-08T23:45:01.4942567Z    Compiling tokio v1.47.1
2025-09-08T23:45:01.6494836Z    Compiling async-process v2.4.0
2025-09-08T23:45:02.4326039Z    Compiling async-std v1.13.2
2025-09-08T23:45:06.1923270Z    Compiling serde_json v1.0.143
2025-09-08T23:45:06.3333068Z    Compiling core-crypto v0.1.0 (/home/runner/work/qnet/qnet/crates/core-crypto)
2025-09-08T23:45:06.5170410Z    Compiling anyhow v1.0.99
2025-09-08T23:45:06.7790980Z    Compiling paste v1.0.15
2025-09-08T23:45:07.4626981Z    Compiling tokio-util v0.7.16
2025-09-08T23:45:07.8989357Z    Compiling openssl-sys v0.9.109
2025-09-08T23:45:08.0313568Z    Compiling libp2p-swarm-derive v0.34.2
2025-09-08T23:45:08.6909934Z    Compiling lru v0.12.5
2025-09-08T23:45:08.7755225Z    Compiling indexmap v2.11.0
2025-09-08T23:45:08.7910870Z    Compiling openssl-macros v0.1.1
2025-09-08T23:45:09.2135125Z    Compiling instant v0.1.13
2025-09-08T23:45:09.2579794Z    Compiling bitflags v1.3.2
2025-09-08T23:45:09.2921275Z    Compiling rustls v0.21.12
2025-09-08T23:45:09.2985853Z    Compiling libp2p-swarm v0.44.2
2025-09-08T23:45:09.3729484Z    Compiling h2 v0.3.27
2025-09-08T23:45:11.1129856Z    Compiling openssl v0.10.73
2025-09-08T23:45:12.8174800Z    Compiling netlink-packet-utils v0.5.2
2025-09-08T23:45:13.0007607Z    Compiling sct v0.7.1
2025-09-08T23:45:13.1111632Z    Compiling rustls-webpki v0.101.7
2025-09-08T23:45:13.9314755Z    Compiling getrandom v0.3.3
2025-09-08T23:45:14.1817688Z    Compiling hyper v0.14.32
2025-09-08T23:45:14.9905678Z    Compiling serde_cbor v0.11.2
2025-09-08T23:45:15.6181800Z    Compiling native-tls v0.2.14
2025-09-08T23:45:17.0698704Z    Compiling netlink-packet-core v0.7.0
2025-09-08T23:45:17.2094716Z    Compiling serde_bytes v0.11.17
2025-09-08T23:45:17.3628077Z    Compiling async-trait v0.1.89
2025-09-08T23:45:18.3960974Z    Compiling tinyvec_macros v0.1.1
2025-09-08T23:45:18.4264956Z    Compiling tinyvec v1.10.0
2025-09-08T23:45:18.7622591Z    Compiling tokio-rustls v0.24.1
2025-09-08T23:45:18.9136003Z    Compiling tokio-native-tls v0.3.1
2025-09-08T23:45:19.1399782Z    Compiling enum-as-inner v0.6.1
2025-09-08T23:45:19.6836129Z    Compiling netlink-sys v0.8.7
2025-09-08T23:45:19.7922546Z    Compiling io-lifetimes v1.0.11
2025-09-08T23:45:19.8475024Z    Compiling netlink-proto v0.11.5
2025-09-08T23:45:20.0243404Z    Compiling hickory-proto v0.24.4
2025-09-08T23:45:20.2349678Z    Compiling rand_core v0.9.3
2025-09-08T23:45:20.3800411Z    Compiling hyper-tls v0.5.0
2025-09-08T23:45:20.4937663Z    Compiling hyper-rustls v0.24.2
2025-09-08T23:45:20.6145128Z    Compiling netlink-packet-route v0.17.1
2025-09-08T23:45:23.4150802Z    Compiling core-cbor v0.1.0 (/home/runner/work/qnet/qnet/crates/core-cbor)
2025-09-08T23:45:23.4244229Z    Compiling nix v0.26.4
2025-09-08T23:45:23.4654944Z    Compiling core-framing v0.1.0 (/home/runner/work/qnet/qnet/crates/core-framing)
2025-09-08T23:45:23.5993055Z    Compiling serde_urlencoded v0.7.1
2025-09-08T23:45:23.7909209Z    Compiling asynchronous-codec v0.7.0
2025-09-08T23:45:23.9704239Z    Compiling polling v2.8.0
2025-09-08T23:45:24.1343318Z    Compiling linked-hash-map v0.5.6
2025-09-08T23:45:24.2482671Z    Compiling rustix v0.37.28
2025-09-08T23:45:24.5009338Z    Compiling reqwest v0.11.27
2025-09-08T23:45:24.8434231Z    Compiling rtnetlink v0.13.1
2025-09-08T23:45:25.8291165Z    Compiling lru-cache v0.1.2
2025-09-08T23:45:25.9337141Z    Compiling rand_chacha v0.9.0
2025-09-08T23:45:26.4706225Z    Compiling snow v0.9.6
2025-09-08T23:45:26.6587366Z    Compiling async-io v1.13.0
2025-09-08T23:45:26.8321196Z    Compiling aho-corasick v1.1.3
2025-09-08T23:45:29.1835787Z    Compiling prometheus-client v0.22.3
2025-09-08T23:45:29.3477433Z    Compiling fastrand v1.9.0
2025-09-08T23:45:29.5110886Z    Compiling nohash-hasher v0.2.0
2025-09-08T23:45:29.5662651Z    Compiling waker-fn v1.2.0
2025-09-08T23:45:29.6072251Z    Compiling resolv-conf v0.7.4
2025-09-08T23:45:29.8909433Z    Compiling linux-raw-sys v0.3.8
2025-09-08T23:45:29.9678876Z    Compiling regex-syntax v0.8.6
2025-09-08T23:45:32.2376950Z    Compiling regex-automata v0.4.10
2025-09-08T23:45:33.0030327Z    Compiling hickory-resolver v0.24.4
2025-09-08T23:45:34.2662833Z    Compiling futures-lite v1.13.0
2025-09-08T23:45:35.0252493Z    Compiling rand v0.9.2
2025-09-08T23:45:35.7812807Z    Compiling if-watch v3.2.1
2025-09-08T23:45:36.0084232Z    Compiling quick-protobuf-codec v0.3.1
2025-09-08T23:45:36.0943159Z    Compiling futures-bounded v0.2.4
2025-09-08T23:45:36.1589087Z    Compiling async-lock v2.8.0
2025-09-08T23:45:36.1988567Z    Compiling prometheus-client-derive-encode v0.4.2
2025-09-08T23:45:36.4262707Z    Compiling socket2 v0.4.10
2025-09-08T23:45:36.7337753Z    Compiling dtoa v1.0.10
2025-09-08T23:45:37.3051171Z    Compiling yamux v0.13.6
2025-09-08T23:45:37.9691267Z    Compiling regex v1.11.2
2025-09-08T23:45:38.1592755Z    Compiling async-std-resolver v0.24.4
2025-09-08T23:45:38.3939321Z    Compiling htx v0.1.0 (/home/runner/work/qnet/qnet/crates/htx)
2025-09-08T23:45:38.8282168Z    Compiling yamux v0.12.1
2025-09-08T23:45:39.4272804Z    Compiling futures-ticker v0.0.3
2025-09-08T23:45:39.5363817Z    Compiling x25519-dalek v2.0.1
2025-09-08T23:45:39.6047137Z    Compiling hex_fmt v0.3.0
2025-09-08T23:45:39.6630818Z    Compiling libp2p-gossipsub v0.46.1
2025-09-08T23:45:41.0058342Z    Compiling libp2p-noise v0.44.0
2025-09-08T23:45:41.5248536Z    Compiling libp2p-yamux v0.45.2
2025-09-08T23:45:41.7110611Z    Compiling libp2p-dns v0.41.1
2025-09-08T23:45:42.0009295Z    Compiling libp2p-tcp v0.41.0
2025-09-08T23:45:42.5558811Z    Compiling libp2p-identify v0.44.2
2025-09-08T23:45:43.1762411Z    Compiling libp2p-request-response v0.26.3
2025-09-08T23:45:43.4551199Z    Compiling libp2p-mdns v0.45.1
2025-09-08T23:45:43.6318603Z    Compiling libp2p-ping v0.44.1
2025-09-08T23:45:43.9344004Z    Compiling libp2p-connection-limits v0.3.1
2025-09-08T23:45:44.1422331Z    Compiling libp2p-allow-block-list v0.3.0
2025-09-08T23:45:44.2662692Z    Compiling libp2p v0.53.2
2025-09-08T23:45:44.3113742Z    Compiling core-identity v0.1.0 (/home/runner/work/qnet/qnet/crates/core-identity)
2025-09-08T23:45:44.5191818Z    Compiling alias-ledger v0.1.0 (/home/runner/work/qnet/qnet/crates/alias-ledger)
2025-09-08T23:45:44.5989428Z    Compiling core-mesh v0.1.0 (/home/runner/work/qnet/qnet/crates/core-mesh)
2025-09-08T23:45:45.0824775Z    Compiling voucher v0.1.0 (/home/runner/work/qnet/qnet/crates/voucher)
2025-09-08T23:45:45.2855560Z    Compiling core-routing v0.1.0 (/home/runner/work/qnet/qnet/crates/core-routing)
2025-09-08T23:45:45.5775155Z    Compiling core-mix v0.1.0 (/home/runner/work/qnet/qnet/crates/core-mix)
2025-09-08T23:45:45.8557742Z    Compiling mixnode v0.1.0 (/home/runner/work/qnet/qnet/crates/mixnode)
2025-09-08T23:45:46.2217783Z    Compiling core-governance v0.1.0 (/home/runner/work/qnet/qnet/crates/core-governance)
2025-09-08T23:45:47.4236292Z    Compiling echo v0.1.0 (/home/runner/work/qnet/qnet/examples/echo)
2025-09-08T23:45:49.6486594Z    Compiling qnet_c v0.1.0 (/home/runner/work/qnet/qnet/crates/c-lib)
2025-09-08T23:45:55.8288356Z     Finished `test` profile [unoptimized + debuginfo] target(s) in 1m 24s
2025-09-08T23:45:55.8548034Z      Running unittests src/lib.rs (target/debug/deps/alias_ledger-78ea355e6d71b46d)
2025-09-08T23:45:55.8560580Z 
2025-09-08T23:45:55.8560892Z running 3 tests
2025-09-08T23:45:55.8564918Z test tests::emergency_path_advances ... ok
2025-09-08T23:45:55.8566143Z test tests::conflict_requires_resolution ... ok
2025-09-08T23:45:55.8567447Z test tests::quorum_commit ... ok
2025-09-08T23:45:55.8567720Z 
2025-09-08T23:45:55.8568155Z test result: ok. 3 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:45:55.8569698Z 
2025-09-08T23:45:55.8572033Z      Running unittests src/lib.rs (target/debug/deps/core_cbor-1a0b920f8a29fd8d)
2025-09-08T23:45:55.8581179Z 
2025-09-08T23:45:55.8582365Z running 2 tests
2025-09-08T23:45:55.8585066Z test tests::det_cbor_map_order_and_template_id_stability ... ok
2025-09-08T23:45:55.8585972Z test tests::template_id_changes_on_param_change ... ok
2025-09-08T23:45:55.8587113Z 
2025-09-08T23:45:55.8588174Z      Running unittests src/lib.rs (target/debug/deps/core_crypto-15236871041d81b0)
2025-09-08T23:45:55.8589117Z test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:45:55.8589907Z 
2025-09-08T23:45:55.8597675Z 
2025-09-08T23:45:55.8598390Z running 4 tests
2025-09-08T23:45:55.8620167Z test tests::ed25519_sign_verify ... ok
2025-09-08T23:45:55.8637013Z test tests::hkdf_extract_expand ... ok
2025-09-08T23:45:55.8637936Z test tests::x25519_key_agreement ... ok
2025-09-08T23:45:55.8729939Z test tests::aead_roundtrip_and_negative ... ok
2025-09-08T23:45:55.8730561Z 
2025-09-08T23:45:55.8734896Z test result: ok. 4 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.01s
2025-09-08T23:45:55.8736014Z      Running unittests src/lib.rs (target/debug/deps/core_framing-7d6ea56bdc8536fa)
2025-09-08T23:45:55.8736533Z 
2025-09-08T23:45:55.8746357Z 
2025-09-08T23:45:55.8746697Z running 3 tests
2025-09-08T23:45:55.8752252Z test tests::len_u24_roundtrip_and_bounds ... ok
2025-09-08T23:45:55.8756264Z test tests::plain_encode_decode ... ok
2025-09-08T23:45:55.8916938Z test tests::aead_protected_encode_decode_and_negative ... ok
2025-09-08T23:45:55.8917568Z 
2025-09-08T23:45:55.8918153Z test result: ok. 3 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.02s
2025-09-08T23:45:55.8919403Z 
2025-09-08T23:45:55.8921079Z      Running unittests src/lib.rs (target/debug/deps/core_governance-212636e4db4c97ce)
2025-09-08T23:45:55.8931064Z 
2025-09-08T23:45:55.8931549Z running 1 test
2025-09-08T23:45:55.8933114Z test tests::caps_bound_scores ... ok
2025-09-08T23:45:55.8933435Z 
2025-09-08T23:45:55.8936224Z      Running unittests src/lib.rs (target/debug/deps/core_identity-50fdb3d0dfc779e4)
2025-09-08T23:45:55.8937178Z test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:45:55.8937921Z 
2025-09-08T23:45:55.8946262Z 
2025-09-08T23:45:55.8946969Z running 1 test
2025-09-08T23:45:55.8948915Z test tests::roundtrip_encodings ... ok
2025-09-08T23:45:55.8949255Z 
2025-09-08T23:45:55.8952489Z      Running unittests src/lib.rs (target/debug/deps/core_mesh-274c54e4fc1369e4)
2025-09-08T23:45:55.8953398Z test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:45:55.8954368Z 
2025-09-08T23:45:55.8962278Z 
2025-09-08T23:45:55.8962976Z running 1 test
2025-09-08T23:45:55.8964618Z test tests::compiles ... ok
2025-09-08T23:45:55.8964895Z 
2025-09-08T23:45:55.8967029Z test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:45:55.8967556Z 
2025-09-08T23:45:55.8968250Z      Running unittests src/lib.rs (target/debug/deps/core_mix-e6fb08bb474fa2d0)
2025-09-08T23:45:55.8978364Z 
2025-09-08T23:45:55.8978900Z running 2 tests
2025-09-08T23:45:55.8981065Z test tests::deterministic_selection ... ok
2025-09-08T23:45:55.8984090Z test tests::diversity_tracking ... ok
2025-09-08T23:45:55.8984385Z 
2025-09-08T23:45:55.8984809Z test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:45:55.8985325Z 
2025-09-08T23:45:55.8987136Z      Running unittests src/lib.rs (target/debug/deps/core_routing-eea39a844c274157)
2025-09-08T23:45:55.8995767Z 
2025-09-08T23:45:55.8996467Z running 1 test
2025-09-08T23:45:55.9010980Z test tests::segment_sign_verify_and_bounds ... ok
2025-09-08T23:45:55.9011993Z 
2025-09-08T23:45:55.9012508Z test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:45:55.9013806Z 
2025-09-08T23:45:55.9018218Z      Running unittests src/main.rs (target/debug/deps/echo-f3faaab3b92cf098)
2025-09-08T23:45:55.9027155Z 
2025-09-08T23:45:55.9027839Z running 0 tests
2025-09-08T23:45:55.9028239Z 
2025-09-08T23:45:55.9028793Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:45:55.9029427Z 
2025-09-08T23:45:55.9030668Z      Running unittests src/lib.rs (target/debug/deps/htx-a5ce46c01d2571a0)
2025-09-08T23:45:55.9050495Z 
2025-09-08T23:45:55.9051208Z running 14 tests
2025-09-08T23:45:55.9126086Z test api::tests::api_echo_e2e ... ok
2025-09-08T23:45:55.9130821Z test api::tests::api_echo_e2e_compat ... ok
2025-09-08T23:45:55.9200455Z test inner::tests::bound_keys_match_and_work ... ok
2025-09-08T23:45:55.9204484Z test inner::tests::compat_flag_changes_binding_context ... ok
2025-09-08T23:45:55.9217180Z test mux::tests::control_rekey_close_blocks_data_until_keyupdate ... ok
2025-09-08T23:45:55.9222953Z test mux::tests::key_update_accepts_up_to_3_old_then_rejects ... ok
2025-09-08T23:45:55.9250784Z test inner::tests::mismatch_context_breaks_decryption ... ok
2025-09-08T23:45:55.9435307Z test mux::tests::many_concurrent_streams_echo ... ok
2025-09-08T23:45:55.9479378Z test tests::noise_xk_roundtrip_and_tamper ... ok
2025-09-08T23:45:55.9481096Z test tl::tests::identity_mapping_keeps_payload ... ok
2025-09-08T23:45:55.9482969Z test tl::tests::policy_triggers_on_limits ... ok
2025-09-08T23:45:56.1782418Z test tls_mirror::tests::template_id_stable_and_cache_works ... ok
2025-09-08T23:45:56.1794480Z test transition::tests::control_sign_verify_and_replay ... ok
2025-09-08T23:46:00.9236153Z test mux::tests::key_update_rotation_continues_flow ... ok
2025-09-08T23:46:00.9239555Z 
2025-09-08T23:46:00.9244842Z test result: ok. 14 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 5.02s
2025-09-08T23:46:00.9246482Z 
2025-09-08T23:46:00.9251643Z      Running unittests src/lib.rs (target/debug/deps/mixnode-34e2cae73c197bb2)
2025-09-08T23:46:00.9262963Z 
2025-09-08T23:46:00.9263327Z running 2 tests
2025-09-08T23:46:00.9266578Z test tests::transforms_body ... ok
2025-09-08T23:46:00.9268013Z test tests::rate_limits ... ok
2025-09-08T23:46:00.9268280Z 
2025-09-08T23:46:00.9268848Z test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:00.9269369Z 
2025-09-08T23:46:00.9270449Z      Running unittests src/lib.rs (target/debug/deps/qnet_c-de64215664257954)
2025-09-08T23:46:00.9285923Z 
2025-09-08T23:46:00.9287513Z running 0 tests
2025-09-08T23:46:00.9288435Z 
2025-09-08T23:46:00.9290357Z      Running unittests src/lib.rs (target/debug/deps/voucher-1b18d3d8c7935c2f)
2025-09-08T23:46:00.9291245Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:00.9292461Z 
2025-09-08T23:46:00.9299520Z 
2025-09-08T23:46:00.9301611Z running 3 tests
2025-09-08T23:46:00.9303748Z test tests::invalid_len ... ok
2025-09-08T23:46:00.9305315Z test tests::aggregate_placeholder_increments ... ok
2025-09-08T23:46:00.9305823Z test tests::round_trip ... ok
2025-09-08T23:46:00.9306069Z 
2025-09-08T23:46:00.9306949Z test result: ok. 3 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:00.9307438Z 
2025-09-08T23:46:00.9308148Z    Doc-tests alias_ledger
2025-09-08T23:46:03.2128206Z 
2025-09-08T23:46:03.2129043Z running 0 tests
2025-09-08T23:46:03.2129454Z 
2025-09-08T23:46:03.2184993Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:03.2186669Z 
2025-09-08T23:46:03.2220182Z    Doc-tests core_cbor
2025-09-08T23:46:03.2809006Z 
2025-09-08T23:46:03.2810194Z running 0 tests
2025-09-08T23:46:03.2810759Z 
2025-09-08T23:46:03.2811658Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:03.2812435Z 
2025-09-08T23:46:03.2840572Z    Doc-tests core_crypto
2025-09-08T23:46:03.3043111Z 
2025-09-08T23:46:03.3043869Z running 0 tests
2025-09-08T23:46:03.3044491Z 
2025-09-08T23:46:03.3045167Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:03.3045956Z 
2025-09-08T23:46:03.3073358Z    Doc-tests core_framing
2025-09-08T23:46:03.3416006Z 
2025-09-08T23:46:03.3416752Z running 0 tests
2025-09-08T23:46:03.3417475Z 
2025-09-08T23:46:03.3418268Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:03.3419500Z 
2025-09-08T23:46:03.3447619Z    Doc-tests core_governance
2025-09-08T23:46:03.3724904Z 
2025-09-08T23:46:03.3725678Z running 0 tests
2025-09-08T23:46:03.3726176Z 
2025-09-08T23:46:03.3726803Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:03.3731245Z 
2025-09-08T23:46:03.3757280Z    Doc-tests core_identity
2025-09-08T23:46:03.3976974Z 
2025-09-08T23:46:03.3977700Z running 0 tests
2025-09-08T23:46:03.3978828Z 
2025-09-08T23:46:03.3979421Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:03.3980584Z 
2025-09-08T23:46:03.4009248Z    Doc-tests core_mesh
2025-09-08T23:46:03.4613354Z 
2025-09-08T23:46:03.4614170Z running 0 tests
2025-09-08T23:46:03.4614684Z 
2025-09-08T23:46:03.4615322Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:03.4617387Z 
2025-09-08T23:46:03.4652982Z    Doc-tests core_mix
2025-09-08T23:46:03.4898795Z 
2025-09-08T23:46:03.4899581Z running 0 tests
2025-09-08T23:46:03.4900043Z 
2025-09-08T23:46:03.4900490Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:03.4901010Z 
2025-09-08T23:46:03.4933099Z    Doc-tests core_routing
2025-09-08T23:46:03.5246253Z 
2025-09-08T23:46:03.5247127Z running 0 tests
2025-09-08T23:46:03.5247694Z 
2025-09-08T23:46:03.5248416Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:03.5249439Z 
2025-09-08T23:46:03.5278794Z    Doc-tests htx
2025-09-08T23:46:03.5904702Z 
2025-09-08T23:46:03.5905456Z running 0 tests
2025-09-08T23:46:03.5905968Z 
2025-09-08T23:46:03.5906953Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:03.5907606Z 
2025-09-08T23:46:03.5941821Z    Doc-tests mixnode
2025-09-08T23:46:03.6181496Z 
2025-09-08T23:46:03.6182255Z running 0 tests
2025-09-08T23:46:03.6182859Z 
2025-09-08T23:46:03.6183604Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:03.6184389Z 
2025-09-08T23:46:03.6212778Z    Doc-tests voucher
2025-09-08T23:46:03.6443217Z 
2025-09-08T23:46:03.6443802Z running 0 tests
2025-09-08T23:46:03.6444392Z 
2025-09-08T23:46:03.6445067Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:03.6445885Z 
2025-09-08T23:46:03.8099279Z    Compiling htx v0.1.0 (/home/runner/work/qnet/qnet/crates/htx)
2025-09-08T23:46:06.5089268Z     Finished `test` profile [unoptimized + debuginfo] target(s) in 2.81s
2025-09-08T23:46:06.5180375Z      Running unittests src/lib.rs (target/debug/deps/htx-37c9d0bb74130644)
2025-09-08T23:46:06.5203425Z 
2025-09-08T23:46:06.5203793Z running 14 tests
2025-09-08T23:46:06.5280213Z test api::tests::api_echo_e2e ... ok
2025-09-08T23:46:06.5283183Z test api::tests::api_echo_e2e_compat ... ok
2025-09-08T23:46:06.5352046Z test inner::tests::compat_flag_changes_binding_context ... ok
2025-09-08T23:46:06.5355278Z test inner::tests::bound_keys_match_and_work ... ok
2025-09-08T23:46:06.5366101Z test mux::tests::control_rekey_close_blocks_data_until_keyupdate ... ok
2025-09-08T23:46:06.5375419Z test mux::tests::key_update_accepts_up_to_3_old_then_rejects ... ok
2025-09-08T23:46:06.5404507Z test inner::tests::mismatch_context_breaks_decryption ... ok
2025-09-08T23:46:06.5592910Z test mux::tests::many_concurrent_streams_echo ... ok
2025-09-08T23:46:06.5631242Z test tests::noise_xk_roundtrip_and_tamper ... ok
2025-09-08T23:46:06.5634531Z test tl::tests::identity_mapping_keeps_payload ... ok
2025-09-08T23:46:06.5638633Z test tl::tests::policy_triggers_on_limits ... ok
2025-09-08T23:46:06.7684033Z test tls_mirror::tests::template_id_stable_and_cache_works ... ok
2025-09-08T23:46:06.7694235Z test transition::tests::control_sign_verify_and_replay ... ok
2025-09-08T23:46:11.5388020Z test mux::tests::key_update_rotation_continues_flow ... ok
2025-09-08T23:46:11.5392431Z 
2025-09-08T23:46:11.5393027Z test result: ok. 14 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 5.02s
2025-09-08T23:46:11.5393546Z 
2025-09-08T23:46:11.5402487Z    Doc-tests htx
2025-09-08T23:46:11.6011531Z 
2025-09-08T23:46:11.6012299Z running 0 tests
2025-09-08T23:46:11.6012786Z 
2025-09-08T23:46:11.6013783Z test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
2025-09-08T23:46:11.6014861Z 
2025-09-08T23:46:11.6132926Z ##[group]Run cargo clippy --workspace --all-targets --all-features -- -D warnings
2025-09-08T23:46:11.6133899Z [36;1mcargo clippy --workspace --all-targets --all-features -- -D warnings[0m
2025-09-08T23:46:11.6134599Z [36;1mcargo fmt --all -- --check[0m
2025-09-08T23:46:11.6178294Z shell: /usr/bin/bash -e {0}
2025-09-08T23:46:11.6178657Z ##[endgroup]
2025-09-08T23:46:12.3830591Z     Checking libc v0.2.175
2025-09-08T23:46:12.3831501Z     Checking cfg-if v1.0.3
2025-09-08T23:46:12.4192376Z     Checking pin-project-lite v0.2.16
2025-09-08T23:46:12.4937486Z     Checking futures-core v0.3.31
2025-09-08T23:46:12.5639995Z     Checking memchr v2.7.5
2025-09-08T23:46:12.9075150Z     Checking futures-io v0.3.31
2025-09-08T23:46:12.9712373Z     Checking slab v0.4.11
2025-09-08T23:46:13.0749694Z     Checking serde v1.0.219
2025-09-08T23:46:13.7574434Z     Checking getrandom v0.2.16
2025-09-08T23:46:13.8512556Z     Checking futures-sink v0.3.31
2025-09-08T23:46:13.8978822Z     Checking pin-utils v0.1.0
2025-09-08T23:46:13.9276766Z     Checking futures-channel v0.3.31
2025-09-08T23:46:14.0617878Z     Checking futures-task v0.3.31
2025-09-08T23:46:14.1433749Z     Checking futures-util v0.3.31
2025-09-08T23:46:15.1837935Z     Checking thiserror v1.0.69
2025-09-08T23:46:15.2231163Z     Checking bytes v1.10.1
2025-09-08T23:46:15.6315759Z     Checking value-bag v1.11.1
2025-09-08T23:46:15.7913690Z     Checking log v0.4.28
2025-09-08T23:46:15.9594935Z     Checking once_cell v1.21.3
2025-09-08T23:46:16.0721940Z     Checking smallvec v1.15.1
2025-09-08T23:46:16.1962667Z     Checking zerofrom v0.1.6
2025-09-08T23:46:16.2615162Z     Checking zerocopy v0.8.27
2025-09-08T23:46:16.3683230Z     Checking stable_deref_trait v1.2.0
2025-09-08T23:46:16.4008543Z     Checking yoke v0.8.0
2025-09-08T23:46:16.5140308Z     Checking typenum v1.18.0
2025-09-08T23:46:16.9807310Z     Checking rand_core v0.6.4
2025-09-08T23:46:17.0847450Z     Checking zerovec v0.11.4
2025-09-08T23:46:17.6816490Z     Checking ppv-lite86 v0.2.21
2025-09-08T23:46:17.8584747Z     Checking generic-array v0.14.7
2025-09-08T23:46:17.9734754Z     Checking subtle v2.6.1
2025-09-08T23:46:18.0646238Z     Checking bitflags v2.9.4
2025-09-08T23:46:18.1645461Z     Checking rand_chacha v0.3.1
2025-09-08T23:46:18.3096855Z     Checking rand v0.8.5
2025-09-08T23:46:18.3574249Z     Checking crypto-common v0.1.6
2025-09-08T23:46:18.4112959Z     Checking block-buffer v0.10.4
2025-09-08T23:46:18.4762976Z     Checking digest v0.10.7
2025-09-08T23:46:18.6114075Z     Checking tinystr v0.8.1
2025-09-08T23:46:18.7362558Z     Checking litemap v0.8.0
2025-09-08T23:46:18.8334671Z     Checking writeable v0.6.1
2025-09-08T23:46:18.8817405Z     Checking zerotrie v0.2.2
2025-09-08T23:46:18.9561795Z     Checking icu_locale_core v2.0.0
2025-09-08T23:46:19.0698054Z     Checking potential_utf v0.1.3
2025-09-08T23:46:19.1313085Z     Checking tracing-core v0.1.34
2025-09-08T23:46:19.3854961Z     Checking icu_provider v2.0.0
2025-09-08T23:46:19.3908888Z     Checking tracing v0.1.41
2025-09-08T23:46:19.5053163Z     Checking icu_collections v2.0.0
2025-09-08T23:46:19.5606439Z     Checking cpufeatures v0.2.17
2025-09-08T23:46:19.5903684Z     Checking icu_properties_data v2.0.1
2025-09-08T23:46:19.6777770Z     Checking icu_normalizer_data v2.0.0
2025-09-08T23:46:19.7142417Z     Checking crossbeam-utils v0.8.21
2025-09-08T23:46:19.7320571Z     Checking icu_normalizer v2.0.0
2025-09-08T23:46:19.9833532Z     Checking icu_properties v2.0.1
2025-09-08T23:46:20.0084665Z     Checking parking v2.2.1
2025-09-08T23:46:20.0633963Z     Checking percent-encoding v2.3.2
2025-09-08T23:46:20.1403258Z     Checking fnv v1.0.7
2025-09-08T23:46:20.1784039Z     Checking form_urlencoded v1.2.2
2025-09-08T23:46:20.2459200Z     Checking concurrent-queue v2.5.0
2025-09-08T23:46:20.3654791Z     Checking utf8_iter v1.0.4
2025-09-08T23:46:20.4355025Z     Checking zeroize v1.8.1
2025-09-08T23:46:20.5218827Z     Checking curve25519-dalek v4.1.3
2025-09-08T23:46:20.8657028Z     Checking idna_adapter v1.2.1
2025-09-08T23:46:20.9242943Z     Checking idna v1.1.0
2025-09-08T23:46:21.1148948Z     Checking url v2.5.7
2025-09-08T23:46:21.2840483Z     Checking untrusted v0.9.0
2025-09-08T23:46:21.3365701Z     Checking ring v0.17.14
2025-09-08T23:46:21.5017738Z     Checking event-listener v5.4.1
2025-09-08T23:46:21.6501181Z     Checking num_cpus v1.17.0
2025-09-08T23:46:21.7434215Z     Checking equivalent v1.0.2
2025-09-08T23:46:21.7754641Z     Checking allocator-api2 v0.2.21
2025-09-08T23:46:22.0298575Z     Checking foldhash v0.1.5
2025-09-08T23:46:22.1060446Z     Checking fastrand v2.3.0
2025-09-08T23:46:22.2239374Z     Checking scopeguard v1.2.0
2025-09-08T23:46:22.2650209Z     Checking lock_api v0.4.13
2025-09-08T23:46:22.3784647Z     Checking hashbrown v0.15.5
2025-09-08T23:46:22.4052812Z     Checking futures-executor v0.3.31
2025-09-08T23:46:22.5060863Z     Checking event-listener-strategy v0.5.4
2025-09-08T23:46:22.5750189Z     Checking parking_lot_core v0.9.11
2025-09-08T23:46:22.7018780Z     Checking byteorder v1.5.0
2025-09-08T23:46:22.8288369Z     Checking parking_lot v0.12.4
2025-09-08T23:46:22.8642216Z     Checking futures v0.3.31
2025-09-08T23:46:22.8984037Z     Checking futures-lite v2.6.1
2025-09-08T23:46:22.9649693Z     Checking linux-raw-sys v0.9.4
2025-09-08T23:46:23.4953232Z     Checking itoa v1.0.15
2025-09-08T23:46:23.5706678Z     Checking async-lock v3.4.1
2025-09-08T23:46:23.9648466Z     Checking sha2 v0.10.9
2025-09-08T23:46:24.0522218Z     Checking rustix v1.0.8
2025-09-08T23:46:24.1709839Z     Checking data-encoding v2.9.0
2025-09-08T23:46:24.3945022Z     Checking thiserror v2.0.16
2025-09-08T23:46:24.4349659Z     Checking socket2 v0.5.10
2025-09-08T23:46:24.6522333Z     Checking async-task v4.7.1
2025-09-08T23:46:24.7734093Z     Checking pin-project v1.1.10
2025-09-08T23:46:24.8074227Z     Checking async-channel v2.5.0
2025-09-08T23:46:24.9290843Z     Checking atomic-waker v1.1.2
2025-09-08T23:46:24.9707066Z     Checking signature v2.2.0
2025-09-08T23:46:25.0279230Z     Checking static_assertions v1.1.0
2025-09-08T23:46:25.0570616Z     Checking unsigned-varint v0.8.0
2025-09-08T23:46:25.1426753Z     Checking ed25519 v2.2.3
2025-09-08T23:46:25.2105551Z     Checking piper v0.2.4
2025-09-08T23:46:25.2820902Z     Checking quick-protobuf v0.8.1
2025-09-08T23:46:25.4131942Z     Checking hmac v0.12.1
2025-09-08T23:46:25.4813498Z     Checking core2 v0.4.0
2025-09-08T23:46:25.5942439Z     Checking ipnet v2.11.0
2025-09-08T23:46:25.7715366Z     Checking multihash v0.19.3
2025-09-08T23:46:25.8424347Z     Checking hkdf v0.12.4
2025-09-08T23:46:25.9109770Z     Checking data-encoding-macro v0.1.18
2025-09-08T23:46:25.9427407Z     Checking blocking v1.6.2
2025-09-08T23:46:26.0560100Z     Checking ed25519-dalek v2.2.0
2025-09-08T23:46:26.1706708Z     Checking async-executor v1.13.3
2025-09-08T23:46:26.3015216Z     Checking bs58 v0.5.1
2025-09-08T23:46:26.4030824Z     Checking futures-timer v3.0.3
2025-09-08T23:46:26.5114459Z     Checking event-listener v2.5.3
2025-09-08T23:46:26.5758860Z     Checking base-x v0.2.11
2025-09-08T23:46:26.6394334Z     Checking multibase v0.9.1
2025-09-08T23:46:26.7462028Z     Checking libp2p-identity v0.2.12
2025-09-08T23:46:26.8432037Z     Checking polling v3.10.0
2025-09-08T23:46:26.9073054Z     Checking socket2 v0.6.0
2025-09-08T23:46:26.9467027Z     Checking async-io v2.5.0
2025-09-08T23:46:27.1438904Z     Checking mio v1.0.4
2025-09-08T23:46:27.2090192Z     Checking async-global-executor v2.4.1
2025-09-08T23:46:27.3054471Z     Checking unsigned-varint v0.7.2
2025-09-08T23:46:27.3661018Z     Checking arrayref v0.3.9
2025-09-08T23:46:27.3828978Z     Checking web-time v1.1.0
2025-09-08T23:46:27.3956055Z     Checking multiaddr v0.18.2
2025-09-08T23:46:27.4145510Z     Checking tokio v1.47.1
2025-09-08T23:46:27.6472657Z     Checking multistream-select v0.13.0
2025-09-08T23:46:27.8486552Z     Checking rw-stream-sink v0.4.0
2025-09-08T23:46:27.9028770Z     Checking signal-hook-registry v1.4.6
2025-09-08T23:46:27.9973193Z     Checking either v1.15.0
2025-09-08T23:46:28.1285360Z     Checking void v1.0.2
2025-09-08T23:46:28.1766802Z     Checking libp2p-core v0.41.3
2025-09-08T23:46:28.7693135Z     Checking async-signal v0.2.12
2025-09-08T23:46:28.8582450Z     Checking base64 v0.21.7
2025-09-08T23:46:29.0451649Z     Checking ryu v1.0.20
2025-09-08T23:46:29.1330118Z     Checking async-process v2.4.0
2025-09-08T23:46:29.3019257Z     Checking async-channel v1.9.0
2025-09-08T23:46:29.3853158Z     Checking http v0.2.12
2025-09-08T23:46:29.9315809Z     Checking kv-log-macro v1.0.7
2025-09-08T23:46:29.9657029Z     Checking foreign-types-shared v0.1.1
2025-09-08T23:46:29.9944575Z     Checking foreign-types v0.3.2
2025-09-08T23:46:30.0213415Z     Checking async-std v1.13.2
2025-09-08T23:46:30.2008017Z     Checking tokio-util v0.7.16
2025-09-08T23:46:30.5545694Z     Checking serde_json v1.0.143
2025-09-08T23:46:31.2121688Z     Checking openssl-sys v0.9.109
2025-09-08T23:46:31.6836369Z     Checking indexmap v2.11.0
2025-09-08T23:46:31.9608336Z     Checking openssl-probe v0.1.6
2025-09-08T23:46:32.0092009Z     Checking try-lock v0.2.5
2025-09-08T23:46:32.0509382Z     Checking want v0.3.1
2025-09-08T23:46:32.1114439Z     Checking openssl v0.10.73
2025-09-08T23:46:32.2297879Z     Checking h2 v0.3.27
2025-09-08T23:46:34.2097239Z     Checking httparse v1.10.1
2025-09-08T23:46:34.3765128Z     Checking http-body v0.4.6
2025-09-08T23:46:34.5177146Z     Checking sct v0.7.1
2025-09-08T23:46:34.5809812Z     Checking core-crypto v0.1.0 (/home/runner/work/qnet/qnet/crates/core-crypto)
2025-09-08T23:46:34.6228430Z     Checking rustls-webpki v0.101.7
2025-09-08T23:46:34.8175020Z     Checking httpdate v1.0.3
2025-09-08T23:46:34.8770927Z     Checking tower-service v0.3.3
2025-09-08T23:46:34.9037735Z     Checking hyper v0.14.32
2025-09-08T23:46:35.7952411Z     Checking rustls v0.21.12
2025-09-08T23:46:36.0234912Z     Checking native-tls v0.2.14
2025-09-08T23:46:36.1324611Z     Checking anyhow v1.0.99
2025-09-08T23:46:36.2820173Z     Checking lru v0.12.5
2025-09-08T23:46:36.3829660Z     Checking instant v0.1.13
2025-09-08T23:46:36.4165105Z     Checking bitflags v1.3.2
2025-09-08T23:46:36.4490655Z     Checking half v1.8.3
2025-09-08T23:46:36.6062236Z     Checking serde_cbor v0.11.2
2025-09-08T23:46:36.9672579Z     Checking libp2p-swarm v0.44.2
2025-09-08T23:46:37.1685479Z     Checking tokio-rustls v0.24.1
2025-09-08T23:46:37.2973185Z     Checking netlink-packet-utils v0.5.2
2025-09-08T23:46:37.3968531Z     Checking tokio-native-tls v0.3.1
2025-09-08T23:46:37.4804375Z     Checking rustls-pemfile v1.0.4
2025-09-08T23:46:37.5467949Z     Checking serde_bytes v0.11.17
2025-09-08T23:46:37.6616449Z     Checking hyper-tls v0.5.0
2025-09-08T23:46:37.7562965Z     Checking netlink-packet-core v0.7.0
2025-09-08T23:46:37.7954871Z     Checking hyper-rustls v0.24.2
2025-09-08T23:46:37.8636031Z     Checking serde_urlencoded v0.7.1
2025-09-08T23:46:37.8933552Z     Checking encoding_rs v0.8.35
2025-09-08T23:46:38.0106503Z     Checking webpki-roots v0.25.4
2025-09-08T23:46:38.0612310Z     Checking tinyvec_macros v0.1.1
2025-09-08T23:46:38.0885954Z     Checking mime v0.3.17
2025-09-08T23:46:38.2077028Z     Checking sync_wrapper v0.1.2
2025-09-08T23:46:38.2426110Z     Checking tinyvec v1.10.0
2025-09-08T23:46:38.6358114Z     Checking getrandom v0.3.3
2025-09-08T23:46:38.7555519Z     Checking rustls-native-certs v0.6.3
2025-09-08T23:46:38.7975734Z     Checking core-cbor v0.1.0 (/home/runner/work/qnet/qnet/crates/core-cbor)
2025-09-08T23:46:38.8415092Z     Checking reqwest v0.11.27
2025-09-08T23:46:38.8493676Z     Checking core-framing v0.1.0 (/home/runner/work/qnet/qnet/crates/core-framing)
2025-09-08T23:46:38.9699884Z     Checking netlink-sys v0.8.7
2025-09-08T23:46:39.0865812Z     Checking md5 v0.7.0
2025-09-08T23:46:39.1825776Z     Checking netlink-proto v0.11.5
2025-09-08T23:46:39.3354342Z     Checking hickory-proto v0.24.4
2025-09-08T23:46:39.5035705Z     Checking rand_core v0.9.3
2025-09-08T23:46:39.6094708Z     Checking netlink-packet-route v0.17.1
2025-09-08T23:46:40.8603741Z     Checking nix v0.26.4
2025-09-08T23:46:41.2144628Z     Checking asynchronous-codec v0.7.0
2025-09-08T23:46:41.3430480Z     Checking linked-hash-map v0.5.6
2025-09-08T23:46:41.4508863Z     Checking lru-cache v0.1.2
2025-09-08T23:46:41.5083739Z     Checking rand_chacha v0.9.0
2025-09-08T23:46:41.6409969Z     Checking htx v0.1.0 (/home/runner/work/qnet/qnet/crates/htx)
2025-09-08T23:46:41.6478229Z     Checking rtnetlink v0.13.1
2025-09-08T23:46:41.9483056Z     Checking io-lifetimes v1.0.11
2025-09-08T23:46:42.0170925Z     Checking aho-corasick v1.1.3
2025-09-08T23:46:42.4931737Z     Checking nohash-hasher v0.2.0
2025-09-08T23:46:42.5284117Z     Checking linux-raw-sys v0.3.8
2025-09-08T23:46:42.7711038Z     Checking fastrand v1.9.0
2025-09-08T23:46:42.8860623Z     Checking resolv-conf v0.7.4
2025-09-08T23:46:43.0036818Z     Checking waker-fn v1.2.0
2025-09-08T23:46:43.0184976Z     Checking regex-syntax v0.8.6
2025-09-08T23:46:43.0407803Z     Checking hex v0.4.3
2025-09-08T23:46:43.2137946Z     Checking futures-lite v1.13.0
2025-09-08T23:46:43.7674403Z     Checking rustix v0.37.28
2025-09-08T23:46:44.4158008Z     Checking regex-automata v0.4.10
2025-09-08T23:46:45.1509658Z     Checking hickory-resolver v0.24.4
2025-09-08T23:46:45.7557689Z     Checking if-watch v3.2.1
2025-09-08T23:46:45.8534155Z     Checking rand v0.9.2
2025-09-08T23:46:45.9463598Z     Checking polling v2.8.0
2025-09-08T23:46:46.0455450Z     Checking quick-protobuf-codec v0.3.1
2025-09-08T23:46:46.1132311Z     Checking async-lock v2.8.0
2025-09-08T23:46:46.2831799Z     Checking futures-bounded v0.2.4
2025-09-08T23:46:46.3063920Z     Checking socket2 v0.4.10
2025-09-08T23:46:46.3750316Z     Checking dtoa v1.0.10
2025-09-08T23:46:46.4519937Z     Checking prometheus-client v0.22.3
2025-09-08T23:46:46.4936084Z     Checking async-io v1.13.0
2025-09-08T23:46:46.6768725Z     Checking yamux v0.13.6
2025-09-08T23:46:46.7508750Z     Checking regex v1.11.2
2025-09-08T23:46:46.9753443Z     Checking snow v0.9.6
2025-09-08T23:46:46.9836378Z     Checking async-std-resolver v0.24.4
2025-09-08T23:46:47.1155005Z     Checking yamux v0.12.1
2025-09-08T23:46:47.2400542Z     Checking futures-ticker v0.0.3
2025-09-08T23:46:47.2914913Z     Checking x25519-dalek v2.0.1
2025-09-08T23:46:47.3500809Z     Checking base32 v0.4.0
2025-09-08T23:46:47.3999570Z     Checking hex_fmt v0.3.0
2025-09-08T23:46:47.4041993Z     Checking libp2p-yamux v0.45.2
2025-09-08T23:46:47.4540559Z     Checking libp2p-gossipsub v0.46.1
2025-09-08T23:46:47.5328070Z     Checking libp2p-noise v0.44.0
2025-09-08T23:46:47.7853232Z     Checking libp2p-dns v0.41.1
2025-09-08T23:46:48.0353202Z     Checking libp2p-tcp v0.41.0
2025-09-08T23:46:48.2392353Z     Checking libp2p-request-response v0.26.3
2025-09-08T23:46:48.4716344Z     Checking libp2p-identify v0.44.2
2025-09-08T23:46:48.7463690Z     Checking libp2p-mdns v0.45.1
2025-09-08T23:46:48.8092950Z     Checking libp2p-allow-block-list v0.3.0
2025-09-08T23:46:48.8946263Z     Checking libp2p-ping v0.44.1
2025-09-08T23:46:49.0283667Z     Checking libp2p-connection-limits v0.3.1
2025-09-08T23:46:49.0592474Z     Checking core-identity v0.1.0 (/home/runner/work/qnet/qnet/crates/core-identity)
2025-09-08T23:46:49.1196980Z     Checking libp2p v0.53.2
2025-09-08T23:46:49.2390334Z     Checking alias-ledger v0.1.0 (/home/runner/work/qnet/qnet/crates/alias-ledger)
2025-09-08T23:46:49.3530162Z     Checking core-mesh v0.1.0 (/home/runner/work/qnet/qnet/crates/core-mesh)
2025-09-08T23:46:49.8552277Z     Checking voucher v0.1.0 (/home/runner/work/qnet/qnet/crates/voucher)
2025-09-08T23:46:50.0529038Z     Checking echo v0.1.0 (/home/runner/work/qnet/qnet/examples/echo)
2025-09-08T23:46:50.0933162Z     Checking qnet_c v0.1.0 (/home/runner/work/qnet/qnet/crates/c-lib)
2025-09-08T23:46:50.2527330Z     Checking core-routing v0.1.0 (/home/runner/work/qnet/qnet/crates/core-routing)
2025-09-08T23:46:50.8805745Z     Checking core-mix v0.1.0 (/home/runner/work/qnet/qnet/crates/core-mix)
2025-09-08T23:46:50.9882402Z     Checking mixnode v0.1.0 (/home/runner/work/qnet/qnet/crates/mixnode)
2025-09-08T23:46:51.2300319Z     Checking core-governance v0.1.0 (/home/runner/work/qnet/qnet/crates/core-governance)
2025-09-08T23:46:51.4190559Z     Finished `dev` profile [unoptimized + debuginfo] target(s) in 39.58s
2025-09-08T23:46:52.0445122Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:1:
2025-09-08T23:46:52.0445833Z  use parking_lot::Mutex;
2025-09-08T23:46:52.0446194Z -use serde::{Serialize, Deserialize};
2025-09-08T23:46:52.0446711Z -use std::collections::{HashMap, BTreeSet};
2025-09-08T23:46:52.0447178Z +use serde::{Deserialize, Serialize};
2025-09-08T23:46:52.0447716Z +use std::collections::{BTreeSet, HashMap};
2025-09-08T23:46:52.0448219Z  use std::time::{SystemTime, UNIX_EPOCH};
2025-09-08T23:46:52.0448582Z  
2025-09-08T23:46:52.0451042Z  type Signer = [u8; 32];
2025-09-08T23:46:52.0453405Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:10:
2025-09-08T23:46:52.0454452Z  type Pending = HashMap<Alias, PendingBySeq>;
2025-09-08T23:46:52.0456816Z  
2025-09-08T23:46:52.0457368Z  #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
2025-09-08T23:46:52.0458398Z -pub struct Alias([u8;32]);
2025-09-08T23:46:52.0458802Z +pub struct Alias([u8; 32]);
2025-09-08T23:46:52.0459145Z  
2025-09-08T23:46:52.0459666Z  #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
2025-09-08T23:46:52.0460261Z -pub struct PeerId([u8;32]);
2025-09-08T23:46:52.0460663Z +pub struct PeerId([u8; 32]);
2025-09-08T23:46:52.0461002Z  
2025-09-08T23:46:52.0461653Z  #[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
2025-09-08T23:46:52.0462181Z  pub struct Entry {
2025-09-08T23:46:52.0462682Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:30:
2025-09-08T23:46:52.0476001Z  
2025-09-08T23:46:52.0476347Z  #[derive(Debug, thiserror::Error)]
2025-09-08T23:46:52.0476763Z  pub enum Error {
2025-09-08T23:46:52.0477113Z -    #[error("sequence too old")] OldSeq,
2025-09-08T23:46:52.0477586Z -    #[error("conflict not resolved")] Conflict,
2025-09-08T23:46:52.0478088Z -    #[error("insufficient quorum")] NoQuorum,
2025-09-08T23:46:52.0478572Z +    #[error("sequence too old")]
2025-09-08T23:46:52.0478949Z +    OldSeq,
2025-09-08T23:46:52.0479265Z +    #[error("conflict not resolved")]
2025-09-08T23:46:52.0479654Z +    Conflict,
2025-09-08T23:46:52.0479978Z +    #[error("insufficient quorum")]
2025-09-08T23:46:52.0480376Z +    NoQuorum,
2025-09-08T23:46:52.0480639Z  }
2025-09-08T23:46:52.0480882Z  
2025-09-08T23:46:52.0481153Z  #[derive(Default)]
2025-09-08T23:46:52.0481902Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:39:
2025-09-08T23:46:52.0482523Z  pub struct Ledger {
2025-09-08T23:46:52.0482995Z      // per-alias latest committed entry
2025-09-08T23:46:52.0483479Z -    committed: Mutex<HashMap<Alias, Entry>>, 
2025-09-08T23:46:52.0483957Z +    committed: Mutex<HashMap<Alias, Entry>>,
2025-09-08T23:46:52.0484617Z      // pending entries per alias (seq -> (entry, votes))
2025-09-08T23:46:52.0485161Z      pending: Mutex<Pending>,
2025-09-08T23:46:52.0485971Z      // emergency lock: if set, only entries with signer in set may advance without quorum
2025-09-08T23:46:52.0486818Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:47:
2025-09-08T23:46:52.0487379Z  }
2025-09-08T23:46:52.0487627Z  
2025-09-08T23:46:52.0487898Z  impl Ledger {
2025-09-08T23:46:52.0488423Z -    pub fn new(quorum: usize) -> Self { Self { quorum, ..Default::default() } }
2025-09-08T23:46:52.0489047Z +    pub fn new(quorum: usize) -> Self {
2025-09-08T23:46:52.0489449Z +        Self {
2025-09-08T23:46:52.0489733Z +            quorum,
2025-09-08T23:46:52.0490172Z +            ..Default::default()
2025-09-08T23:46:52.0490528Z +        }
2025-09-08T23:46:52.0490798Z +    }
2025-09-08T23:46:52.0491039Z  
2025-09-08T23:46:52.0491912Z      pub fn propose(&self, alias: Alias, target: PeerId, seq: u64) -> Entry {
2025-09-08T23:46:52.0492731Z -        let ts = SystemTime::now().duration_since(UNIX_EPOCH).unwrap().as_secs();
2025-09-08T23:46:52.0493351Z -        Entry { seq, alias, target, ts }
2025-09-08T23:46:52.0494055Z +        let ts = SystemTime::now()
2025-09-08T23:46:52.0494514Z +            .duration_since(UNIX_EPOCH)
2025-09-08T23:46:52.0494933Z +            .unwrap()
2025-09-08T23:46:52.0495260Z +            .as_secs();
2025-09-08T23:46:52.0495588Z +        Entry {
2025-09-08T23:46:52.0495876Z +            seq,
2025-09-08T23:46:52.0496170Z +            alias,
2025-09-08T23:46:52.0496463Z +            target,
2025-09-08T23:46:52.0496767Z +            ts,
2025-09-08T23:46:52.0497056Z +        }
2025-09-08T23:46:52.0497329Z      }
2025-09-08T23:46:52.0497580Z  
2025-09-08T23:46:52.0498127Z      pub fn vote(&self, e: &Entry, signer: [u8; 32]) -> Result<(), Error> {
2025-09-08T23:46:52.0498843Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:58:
2025-09-08T23:46:52.0499576Z          // reject votes for stale sequences
2025-09-08T23:46:52.0500322Z          if let Some(comm) = self.committed.lock().get(&e.alias) {
2025-09-08T23:46:52.0518305Z -            if e.seq <= comm.seq { return Err(Error::OldSeq); }
2025-09-08T23:46:52.0519092Z +            if e.seq <= comm.seq {
2025-09-08T23:46:52.0519547Z +                return Err(Error::OldSeq);
2025-09-08T23:46:52.0519947Z +            }
2025-09-08T23:46:52.0520265Z          }
2025-09-08T23:46:52.0520732Z          let mut p = self.pending.lock();
2025-09-08T23:46:52.0521841Z          let by_alias = p.entry(e.alias).or_default();
2025-09-08T23:46:52.0522612Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:64:
2025-09-08T23:46:52.0523502Z -    let (entry, voters) = by_alias.entry(e.seq).or_insert_with(|| (e.clone(), BTreeSet::new()));
2025-09-08T23:46:52.0524248Z -        if entry != e { return Err(Error::Conflict); }
2025-09-08T23:46:52.0524731Z +        let (entry, voters) = by_alias
2025-09-08T23:46:52.0525120Z +            .entry(e.seq)
2025-09-08T23:46:52.0525513Z +            .or_insert_with(|| (e.clone(), BTreeSet::new()));
2025-09-08T23:46:52.0525947Z +        if entry != e {
2025-09-08T23:46:52.0526294Z +            return Err(Error::Conflict);
2025-09-08T23:46:52.0526683Z +        }
2025-09-08T23:46:52.0527066Z          voters.insert(signer);
2025-09-08T23:46:52.0527456Z          Ok(())
2025-09-08T23:46:52.0527725Z      }
2025-09-08T23:46:52.0533291Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:69:
2025-09-08T23:46:52.0533918Z  
2025-09-08T23:46:52.0534567Z      pub fn try_commit(&self, alias: Alias) -> Result<Option<Entry>, Error> {
2025-09-08T23:46:52.0535348Z          let mut p = self.pending.lock();
2025-09-08T23:46:52.0535934Z -        let Some(by_seq) = p.get_mut(&alias) else { return Ok(None) };
2025-09-08T23:46:52.0536534Z +        let Some(by_seq) = p.get_mut(&alias) else {
2025-09-08T23:46:52.0536997Z +            return Ok(None);
2025-09-08T23:46:52.0537353Z +        };
2025-09-08T23:46:52.0537807Z          // pick highest seq with quorum
2025-09-08T23:46:52.0538460Z          let mut best: Option<(u64, Entry)> = None;
2025-09-08T23:46:52.0539127Z          for (seq, (e, voters)) in by_seq.iter() {
2025-09-08T23:46:52.0539787Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:76:
2025-09-08T23:46:52.0540389Z -            if voters.len() >= self.quorum
2025-09-08T23:46:52.0540908Z -                && best.as_ref().map(|(s, _)| seq > s).unwrap_or(true)
2025-09-08T23:46:52.0542670Z -            {
2025-09-08T23:46:52.0543239Z +            if voters.len() >= self.quorum && best.as_ref().map(|(s, _)| seq > s).unwrap_or(true) {
2025-09-08T23:46:52.0544177Z                  best = Some((*seq, e.clone()));
2025-09-08T23:46:52.0544618Z              }
2025-09-08T23:46:52.0544916Z          }
2025-09-08T23:46:52.0545414Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:103:
2025-09-08T23:46:52.0546046Z          Ok(None)
2025-09-08T23:46:52.0546327Z      }
2025-09-08T23:46:52.0546563Z  
2025-09-08T23:46:52.0547169Z -    pub fn set_emergency(&self, allow: Option<BTreeSet<[u8; 32]>>) { *self.emergency.lock() = allow; }
2025-09-08T23:46:52.0548291Z +    pub fn set_emergency(&self, allow: Option<BTreeSet<[u8; 32]>>) {
2025-09-08T23:46:52.0548875Z +        *self.emergency.lock() = allow;
2025-09-08T23:46:52.0549267Z +    }
2025-09-08T23:46:52.0549509Z  
2025-09-08T23:46:52.0550094Z -    pub fn head(&self, alias: &Alias) -> Option<Entry> { self.committed.lock().get(alias).cloned() }
2025-09-08T23:46:52.0550894Z +    pub fn head(&self, alias: &Alias) -> Option<Entry> {
2025-09-08T23:46:52.0551658Z +        self.committed.lock().get(alias).cloned()
2025-09-08T23:46:52.0552099Z +    }
2025-09-08T23:46:52.0552364Z  }
2025-09-08T23:46:52.0552652Z  
2025-09-08T23:46:52.0552920Z  #[cfg(test)]
2025-09-08T23:46:52.0553436Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:112:
2025-09-08T23:46:52.0554028Z  mod tests {
2025-09-08T23:46:52.0554358Z      use super::*;
2025-09-08T23:46:52.0554642Z  
2025-09-08T23:46:52.0554984Z -    fn id(n: u8) -> [u8;32] { let mut a=[0u8;32]; a[0]=n; a }
2025-09-08T23:46:52.0555472Z +    fn id(n: u8) -> [u8; 32] {
2025-09-08T23:46:52.0555810Z +        let mut a = [0u8; 32];
2025-09-08T23:46:52.0556389Z +        a[0] = n;
2025-09-08T23:46:52.0556684Z +        a
2025-09-08T23:46:52.0556952Z +    }
2025-09-08T23:46:52.0557192Z  
2025-09-08T23:46:52.0557471Z      #[test]
2025-09-08T23:46:52.0557826Z      fn quorum_commit() {
2025-09-08T23:46:52.0558388Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:119:
2025-09-08T23:46:52.0559141Z          let ledger = Ledger::new(2);
2025-09-08T23:46:52.0559563Z -        let alias = Alias([1u8;32]);
2025-09-08T23:46:52.0559982Z -        let p1 = PeerId([9u8;32]);
2025-09-08T23:46:52.0560391Z +        let alias = Alias([1u8; 32]);
2025-09-08T23:46:52.0560812Z +        let p1 = PeerId([9u8; 32]);
2025-09-08T23:46:52.0562381Z          let e = ledger.propose(alias, p1, 1);
2025-09-08T23:46:52.0563030Z          ledger.vote(&e, id(1)).unwrap();
2025-09-08T23:46:52.0563630Z          ledger.vote(&e, id(2)).unwrap();
2025-09-08T23:46:52.0564255Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:130:
2025-09-08T23:46:52.0564900Z      #[test]
2025-09-08T23:46:52.0565344Z      fn conflict_requires_resolution() {
2025-09-08T23:46:52.0565930Z          let ledger = Ledger::new(2);
2025-09-08T23:46:52.0566342Z -        let alias = Alias([2u8;32]);
2025-09-08T23:46:52.0566759Z -        let p1 = PeerId([1u8;32]);
2025-09-08T23:46:52.0567183Z -        let p2 = PeerId([2u8;32]);
2025-09-08T23:46:52.0567596Z +        let alias = Alias([2u8; 32]);
2025-09-08T23:46:52.0568006Z +        let p1 = PeerId([1u8; 32]);
2025-09-08T23:46:52.0568409Z +        let p2 = PeerId([2u8; 32]);
2025-09-08T23:46:52.0569020Z          let e1 = ledger.propose(alias, p1, 5);
2025-09-08T23:46:52.0569684Z          let e2 = ledger.propose(alias, p2, 5);
2025-09-08T23:46:52.0570307Z          ledger.vote(&e1, id(1)).unwrap();
2025-09-08T23:46:52.0570894Z Diff in /home/runner/work/qnet/qnet/crates/alias-ledger/src/lib.rs:148:
2025-09-08T23:46:52.0571693Z      #[test]
2025-09-08T23:46:52.0572100Z      fn emergency_path_advances() {
2025-09-08T23:46:52.0572683Z          let ledger = Ledger::new(2);
2025-09-08T23:46:52.0573079Z -        let alias = Alias([3u8;32]);
2025-09-08T23:46:52.0573477Z -        let p1 = PeerId([7u8;32]);
2025-09-08T23:46:52.0573900Z +        let alias = Alias([3u8; 32]);
2025-09-08T23:46:52.0574314Z +        let p1 = PeerId([7u8; 32]);
2025-09-08T23:46:52.0574915Z          let e = ledger.propose(alias, p1, 10);
2025-09-08T23:46:52.0575632Z          ledger.vote(&e, id(9)).unwrap(); // only one vote
2025-09-08T23:46:52.0576127Z -        // set emergency allowing signer 9
2025-09-08T23:46:52.0576632Z +                                         // set emergency allowing signer 9
2025-09-08T23:46:52.0577263Z          let mut allow = BTreeSet::new();
2025-09-08T23:46:52.0577795Z          allow.insert(id(9));
2025-09-08T23:46:52.0578318Z          ledger.set_emergency(Some(allow));
2025-09-08T23:46:52.0579009Z Diff in /home/runner/work/qnet/qnet/crates/c-lib/src/lib.rs:10:
2025-09-08T23:46:52.0579540Z  /// # Safety
2025-09-08T23:46:52.0580483Z  /// Callers must ensure `out_client` and `out_server` are valid, non-null pointers to writable QnetConn slots.
2025-09-08T23:46:52.0581234Z  #[no_mangle]
2025-09-08T23:46:52.0582210Z -pub unsafe extern "C" fn qnet_dial_inproc(out_client: *mut QnetConn, out_server: *mut QnetConn) -> c_int {
2025-09-08T23:46:52.0583009Z +pub unsafe extern "C" fn qnet_dial_inproc(
2025-09-08T23:46:52.0583454Z +    out_client: *mut QnetConn,
2025-09-08T23:46:52.0583851Z +    out_server: *mut QnetConn,
2025-09-08T23:46:52.0584207Z +) -> c_int {
2025-09-08T23:46:52.0584666Z      let (c, s) = htx::api::dial_inproc_secure();
2025-09-08T23:46:52.0585156Z      let b1 = Box::new(c);
2025-09-08T23:46:52.0585558Z      let b2 = Box::new(s);
2025-09-08T23:46:52.0586056Z Diff in /home/runner/work/qnet/qnet/crates/c-lib/src/lib.rs:17:
2025-09-08T23:46:52.0586726Z -    if !out_client.is_null() { (*out_client).0 = Box::into_raw(b1); }
2025-09-08T23:46:52.0587404Z -    if !out_server.is_null() { (*out_server).0 = Box::into_raw(b2); }
2025-09-08T23:46:52.0587952Z +    if !out_client.is_null() {
2025-09-08T23:46:52.0588586Z +        (*out_client).0 = Box::into_raw(b1);
2025-09-08T23:46:52.0588973Z +    }
2025-09-08T23:46:52.0589262Z +    if !out_server.is_null() {
2025-09-08T23:46:52.0589674Z +        (*out_server).0 = Box::into_raw(b2);
2025-09-08T23:46:52.0590070Z +    }
2025-09-08T23:46:52.0590336Z      0
2025-09-08T23:46:52.0590578Z  }
2025-09-08T23:46:52.0590823Z  
2025-09-08T23:46:52.0591238Z Diff in /home/runner/work/qnet/qnet/crates/c-lib/src/lib.rs:23:
2025-09-08T23:46:52.0592445Z  /// `conn` must be a valid, non-null pointer to an initialized QnetConn.
2025-09-08T23:46:52.0592992Z  #[no_mangle]
2025-09-08T23:46:52.0593561Z  pub unsafe extern "C" fn qnet_conn_open_stream(conn: *mut QnetConn) -> QnetStream {
2025-09-08T23:46:52.0594276Z -    if conn.is_null() { return QnetStream(ptr::null_mut()); }
2025-09-08T23:46:52.0594769Z +    if conn.is_null() {
2025-09-08T23:46:52.0595161Z +        return QnetStream(ptr::null_mut());
2025-09-08T23:46:52.0595560Z +    }
2025-09-08T23:46:52.0595894Z      let c = &*((*conn).0);
2025-09-08T23:46:52.0596306Z      let s = c.open_stream();
2025-09-08T23:46:52.0596807Z      QnetStream(Box::into_raw(Box::new(s)))
2025-09-08T23:46:52.0597355Z Diff in /home/runner/work/qnet/qnet/crates/c-lib/src/lib.rs:32:
2025-09-08T23:46:52.0597846Z  /// # Safety
2025-09-08T23:46:52.0598337Z  /// `conn` must be a valid, non-null pointer to an initialized QnetConn.
2025-09-08T23:46:52.0598883Z  #[no_mangle]
2025-09-08T23:46:52.0599520Z -pub unsafe extern "C" fn qnet_conn_accept_stream(conn: *mut QnetConn, timeout_ms: u64) -> QnetStream {
2025-09-08T23:46:52.0600344Z -    if conn.is_null() { return QnetStream(ptr::null_mut()); }
2025-09-08T23:46:52.0600913Z +pub unsafe extern "C" fn qnet_conn_accept_stream(
2025-09-08T23:46:52.0601655Z +    conn: *mut QnetConn,
2025-09-08T23:46:52.0602016Z +    timeout_ms: u64,
2025-09-08T23:46:52.0602355Z +) -> QnetStream {
2025-09-08T23:46:52.0602700Z +    if conn.is_null() {
2025-09-08T23:46:52.0603092Z +        return QnetStream(ptr::null_mut());
2025-09-08T23:46:52.0603497Z +    }
2025-09-08T23:46:52.0603840Z      let c = &*((*conn).0);
2025-09-08T23:46:52.0604304Z      match c.accept_stream(timeout_ms) {
2025-09-08T23:46:52.0605019Z          Some(s) => QnetStream(Box::into_raw(Box::new(s))),
2025-09-08T23:46:52.0605638Z Diff in /home/runner/work/qnet/qnet/crates/c-lib/src/lib.rs:44:
2025-09-08T23:46:52.0606168Z  /// # Safety
2025-09-08T23:46:52.0606828Z  /// `st` must be a valid, non-null pointer to a QnetStream. `data` must point to `len` readable bytes.
2025-09-08T23:46:52.0607516Z  #[no_mangle]
2025-09-08T23:46:52.0608126Z -pub unsafe extern "C" fn qnet_stream_write(st: *mut QnetStream, data: *const u8, len: size_t) -> c_int {
2025-09-08T23:46:52.0608864Z -    if st.is_null() || data.is_null() { return -1; }
2025-09-08T23:46:52.0609342Z +pub unsafe extern "C" fn qnet_stream_write(
2025-09-08T23:46:52.0609744Z +    st: *mut QnetStream,
2025-09-08T23:46:52.0610057Z +    data: *const u8,
2025-09-08T23:46:52.0610541Z +    len: size_t,
2025-09-08T23:46:52.0610829Z +) -> c_int {
2025-09-08T23:46:52.0611110Z +    if st.is_null() || data.is_null() {
2025-09-08T23:46:52.0611761Z +        return -1;
2025-09-08T23:46:52.0612021Z +    }
2025-09-08T23:46:52.0612311Z      let s = &*((*st).0);
2025-09-08T23:46:52.0612815Z      let slice = std::slice::from_raw_parts(data, len);
2025-09-08T23:46:52.0613321Z      s.write(slice);
2025-09-08T23:46:52.0613797Z Diff in /home/runner/work/qnet/qnet/crates/c-lib/src/lib.rs:55:
2025-09-08T23:46:52.0614307Z  /// # Safety
2025-09-08T23:46:52.0614765Z  /// `st` must be valid. `out_buf` must point to `cap` writable bytes.
2025-09-08T23:46:52.0615251Z  #[no_mangle]
2025-09-08T23:46:52.0615898Z -pub unsafe extern "C" fn qnet_stream_read(st: *mut QnetStream, out_buf: *mut u8, cap: size_t) -> isize {
2025-09-08T23:46:52.0616698Z -    if st.is_null() || out_buf.is_null() { return -1; }
2025-09-08T23:46:52.0617205Z +pub unsafe extern "C" fn qnet_stream_read(
2025-09-08T23:46:52.0617642Z +    st: *mut QnetStream,
2025-09-08T23:46:52.0618175Z +    out_buf: *mut u8,
2025-09-08T23:46:52.0618487Z +    cap: size_t,
2025-09-08T23:46:52.0618752Z +) -> isize {
2025-09-08T23:46:52.0619091Z +    if st.is_null() || out_buf.is_null() {
2025-09-08T23:46:52.0619502Z +        return -1;
2025-09-08T23:46:52.0619795Z +    }
2025-09-08T23:46:52.0620111Z      let s = &*((*st).0);
2025-09-08T23:46:52.0620541Z      if let Some(buf) = s.read() {
2025-09-08T23:46:52.0621043Z          let n = buf.len().min(cap);
2025-09-08T23:46:52.0621746Z Diff in /home/runner/work/qnet/qnet/crates/c-lib/src/lib.rs:63:
2025-09-08T23:46:52.0622565Z          ptr::copy_nonoverlapping(buf.as_ptr(), out_buf, n);
2025-09-08T23:46:52.0623055Z          n as isize
2025-09-08T23:46:52.0623372Z -    } else { -2 }
2025-09-08T23:46:52.0623663Z +    } else {
2025-09-08T23:46:52.0623946Z +        -2
2025-09-08T23:46:52.0624197Z +    }
2025-09-08T23:46:52.0624435Z  }
2025-09-08T23:46:52.0624648Z  
2025-09-08T23:46:52.0624880Z  /// # Safety
2025-09-08T23:46:52.0625299Z Diff in /home/runner/work/qnet/qnet/crates/c-lib/src/lib.rs:69:
2025-09-08T23:46:52.0626069Z  /// `conn` must be a valid pointer returned by this library. It will be freed and set to null.
2025-09-08T23:46:52.0626663Z  #[no_mangle]
2025-09-08T23:46:52.0627069Z  pub unsafe extern "C" fn qnet_conn_free(conn: *mut QnetConn) {
2025-09-08T23:46:52.0627555Z -    if conn.is_null() { return; }
2025-09-08T23:46:52.0628140Z -    if !(*conn).0.is_null() { let _ = Box::from_raw((*conn).0); (*conn).0 = ptr::null_mut(); }
2025-09-08T23:46:52.0628746Z +    if conn.is_null() {
2025-09-08T23:46:52.0629059Z +        return;
2025-09-08T23:46:52.0629323Z +    }
2025-09-08T23:46:52.0629595Z +    if !(*conn).0.is_null() {
2025-09-08T23:46:52.0629962Z +        let _ = Box::from_raw((*conn).0);
2025-09-08T23:46:52.0630374Z +        (*conn).0 = ptr::null_mut();
2025-09-08T23:46:52.0630721Z +    }
2025-09-08T23:46:52.0630949Z  }
2025-09-08T23:46:52.0631168Z  
2025-09-08T23:46:52.0631679Z  /// # Safety
2025-09-08T23:46:52.0632117Z Diff in /home/runner/work/qnet/qnet/crates/c-lib/src/lib.rs:77:
2025-09-08T23:46:52.0632924Z  /// `st` must be a valid pointer returned by this library. It will be freed and set to null.
2025-09-08T23:46:52.0633527Z  #[no_mangle]
2025-09-08T23:46:52.0633989Z  pub unsafe extern "C" fn qnet_stream_free(st: *mut QnetStream) {
2025-09-08T23:46:52.0634516Z -    if st.is_null() { return; }
2025-09-08T23:46:52.0635047Z -    if !(*st).0.is_null() { let _ = Box::from_raw((*st).0); (*st).0 = ptr::null_mut(); }
2025-09-08T23:46:52.0635576Z +    if st.is_null() {
2025-09-08T23:46:52.0635875Z +        return;
2025-09-08T23:46:52.0636146Z +    }
2025-09-08T23:46:52.0636409Z +    if !(*st).0.is_null() {
2025-09-08T23:46:52.0636780Z +        let _ = Box::from_raw((*st).0);
2025-09-08T23:46:52.0637179Z +        (*st).0 = ptr::null_mut();
2025-09-08T23:46:52.0637530Z +    }
2025-09-08T23:46:52.0637765Z  }
2025-09-08T23:46:52.0637989Z  
2025-09-08T23:46:52.0638601Z Diff in /home/runner/work/qnet/qnet/crates/core-crypto/src/lib.rs:6:
2025-09-08T23:46:52.0639123Z  }
2025-09-08T23:46:52.0639352Z  
2025-09-08T23:46:52.0639600Z  pub mod aead {
2025-09-08T23:46:52.0640018Z -    use ring::aead::{self, Aad, LessSafeKey, Nonce, UnboundKey};
2025-09-08T23:46:52.0640543Z      use crate::Error;
2025-09-08T23:46:52.0640968Z +    use ring::aead::{self, Aad, LessSafeKey, Nonce, UnboundKey};
2025-09-08T23:46:52.0641672Z  
2025-09-08T23:46:52.0642097Z      // ChaCha20-Poly1305 AEAD (IETF 12-byte nonce)
2025-09-08T23:46:52.0643258Z      pub fn seal(key: &[u8; 32], nonce: &[u8; 12], aad: &[u8], pt: &[u8]) -> Vec<u8> {
2025-09-08T23:46:52.0644001Z Diff in /home/runner/work/qnet/qnet/crates/core-crypto/src/lib.rs:14:
2025-09-08T23:46:52.0645121Z          let unbound = UnboundKey::new(&aead::CHACHA20_POLY1305, key).expect("aead key");
2025-09-08T23:46:52.0645916Z          let key = LessSafeKey::new(unbound);
2025-09-08T23:46:52.0646473Z          let mut buf = pt.to_vec();
2025-09-08T23:46:52.0646838Z -        key
2025-09-08T23:46:52.0647434Z -            .seal_in_place_append_tag(Nonce::assume_unique_for_key(*nonce), Aad::from(aad), &mut buf)
2025-09-08T23:46:52.0648339Z -            .expect("aead seal");
2025-09-08T23:46:52.0648756Z +        key.seal_in_place_append_tag(
2025-09-08T23:46:52.0649228Z +            Nonce::assume_unique_for_key(*nonce),
2025-09-08T23:46:52.0649664Z +            Aad::from(aad),
2025-09-08T23:46:52.0650013Z +            &mut buf,
2025-09-08T23:46:52.0650306Z +        )
2025-09-08T23:46:52.0650605Z +        .expect("aead seal");
2025-09-08T23:46:52.0650984Z          buf
2025-09-08T23:46:52.0651270Z      }
2025-09-08T23:46:52.0651693Z  
2025-09-08T23:46:52.0652168Z Diff in /home/runner/work/qnet/qnet/crates/core-crypto/src/lib.rs:25:
2025-09-08T23:46:52.0652973Z          let key = LessSafeKey::new(unbound);
2025-09-08T23:46:52.0653559Z          let mut buf = ct.to_vec();
2025-09-08T23:46:52.0654027Z          let out = key
2025-09-08T23:46:52.0654614Z -            .open_in_place(Nonce::assume_unique_for_key(*nonce), Aad::from(aad), &mut buf)
2025-09-08T23:46:52.0655260Z +            .open_in_place(
2025-09-08T23:46:52.0655673Z +                Nonce::assume_unique_for_key(*nonce),
2025-09-08T23:46:52.0656126Z +                Aad::from(aad),
2025-09-08T23:46:52.0656486Z +                &mut buf,
2025-09-08T23:46:52.0656797Z +            )
2025-09-08T23:46:52.0657317Z              .map_err(|_| Error::Crypto)?;
2025-09-08T23:46:52.0657802Z          Ok(out.to_vec())
2025-09-08T23:46:52.0658142Z      }
2025-09-08T23:46:52.0658616Z Diff in /home/runner/work/qnet/qnet/crates/core-crypto/src/lib.rs:41:
2025-09-08T23:46:52.0659568Z      // Local length marker to request arbitrary-length OKM from ring's HKDF.
2025-09-08T23:46:52.0660249Z      pub struct Len<const N: usize>;
2025-09-08T23:46:52.0660804Z      impl<const N: usize> KeyType for Len<N> {
2025-09-08T23:46:52.0661269Z -        fn len(&self) -> usize { N }
2025-09-08T23:46:52.0662006Z +        fn len(&self) -> usize {
2025-09-08T23:46:52.0662380Z +            N
2025-09-08T23:46:52.0662666Z +        }
2025-09-08T23:46:52.0662935Z      }
2025-09-08T23:46:52.0663169Z  
2025-09-08T23:46:52.0663727Z      pub fn expand<const N: usize>(prk: &Prk, info: &[u8]) -> [u8; N] {
2025-09-08T23:46:52.0664455Z Diff in /home/runner/work/qnet/qnet/crates/core-crypto/src/lib.rs:102:
2025-09-08T23:46:52.0665189Z          KeyPair { priv_key, pubkey }
2025-09-08T23:46:52.0665580Z      }
2025-09-08T23:46:52.0665818Z  
2025-09-08T23:46:52.0666473Z -    pub fn dh(priv_key: agreement::EphemeralPrivateKey, peer_public: &[u8; 32]) -> Result<[u8; 32], Error> {
2025-09-08T23:46:52.0667216Z +    pub fn dh(
2025-09-08T23:46:52.0667601Z +        priv_key: agreement::EphemeralPrivateKey,
2025-09-08T23:46:52.0668090Z +        peer_public: &[u8; 32],
2025-09-08T23:46:52.0668497Z +    ) -> Result<[u8; 32], Error> {
2025-09-08T23:46:52.0669478Z          let peer = agreement::UnparsedPublicKey::new(&agreement::X25519, peer_public);
2025-09-08T23:46:52.0670717Z          agreement::agree_ephemeral(priv_key, &peer, |km: &[u8]| {
2025-09-08T23:46:52.0671679Z              let mut out = [0u8; 32];
2025-09-08T23:46:52.0672286Z Diff in /home/runner/work/qnet/qnet/crates/core-crypto/src/lib.rs:160:
2025-09-08T23:46:52.0672987Z          let salt = b"salt";
2025-09-08T23:46:52.0673535Z          let ikm = b"input keying material";
2025-09-08T23:46:52.0674157Z          let prk = hkdf::extract(salt, ikm);
2025-09-08T23:46:52.0674660Z -    let okm: [u8; 42] = hkdf::expand(&prk, b"info");
2025-09-08T23:46:52.0675217Z -    // Just basic sanity: not all-zero and stable length
2025-09-08T23:46:52.0675726Z -    assert_eq!(okm.len(), 42);
2025-09-08T23:46:52.0676187Z +        let okm: [u8; 42] = hkdf::expand(&prk, b"info");
2025-09-08T23:46:52.0676744Z +        // Just basic sanity: not all-zero and stable length
2025-09-08T23:46:52.0677212Z +        assert_eq!(okm.len(), 42);
2025-09-08T23:46:52.0677783Z          assert!(okm.iter().any(|&b| b != 0));
2025-09-08T23:46:52.0678192Z      }
2025-09-08T23:46:52.0678439Z  
2025-09-08T23:46:52.0678911Z Diff in /home/runner/work/qnet/qnet/crates/core-crypto/src/lib.rs:172:
2025-09-08T23:46:52.0679860Z          let msg = b"qnet";
2025-09-08T23:46:52.0680402Z          let sig = ed25519::sign(&seed, msg);
2025-09-08T23:46:52.0681238Z          // Build public key from seed via KeyPair for verification
2025-09-08T23:46:52.0682176Z -    use ring::signature::{Ed25519KeyPair, KeyPair};
2025-09-08T23:46:52.0682736Z +        use ring::signature::{Ed25519KeyPair, KeyPair};
2025-09-08T23:46:52.0683594Z          let kp = Ed25519KeyPair::from_seed_unchecked(&seed).unwrap();
2025-09-08T23:46:52.0684360Z          let pk = kp.public_key().as_ref().to_vec();
2025-09-08T23:46:52.0685123Z          ed25519::verify(&pk, msg, &sig).expect("verify ok");
2025-09-08T23:46:52.0685800Z Diff in /home/runner/work/qnet/qnet/crates/core-framing/src/lib.rs:41:
2025-09-08T23:46:52.0686347Z  
2025-09-08T23:46:52.0686928Z      /// Decode a single frame without encryption from a buffer slice.
2025-09-08T23:46:52.0687764Z      pub fn decode_plain(mut src: &[u8]) -> Result<Frame, Error> {
2025-09-08T23:46:52.0688397Z -        if src.len() < 4 { return Err(Error::TooShort); }
2025-09-08T23:46:52.0688859Z +        if src.len() < 4 {
2025-09-08T23:46:52.0689251Z +            return Err(Error::TooShort);
2025-09-08T23:46:52.0689649Z +        }
2025-09-08T23:46:52.0690133Z          let len = get_u24(&mut src)? as usize;
2025-09-08T23:46:52.0690661Z -        if src.len() < len { return Err(Error::InvalidLen); }
2025-09-08T23:46:52.0691227Z -    let ty = src.first().copied().ok_or(Error::TooShort)?;
2025-09-08T23:46:52.0691900Z +        if src.len() < len {
2025-09-08T23:46:52.0692298Z +            return Err(Error::InvalidLen);
2025-09-08T23:46:52.0692684Z +        }
2025-09-08T23:46:52.0693070Z +        let ty = src.first().copied().ok_or(Error::TooShort)?;
2025-09-08T23:46:52.0693666Z          let ty = match ty {
2025-09-08T23:46:52.0694233Z              0x10 => FrameType::Stream,
2025-09-08T23:46:52.0694885Z              0x11 => FrameType::WindowUpdate,
2025-09-08T23:46:52.0695540Z Diff in /home/runner/work/qnet/qnet/crates/core-framing/src/lib.rs:65:
2025-09-08T23:46:52.0696100Z  }
2025-09-08T23:46:52.0696341Z  
2025-09-08T23:46:52.0696707Z  fn get_u24(src: &mut &[u8]) -> Result<u32, Error> {
2025-09-08T23:46:52.0697266Z -    if src.len() < 3 { return Err(Error::TooShort); }
2025-09-08T23:46:52.0697735Z +    if src.len() < 3 {
2025-09-08T23:46:52.0698114Z +        return Err(Error::TooShort);
2025-09-08T23:46:52.0698499Z +    }
2025-09-08T23:46:52.0699071Z      let v = ((src[0] as u32) << 16) | ((src[1] as u32) << 8) | (src[2] as u32);
2025-09-08T23:46:52.0699622Z      *src = &src[3..];
2025-09-08T23:46:52.0699954Z      Ok(v)
2025-09-08T23:46:52.0700451Z Diff in /home/runner/work/qnet/qnet/crates/core-framing/src/lib.rs:99:
2025-09-08T23:46:52.0701008Z  }
2025-09-08T23:46:52.0701244Z  
2025-09-08T23:46:52.0701934Z  pub fn decode(mut src: &[u8], key: KeyCtx, nonce: [u8; 12]) -> Result<Frame, Error> {
2025-09-08T23:46:52.0702812Z -    if src.len() < 4 { return Err(Error::TooShort); }
2025-09-08T23:46:52.0703291Z +    if src.len() < 4 {
2025-09-08T23:46:52.0703660Z +        return Err(Error::TooShort);
2025-09-08T23:46:52.0704050Z +    }
2025-09-08T23:46:52.0704478Z      let wire_len = get_u24(&mut src)? as usize;
2025-09-08T23:46:52.0705036Z -    if src.len() < wire_len { return Err(Error::InvalidLen); }
2025-09-08T23:46:52.0705552Z +    if src.len() < wire_len {
2025-09-08T23:46:52.0705956Z +        return Err(Error::InvalidLen);
2025-09-08T23:46:52.0706346Z +    }
2025-09-08T23:46:52.0706834Z      let typ = src.first().copied().ok_or(Error::TooShort)?;
2025-09-08T23:46:52.0707363Z      let mut aad = [0u8; 4];
2025-09-08T23:46:52.0707868Z      aad[0] = ((wire_len as u32 >> 16) & 0xff) as u8;
2025-09-08T23:46:52.0708505Z Diff in /home/runner/work/qnet/qnet/crates/core-framing/src/lib.rs:131:
2025-09-08T23:46:52.0709249Z          let mut b = BytesMut::new();
2025-09-08T23:46:52.0709751Z          put_u24(&mut b, 0);
2025-09-08T23:46:52.0710212Z          put_u24(&mut b, 1);
2025-09-08T23:46:52.0710784Z -    put_u24(&mut b, 0x0000_FFFF);
2025-09-08T23:46:52.0711179Z -    let s = b.freeze();
2025-09-08T23:46:52.0711744Z +        put_u24(&mut b, 0x0000_FFFF);
2025-09-08T23:46:52.0712151Z +        let s = b.freeze();
2025-09-08T23:46:52.0712802Z          assert_eq!(get_u24(&mut s.as_ref()).unwrap(), 0);
2025-09-08T23:46:52.0713383Z          let mut s2 = &s[3..];
2025-09-08T23:46:52.0713962Z          assert_eq!(get_u24(&mut s2).unwrap(), 1);
2025-09-08T23:46:52.0714601Z Diff in /home/runner/work/qnet/qnet/crates/core-framing/src/lib.rs:139:
2025-09-08T23:46:52.0715256Z          let mut s3 = &s[6..];
2025-09-08T23:46:52.0715694Z -    assert_eq!(get_u24(&mut s3).unwrap(), 0x0000_FFFF);
2025-09-08T23:46:52.0716231Z +        assert_eq!(get_u24(&mut s3).unwrap(), 0x0000_FFFF);
2025-09-08T23:46:52.0716689Z      }
2025-09-08T23:46:52.0716914Z  
2025-09-08T23:46:52.0717162Z      #[test]
2025-09-08T23:46:52.0717658Z Diff in /home/runner/work/qnet/qnet/crates/core-framing/src/lib.rs:144:
2025-09-08T23:46:52.0718337Z      fn plain_encode_decode() {
2025-09-08T23:46:52.0718888Z -        let f = Frame { ty: FrameType::Stream, payload: b"hello".to_vec() };
2025-09-08T23:46:52.0719429Z +        let f = Frame {
2025-09-08T23:46:52.0719792Z +            ty: FrameType::Stream,
2025-09-08T23:46:52.0720208Z +            payload: b"hello".to_vec(),
2025-09-08T23:46:52.0720606Z +        };
2025-09-08T23:46:52.0721018Z          let w = f.encode_plain();
2025-09-08T23:46:52.0721804Z          let g = Frame::decode_plain(&w).unwrap();
2025-09-08T23:46:52.0722346Z          assert_eq!(f, g);
2025-09-08T23:46:52.0722906Z Diff in /home/runner/work/qnet/qnet/crates/core-framing/src/lib.rs:175:
2025-09-08T23:46:52.0723471Z  
2025-09-08T23:46:52.0723964Z              // Tamper ciphertext -> fail
2025-09-08T23:46:52.0724588Z              let mut bad = w.to_vec();
2025-09-08T23:46:52.0725067Z -            if bad.len() > 8 { // ensure there's ct to flip
2025-09-08T23:46:52.0725544Z +            if bad.len() > 8 {
2025-09-08T23:46:52.0725964Z +                // ensure there's ct to flip
2025-09-08T23:46:52.0726665Z                  let last = bad.len() - 1;
2025-09-08T23:46:52.0727275Z                  bad[last] ^= 1;
2025-09-08T23:46:52.0728123Z                  assert!(decode(&bad, keyctx, nonce).is_err());
2025-09-08T23:46:52.0728826Z Diff in /home/runner/work/qnet/qnet/crates/core-governance/src/lib.rs:1:
2025-09-08T23:46:52.0729476Z -use serde::{Serialize, Deserialize};
2025-09-08T23:46:52.0729934Z +use serde::{Deserialize, Serialize};
2025-09-08T23:46:52.0730316Z  
2025-09-08T23:46:52.0730799Z  #[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq, Hash)]
2025-09-08T23:46:52.0731569Z  pub struct OrgId(pub String);
2025-09-08T23:46:52.0732212Z Diff in /home/runner/work/qnet/qnet/crates/core-governance/src/lib.rs:26:
2025-09-08T23:46:52.0732800Z  
2025-09-08T23:46:52.0733238Z  pub fn score_nodes(nodes: Vec<Node>, caps: Caps) -> Vec<Score> {
2025-09-08T23:46:52.0734089Z      // raw scores proportional to uptime
2025-09-08T23:46:52.0734751Z -    let raw: Vec<f64> = nodes.iter().map(|n| n.uptime_ratio.clamp(0.0, 1.0)).collect();
2025-09-08T23:46:52.0735354Z +    let raw: Vec<f64> = nodes
2025-09-08T23:46:52.0735697Z +        .iter()
2025-09-08T23:46:52.0736049Z +        .map(|n| n.uptime_ratio.clamp(0.0, 1.0))
2025-09-08T23:46:52.0736477Z +        .collect();
2025-09-08T23:46:52.0737087Z      // apply caps by redistributing excess above cap proportionally
2025-09-08T23:46:52.0737669Z      // compute group sums
2025-09-08T23:46:52.0738126Z      use std::collections::HashMap;
2025-09-08T23:46:52.0738759Z Diff in /home/runner/work/qnet/qnet/crates/core-governance/src/lib.rs:41:
2025-09-08T23:46:52.0739516Z      for (i, n) in nodes.iter().enumerate() {
2025-09-08T23:46:52.0740330Z          let org_total = by_org.get(&n.org).copied().unwrap_or(0.0);
2025-09-08T23:46:52.0741191Z          let as_total = by_as.get(&n.asn).copied().unwrap_or(0.0);
2025-09-08T23:46:52.0742143Z -        let org_factor = if org_total > 0.0 { (caps.org_cap * org_total) / org_total } else { 1.0 };
2025-09-08T23:46:52.0743259Z -        let as_factor = if as_total > 0.0 { (caps.as_cap * as_total) / as_total } else { 1.0 };
2025-09-08T23:46:52.0743922Z +        let org_factor = if org_total > 0.0 {
2025-09-08T23:46:52.0744406Z +            (caps.org_cap * org_total) / org_total
2025-09-08T23:46:52.0744849Z +        } else {
2025-09-08T23:46:52.0745156Z +            1.0
2025-09-08T23:46:52.0745439Z +        };
2025-09-08T23:46:52.0745768Z +        let as_factor = if as_total > 0.0 {
2025-09-08T23:46:52.0746239Z +            (caps.as_cap * as_total) / as_total
2025-09-08T23:46:52.0746659Z +        } else {
2025-09-08T23:46:52.0746966Z +            1.0
2025-09-08T23:46:52.0747254Z +        };
2025-09-08T23:46:52.0747907Z          let factor = org_factor.min(as_factor).min(1.0);
2025-09-08T23:46:52.0748544Z          capped[i] = raw[i] * factor;
2025-09-08T23:46:52.0748950Z      }
2025-09-08T23:46:52.0749447Z Diff in /home/runner/work/qnet/qnet/crates/core-governance/src/lib.rs:49:
2025-09-08T23:46:52.0750278Z -    raw.into_iter().zip(capped).map(|(raw, capped)| Score { raw, capped }).collect()
2025-09-08T23:46:52.0750878Z +    raw.into_iter()
2025-09-08T23:46:52.0751193Z +        .zip(capped)
2025-09-08T23:46:52.0751737Z +        .map(|(raw, capped)| Score { raw, capped })
2025-09-08T23:46:52.0752170Z +        .collect()
2025-09-08T23:46:52.0752458Z  }
2025-09-08T23:46:52.0752698Z  
2025-09-08T23:46:52.0752964Z  #[cfg(test)]
2025-09-08T23:46:52.0753479Z Diff in /home/runner/work/qnet/qnet/crates/core-governance/src/lib.rs:56:
2025-09-08T23:46:52.0754107Z      #[test]
2025-09-08T23:46:52.0754475Z      fn caps_bound_scores() {
2025-09-08T23:46:52.0754953Z          let nodes = vec![
2025-09-08T23:46:52.0755520Z -            Node { uptime_ratio: 1.0, org: OrgId("A".into()), asn: AsId("AS1".into()) },
2025-09-08T23:46:52.0756289Z -            Node { uptime_ratio: 1.0, org: OrgId("A".into()), asn: AsId("AS1".into()) },
2025-09-08T23:46:52.0757078Z -            Node { uptime_ratio: 1.0, org: OrgId("B".into()), asn: AsId("AS2".into()) },
2025-09-08T23:46:52.0757847Z -            Node { uptime_ratio: 0.5, org: OrgId("B".into()), asn: AsId("AS2".into()) },
2025-09-08T23:46:52.0758422Z +            Node {
2025-09-08T23:46:52.0758750Z +                uptime_ratio: 1.0,
2025-09-08T23:46:52.0759179Z +                org: OrgId("A".into()),
2025-09-08T23:46:52.0759606Z +                asn: AsId("AS1".into()),
2025-09-08T23:46:52.0760010Z +            },
2025-09-08T23:46:52.0760300Z +            Node {
2025-09-08T23:46:52.0760621Z +                uptime_ratio: 1.0,
2025-09-08T23:46:52.0761025Z +                org: OrgId("A".into()),
2025-09-08T23:46:52.0761600Z +                asn: AsId("AS1".into()),
2025-09-08T23:46:52.0761981Z +            },
2025-09-08T23:46:52.0762261Z +            Node {
2025-09-08T23:46:52.0762598Z +                uptime_ratio: 1.0,
2025-09-08T23:46:52.0763004Z +                org: OrgId("B".into()),
2025-09-08T23:46:52.0763652Z +                asn: AsId("AS2".into()),
2025-09-08T23:46:52.0764082Z +            },
2025-09-08T23:46:52.0764363Z +            Node {
2025-09-08T23:46:52.0764690Z +                uptime_ratio: 0.5,
2025-09-08T23:46:52.0765102Z +                org: OrgId("B".into()),
2025-09-08T23:46:52.0765530Z +                asn: AsId("AS2".into()),
2025-09-08T23:46:52.0765917Z +            },
2025-09-08T23:46:52.0766235Z          ];
2025-09-08T23:46:52.0766603Z -        let caps = Caps { org_cap: 0.20, as_cap: 0.25 };
2025-09-08T23:46:52.0767082Z +        let caps = Caps {
2025-09-08T23:46:52.0767448Z +            org_cap: 0.20,
2025-09-08T23:46:52.0767796Z +            as_cap: 0.25,
2025-09-08T23:46:52.0778209Z +        };
2025-09-08T23:46:52.0778858Z          let scores = score_nodes(nodes, caps);
2025-09-08T23:46:52.0779332Z          // raw
2025-09-08T23:46:52.0780021Z          assert_eq!(scores.iter().map(|s| s.raw).sum::<f64>(), 3.5);
2025-09-08T23:46:52.0780716Z Diff in /home/runner/work/qnet/qnet/crates/core-identity/src/lib.rs:1:
2025-09-08T23:46:52.0781735Z -use serde::{Serialize, Deserialize};
2025-09-08T23:46:52.0782158Z +use serde::{Deserialize, Serialize};
2025-09-08T23:46:52.0782564Z  use sha2::{Digest, Sha256};
2025-09-08T23:46:52.0782876Z  
2025-09-08T23:46:52.0783283Z  #[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
2025-09-08T23:46:52.0783965Z Diff in /home/runner/work/qnet/qnet/crates/core-identity/src/lib.rs:15:
2025-09-08T23:46:52.0784541Z      PeerId(mh)
2025-09-08T23:46:52.0784833Z  }
2025-09-08T23:46:52.0785079Z  
2025-09-08T23:46:52.0785482Z -pub fn to_hex(id: &PeerId) -> String { hex::encode(&id.0) }
2025-09-08T23:46:52.0786016Z +pub fn to_hex(id: &PeerId) -> String {
2025-09-08T23:46:52.0786445Z +    hex::encode(&id.0)
2025-09-08T23:46:52.0786748Z +}
2025-09-08T23:46:52.0786990Z  
2025-09-08T23:46:52.0787542Z -pub fn to_base32(id: &PeerId) -> String { base32::encode(base32::Alphabet::Crockford, &id.0) }
2025-09-08T23:46:52.0788251Z +pub fn to_base32(id: &PeerId) -> String {
2025-09-08T23:46:52.0788777Z +    base32::encode(base32::Alphabet::Crockford, &id.0)
2025-09-08T23:46:52.0789235Z +}
2025-09-08T23:46:52.0789479Z  
2025-09-08T23:46:52.0789734Z  #[cfg(test)]
2025-09-08T23:46:52.0790023Z  mod tests {
2025-09-08T23:46:52.0790521Z Diff in /home/runner/work/qnet/qnet/crates/core-identity/src/lib.rs:24:
2025-09-08T23:46:52.0791163Z      use super::*;
2025-09-08T23:46:52.0791670Z      #[test]
2025-09-08T23:46:52.0792057Z      fn roundtrip_encodings() {
2025-09-08T23:46:52.0792479Z -        let id = from_pubkey(&[1u8;33]);
2025-09-08T23:46:52.0792929Z +        let id = from_pubkey(&[1u8; 33]);
2025-09-08T23:46:52.0793454Z          let h = to_hex(&id);
2025-09-08T23:46:52.0793949Z          let b32 = to_base32(&id);
2025-09-08T23:46:52.0794474Z          assert!(!h.is_empty());
2025-09-08T23:46:52.0797486Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:1:
2025-09-08T23:46:52.0798099Z  #[cfg(feature = "with-libp2p")]
2025-09-08T23:46:52.0798486Z  pub mod impls {
2025-09-08T23:46:52.0798839Z -    use futures::prelude::*;
2025-09-08T23:46:52.0799599Z      use futures::io::{AsyncRead, AsyncReadExt, AsyncWrite, AsyncWriteExt};
2025-09-08T23:46:52.0800216Z +    use futures::prelude::*;
2025-09-08T23:46:52.0800631Z +    use libp2p::request_response::{
2025-09-08T23:46:52.0801475Z +        Behaviour as RrBehaviour, Codec as RrCodec, Config as RrConfig, Event as RrEvent,
2025-09-08T23:46:52.0802151Z +        Message as RrMessage,
2025-09-08T23:46:52.0802515Z +    };
2025-09-08T23:46:52.0802842Z      use libp2p::{
2025-09-08T23:46:52.0803149Z -        identity,
2025-09-08T23:46:52.0803433Z -        mdns,
2025-09-08T23:46:52.0803717Z -        ping,
2025-09-08T23:46:52.0803994Z -        noise,
2025-09-08T23:46:52.0804267Z -        tcp,
2025-09-08T23:46:52.0804517Z -        yamux,
2025-09-08T23:46:52.0804872Z          core::upgrade,
2025-09-08T23:46:52.0805250Z -        request_response::{self, ProtocolSupport},
2025-09-08T23:46:52.0806399Z          gossipsub::{self, IdentTopic as Topic, MessageAuthenticity, ValidationMode},
2025-09-08T23:46:52.0807366Z -    Multiaddr, PeerId, swarm::{SwarmEvent, Config as SwarmConfig, StreamProtocol}, Transport, Swarm,
2025-09-08T23:46:52.0808133Z +        identity, mdns, noise, ping,
2025-09-08T23:46:52.0808621Z +        request_response::{self, ProtocolSupport},
2025-09-08T23:46:52.0809217Z +        swarm::{Config as SwarmConfig, StreamProtocol, SwarmEvent},
2025-09-08T23:46:52.0809778Z +        tcp, yamux, Multiaddr, PeerId, Swarm, Transport,
2025-09-08T23:46:52.0810210Z      };
2025-09-08T23:46:52.0810991Z -    use libp2p::request_response::{Behaviour as RrBehaviour, Codec as RrCodec, Config as RrConfig, Event as RrEvent, Message as RrMessage};
2025-09-08T23:46:52.0812051Z -    use serde::{Serialize, Deserialize};
2025-09-08T23:46:52.0812735Z -    use std::{collections::{HashMap, VecDeque}, io, time::{Duration, SystemTime, UNIX_EPOCH}};
2025-09-08T23:46:52.0813398Z -    use std::pin::Pin;
2025-09-08T23:46:52.0813792Z +    use serde::{Deserialize, Serialize};
2025-09-08T23:46:52.0814556Z      use sha2::{Digest, Sha256};
2025-09-08T23:46:52.0814959Z +    use std::pin::Pin;
2025-09-08T23:46:52.0815296Z +    use std::{
2025-09-08T23:46:52.0815626Z +        collections::{HashMap, VecDeque},
2025-09-08T23:46:52.0815996Z +        io,
2025-09-08T23:46:52.0816321Z +        time::{Duration, SystemTime, UNIX_EPOCH},
2025-09-08T23:46:52.0816720Z +    };
2025-09-08T23:46:52.0816978Z  
2025-09-08T23:46:52.0817365Z      #[derive(Debug, thiserror::Error)]
2025-09-08T23:46:52.0817843Z -    pub enum Error { #[error("swarm error")] Swarm }
2025-09-08T23:46:52.0818282Z +    pub enum Error {
2025-09-08T23:46:52.0818605Z +        #[error("swarm error")]
2025-09-08T23:46:52.0818941Z +        Swarm,
2025-09-08T23:46:52.0819205Z +    }
2025-09-08T23:46:52.0819438Z  
2025-09-08T23:46:52.0819746Z      #[derive(Clone, Debug)]
2025-09-08T23:46:52.0820156Z      pub struct MeshConfig {
2025-09-08T23:46:52.0820683Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:29:
2025-09-08T23:46:52.0821639Z          pub version: String,
2025-09-08T23:46:52.0822122Z          pub caps: Vec<String>,
2025-09-08T23:46:52.0822598Z          // Discovery parameters
2025-09-08T23:46:52.0823140Z -        pub rendezvous_salt: String,  // salt to derive rotating rendezvous
2025-09-08T23:46:52.0823870Z +        pub rendezvous_salt: String, // salt to derive rotating rendezvous
2025-09-08T23:46:52.0824716Z          pub rendezvous_period_secs: u64, // rotation period
2025-09-08T23:46:52.0825736Z          pub pow_difficulty_prefix_zeros: u8, // number of leading zero bits required in PoW
2025-09-08T23:46:52.0826824Z          pub rate_limit_per_minute: u32, // per-peer rate limit for discovery msgs
2025-09-08T23:46:52.0827552Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:36:
2025-09-08T23:46:52.0828084Z      }
2025-09-08T23:46:52.0828322Z  
2025-09-08T23:46:52.0828755Z      #[derive(Debug, Clone, Serialize, Deserialize)]
2025-09-08T23:46:52.0829366Z -    pub struct CapMsg { pub version: String, pub caps: Vec<String> }
2025-09-08T23:46:52.0829909Z +    pub struct CapMsg {
2025-09-08T23:46:52.0830262Z +        pub version: String,
2025-09-08T23:46:52.0830629Z +        pub caps: Vec<String>,
2025-09-08T23:46:52.0830964Z +    }
2025-09-08T23:46:52.0831202Z  
2025-09-08T23:46:52.0832090Z      #[derive(Clone, Default)]
2025-09-08T23:46:52.0832500Z      struct CapCodec;
2025-09-08T23:46:52.0833026Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:43:
2025-09-08T23:46:52.0833556Z  
2025-09-08T23:46:52.0833910Z      impl RrCodec for CapCodec {
2025-09-08T23:46:52.0834333Z -    type Protocol = StreamProtocol;
2025-09-08T23:46:52.0834782Z +        type Protocol = StreamProtocol;
2025-09-08T23:46:52.0835313Z          type Request = CapMsg;
2025-09-08T23:46:52.0835790Z          type Response = CapMsg;
2025-09-08T23:46:52.0836496Z          fn read_request<'life0, 'life1, 'life2, 'async_trait, T>(
2025-09-08T23:46:52.0837160Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:49:
2025-09-08T23:46:52.0838045Z              &'life0 mut self,
2025-09-08T23:46:52.0838657Z              _p: &'life1 Self::Protocol,
2025-09-08T23:46:52.0839224Z              io: &'life2 mut T,
2025-09-08T23:46:52.0839951Z -        ) -> Pin<Box<dyn futures::Future<Output = Result<Self::Request, io::Error>> + Send + 'async_trait>>
2025-09-08T23:46:52.0840654Z +        ) -> Pin<
2025-09-08T23:46:52.0840963Z +            Box<
2025-09-08T23:46:52.0841751Z +                dyn futures::Future<Output = Result<Self::Request, io::Error>>
2025-09-08T23:46:52.0842333Z +                    + Send
2025-09-08T23:46:52.0842695Z +                    + 'async_trait,
2025-09-08T23:46:52.0843077Z +            >,
2025-09-08T23:46:52.0843359Z +        >
2025-09-08T23:46:52.0843678Z          where
2025-09-08T23:46:52.0844328Z              T: AsyncRead + Unpin + Send + 'async_trait,
2025-09-08T23:46:52.0844949Z              Self: 'async_trait,
2025-09-08T23:46:52.0845526Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:63:
2025-09-08T23:46:52.0846845Z                  let len = u32::from_be_bytes(len_buf) as usize;
2025-09-08T23:46:52.0847635Z                  let mut buf = vec![0u8; len];
2025-09-08T23:46:52.0848462Z                  io.read_exact(&mut buf).await?;
2025-09-08T23:46:52.0849187Z -                serde_json::from_slice(&buf).map_err(|e| io::Error::new(io::ErrorKind::InvalidData, e))
2025-09-08T23:46:52.0849886Z +                serde_json::from_slice(&buf)
2025-09-08T23:46:52.0850446Z +                    .map_err(|e| io::Error::new(io::ErrorKind::InvalidData, e))
2025-09-08T23:46:52.0851019Z              })
2025-09-08T23:46:52.0851507Z          }
2025-09-08T23:46:52.0851781Z  
2025-09-08T23:46:52.0852237Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:71:
2025-09-08T23:46:52.0852919Z              &'life0 mut self,
2025-09-08T23:46:52.0853471Z              _p: &'life1 Self::Protocol,
2025-09-08T23:46:52.0854019Z              io: &'life2 mut T,
2025-09-08T23:46:52.0854701Z -        ) -> Pin<Box<dyn futures::Future<Output = Result<Self::Response, io::Error>> + Send + 'async_trait>>
2025-09-08T23:46:52.0855372Z +        ) -> Pin<
2025-09-08T23:46:52.0855673Z +            Box<
2025-09-08T23:46:52.0856137Z +                dyn futures::Future<Output = Result<Self::Response, io::Error>>
2025-09-08T23:46:52.0856676Z +                    + Send
2025-09-08T23:46:52.0857023Z +                    + 'async_trait,
2025-09-08T23:46:52.0857389Z +            >,
2025-09-08T23:46:52.0857656Z +        >
2025-09-08T23:46:52.0857968Z          where
2025-09-08T23:46:52.0858602Z              T: AsyncRead + Unpin + Send + 'async_trait,
2025-09-08T23:46:52.0859218Z              Self: 'async_trait,
2025-09-08T23:46:52.0859789Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:85:
2025-09-08T23:46:52.0860829Z                  let len = u32::from_be_bytes(len_buf) as usize;
2025-09-08T23:46:52.0861909Z                  let mut buf = vec![0u8; len];
2025-09-08T23:46:52.0862665Z                  io.read_exact(&mut buf).await?;
2025-09-08T23:46:52.0863404Z -                serde_json::from_slice(&buf).map_err(|e| io::Error::new(io::ErrorKind::InvalidData, e))
2025-09-08T23:46:52.0864090Z +                serde_json::from_slice(&buf)
2025-09-08T23:46:52.0864654Z +                    .map_err(|e| io::Error::new(io::ErrorKind::InvalidData, e))
2025-09-08T23:46:52.0865177Z              })
2025-09-08T23:46:52.0865469Z          }
2025-09-08T23:46:52.0865731Z  
2025-09-08T23:46:52.0866186Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:103:
2025-09-08T23:46:52.0866937Z              'life2: 'async_trait,
2025-09-08T23:46:52.0867334Z          {
2025-09-08T23:46:52.0867805Z              Box::pin(async move {
2025-09-08T23:46:52.0868490Z -                let data = serde_json::to_vec(&req).map_err(|e| io::Error::new(io::ErrorKind::InvalidData, e))?;
2025-09-08T23:46:52.0869214Z +                let data = serde_json::to_vec(&req)
2025-09-08T23:46:52.0870014Z +                    .map_err(|e| io::Error::new(io::ErrorKind::InvalidData, e))?;
2025-09-08T23:46:52.0871016Z                  let len = (data.len() as u32).to_be_bytes();
2025-09-08T23:46:52.0871938Z                  io.write_all(&len).await?;
2025-09-08T23:46:52.0872642Z                  io.write_all(&data).await?;
2025-09-08T23:46:52.0873251Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:125:
2025-09-08T23:46:52.0873983Z              'life2: 'async_trait,
2025-09-08T23:46:52.0874388Z          {
2025-09-08T23:46:52.0874851Z              Box::pin(async move {
2025-09-08T23:46:52.0875545Z -                let data = serde_json::to_vec(&resp).map_err(|e| io::Error::new(io::ErrorKind::InvalidData, e))?;
2025-09-08T23:46:52.0876271Z +                let data = serde_json::to_vec(&resp)
2025-09-08T23:46:52.0876853Z +                    .map_err(|e| io::Error::new(io::ErrorKind::InvalidData, e))?;
2025-09-08T23:46:52.0877836Z                  let len = (data.len() as u32).to_be_bytes();
2025-09-08T23:46:52.0878579Z                  io.write_all(&len).await?;
2025-09-08T23:46:52.0879519Z                  io.write_all(&data).await?;
2025-09-08T23:46:52.0880137Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:134:
2025-09-08T23:46:52.0880720Z          }
2025-09-08T23:46:52.0881003Z      }
2025-09-08T23:46:52.0881254Z  
2025-09-08T23:46:52.0882079Z -    fn current_unix() -> u64 { SystemTime::now().duration_since(UNIX_EPOCH).unwrap_or_default().as_secs() }
2025-09-08T23:46:52.0882828Z +    fn current_unix() -> u64 {
2025-09-08T23:46:52.0883228Z +        SystemTime::now()
2025-09-08T23:46:52.0883611Z +            .duration_since(UNIX_EPOCH)
2025-09-08T23:46:52.0884053Z +            .unwrap_or_default()
2025-09-08T23:46:52.0884443Z +            .as_secs()
2025-09-08T23:46:52.0884751Z +    }
2025-09-08T23:46:52.0885003Z  
2025-09-08T23:46:52.0885546Z      fn derive_topic(salt: &str, period: u64, now: u64) -> String {
2025-09-08T23:46:52.0886238Z          let epoch = now / period.max(1);
2025-09-08T23:46:52.0886816Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:141:
2025-09-08T23:46:52.0887513Z          let mut h = Sha256::new();
2025-09-08T23:46:52.0888014Z          h.update(salt.as_bytes());
2025-09-08T23:46:52.0888413Z -    h.update(epoch.to_be_bytes());
2025-09-08T23:46:52.0888829Z +        h.update(epoch.to_be_bytes());
2025-09-08T23:46:52.0889344Z          let digest = h.finalize();
2025-09-08T23:46:52.0890235Z          base32::encode(base32::Alphabet::Crockford, &digest[..16]) // short but stable
2025-09-08T23:46:52.0890810Z      }
2025-09-08T23:46:52.0891251Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:148:
2025-09-08T23:46:52.0892251Z      fn pow_ok(payload: &[u8], nonce: u64, difficulty_bits: u8) -> bool {
2025-09-08T23:46:52.0892900Z          let mut h = Sha256::new();
2025-09-08T23:46:52.0893362Z          h.update(payload);
2025-09-08T23:46:52.0893722Z -    h.update(nonce.to_le_bytes());
2025-09-08T23:46:52.0894124Z +        h.update(nonce.to_le_bytes());
2025-09-08T23:46:52.0894614Z          let d = h.finalize();
2025-09-08T23:46:52.0895486Z          // Count leading zero bits without early returns; always scan full digest
2025-09-08T23:46:52.0896178Z          let mut zeros: u16 = 0;
2025-09-08T23:46:52.0896732Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:155:
2025-09-08T23:46:52.0897425Z          let mut seen_nonzero = 0u8;
2025-09-08T23:46:52.0897880Z          for b in d {
2025-09-08T23:46:52.0898371Z              if seen_nonzero == 0 {
2025-09-08T23:46:52.0898957Z -                if b == 0 { zeros += 8; } else { zeros += b.leading_zeros() as u16; seen_nonzero = 1; }
2025-09-08T23:46:52.0899533Z +                if b == 0 {
2025-09-08T23:46:52.0899891Z +                    zeros += 8;
2025-09-08T23:46:52.0900258Z +                } else {
2025-09-08T23:46:52.0900649Z +                    zeros += b.leading_zeros() as u16;
2025-09-08T23:46:52.0901109Z +                    seen_nonzero = 1;
2025-09-08T23:46:52.0901663Z +                }
2025-09-08T23:46:52.0902051Z              } else {
2025-09-08T23:46:52.0903024Z                  // no-op to keep constant loop body
2025-09-08T23:46:52.0903601Z                  let _ = b;
2025-09-08T23:46:52.0904138Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:165:
2025-09-08T23:46:52.0904694Z      }
2025-09-08T23:46:52.0904936Z  
2025-09-08T23:46:52.0905362Z      #[derive(Debug, Clone, Serialize, Deserialize)]
2025-09-08T23:46:52.0906082Z -    struct DiscoMsg { ts: u64, nonce: u64, peer: String, ver: String, caps: Vec<String> }
2025-09-08T23:46:52.0906700Z +    struct DiscoMsg {
2025-09-08T23:46:52.0907031Z +        ts: u64,
2025-09-08T23:46:52.0907335Z +        nonce: u64,
2025-09-08T23:46:52.0907645Z +        peer: String,
2025-09-08T23:46:52.0907974Z +        ver: String,
2025-09-08T23:46:52.0908303Z +        caps: Vec<String>,
2025-09-08T23:46:52.0908618Z +    }
2025-09-08T23:46:52.0908846Z  
2025-09-08T23:46:52.0909149Z      struct RateLimiter {
2025-09-08T23:46:52.0909713Z          // sliding window per peer of timestamps (secs)
2025-09-08T23:46:52.0910519Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:173:
2025-09-08T23:46:52.0911086Z          limit: u32,
2025-09-08T23:46:52.0911549Z      }
2025-09-08T23:46:52.0911847Z      impl RateLimiter {
2025-09-08T23:46:52.0912312Z -        fn new(limit: u32) -> Self { Self { per_peer: HashMap::new(), limit } }
2025-09-08T23:46:52.0912853Z +        fn new(limit: u32) -> Self {
2025-09-08T23:46:52.0913202Z +            Self {
2025-09-08T23:46:52.0913511Z +                per_peer: HashMap::new(),
2025-09-08T23:46:52.0913874Z +                limit,
2025-09-08T23:46:52.0914151Z +            }
2025-09-08T23:46:52.0914399Z +        }
2025-09-08T23:46:52.0915004Z          fn allow(&mut self, peer: PeerId, now: u64) -> bool {
2025-09-08T23:46:52.0915862Z              let q = self.per_peer.entry(peer).or_default();
2025-09-08T23:46:52.0916606Z -            while let Some(&t) = q.front() { if now.saturating_sub(t) > 60 { q.pop_front(); } else { break; } }
2025-09-08T23:46:52.0917390Z -            if (q.len() as u32) < self.limit { q.push_back(now); true } else { false }
2025-09-08T23:46:52.0917933Z +            while let Some(&t) = q.front() {
2025-09-08T23:46:52.0918349Z +                if now.saturating_sub(t) > 60 {
2025-09-08T23:46:52.0918748Z +                    q.pop_front();
2025-09-08T23:46:52.0919101Z +                } else {
2025-09-08T23:46:52.0919402Z +                    break;
2025-09-08T23:46:52.0919695Z +                }
2025-09-08T23:46:52.0919958Z +            }
2025-09-08T23:46:52.0920263Z +            if (q.len() as u32) < self.limit {
2025-09-08T23:46:52.0920660Z +                q.push_back(now);
2025-09-08T23:46:52.0920994Z +                true
2025-09-08T23:46:52.0921269Z +            } else {
2025-09-08T23:46:52.0921695Z +                false
2025-09-08T23:46:52.0921972Z +            }
2025-09-08T23:46:52.0922239Z          }
2025-09-08T23:46:52.0922496Z      }
2025-09-08T23:46:52.0922731Z  
2025-09-08T23:46:52.0923163Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:184:
2025-09-08T23:46:52.0924032Z      pub async fn start_basic_mesh(cfg: MeshConfig) -> Result<(), Error> {
2025-09-08T23:46:52.0924682Z -    let id_keys = identity::Keypair::generate_ed25519();
2025-09-08T23:46:52.0925233Z -    let peer_id = PeerId::from(id_keys.public());
2025-09-08T23:46:52.0925797Z +        let id_keys = identity::Keypair::generate_ed25519();
2025-09-08T23:46:52.0926366Z +        let peer_id = PeerId::from(id_keys.public());
2025-09-08T23:46:52.0926793Z  
2025-09-08T23:46:52.0927216Z -    let noise_config = noise::Config::new(&id_keys).expect("noise");
2025-09-08T23:46:52.0927882Z +        let noise_config = noise::Config::new(&id_keys).expect("noise");
2025-09-08T23:46:52.0928340Z  
2025-09-08T23:46:52.0928819Z -    let transport = tcp::async_io::Transport::new(tcp::Config::default().nodelay(true))
2025-09-08T23:46:52.0929642Z +        let transport = tcp::async_io::Transport::new(tcp::Config::default().nodelay(true))
2025-09-08T23:46:52.0930736Z              .upgrade(upgrade::Version::V1Lazy)
2025-09-08T23:46:52.0931543Z              .authenticate(noise_config)
2025-09-08T23:46:52.0932215Z              .multiplex(yamux::Config::default())
2025-09-08T23:46:52.0932834Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:194:
2025-09-08T23:46:52.0933465Z              .boxed();
2025-09-08T23:46:52.0933756Z  
2025-09-08T23:46:52.0934228Z          // Request/Response capability protocol
2025-09-08T23:46:52.0935000Z -    let protocols = std::iter::once((StreamProtocol::new("/qnet/cap/1.0.0"), ProtocolSupport::Full));
2025-09-08T23:46:52.0935696Z +        let protocols = std::iter::once((
2025-09-08T23:46:52.0936133Z +            StreamProtocol::new("/qnet/cap/1.0.0"),
2025-09-08T23:46:52.0936558Z +            ProtocolSupport::Full,
2025-09-08T23:46:52.0936907Z +        ));
2025-09-08T23:46:52.0937670Z          let rr_cfg = RrConfig::default().with_request_timeout(Duration::from_secs(10));
2025-09-08T23:46:52.0938418Z -    let rr = request_response::Behaviour::<CapCodec>::new(protocols, rr_cfg);
2025-09-08T23:46:52.0939330Z +        let rr = request_response::Behaviour::<CapCodec>::new(protocols, rr_cfg);
2025-09-08T23:46:52.0939835Z  
2025-09-08T23:46:52.0940381Z -    // Use async-io compatible mDNS behaviour (libp2p-mdns >=0.45 uses runtime-specific modules)
2025-09-08T23:46:52.0941259Z -    let mdns = mdns::async_io::Behaviour::new(mdns::Config::default(), peer_id).expect("mdns");
2025-09-08T23:46:52.0942291Z +        // Use async-io compatible mDNS behaviour (libp2p-mdns >=0.45 uses runtime-specific modules)
2025-09-08T23:46:52.0943182Z +        let mdns = mdns::async_io::Behaviour::new(mdns::Config::default(), peer_id).expect("mdns");
2025-09-08T23:46:52.0943955Z          let ping = ping::Behaviour::default();
2025-09-08T23:46:52.0944326Z  
2025-09-08T23:46:52.0944755Z          // Gossipsub for discovery broadcasting
2025-09-08T23:46:52.0945317Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:208:
2025-09-08T23:46:52.0946155Z              .heartbeat_interval(Duration::from_secs(10))
2025-09-08T23:46:52.0946656Z              .build()
2025-09-08T23:46:52.0947154Z              .expect("gossipsub config");
2025-09-08T23:46:52.0947845Z -    let gsub = gossipsub::Behaviour::new(MessageAuthenticity::Signed(id_keys.clone()), gcfg)
2025-09-08T23:46:52.0948751Z +        let gsub = gossipsub::Behaviour::new(MessageAuthenticity::Signed(id_keys.clone()), gcfg)
2025-09-08T23:46:52.0949564Z              .map_err(|_| Error::Swarm)?;
2025-09-08T23:46:52.0949908Z  
2025-09-08T23:46:52.0950369Z          #[derive(libp2p::swarm::NetworkBehaviour)]
2025-09-08T23:46:52.0950951Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:224:
2025-09-08T23:46:52.0951759Z              request_response: rr,
2025-09-08T23:46:52.0952160Z              mdns,
2025-09-08T23:46:52.0952489Z              ping,
2025-09-08T23:46:52.0953159Z -            identify: libp2p::identify::Behaviour::new(libp2p::identify::Config::new("qnet/0.1".into(), id_keys.public())),
2025-09-08T23:46:52.0954106Z +            identify: libp2p::identify::Behaviour::new(libp2p::identify::Config::new(
2025-09-08T23:46:52.0954659Z +                "qnet/0.1".into(),
2025-09-08T23:46:52.0955023Z +                id_keys.public(),
2025-09-08T23:46:52.0955352Z +            )),
2025-09-08T23:46:52.0955747Z              gossipsub: gsub,
2025-09-08T23:46:52.0956091Z          };
2025-09-08T23:46:52.0956329Z  
2025-09-08T23:46:52.0956788Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:235:
2025-09-08T23:46:52.0957672Z              SwarmConfig::with_async_std_executor(),
2025-09-08T23:46:52.0958139Z          );
2025-09-08T23:46:52.0958398Z  
2025-09-08T23:46:52.0958689Z -    // Dial configured seeds
2025-09-08T23:46:52.0959221Z -        for addr in cfg.seeds.iter().cloned() { let _ = swarm.dial(addr); }
2025-09-08T23:46:52.0959791Z +        // Dial configured seeds
2025-09-08T23:46:52.0960232Z +        for addr in cfg.seeds.iter().cloned() {
2025-09-08T23:46:52.0960682Z +            let _ = swarm.dial(addr);
2025-09-08T23:46:52.0961513Z +        }
2025-09-08T23:46:52.0961805Z  
2025-09-08T23:46:52.0962342Z -    let local_msg = CapMsg { version: cfg.version.clone(), caps: cfg.caps.clone() };
2025-09-08T23:46:52.0962999Z +        let local_msg = CapMsg {
2025-09-08T23:46:52.0963428Z +            version: cfg.version.clone(),
2025-09-08T23:46:52.0963881Z +            caps: cfg.caps.clone(),
2025-09-08T23:46:52.0964464Z +        };
2025-09-08T23:46:52.0964729Z  
2025-09-08T23:46:52.0964998Z -    // Discovery setup
2025-09-08T23:46:52.0965487Z -    let mut rate = RateLimiter::new(cfg.rate_limit_per_minute);
2025-09-08T23:46:52.0966050Z -    let mut last_topic = String::new();
2025-09-08T23:46:52.0966486Z +        // Discovery setup
2025-09-08T23:46:52.0966977Z +        let mut rate = RateLimiter::new(cfg.rate_limit_per_minute);
2025-09-08T23:46:52.0967539Z +        let mut last_topic = String::new();
2025-09-08T23:46:52.0967931Z  
2025-09-08T23:46:52.0968240Z          loop {
2025-09-08T23:46:52.0968836Z              match swarm.select_next_some().await {
2025-09-08T23:46:52.0969656Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:249:
2025-09-08T23:46:52.0971043Z                  SwarmEvent::Behaviour(BehaviourEvent::RequestResponse(ev)) => match ev {
2025-09-08T23:46:52.0972440Z                      RrEvent::Message { peer: _, message } => match message {
2025-09-08T23:46:52.0973519Z                          RrMessage::Request { channel, .. } => {
2025-09-08T23:46:52.0974255Z -                            let _ = swarm.behaviour_mut().request_response.send_response(channel, local_msg.clone());
2025-09-08T23:46:52.0974894Z +                            let _ = swarm
2025-09-08T23:46:52.0975286Z +                                .behaviour_mut()
2025-09-08T23:46:52.0975688Z +                                .request_response
2025-09-08T23:46:52.0976162Z +                                .send_response(channel, local_msg.clone());
2025-09-08T23:46:52.0976778Z                          }
2025-09-08T23:46:52.0977282Z -                        RrMessage::Response { request_id: _, response: _ } => {
2025-09-08T23:46:52.0977820Z +                        RrMessage::Response {
2025-09-08T23:46:52.0978261Z +                            request_id: _,
2025-09-08T23:46:52.0978677Z +                            response: _,
2025-09-08T23:46:52.0979045Z +                        } => {
2025-09-08T23:46:52.0980060Z                              // For PoC, we accept receipt silently.
2025-09-08T23:46:52.0980658Z                          }
2025-09-08T23:46:52.0981113Z                      },
2025-09-08T23:46:52.0986786Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:258:
2025-09-08T23:46:52.0987468Z -                    RrEvent::ResponseSent { .. } => {},
2025-09-08T23:46:52.0987983Z -                    RrEvent::InboundFailure { .. } => {},
2025-09-08T23:46:52.0988472Z -                    RrEvent::OutboundFailure { .. } => {},
2025-09-08T23:46:52.0988965Z +                    RrEvent::ResponseSent { .. } => {}
2025-09-08T23:46:52.0989469Z +                    RrEvent::InboundFailure { .. } => {}
2025-09-08T23:46:52.0989946Z +                    RrEvent::OutboundFailure { .. } => {}
2025-09-08T23:46:52.0990463Z                  },
2025-09-08T23:46:52.0990921Z -                SwarmEvent::Behaviour(BehaviourEvent::Mdns(event)) => {
2025-09-08T23:46:52.0991631Z -                    match event {
2025-09-08T23:46:52.0992101Z -                        mdns::Event::Discovered(list) => {
2025-09-08T23:46:52.0992592Z -                            for (peer, _) in list {
2025-09-08T23:46:52.0993317Z -                                let _ = swarm.behaviour_mut().request_response.send_request(&peer, local_msg.clone());
2025-09-08T23:46:52.0994020Z -                            }
2025-09-08T23:46:52.0994558Z +                SwarmEvent::Behaviour(BehaviourEvent::Mdns(event)) => match event {
2025-09-08T23:46:52.0995210Z +                    mdns::Event::Discovered(list) => {
2025-09-08T23:46:52.0995888Z +                        for (peer, _) in list {
2025-09-08T23:46:52.0996323Z +                            let _ = swarm
2025-09-08T23:46:52.0996762Z +                                .behaviour_mut()
2025-09-08T23:46:52.0997202Z +                                .request_response
2025-09-08T23:46:52.0997716Z +                                .send_request(&peer, local_msg.clone());
2025-09-08T23:46:52.0998313Z                          }
2025-09-08T23:46:52.0998689Z -                        mdns::Event::Expired(_) => {}
2025-09-08T23:46:52.0999192Z                      }
2025-09-08T23:46:52.0999532Z +                    mdns::Event::Expired(_) => {}
2025-09-08T23:46:52.1000001Z                  },
2025-09-08T23:46:52.1000840Z                  SwarmEvent::ConnectionEstablished { peer_id, .. } => {
2025-09-08T23:46:52.1001809Z -                    let _ = swarm.behaviour_mut().request_response.send_request(&peer_id, local_msg.clone());
2025-09-08T23:46:52.1002472Z +                    let _ = swarm
2025-09-08T23:46:52.1002872Z +                        .behaviour_mut()
2025-09-08T23:46:52.1003476Z +                        .request_response
2025-09-08T23:46:52.1003945Z +                        .send_request(&peer_id, local_msg.clone());
2025-09-08T23:46:52.1004453Z                  }
2025-09-08T23:46:52.1004844Z -                SwarmEvent::Behaviour(BehaviourEvent::Gossipsub(
2025-09-08T23:46:52.1005488Z -                    gossipsub::Event::Message { propagation_source, message, .. }
2025-09-08T23:46:52.1006011Z -                )) => {
2025-09-08T23:46:52.1006592Z +                SwarmEvent::Behaviour(BehaviourEvent::Gossipsub(gossipsub::Event::Message {
2025-09-08T23:46:52.1007227Z +                    propagation_source,
2025-09-08T23:46:52.1007626Z +                    message,
2025-09-08T23:46:52.1007952Z +                    ..
2025-09-08T23:46:52.1008259Z +                })) => {
2025-09-08T23:46:52.1009129Z                      // Verify discovery message PoW and rate limit
2025-09-08T23:46:52.1010397Z                      if let Ok(dmsg) = serde_json::from_slice::<DiscoMsg>(&message.data) {
2025-09-08T23:46:52.1011601Z                          let now = current_unix();
2025-09-08T23:46:52.1012203Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:281:
2025-09-08T23:46:52.1013194Z                          // Timestamp within 120s skew
2025-09-08T23:46:52.1013649Z -                        if now.abs_diff(dmsg.ts) <= 120
2025-09-08T23:46:52.1014140Z -                            && rate.allow(propagation_source, now)
2025-09-08T23:46:52.1014577Z -                        {
2025-09-08T23:46:52.1015084Z +                        if now.abs_diff(dmsg.ts) <= 120 && rate.allow(propagation_source, now) {
2025-09-08T23:46:52.1015996Z                              let payload = {
2025-09-08T23:46:52.1016939Z                                  let mut v = Vec::new();
2025-09-08T23:46:52.1018182Z                                  v.extend_from_slice(dmsg.peer.as_bytes());
2025-09-08T23:46:52.1018810Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:288:
2025-09-08T23:46:52.1020168Z                                  v.extend_from_slice(dmsg.ver.as_bytes());
2025-09-08T23:46:52.1020748Z -                                for c in &dmsg.caps { v.extend_from_slice(c.as_bytes()); }
2025-09-08T23:46:52.1021419Z +                                for c in &dmsg.caps {
2025-09-08T23:46:52.1021895Z +                                    v.extend_from_slice(c.as_bytes());
2025-09-08T23:46:52.1022322Z +                                }
2025-09-08T23:46:52.1023591Z                                  v.extend_from_slice(&dmsg.ts.to_le_bytes());
2025-09-08T23:46:52.1024324Z                                  v
2025-09-08T23:46:52.1024896Z                              };
2025-09-08T23:46:52.1025436Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:297:
2025-09-08T23:46:52.1026124Z                          }
2025-09-08T23:46:52.1026555Z                      }
2025-09-08T23:46:52.1026924Z                  }
2025-09-08T23:46:52.1027874Z -                SwarmEvent::NewListenAddr { .. } | SwarmEvent::ListenerClosed { .. } | SwarmEvent::OutgoingConnectionError { .. } => {}
2025-09-08T23:46:52.1028723Z +                SwarmEvent::NewListenAddr { .. }
2025-09-08T23:46:52.1029020Z +                | SwarmEvent::ListenerClosed { .. }
2025-09-08T23:46:52.1029349Z +                | SwarmEvent::OutgoingConnectionError { .. } => {}
2025-09-08T23:46:52.1029692Z                  _ => {}
2025-09-08T23:46:52.1029909Z              }
2025-09-08T23:46:52.1030062Z  
2025-09-08T23:46:52.1030324Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:307:
2025-09-08T23:46:52.1030764Z              if topic_str != last_topic {
2025-09-08T23:46:52.1031201Z                  // Unsubscribe previous, subscribe new
2025-09-08T23:46:52.1031844Z                  if !last_topic.is_empty() {
2025-09-08T23:46:52.1032272Z -                    let _ = swarm.behaviour_mut().gossipsub.unsubscribe(&Topic::new(last_topic.clone()));
2025-09-08T23:46:52.1032666Z +                    let _ = swarm
2025-09-08T23:46:52.1033031Z +                        .behaviour_mut()
2025-09-08T23:46:52.1033278Z +                        .gossipsub
2025-09-08T23:46:52.1033551Z +                        .unsubscribe(&Topic::new(last_topic.clone()));
2025-09-08T23:46:52.1033859Z                  }
2025-09-08T23:46:52.1034261Z                  let topic = Topic::new(topic_str.clone());
2025-09-08T23:46:52.1034838Z                  let _ = swarm.behaviour_mut().gossipsub.subscribe(&topic);
2025-09-08T23:46:52.1035232Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:326:
2025-09-08T23:46:52.1035702Z                      let mut v = Vec::new();
2025-09-08T23:46:52.1036174Z                      v.extend_from_slice(peer.as_bytes());
2025-09-08T23:46:52.1036649Z                      v.extend_from_slice(ver.as_bytes());
2025-09-08T23:46:52.1036955Z -                    for c in &caps { v.extend_from_slice(c.as_bytes()); }
2025-09-08T23:46:52.1037234Z +                    for c in &caps {
2025-09-08T23:46:52.1037494Z +                        v.extend_from_slice(c.as_bytes());
2025-09-08T23:46:52.1037732Z +                    }
2025-09-08T23:46:52.1038162Z                      v.extend_from_slice(&ts.to_le_bytes());
2025-09-08T23:46:52.1038464Z                      v
2025-09-08T23:46:52.1038670Z                  };
2025-09-08T23:46:52.1038942Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:333:
2025-09-08T23:46:52.1039367Z                  while nonce < 10_000 {
2025-09-08T23:46:52.1039689Z -                    if pow_ok(&pre, nonce, cfg.pow_difficulty_prefix_zeros) { break; }
2025-09-08T23:46:52.1039835Z +                    if pow_ok(&pre, nonce, cfg.pow_difficulty_prefix_zeros) {
2025-09-08T23:46:52.1039917Z +                        break;
2025-09-08T23:46:52.1039985Z +                    }
2025-09-08T23:46:52.1040163Z                      nonce += 1;
2025-09-08T23:46:52.1040267Z                  }
2025-09-08T23:46:52.1040403Z -                let msg = DiscoMsg { ts, nonce, peer, ver, caps };
2025-09-08T23:46:52.1040495Z +                let msg = DiscoMsg {
2025-09-08T23:46:52.1040569Z +                    ts,
2025-09-08T23:46:52.1040646Z +                    nonce,
2025-09-08T23:46:52.1040718Z +                    peer,
2025-09-08T23:46:52.1040787Z +                    ver,
2025-09-08T23:46:52.1040857Z +                    caps,
2025-09-08T23:46:52.1040929Z +                };
2025-09-08T23:46:52.1041238Z                  serde_json::to_vec(&msg).unwrap_or_default()
2025-09-08T23:46:52.1041497Z              };
2025-09-08T23:46:52.1041692Z              if !last_topic.is_empty() {
2025-09-08T23:46:52.1041867Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:341:
2025-09-08T23:46:52.1042120Z -                let _ = swarm.behaviour_mut().gossipsub.publish(Topic::new(last_topic.clone()), payload);
2025-09-08T23:46:52.1042205Z +                let _ = swarm
2025-09-08T23:46:52.1042287Z +                    .behaviour_mut()
2025-09-08T23:46:52.1042364Z +                    .gossipsub
2025-09-08T23:46:52.1042624Z +                    .publish(Topic::new(last_topic.clone()), payload);
2025-09-08T23:46:52.1042722Z              }
2025-09-08T23:46:52.1042799Z          }
2025-09-08T23:46:52.1042867Z      }
2025-09-08T23:46:52.1043044Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:347:
2025-09-08T23:46:52.1043153Z  #[cfg(not(feature = "with-libp2p"))]
2025-09-08T23:46:52.1043227Z  pub mod stub {
2025-09-08T23:46:52.1043359Z      #[derive(Debug, thiserror::Error)]
2025-09-08T23:46:52.1043501Z -    pub enum Error { #[error("libp2p disabled")] Disabled }
2025-09-08T23:46:52.1043575Z +    pub enum Error {
2025-09-08T23:46:52.1043663Z +        #[error("libp2p disabled")]
2025-09-08T23:46:52.1043735Z +        Disabled,
2025-09-08T23:46:52.1043796Z +    }
2025-09-08T23:46:52.1043908Z      #[derive(Clone, Debug)]
2025-09-08T23:46:52.1044017Z      pub struct MeshConfig {
2025-09-08T23:46:52.1044157Z          pub seeds: Vec<String>,
2025-09-08T23:46:52.1044329Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:358:
2025-09-08T23:46:52.1044619Z          pub pow_difficulty_prefix_zeros: u8,
2025-09-08T23:46:52.1044780Z          pub rate_limit_per_minute: u32,
2025-09-08T23:46:52.1044847Z      }
2025-09-08T23:46:52.1045093Z -    pub async fn start_basic_mesh(_cfg: MeshConfig) -> Result<(), Error> { Err(Error::Disabled) }
2025-09-08T23:46:52.1045267Z +    pub async fn start_basic_mesh(_cfg: MeshConfig) -> Result<(), Error> {
2025-09-08T23:46:52.1045348Z +        Err(Error::Disabled)
2025-09-08T23:46:52.1045410Z +    }
2025-09-08T23:46:52.1045469Z  }
2025-09-08T23:46:52.1045532Z  
2025-09-08T23:46:52.1045602Z  #[cfg(test)]
2025-09-08T23:46:52.1045769Z Diff in /home/runner/work/qnet/qnet/crates/core-mesh/src/lib.rs:365:
2025-09-08T23:46:52.1045843Z  mod tests {
2025-09-08T23:46:52.1045927Z      #[test]
2025-09-08T23:46:52.1046052Z -    fn compiles() { /* smoke test placeholder */ }
2025-09-08T23:46:52.1046159Z +    fn compiles() { /* smoke test placeholder */
2025-09-08T23:46:52.1046236Z +    }
2025-09-08T23:46:52.1046295Z  }
2025-09-08T23:46:52.1046352Z  
2025-09-08T23:46:52.1046522Z Diff in /home/runner/work/qnet/qnet/crates/core-mix/src/lib.rs:1:
2025-09-08T23:46:52.1046616Z -use serde::{Serialize, Deserialize};
2025-09-08T23:46:52.1046708Z +use serde::{Deserialize, Serialize};
2025-09-08T23:46:52.1046798Z  use sha2::{Digest, Sha256};
2025-09-08T23:46:52.1046862Z  
2025-09-08T23:46:52.1047045Z  #[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq, Hash)]
2025-09-08T23:46:52.1047206Z Diff in /home/runner/work/qnet/qnet/crates/core-mix/src/lib.rs:5:
2025-09-08T23:46:52.1047301Z -pub struct NodeId(pub [u8;32]);
2025-09-08T23:46:52.1047388Z +pub struct NodeId(pub [u8; 32]);
2025-09-08T23:46:52.1047446Z  
2025-09-08T23:46:52.1047573Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-09-08T23:46:52.1047659Z  pub struct BeaconSet {
2025-09-08T23:46:52.1047874Z Diff in /home/runner/work/qnet/qnet/crates/core-mix/src/lib.rs:18:
2025-09-08T23:46:52.1047932Z  }
2025-09-08T23:46:52.1048005Z  
2025-09-08T23:46:52.1048098Z  impl DiversityTracker {
2025-09-08T23:46:52.1048359Z -    pub fn new(max_keep: usize) -> Self { Self { recent: std::collections::VecDeque::new(), max_keep } }
2025-09-08T23:46:52.1048465Z +    pub fn new(max_keep: usize) -> Self {
2025-09-08T23:46:52.1048532Z +        Self {
2025-09-08T23:46:52.1048647Z +            recent: std::collections::VecDeque::new(),
2025-09-08T23:46:52.1048717Z +            max_keep,
2025-09-08T23:46:52.1048790Z +        }
2025-09-08T23:46:52.1048851Z +    }
2025-09-08T23:46:52.1049124Z      pub fn record(&mut self, src: &NodeId, dst: &NodeId, epoch: u64, idx: usize) {
2025-09-08T23:46:52.1049294Z -        self.recent.push_back((src.clone(), dst.clone(), epoch, idx));
2025-09-08T23:46:52.1049473Z -        while self.recent.len() > self.max_keep { self.recent.pop_front(); }
2025-09-08T23:46:52.1049545Z +        self.recent
2025-09-08T23:46:52.1049678Z +            .push_back((src.clone(), dst.clone(), epoch, idx));
2025-09-08T23:46:52.1049904Z +        while self.recent.len() > self.max_keep {
2025-09-08T23:46:52.1050002Z +            self.recent.pop_front();
2025-09-08T23:46:52.1050064Z +        }
2025-09-08T23:46:52.1050141Z      }
2025-09-08T23:46:52.1050412Z      pub fn seen(&self, src: &NodeId, dst: &NodeId, epoch: u64, idx: usize) -> bool {
2025-09-08T23:46:52.1050590Z -        self.recent.iter().any(|(s,d,e,i)| s==src && d==dst && *e==epoch && *i==idx)
2025-09-08T23:46:52.1050668Z +        self.recent
2025-09-08T23:46:52.1050735Z +            .iter()
2025-09-08T23:46:52.1050872Z +            .any(|(s, d, e, i)| s == src && d == dst && *e == epoch && *i == idx)
2025-09-08T23:46:52.1050944Z      }
2025-09-08T23:46:52.1051003Z  }
2025-09-08T23:46:52.1051061Z  
2025-09-08T23:46:52.1051237Z Diff in /home/runner/work/qnet/qnet/crates/core-mix/src/lib.rs:31:
2025-09-08T23:46:52.1051656Z  pub fn vrf_select(src: &NodeId, dst: &NodeId, epoch: u64, set: &BeaconSet) -> Option<usize> {
2025-09-08T23:46:52.1051774Z -    if set.nodes.is_empty() { return None; }
2025-09-08T23:46:52.1051987Z +    if set.nodes.is_empty() {
2025-09-08T23:46:52.1052064Z +        return None;
2025-09-08T23:46:52.1052126Z +    }
2025-09-08T23:46:52.1052240Z      let mut h = Sha256::new();
2025-09-08T23:46:52.1052333Z      h.update(src.0);
2025-09-08T23:46:52.1052429Z      h.update(dst.0);
2025-09-08T23:46:52.1052601Z Diff in /home/runner/work/qnet/qnet/crates/core-mix/src/lib.rs:44:
2025-09-08T23:46:52.1052674Z  mod tests {
2025-09-08T23:46:52.1052771Z      use super::*;
2025-09-08T23:46:52.1052830Z  
2025-09-08T23:46:52.1052973Z -    fn id(n: u8) -> NodeId { let mut a=[0u8;32]; a[0]=n; NodeId(a) }
2025-09-08T23:46:52.1053060Z +    fn id(n: u8) -> NodeId {
2025-09-08T23:46:52.1053138Z +        let mut a = [0u8; 32];
2025-09-08T23:46:52.1053205Z +        a[0] = n;
2025-09-08T23:46:52.1053271Z +        NodeId(a)
2025-09-08T23:46:52.1053340Z +    }
2025-09-08T23:46:52.1053398Z  
2025-09-08T23:46:52.1053474Z      #[test]
2025-09-08T23:46:52.1053604Z      fn deterministic_selection() {
2025-09-08T23:46:52.1053786Z Diff in /home/runner/work/qnet/qnet/crates/core-mix/src/lib.rs:51:
2025-09-08T23:46:52.1053966Z -        let set = BeaconSet { epoch: 1, nodes: vec![id(1), id(2), id(3), id(4)] };
2025-09-08T23:46:52.1054054Z -        let a = id(9); let b = id(5);
2025-09-08T23:46:52.1054141Z +        let set = BeaconSet {
2025-09-08T23:46:52.1054212Z +            epoch: 1,
2025-09-08T23:46:52.1054313Z +            nodes: vec![id(1), id(2), id(3), id(4)],
2025-09-08T23:46:52.1054382Z +        };
2025-09-08T23:46:52.1054454Z +        let a = id(9);
2025-09-08T23:46:52.1054524Z +        let b = id(5);
2025-09-08T23:46:52.1054732Z          let i1 = vrf_select(&a, &b, 42, &set).unwrap();
2025-09-08T23:46:52.1054936Z          let i2 = vrf_select(&a, &b, 42, &set).unwrap();
2025-09-08T23:46:52.1055060Z          assert_eq!(i1, i2);
2025-09-08T23:46:52.1055225Z Diff in /home/runner/work/qnet/qnet/crates/core-mix/src/lib.rs:58:
2025-09-08T23:46:52.1055306Z      #[test]
2025-09-08T23:46:52.1055422Z      fn diversity_tracking() {
2025-09-08T23:46:52.1055612Z          let mut dt = DiversityTracker::new(8);
2025-09-08T23:46:52.1055779Z -        let set = BeaconSet { epoch: 7, nodes: vec![id(1), id(2), id(3)] };
2025-09-08T23:46:52.1055867Z -        let a = id(10); let b = id(11);
2025-09-08T23:46:52.1055946Z +        let set = BeaconSet {
2025-09-08T23:46:52.1056016Z +            epoch: 7,
2025-09-08T23:46:52.1056113Z +            nodes: vec![id(1), id(2), id(3)],
2025-09-08T23:46:52.1056176Z +        };
2025-09-08T23:46:52.1056248Z +        let a = id(10);
2025-09-08T23:46:52.1056326Z +        let b = id(11);
2025-09-08T23:46:52.1056566Z          let idx = vrf_select(&a, &b, set.epoch, &set).unwrap();
2025-09-08T23:46:52.1056680Z -        assert!(!dt.seen(&a,&b,set.epoch,idx));
2025-09-08T23:46:52.1056776Z -        dt.record(&a,&b,set.epoch,idx);
2025-09-08T23:46:52.1056883Z -        assert!(dt.seen(&a,&b,set.epoch,idx));
2025-09-08T23:46:52.1056988Z +        assert!(!dt.seen(&a, &b, set.epoch, idx));
2025-09-08T23:46:52.1057196Z +        dt.record(&a, &b, set.epoch, idx);
2025-09-08T23:46:52.1057307Z +        assert!(dt.seen(&a, &b, set.epoch, idx));
2025-09-08T23:46:52.1057377Z      }
2025-09-08T23:46:52.1057435Z  }
2025-09-08T23:46:52.1057497Z  
2025-09-08T23:46:52.1057674Z Diff in /home/runner/work/qnet/qnet/crates/core-routing/src/lib.rs:6:
2025-09-08T23:46:52.1057733Z  
2025-09-08T23:46:52.1057833Z  #[derive(Debug, thiserror::Error)]
2025-09-08T23:46:52.1057914Z  pub enum Error {
2025-09-08T23:46:52.1058004Z -    #[error("crypto error")] Crypto,
2025-09-08T23:46:52.1058100Z -    #[error("invalid structure")] Invalid,
2025-09-08T23:46:52.1058187Z +    #[error("crypto error")]
2025-09-08T23:46:52.1058252Z +    Crypto,
2025-09-08T23:46:52.1058337Z +    #[error("invalid structure")]
2025-09-08T23:46:52.1058402Z +    Invalid,
2025-09-08T23:46:52.1058465Z  }
2025-09-08T23:46:52.1058522Z  
2025-09-08T23:46:52.1058689Z  #[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]
2025-09-08T23:46:52.1058884Z Diff in /home/runner/work/qnet/qnet/crates/core-routing/src/lib.rs:14:
2025-09-08T23:46:52.1059086Z  pub struct Hop {
2025-09-08T23:46:52.1059195Z -    pub as_id: u64,        // Autonomous System ID
2025-09-08T23:46:52.1059293Z -    pub if_in: u16,        // ingress interface
2025-09-08T23:46:52.1059394Z -    pub if_out: u16,       // egress interface
2025-09-08T23:46:52.1059489Z -    pub ts: u64,           // timestamp seconds
2025-09-08T23:46:52.1059603Z -    pub exp: u32,          // expiry seconds from ts
2025-09-08T23:46:52.1059706Z +    pub as_id: u64,  // Autonomous System ID
2025-09-08T23:46:52.1059797Z +    pub if_in: u16,  // ingress interface
2025-09-08T23:46:52.1059886Z +    pub if_out: u16, // egress interface
2025-09-08T23:46:52.1059979Z +    pub ts: u64,     // timestamp seconds
2025-09-08T23:46:52.1060076Z +    pub exp: u32,    // expiry seconds from ts
2025-09-08T23:46:52.1060133Z  }
2025-09-08T23:46:52.1060190Z  
2025-09-08T23:46:52.1060364Z  #[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]
2025-09-08T23:46:52.1060548Z Diff in /home/runner/work/qnet/qnet/crates/core-routing/src/lib.rs:23:
2025-09-08T23:46:52.1060629Z  pub struct Segment {
2025-09-08T23:46:52.1060729Z      pub version: u8,
2025-09-08T23:46:52.1060833Z      pub hops: Vec<Hop>,
2025-09-08T23:46:52.1061047Z -    #[serde(with = "serde_bytes")] pub prev_sig: Vec<u8>, // aggregate or prev signer proof
2025-09-08T23:46:52.1061131Z +    #[serde(with = "serde_bytes")]
2025-09-08T23:46:52.1061275Z +    pub prev_sig: Vec<u8>, // aggregate or prev signer proof
2025-09-08T23:46:52.1061575Z  }
2025-09-08T23:46:52.1061641Z  
2025-09-08T23:46:52.1061825Z  #[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]
2025-09-08T23:46:52.1062009Z Diff in /home/runner/work/qnet/qnet/crates/core-routing/src/lib.rs:30:
2025-09-08T23:46:52.1062101Z  pub struct SignedSegment {
2025-09-08T23:46:52.1062202Z      pub seg: Segment,
2025-09-08T23:46:52.1062316Z -    #[serde(with = "serde_bytes")] pub sig: Vec<u8>,
2025-09-08T23:46:52.1062468Z -    #[serde(with = "serde_bytes")] pub pubkey: Vec<u8>, // ed25519
2025-09-08T23:46:52.1062557Z +    #[serde(with = "serde_bytes")]
2025-09-08T23:46:52.1062637Z +    pub sig: Vec<u8>,
2025-09-08T23:46:52.1062717Z +    #[serde(with = "serde_bytes")]
2025-09-08T23:46:52.1062802Z +    pub pubkey: Vec<u8>, // ed25519
2025-09-08T23:46:52.1062864Z  }
2025-09-08T23:46:52.1062921Z  
2025-09-08T23:46:52.1062995Z  impl Segment {
2025-09-08T23:46:52.1063173Z Diff in /home/runner/work/qnet/qnet/crates/core-routing/src/lib.rs:37:
2025-09-08T23:46:52.1063425Z      pub fn new(version: u8, hops: Vec<Hop>, prev_sig: Vec<u8>) -> Self {
2025-09-08T23:46:52.1063519Z -        Self { version, hops, prev_sig }
2025-09-08T23:46:52.1063585Z +        Self {
2025-09-08T23:46:52.1063658Z +            version,
2025-09-08T23:46:52.1063724Z +            hops,
2025-09-08T23:46:52.1063793Z +            prev_sig,
2025-09-08T23:46:52.1063864Z +        }
2025-09-08T23:46:52.1063935Z      }
2025-09-08T23:46:52.1063992Z  
2025-09-08T23:46:52.1064262Z      fn canonical_bytes(&self) -> Vec<u8> {
2025-09-08T23:46:52.1064457Z Diff in /home/runner/work/qnet/qnet/crates/core-routing/src/lib.rs:49:
2025-09-08T23:46:52.1064659Z          // Derive public key from seed for embedding
2025-09-08T23:46:52.1065046Z          let kp = ring::signature::Ed25519KeyPair::from_seed_unchecked(seed32).expect("seed");
2025-09-08T23:46:52.1065250Z          let pk = kp.public_key().as_ref().to_vec();
2025-09-08T23:46:52.1065384Z -        SignedSegment { seg: self.clone(), sig, pubkey: pk }
2025-09-08T23:46:52.1065461Z +        SignedSegment {
2025-09-08T23:46:52.1065545Z +            seg: self.clone(),
2025-09-08T23:46:52.1065611Z +            sig,
2025-09-08T23:46:52.1065684Z +            pubkey: pk,
2025-09-08T23:46:52.1065747Z +        }
2025-09-08T23:46:52.1065822Z      }
2025-09-08T23:46:52.1065878Z  }
2025-09-08T23:46:52.1065934Z  
2025-09-08T23:46:52.1066111Z Diff in /home/runner/work/qnet/qnet/crates/core-routing/src/lib.rs:56:
2025-09-08T23:46:52.1066198Z  impl SignedSegment {
2025-09-08T23:46:52.1066500Z      pub fn verify(&self, now_ts: u64) -> Result<(), Error> {
2025-09-08T23:46:52.1066644Z          // Basic structure checks
2025-09-08T23:46:52.1066793Z -        if self.seg.version != 1 { return Err(Error::Invalid); }
2025-09-08T23:46:52.1066954Z -        if self.seg.hops.is_empty() { return Err(Error::Invalid); }
2025-09-08T23:46:52.1067040Z +        if self.seg.version != 1 {
2025-09-08T23:46:52.1067136Z +            return Err(Error::Invalid);
2025-09-08T23:46:52.1067200Z +        }
2025-09-08T23:46:52.1067291Z +        if self.seg.hops.is_empty() {
2025-09-08T23:46:52.1067378Z +            return Err(Error::Invalid);
2025-09-08T23:46:52.1067445Z +        }
2025-09-08T23:46:52.1067676Z          // Timestamp/expiry bounds (check last hop window)
2025-09-08T23:46:52.1067869Z          let last = self.seg.hops.last().unwrap();
2025-09-08T23:46:52.1067997Z -        if now_ts < last.ts { return Err(Error::Invalid); }
2025-09-08T23:46:52.1068212Z -        if now_ts > last.ts.saturating_add(last.exp as u64) { return Err(Error::Invalid); }
2025-09-08T23:46:52.1068296Z +        if now_ts < last.ts {
2025-09-08T23:46:52.1068388Z +            return Err(Error::Invalid);
2025-09-08T23:46:52.1068450Z +        }
2025-09-08T23:46:52.1068577Z +        if now_ts > last.ts.saturating_add(last.exp as u64) {
2025-09-08T23:46:52.1068663Z +            return Err(Error::Invalid);
2025-09-08T23:46:52.1068729Z +        }
2025-09-08T23:46:52.1068914Z          // Verify signature over canonical bytes
2025-09-08T23:46:52.1069220Z          let msg = serde_json::to_vec(&self.seg).map_err(|_| Error::Invalid)?;
2025-09-08T23:46:52.1069593Z          crypto::ed25519::verify(&self.pubkey, &msg, &self.sig).map_err(|_| Error::Crypto)
2025-09-08T23:46:52.1069773Z Diff in /home/runner/work/qnet/qnet/crates/core-routing/src/lib.rs:74:
2025-09-08T23:46:52.1069833Z  
2025-09-08T23:46:52.1069915Z      #[test]
2025-09-08T23:46:52.1070054Z      fn segment_sign_verify_and_bounds() {
2025-09-08T23:46:52.1070220Z -        let hop = Hop { as_id: 42, if_in: 1, if_out: 2, ts: 1_700_000_000, exp: 600 };
2025-09-08T23:46:52.1070303Z +        let hop = Hop {
2025-09-08T23:46:52.1070380Z +            as_id: 42,
2025-09-08T23:46:52.1070448Z +            if_in: 1,
2025-09-08T23:46:52.1070519Z +            if_out: 2,
2025-09-08T23:46:52.1070597Z +            ts: 1_700_000_000,
2025-09-08T23:46:52.1070666Z +            exp: 600,
2025-09-08T23:46:52.1070728Z +        };
2025-09-08T23:46:52.1070966Z          let seg = Segment::new(1, vec![hop.clone()], vec![]);
2025-09-08T23:46:52.1071091Z          let seed = [9u8; 32];
2025-09-08T23:46:52.1071264Z          let signed = seg.sign_ed25519(&seed);
2025-09-08T23:46:52.1071684Z Diff in /home/runner/work/qnet/qnet/crates/htx/examples/dial_tls_demo.rs:6:
2025-09-08T23:46:52.1071785Z      use std::env;
2025-09-08T23:46:52.1072072Z      // No I/O against the remote since it won't speak HTX; we just demo connecting.
2025-09-08T23:46:52.1072131Z  
2025-09-08T23:46:52.1072485Z -    let origin = env::args().nth(1).unwrap_or_else(|| "https://example.com".to_string());
2025-09-08T23:46:52.1072580Z +    let origin = env::args()
2025-09-08T23:46:52.1072647Z +        .nth(1)
2025-09-08T23:46:52.1072790Z +        .unwrap_or_else(|| "https://example.com".to_string());
2025-09-08T23:46:52.1072928Z      println!("dialing {origin} ...");
2025-09-08T23:46:52.1073065Z      let conn = match api::dial(&origin) {
2025-09-08T23:46:52.1073168Z          Ok(c) => c,
2025-09-08T23:46:52.1073386Z Diff in /home/runner/work/qnet/qnet/crates/htx/examples/tls_mirror_demo.rs:1:
2025-09-08T23:46:52.1073576Z -use htx::tls_mirror::{MirrorCache, calibrate, build_client_hello, Config};
2025-09-08T23:46:52.1073752Z +use htx::tls_mirror::{build_client_hello, calibrate, Config, MirrorCache};
2025-09-08T23:46:52.1073843Z  use std::time::Duration;
2025-09-08T23:46:52.1073900Z  
2025-09-08T23:46:52.1073969Z  fn main() {
2025-09-08T23:46:52.1074174Z Diff in /home/runner/work/qnet/qnet/crates/htx/examples/tls_mirror_demo.rs:5:
2025-09-08T23:46:52.1074498Z -    let origin = std::env::args().nth(1).unwrap_or_else(|| "https://example.com".into());
2025-09-08T23:46:52.1074660Z -    let mut cache = MirrorCache::new(Duration::from_secs(24*60*60));
2025-09-08T23:46:52.1074746Z +    let origin = std::env::args()
2025-09-08T23:46:52.1074816Z +        .nth(1)
2025-09-08T23:46:52.1074944Z +        .unwrap_or_else(|| "https://example.com".into());
2025-09-08T23:46:52.1075110Z +    let mut cache = MirrorCache::new(Duration::from_secs(24 * 60 * 60));
2025-09-08T23:46:52.1075234Z      let cfg = Config::default();
2025-09-08T23:46:52.1075531Z      let (tid, tpl) = calibrate(&origin, Some(&mut cache), Some(&cfg)).expect("calibrate");
2025-09-08T23:46:52.1075672Z      let client = build_client_hello(&tpl);
2025-09-08T23:46:52.1076601Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:1:
2025-09-08T23:46:52.1077005Z -use crate::inner::{Caps, TlsStream, Exporter, open_inner, open_inner_with_compat};
2025-09-08T23:46:52.1077402Z +use crate::inner::{open_inner, open_inner_with_compat, Caps, Exporter, TlsStream};
2025-09-08T23:46:52.1078743Z +use crate::mux::{self, Mux, StreamHandle};
2025-09-08T23:46:52.1079273Z  use crate::tls_mirror::Template;
2025-09-08T23:46:52.1079679Z  use crate::Handshake;
2025-09-08T23:46:52.1080156Z -use crate::mux::{self, Mux, StreamHandle};
2025-09-08T23:46:52.1080706Z +use bytes::Bytes;
2025-09-08T23:46:52.1081145Z  use core_crypto as crypto;
2025-09-08T23:46:52.1081777Z  use curve25519_dalek::constants::X25519_BASEPOINT;
2025-09-08T23:46:52.1082367Z  use curve25519_dalek::scalar::Scalar;
2025-09-08T23:46:52.1082938Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:11:
2025-09-08T23:46:52.1083709Z  use std::sync::mpsc;
2025-09-08T23:46:52.1084107Z  use std::thread;
2025-09-08T23:46:52.1084518Z  use std::time::Duration;
2025-09-08T23:46:52.1085038Z -use bytes::Bytes;
2025-09-08T23:46:52.1085371Z  
2025-09-08T23:46:52.1085706Z  #[derive(Clone)]
2025-09-08T23:46:52.1086075Z  pub struct Conn {
2025-09-08T23:46:52.1086595Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:18:
2025-09-08T23:46:52.1087271Z      mux: Mux,
2025-09-08T23:46:52.1087431Z -    tx_key: [u8;32],
2025-09-08T23:46:52.1087561Z -    rx_key: [u8;32],
2025-09-08T23:46:52.1087691Z +    tx_key: [u8; 32],
2025-09-08T23:46:52.1087825Z +    rx_key: [u8; 32],
2025-09-08T23:46:52.1087934Z  }
2025-09-08T23:46:52.1088035Z  
2025-09-08T23:46:52.1088248Z  pub struct SecureStream {
2025-09-08T23:46:52.1088546Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:24:
2025-09-08T23:46:52.1088838Z      inner: StreamHandle,
2025-09-08T23:46:52.1088976Z -    tx_key: [u8;32],
2025-09-08T23:46:52.1089113Z -    rx_key: [u8;32],
2025-09-08T23:46:52.1089238Z +    tx_key: [u8; 32],
2025-09-08T23:46:52.1089441Z +    rx_key: [u8; 32],
2025-09-08T23:46:52.1089796Z      send_ctr: std::sync::Arc<std::sync::atomic::AtomicU64>,
2025-09-08T23:46:52.1089990Z      recv_ctr: std::sync::Arc<std::sync::atomic::AtomicU64>,
2025-09-08T23:46:52.1090162Z  }
2025-09-08T23:46:52.1090639Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:41:
2025-09-08T23:46:52.1090870Z      }
2025-09-08T23:46:52.1091265Z  
2025-09-08T23:46:52.1091897Z      pub fn accept_stream(&self, timeout_ms: u64) -> Option<SecureStream> {
2025-09-08T23:46:52.1092363Z -        self.mux.accept_stream(std::time::Duration::from_millis(timeout_ms)).map(|sh| SecureStream {
2025-09-08T23:46:52.1092509Z -            inner: sh,
2025-09-08T23:46:52.1092668Z -            tx_key: self.tx_key,
2025-09-08T23:46:52.1092814Z -            rx_key: self.rx_key,
2025-09-08T23:46:52.1093127Z -            send_ctr: std::sync::Arc::new(std::sync::atomic::AtomicU64::new(0)),
2025-09-08T23:46:52.1093425Z -            recv_ctr: std::sync::Arc::new(std::sync::atomic::AtomicU64::new(0)),
2025-09-08T23:46:52.1093538Z -        })
2025-09-08T23:46:52.1093655Z +        self.mux
2025-09-08T23:46:52.1093941Z +            .accept_stream(std::time::Duration::from_millis(timeout_ms))
2025-09-08T23:46:52.1094094Z +            .map(|sh| SecureStream {
2025-09-08T23:46:52.1094455Z +                inner: sh,
2025-09-08T23:46:52.1094620Z +                tx_key: self.tx_key,
2025-09-08T23:46:52.1094771Z +                rx_key: self.rx_key,
2025-09-08T23:46:52.1095077Z +                send_ctr: std::sync::Arc::new(std::sync::atomic::AtomicU64::new(0)),
2025-09-08T23:46:52.1095378Z +                recv_ctr: std::sync::Arc::new(std::sync::atomic::AtomicU64::new(0)),
2025-09-08T23:46:52.1095507Z +            })
2025-09-08T23:46:52.1095634Z      }
2025-09-08T23:46:52.1095745Z  
2025-09-08T23:46:52.1095985Z -    pub fn key_update(&self) { self.mux.key_update(); }
2025-09-08T23:46:52.1096145Z +    pub fn key_update(&self) {
2025-09-08T23:46:52.1096298Z +        self.mux.key_update();
2025-09-08T23:46:52.1096412Z +    }
2025-09-08T23:46:52.1096521Z  
2025-09-08T23:46:52.1096857Z -    pub fn encryption_epoch(&self) -> u64 { self.mux.encryption_epoch() }
2025-09-08T23:46:52.1097047Z +    pub fn encryption_epoch(&self) -> u64 {
2025-09-08T23:46:52.1097229Z +        self.mux.encryption_epoch()
2025-09-08T23:46:52.1097350Z +    }
2025-09-08T23:46:52.1097453Z  }
2025-09-08T23:46:52.1097562Z  
2025-09-08T23:46:52.1097719Z  impl SecureStream {
2025-09-08T23:46:52.1098002Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:59:
2025-09-08T23:46:52.1098186Z -    fn next_nonce(counter: u64) -> [u8;12] {
2025-09-08T23:46:52.1098336Z -        let mut n = [0u8;12];
2025-09-08T23:46:52.1098517Z +    fn next_nonce(counter: u64) -> [u8; 12] {
2025-09-08T23:46:52.1098662Z +        let mut n = [0u8; 12];
2025-09-08T23:46:52.1099094Z          n[4..12].copy_from_slice(&counter.to_le_bytes());
2025-09-08T23:46:52.1099243Z          n
2025-09-08T23:46:52.1099368Z      }
2025-09-08T23:46:52.1099651Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:64:
2025-09-08T23:46:52.1099766Z  
2025-09-08T23:46:52.1100009Z      pub fn write(&self, pt: &[u8]) {
2025-09-08T23:46:52.1100362Z -        let ctr = self.send_ctr.fetch_add(1, std::sync::atomic::Ordering::SeqCst);
2025-09-08T23:46:52.1100514Z +        let ctr = self
2025-09-08T23:46:52.1100646Z +            .send_ctr
2025-09-08T23:46:52.1100888Z +            .fetch_add(1, std::sync::atomic::Ordering::SeqCst);
2025-09-08T23:46:52.1101189Z          let nonce = Self::next_nonce(ctr);
2025-09-08T23:46:52.1101888Z          let ct = crypto::aead::seal(&self.tx_key, &nonce, b"", pt);
2025-09-08T23:46:52.1102132Z          self.inner.write(&ct);
2025-09-08T23:46:52.1102415Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:71:
2025-09-08T23:46:52.1102528Z  
2025-09-08T23:46:52.1102795Z      pub fn read(&self) -> Option<Vec<u8>> {
2025-09-08T23:46:52.1103069Z          let ct = self.inner.read()?;
2025-09-08T23:46:52.1103426Z -        let ctr = self.recv_ctr.fetch_add(1, std::sync::atomic::Ordering::SeqCst);
2025-09-08T23:46:52.1103563Z +        let ctr = self
2025-09-08T23:46:52.1103688Z +            .recv_ctr
2025-09-08T23:46:52.1103918Z +            .fetch_add(1, std::sync::atomic::Ordering::SeqCst);
2025-09-08T23:46:52.1104458Z          let nonce = Self::next_nonce(ctr);
2025-09-08T23:46:52.1104958Z          crypto::aead::open(&self.rx_key, &nonce, b"", &ct).ok()
2025-09-08T23:46:52.1105085Z      }
2025-09-08T23:46:52.1105373Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:78:
2025-09-08T23:46:52.1105472Z  }
2025-09-08T23:46:52.1105573Z  
2025-09-08T23:46:52.1105973Z  // Dummy TLS exporter for in-proc demo; both sides share the same master secret
2025-09-08T23:46:52.1106134Z -struct DummyTls { master: [u8;32] }
2025-09-08T23:46:52.1106256Z +struct DummyTls {
2025-09-08T23:46:52.1106376Z +    master: [u8; 32],
2025-09-08T23:46:52.1106484Z +}
2025-09-08T23:46:52.1106652Z  impl Exporter for DummyTls {
2025-09-08T23:46:52.1107088Z -    fn export(&self, label: &[u8], context: &[u8], len: usize) -> Result<Vec<u8>, crate::inner::Error> {
2025-09-08T23:46:52.1107221Z +    fn export(
2025-09-08T23:46:52.1107368Z +        &self,
2025-09-08T23:46:52.1107534Z +        label: &[u8],
2025-09-08T23:46:52.1107664Z +        context: &[u8],
2025-09-08T23:46:52.1107998Z +        len: usize,
2025-09-08T23:46:52.1108189Z +    ) -> Result<Vec<u8>, crate::inner::Error> {
2025-09-08T23:46:52.1108729Z          let mut ikm = Vec::with_capacity(label.len() + context.len());
2025-09-08T23:46:52.1109033Z          ikm.extend_from_slice(label);
2025-09-08T23:46:52.1109336Z          ikm.extend_from_slice(context);
2025-09-08T23:46:52.1109611Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:87:
2025-09-08T23:46:52.1110074Z          let prk = crypto::hkdf::extract(&self.master, &ikm);
2025-09-08T23:46:52.1110362Z -        let out: [u8;32] = crypto::hkdf::expand(&prk, b"inner-exporter");
2025-09-08T23:46:52.1110643Z +        let out: [u8; 32] = crypto::hkdf::expand(&prk, b"inner-exporter");
2025-09-08T23:46:52.1110950Z          Ok(out[..len.min(32)].to_vec())
2025-09-08T23:46:52.1111075Z      }
2025-09-08T23:46:52.1111178Z  }
2025-09-08T23:46:52.1111640Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:92:
2025-09-08T23:46:52.1111745Z  
2025-09-08T23:46:52.1112204Z  fn noise_xk_pair() -> (Handshake, Handshake) {
2025-09-08T23:46:52.1113510Z -    let si = Scalar::from_bytes_mod_order([1u8;32]);
2025-09-08T23:46:52.1114063Z -    let sr = Scalar::from_bytes_mod_order([2u8;32]);
2025-09-08T23:46:52.1114624Z +    let si = Scalar::from_bytes_mod_order([1u8; 32]);
2025-09-08T23:46:52.1115061Z +    let sr = Scalar::from_bytes_mod_order([2u8; 32]);
2025-09-08T23:46:52.1115307Z      let rs = (sr * X25519_BASEPOINT).to_bytes();
2025-09-08T23:46:52.1115489Z      let mut init = Handshake::init_initiator(si, rs);
2025-09-08T23:46:52.1115661Z      let mut resp = Handshake::init_responder(sr);
2025-09-08T23:46:52.1115830Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:105:
2025-09-08T23:46:52.1115889Z  
2025-09-08T23:46:52.1116013Z  pub fn dial_inproc_secure() -> (Conn, Conn) {
2025-09-08T23:46:52.1116158Z      // Calibrate template (static for demo)
2025-09-08T23:46:52.1116622Z -    let tpl = Template { alpn: vec!["h2".into(), "http/1.1".into()], sig_algs: vec!["rsa_pss_rsae_sha256".into()], groups: vec!["x25519".into()], extensions: vec![0,11,10,35,16,23,43,51] };
2025-09-08T23:46:52.1116710Z +    let tpl = Template {
2025-09-08T23:46:52.1116820Z +        alpn: vec!["h2".into(), "http/1.1".into()],
2025-09-08T23:46:52.1117142Z +        sig_algs: vec!["rsa_pss_rsae_sha256".into()],
2025-09-08T23:46:52.1117296Z +        groups: vec!["x25519".into()],
2025-09-08T23:46:52.1117543Z +        extensions: vec![0, 11, 10, 35, 16, 23, 43, 51],
2025-09-08T23:46:52.1117671Z +    };
2025-09-08T23:46:52.1117882Z      let caps = Caps::default();
2025-09-08T23:46:52.1118042Z      let (init_hs, resp_hs) = noise_xk_pair();
2025-09-08T23:46:52.1118289Z      let master = {
2025-09-08T23:46:52.1118588Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:112:
2025-09-08T23:46:52.1118835Z          let mut r = rand::rngs::StdRng::seed_from_u64(99);
2025-09-08T23:46:52.1118955Z -        let mut k = [0u8;32]; r.fill_bytes(&mut k); k
2025-09-08T23:46:52.1119372Z +        let mut k = [0u8; 32];
2025-09-08T23:46:52.1119502Z +        r.fill_bytes(&mut k);
2025-09-08T23:46:52.1119708Z +        k
2025-09-08T23:46:52.1119849Z      };
2025-09-08T23:46:52.1120171Z      let tls_c = TlsStream::new(DummyTls { master });
2025-09-08T23:46:52.1120345Z      let tls_s = TlsStream::new(DummyTls { master });
2025-09-08T23:46:52.1120504Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:117:
2025-09-08T23:46:52.1120951Z      let ic = open_inner(&tls_c, &caps, &tpl, &init_hs).unwrap();
2025-09-08T23:46:52.1121160Z      let rc = open_inner(&tls_s, &caps, &tpl, &resp_hs).unwrap();
2025-09-08T23:46:52.1121852Z      let (mux_c, mux_s) = mux::pair_encrypted(ic.tx_key, ic.rx_key, rc.tx_key, rc.rx_key);
2025-09-08T23:46:52.1122194Z -    let c = Conn { mux: mux_c, tx_key: ic.tx_key, rx_key: ic.rx_key };
2025-09-08T23:46:52.1122523Z -    let s = Conn { mux: mux_s, tx_key: rc.tx_key, rx_key: rc.rx_key };
2025-09-08T23:46:52.1122726Z +    let c = Conn {
2025-09-08T23:46:52.1122861Z +        mux: mux_c,
2025-09-08T23:46:52.1123164Z +        tx_key: ic.tx_key,
2025-09-08T23:46:52.1123243Z +        rx_key: ic.rx_key,
2025-09-08T23:46:52.1123309Z +    };
2025-09-08T23:46:52.1123525Z +    let s = Conn {
2025-09-08T23:46:52.1123657Z +        mux: mux_s,
2025-09-08T23:46:52.1123791Z +        tx_key: rc.tx_key,
2025-09-08T23:46:52.1123933Z +        rx_key: rc.rx_key,
2025-09-08T23:46:52.1124042Z +    };
2025-09-08T23:46:52.1124224Z      (c, s)
2025-09-08T23:46:52.1124336Z  }
2025-09-08T23:46:52.1124446Z  
2025-09-08T23:46:52.1124769Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:125:
2025-09-08T23:46:52.1125050Z  pub fn dial_inproc_secure_compat() -> (Conn, Conn) {
2025-09-08T23:46:52.1125523Z      // Same as above but binds keys with compat flag for translation interop
2025-09-08T23:46:52.1126209Z -    let tpl = Template { alpn: vec!["h2".into(), "http/1.1".into()], sig_algs: vec!["rsa_pss_rsae_sha256".into()], groups: vec!["x25519".into()], extensions: vec![0,11,10,35,16,23,43,51] };
2025-09-08T23:46:52.1126433Z +    let tpl = Template {
2025-09-08T23:46:52.1126641Z +        alpn: vec!["h2".into(), "http/1.1".into()],
2025-09-08T23:46:52.1126809Z +        sig_algs: vec!["rsa_pss_rsae_sha256".into()],
2025-09-08T23:46:52.1126901Z +        groups: vec!["x25519".into()],
2025-09-08T23:46:52.1127020Z +        extensions: vec![0, 11, 10, 35, 16, 23, 43, 51],
2025-09-08T23:46:52.1127083Z +    };
2025-09-08T23:46:52.1127206Z      let caps = Caps::default();
2025-09-08T23:46:52.1127362Z      let (init_hs, resp_hs) = noise_xk_pair();
2025-09-08T23:46:52.1127595Z      let master = {
2025-09-08T23:46:52.1127881Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:131:
2025-09-08T23:46:52.1128127Z          let mut r = rand::rngs::StdRng::seed_from_u64(101);
2025-09-08T23:46:52.1128381Z -        let mut k = [0u8;32]; r.fill_bytes(&mut k); k
2025-09-08T23:46:52.1128526Z +        let mut k = [0u8; 32];
2025-09-08T23:46:52.1128675Z +        r.fill_bytes(&mut k);
2025-09-08T23:46:52.1128793Z +        k
2025-09-08T23:46:52.1128926Z      };
2025-09-08T23:46:52.1129247Z      let tls_c = TlsStream::new(DummyTls { master });
2025-09-08T23:46:52.1129425Z      let tls_s = TlsStream::new(DummyTls { master });
2025-09-08T23:46:52.1129763Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:136:
2025-09-08T23:46:52.1130253Z      let ic = open_inner_with_compat(&tls_c, &caps, &tpl, &init_hs, Some("compat=1.1")).unwrap();
2025-09-08T23:46:52.1130811Z      let rc = open_inner_with_compat(&tls_s, &caps, &tpl, &resp_hs, Some("compat=1.1")).unwrap();
2025-09-08T23:46:52.1131937Z      let (mux_c, mux_s) = mux::pair_encrypted(ic.tx_key, ic.rx_key, rc.tx_key, rc.rx_key);
2025-09-08T23:46:52.1132306Z -    let c = Conn { mux: mux_c, tx_key: ic.tx_key, rx_key: ic.rx_key };
2025-09-08T23:46:52.1133125Z -    let s = Conn { mux: mux_s, tx_key: rc.tx_key, rx_key: rc.rx_key };
2025-09-08T23:46:52.1133742Z +    let c = Conn {
2025-09-08T23:46:52.1134127Z +        mux: mux_c,
2025-09-08T23:46:52.1134492Z +        tx_key: ic.tx_key,
2025-09-08T23:46:52.1135067Z +        rx_key: ic.rx_key,
2025-09-08T23:46:52.1135923Z +    };
2025-09-08T23:46:52.1136311Z +    let s = Conn {
2025-09-08T23:46:52.1136685Z +        mux: mux_s,
2025-09-08T23:46:52.1137058Z +        tx_key: rc.tx_key,
2025-09-08T23:46:52.1137446Z +        rx_key: rc.rx_key,
2025-09-08T23:46:52.1137820Z +    };
2025-09-08T23:46:52.1138191Z      (c, s)
2025-09-08T23:46:52.1138549Z  }
2025-09-08T23:46:52.1138854Z  
2025-09-08T23:46:52.1139360Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:151:
2025-09-08T23:46:52.1140139Z  }
2025-09-08T23:46:52.1140409Z  
2025-09-08T23:46:52.1140792Z  #[cfg(feature = "rustls-config")]
2025-09-08T23:46:52.1141994Z -fn spawn_tls_pump<S: Read + Write + Send + 'static>(mut tls: S, to_net_rx: mpsc::Receiver<Bytes>, from_net_tx: mpsc::Sender<Bytes>) {
2025-09-08T23:46:52.1146360Z +fn spawn_tls_pump<S: Read + Write + Send + 'static>(
2025-09-08T23:46:52.1146487Z +    mut tls: S,
2025-09-08T23:46:52.1146657Z +    to_net_rx: mpsc::Receiver<Bytes>,
2025-09-08T23:46:52.1147037Z +    from_net_tx: mpsc::Sender<Bytes>,
2025-09-08T23:46:52.1147150Z +) {
2025-09-08T23:46:52.1147366Z      std::thread::spawn(move || {
2025-09-08T23:46:52.1147844Z          let mut buf = Vec::<u8>::with_capacity(16 * 1024);
2025-09-08T23:46:52.1148110Z          let mut tmp = [0u8; 4096];
2025-09-08T23:46:52.1148390Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:160:
2025-09-08T23:46:52.1148580Z              loop {
2025-09-08T23:46:52.1149007Z                  match to_net_rx.try_recv() {
2025-09-08T23:46:52.1149376Z                      Ok(bytes) => {
2025-09-08T23:46:52.1149607Z -                        if tls.write_all(&bytes).is_err() { return; }
2025-09-08T23:46:52.1149797Z +                        if tls.write_all(&bytes).is_err() {
2025-09-08T23:46:52.1149943Z +                            return;
2025-09-08T23:46:52.1150073Z +                        }
2025-09-08T23:46:52.1150569Z                          let _ = tls.flush();
2025-09-08T23:46:52.1150809Z                      }
2025-09-08T23:46:52.1151669Z                      Err(mpsc::TryRecvError::Empty) => break,
2025-09-08T23:46:52.1151971Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:173:
2025-09-08T23:46:52.1152251Z                  Ok(n) => {
2025-09-08T23:46:52.1152851Z                      buf.extend_from_slice(&tmp[..n]);
2025-09-08T23:46:52.1153311Z                      while buf.len() >= 4 {
2025-09-08T23:46:52.1153651Z -                        let len = ((buf[0] as usize) << 16) | ((buf[1] as usize) << 8) | (buf[2] as usize);
2025-09-08T23:46:52.1153853Z +                        let len = ((buf[0] as usize) << 16)
2025-09-08T23:46:52.1154031Z +                            | ((buf[1] as usize) << 8)
2025-09-08T23:46:52.1154194Z +                            | (buf[2] as usize);
2025-09-08T23:46:52.1154712Z                          let total = 4 + len;
2025-09-08T23:46:52.1154898Z -                        if buf.len() < total { break; }
2025-09-08T23:46:52.1155066Z +                        if buf.len() < total {
2025-09-08T23:46:52.1155235Z +                            break;
2025-09-08T23:46:52.1155366Z +                        }
2025-09-08T23:46:52.1156276Z                          let frame = Bytes::copy_from_slice(&buf[..total]);
2025-09-08T23:46:52.1156513Z -                        if from_net_tx.send(frame).is_err() { return; }
2025-09-08T23:46:52.1156717Z +                        if from_net_tx.send(frame).is_err() {
2025-09-08T23:46:52.1156859Z +                            return;
2025-09-08T23:46:52.1156987Z +                        }
2025-09-08T23:46:52.1157496Z                          buf.drain(..total);
2025-09-08T23:46:52.1157743Z                      }
2025-09-08T23:46:52.1157938Z                  }
2025-09-08T23:46:52.1158223Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:192:
2025-09-08T23:46:52.1158342Z  
2025-09-08T23:46:52.1158527Z  #[cfg(feature = "rustls-config")]
2025-09-08T23:46:52.1158791Z  pub fn dial(origin: &str) -> Result<Conn, ApiError> {
2025-09-08T23:46:52.1159365Z -    use crate::tls_mirror::{calibrate, build_client_hello, Config as TlsCfg};
2025-09-08T23:46:52.1159600Z      use crate::inner::Caps;
2025-09-08T23:46:52.1159939Z +    use crate::tls_mirror::{build_client_hello, calibrate, Config as TlsCfg};
2025-09-08T23:46:52.1160156Z      use std::time::Duration;
2025-09-08T23:46:52.1160317Z      use url::Url;
2025-09-08T23:46:52.1160418Z  
2025-09-08T23:46:52.1160705Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:201:
2025-09-08T23:46:52.1161071Z      let url = Url::parse(origin).map_err(|_| ApiError::Url)?;
2025-09-08T23:46:52.1161770Z      let host = url.host_str().ok_or(ApiError::Url)?.to_string();
2025-09-08T23:46:52.1162029Z      let port = url.port().unwrap_or(443);
2025-09-08T23:46:52.1162414Z -    let mut cache = crate::tls_mirror::MirrorCache::new(Duration::from_secs(24*60*60));
2025-09-08T23:46:52.1162911Z -    let (_tid, tpl) = calibrate(origin, Some(&mut cache), Some(&TlsCfg::default())).map_err(|_| ApiError::Tls)?;
2025-09-08T23:46:52.1163316Z +    let mut cache = crate::tls_mirror::MirrorCache::new(Duration::from_secs(24 * 60 * 60));
2025-09-08T23:46:52.1163636Z +    let (_tid, tpl) =
2025-09-08T23:46:52.1164057Z +        calibrate(origin, Some(&mut cache), Some(&TlsCfg::default())).map_err(|_| ApiError::Tls)?;
2025-09-08T23:46:52.1178672Z      let client = build_client_hello(&tpl);
2025-09-08T23:46:52.1178807Z  
2025-09-08T23:46:52.1179015Z      // Build rustls client
2025-09-08T23:46:52.1179293Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:213:
2025-09-08T23:46:52.1179501Z      tcp.set_nodelay(true).ok();
2025-09-08T23:46:52.1179676Z      // Drive handshake
2025-09-08T23:46:52.1179876Z      while conn.is_handshaking() {
2025-09-08T23:46:52.1180254Z -        match conn.complete_io(&mut tcp) { Ok(_) => {}, Err(e) => return Err(ApiError::Io(e)) }
2025-09-08T23:46:52.1180422Z +        match conn.complete_io(&mut tcp) {
2025-09-08T23:46:52.1180540Z +            Ok(_) => {}
2025-09-08T23:46:52.1180720Z +            Err(e) => return Err(ApiError::Io(e)),
2025-09-08T23:46:52.1180830Z +        }
2025-09-08T23:46:52.1180947Z      }
2025-09-08T23:46:52.1181115Z      // Exporter context
2025-09-08T23:46:52.1181495Z      let caps = Caps::default();
2025-09-08T23:46:52.1181870Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:220:
2025-09-08T23:46:52.1182212Z      // Build exporter context same as inner::open_inner uses
2025-09-08T23:46:52.1182540Z      let tid = crate::tls_mirror::compute_template_id(&tpl);
2025-09-08T23:46:52.1182741Z      #[derive(serde::Serialize)]
2025-09-08T23:46:52.1183080Z -    struct Bind<'a> { #[serde(with = "serde_bytes")] template_id: &'a [u8], caps: &'a Caps }
2025-09-08T23:46:52.1183509Z -    let ctx = core_cbor::to_det_cbor(&Bind { template_id: &tid.0, caps: &caps }).map_err(|_| ApiError::Tls)?;
2025-09-08T23:46:52.1183632Z +    struct Bind<'a> {
2025-09-08T23:46:52.1183783Z +        #[serde(with = "serde_bytes")]
2025-09-08T23:46:52.1183914Z +        template_id: &'a [u8],
2025-09-08T23:46:52.1184039Z +        caps: &'a Caps,
2025-09-08T23:46:52.1184159Z +    }
2025-09-08T23:46:52.1184333Z +    let ctx = core_cbor::to_det_cbor(&Bind {
2025-09-08T23:46:52.1184473Z +        template_id: &tid.0,
2025-09-08T23:46:52.1184597Z +        caps: &caps,
2025-09-08T23:46:52.1184711Z +    })
2025-09-08T23:46:52.1184863Z +    .map_err(|_| ApiError::Tls)?;
2025-09-08T23:46:52.1185050Z      // Export 32 bytes EKM
2025-09-08T23:46:52.1185191Z -    let mut ekm = [0u8;32];
2025-09-08T23:46:52.1185634Z -    conn.export_keying_material(&mut ekm, b"qnet inner", Some(&ctx)).map_err(|_| ApiError::Tls)?;
2025-09-08T23:46:52.1185769Z +    let mut ekm = [0u8; 32];
2025-09-08T23:46:52.1186066Z +    conn.export_keying_material(&mut ekm, b"qnet inner", Some(&ctx))
2025-09-08T23:46:52.1186220Z +        .map_err(|_| ApiError::Tls)?;
2025-09-08T23:46:52.1186532Z      // Build exporter wrapper that returns fixed EKM
2025-09-08T23:46:52.1186704Z -    struct RustlsExporter { ekm: [u8;32] }
2025-09-08T23:46:52.1186855Z +    struct RustlsExporter {
2025-09-08T23:46:52.1187178Z +        ekm: [u8; 32],
2025-09-08T23:46:52.1187288Z +    }
2025-09-08T23:46:52.1187532Z      impl Exporter for RustlsExporter {
2025-09-08T23:46:52.1187929Z -        fn export(&self, _label: &[u8], _context: &[u8], len: usize) -> Result<Vec<u8>, crate::inner::Error> {
2025-09-08T23:46:52.1188041Z +        fn export(
2025-09-08T23:46:52.1188151Z +            &self,
2025-09-08T23:46:52.1188269Z +            _label: &[u8],
2025-09-08T23:46:52.1188389Z +            _context: &[u8],
2025-09-08T23:46:52.1188498Z +            len: usize,
2025-09-08T23:46:52.1188674Z +        ) -> Result<Vec<u8>, crate::inner::Error> {
2025-09-08T23:46:52.1189041Z              Ok(self.ekm[..len.min(32)].to_vec())
2025-09-08T23:46:52.1189181Z          }
2025-09-08T23:46:52.1189304Z      }
2025-09-08T23:46:52.1189584Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:244:
2025-09-08T23:46:52.1189927Z      let tls_stream = rustls::StreamOwned::new(conn, tcp);
2025-09-08T23:46:52.1190456Z      std::thread::spawn(move || spawn_tls_pump(tls_stream, to_net_rx, from_net_tx));
2025-09-08T23:46:52.1191117Z      let mux = Mux::new_encrypted(to_net_tx, from_net_rx, inner.tx_key, inner.rx_key);
2025-09-08T23:46:52.1191503Z -    Ok(Conn { mux, tx_key: inner.tx_key, rx_key: inner.rx_key })
2025-09-08T23:46:52.1191623Z +    Ok(Conn {
2025-09-08T23:46:52.1191731Z +        mux,
2025-09-08T23:46:52.1191854Z +        tx_key: inner.tx_key,
2025-09-08T23:46:52.1191982Z +        rx_key: inner.rx_key,
2025-09-08T23:46:52.1192093Z +    })
2025-09-08T23:46:52.1192196Z  }
2025-09-08T23:46:52.1192298Z  
2025-09-08T23:46:52.1192477Z  #[cfg(not(feature = "rustls-config"))]
2025-09-08T23:46:52.1192753Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:251:
2025-09-08T23:46:52.1193135Z -pub fn dial(_origin: &str) -> Result<Conn, ApiError> { Err(ApiError::FeatureDisabled) }
2025-09-08T23:46:52.1193358Z +pub fn dial(_origin: &str) -> Result<Conn, ApiError> {
2025-09-08T23:46:52.1193518Z +    Err(ApiError::FeatureDisabled)
2025-09-08T23:46:52.1193629Z +}
2025-09-08T23:46:52.1193728Z  
2025-09-08T23:46:52.1193895Z  #[cfg(feature = "rustls-config")]
2025-09-08T23:46:52.1194243Z -pub fn accept(_bind: &str) -> Result<(), ApiError> { Err(ApiError::NotImplemented) }
2025-09-08T23:46:52.1194445Z +pub fn accept(_bind: &str) -> Result<(), ApiError> {
2025-09-08T23:46:52.1194589Z +    Err(ApiError::NotImplemented)
2025-09-08T23:46:52.1194692Z +}
2025-09-08T23:46:52.1194858Z  #[cfg(not(feature = "rustls-config"))]
2025-09-08T23:46:52.1195178Z -pub fn accept(_bind: &str) -> Result<(), ApiError> { Err(ApiError::FeatureDisabled) }
2025-09-08T23:46:52.1195369Z +pub fn accept(_bind: &str) -> Result<(), ApiError> {
2025-09-08T23:46:52.1195508Z +    Err(ApiError::FeatureDisabled)
2025-09-08T23:46:52.1195598Z +}
2025-09-08T23:46:52.1195687Z  
2025-09-08T23:46:52.1195800Z  #[cfg(test)]
2025-09-08T23:46:52.1195907Z  mod tests {
2025-09-08T23:46:52.1196151Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:297:
2025-09-08T23:46:52.1196265Z      }
2025-09-08T23:46:52.1196366Z  }
2025-09-08T23:46:52.1196455Z  
2025-09-08T23:46:52.1196917Z -fn spawn_socket_pump(sock: TcpStream, to_net_rx: mpsc::Receiver<Bytes>, from_net_tx: mpsc::Sender<Bytes>) {
2025-09-08T23:46:52.1197051Z +fn spawn_socket_pump(
2025-09-08T23:46:52.1197179Z +    sock: TcpStream,
2025-09-08T23:46:52.1197331Z +    to_net_rx: mpsc::Receiver<Bytes>,
2025-09-08T23:46:52.1197492Z +    from_net_tx: mpsc::Sender<Bytes>,
2025-09-08T23:46:52.1197592Z +) {
2025-09-08T23:46:52.1197805Z      sock.set_nodelay(true).ok();
2025-09-08T23:46:52.1198122Z      let mut sock_r = sock.try_clone().expect("clone");
2025-09-08T23:46:52.1198309Z      let mut sock_w = sock;
2025-09-08T23:46:52.1198572Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:306:
2025-09-08T23:46:52.1198777Z      let to_net_rx_w = to_net_rx;
2025-09-08T23:46:52.1199008Z      let writer = thread::spawn(move || {
2025-09-08T23:46:52.1199349Z          while let Ok(bytes) = to_net_rx_w.recv() {
2025-09-08T23:46:52.1199693Z -            if sock_w.write_all(&bytes).is_err() { break; }
2025-09-08T23:46:52.1199875Z +            if sock_w.write_all(&bytes).is_err() {
2025-09-08T23:46:52.1199993Z +                break;
2025-09-08T23:46:52.1200101Z +            }
2025-09-08T23:46:52.1200237Z          }
2025-09-08T23:46:52.1200363Z      });
2025-09-08T23:46:52.1200462Z  
2025-09-08T23:46:52.1200721Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:321:
2025-09-08T23:46:52.1201278Z                      buf.extend_from_slice(&tmp[..n]);
2025-09-08T23:46:52.1201854Z                      // parse frames if full
2025-09-08T23:46:52.1202125Z                      loop {
2025-09-08T23:46:52.1202292Z -                        if buf.len() < 4 { break; }
2025-09-08T23:46:52.1202601Z -                        let len = ((buf[0] as usize) << 16) | ((buf[1] as usize) << 8) | (buf[2] as usize);
2025-09-08T23:46:52.1202749Z +                        if buf.len() < 4 {
2025-09-08T23:46:52.1202879Z +                            break;
2025-09-08T23:46:52.1203011Z +                        }
2025-09-08T23:46:52.1203330Z +                        let len = ((buf[0] as usize) << 16)
2025-09-08T23:46:52.1203484Z +                            | ((buf[1] as usize) << 8)
2025-09-08T23:46:52.1203640Z +                            | (buf[2] as usize);
2025-09-08T23:46:52.1204539Z                          let total = 4 + len; // 3 bytes len + 1 type + payload
2025-09-08T23:46:52.1204706Z -                        if buf.len() < total { break; }
2025-09-08T23:46:52.1204863Z +                        if buf.len() < total {
2025-09-08T23:46:52.1204990Z +                            break;
2025-09-08T23:46:52.1205109Z +                        }
2025-09-08T23:46:52.1205969Z                          let frame = Bytes::copy_from_slice(&buf[..total]);
2025-09-08T23:46:52.1206186Z -                        if from_net_tx.send(frame).is_err() { break; }
2025-09-08T23:46:52.1206362Z +                        if from_net_tx.send(frame).is_err() {
2025-09-08T23:46:52.1206485Z +                            break;
2025-09-08T23:46:52.1206616Z +                        }
2025-09-08T23:46:52.1207075Z                          buf.drain(..total);
2025-09-08T23:46:52.1207296Z                      }
2025-09-08T23:46:52.1207482Z                  }
2025-09-08T23:46:52.1207739Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:346:
2025-09-08T23:46:52.1207835Z  }
2025-09-08T23:46:52.1207926Z  
2025-09-08T23:46:52.1208054Z  impl HtxConn {
2025-09-08T23:46:52.1208345Z -    pub fn open_stream(&self) -> StreamHandle { self.mux.open_stream() }
2025-09-08T23:46:52.1208827Z -    pub fn accept_stream(&self, timeout: Duration) -> Option<StreamHandle> { self.mux.accept_stream(timeout) }
2025-09-08T23:46:52.1209117Z -    pub fn encryption_epoch(&self) -> u64 { self.mux.encryption_epoch() }
2025-09-08T23:46:52.1209296Z +    pub fn open_stream(&self) -> StreamHandle {
2025-09-08T23:46:52.1209429Z +        self.mux.open_stream()
2025-09-08T23:46:52.1209530Z +    }
2025-09-08T23:46:52.1209846Z +    pub fn accept_stream(&self, timeout: Duration) -> Option<StreamHandle> {
2025-09-08T23:46:52.1210013Z +        self.mux.accept_stream(timeout)
2025-09-08T23:46:52.1210113Z +    }
2025-09-08T23:46:52.1210279Z +    pub fn encryption_epoch(&self) -> u64 {
2025-09-08T23:46:52.1210421Z +        self.mux.encryption_epoch()
2025-09-08T23:46:52.1210519Z +    }
2025-09-08T23:46:52.1210625Z  }
2025-09-08T23:46:52.1210726Z  
2025-09-08T23:46:52.1210879Z  pub struct HtxListener {
2025-09-08T23:46:52.1211139Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/api.rs:361:
2025-09-08T23:46:52.1211630Z          let (acc_tx, acc_rx) = mpsc::channel();
2025-09-08T23:46:52.1211878Z          thread::spawn(move || {
2025-09-08T23:46:52.1212356Z              for stream in listener.incoming().flatten() {
2025-09-08T23:46:52.1212576Z -                    // Build channel pair connecting socket to Mux
2025-09-08T23:46:52.1212793Z -                    let (to_net_tx, to_net_rx) = mpsc::channel::<Bytes>();
2025-09-08T23:46:52.1213211Z -                    let (from_net_tx, from_net_rx) = mpsc::channel::<Bytes>();
2025-09-08T23:46:52.1213387Z -                    // Start socket pump
2025-09-08T23:46:52.1213718Z -                    thread::spawn(move || spawn_socket_pump(stream, to_net_rx, from_net_tx));
2025-09-08T23:46:52.1213886Z -                    // Create Mux using the channels
2025-09-08T23:46:52.1214086Z -                    let mux = Mux::new(to_net_tx, from_net_rx);
2025-09-08T23:46:52.1214254Z -                    let conn = HtxConn { mux };
2025-09-08T23:46:52.1214401Z -                    let _ = acc_tx.send(conn);
2025-09-08T23:46:52.1214599Z +                // Build channel pair connecting socket to Mux
2025-09-08T23:46:52.1214818Z +                let (to_net_tx, to_net_rx) = mpsc::channel::<Bytes>();
2025-09-08T23:46:52.1215069Z +                let (from_net_tx, from_net_rx) = mpsc::channel::<Bytes>();
2025-09-08T23:46:52.1215216Z +                // Start socket pump
2025-09-08T23:46:52.1215542Z +                thread::spawn(move || spawn_socket_pump(stream, to_net_rx, from_net_tx));
2025-09-08T23:46:52.1215856Z +                // Create Mux using the channels
2025-09-08T23:46:52.1216053Z +                let mux = Mux::new(to_net_tx, from_net_rx);
2025-09-08T23:46:52.1216213Z +                let conn = HtxConn { mux };
2025-09-08T23:46:52.1216355Z +                let _ = acc_tx.send(conn);
2025-09-08T23:46:52.1216503Z              }
2025-09-08T23:46:52.1216643Z          });
2025-09-08T23:46:52.1216952Z          Ok(HtxListener { incoming: acc_rx })
2025-09-08T23:46:52.1217224Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:1:
2025-09-08T23:46:52.1217353Z -use crate::Handshake;
2025-09-08T23:46:52.1217521Z  use crate::tls_mirror::Template;
2025-09-08T23:46:52.1217653Z -use core_crypto as crypto;
2025-09-08T23:46:52.1217786Z +use crate::Handshake;
2025-09-08T23:46:52.1217928Z  use core_cbor as cbor;
2025-09-08T23:46:52.1218101Z -use serde::{Serialize, Deserialize};
2025-09-08T23:46:52.1218246Z +use core_crypto as crypto;
2025-09-08T23:46:52.1218426Z +use serde::{Deserialize, Serialize};
2025-09-08T23:46:52.1218535Z  
2025-09-08T23:46:52.1218664Z  #[derive(Debug)]
2025-09-08T23:46:52.1218794Z  pub enum Error {
2025-09-08T23:46:52.1219073Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:28:
2025-09-08T23:46:52.1219180Z  
2025-09-08T23:46:52.1219312Z  impl TlsStream {
2025-09-08T23:46:52.1219716Z      pub fn new<E: Exporter + Send + Sync + 'static>(exp: E) -> Self {
2025-09-08T23:46:52.1219899Z -        Self { inner: std::sync::Arc::new(exp) }
2025-09-08T23:46:52.1220010Z +        Self {
2025-09-08T23:46:52.1220171Z +            inner: std::sync::Arc::new(exp),
2025-09-08T23:46:52.1220284Z +        }
2025-09-08T23:46:52.1220399Z      }
2025-09-08T23:46:52.1220858Z      pub fn export(&self, label: &[u8], context: &[u8], len: usize) -> Result<Vec<u8>, Error> {
2025-09-08T23:46:52.1221051Z          self.inner.export(label, context, len)
2025-09-08T23:46:52.1221226Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:37:
2025-09-08T23:46:52.1221480Z  
2025-09-08T23:46:52.1221600Z  #[derive(Debug, Clone)]
2025-09-08T23:46:52.1221695Z  pub struct InnerConn {
2025-09-08T23:46:52.1221774Z -    pub tx_key: [u8;32],
2025-09-08T23:46:52.1221849Z -    pub rx_key: [u8;32],
2025-09-08T23:46:52.1221924Z +    pub tx_key: [u8; 32],
2025-09-08T23:46:52.1222005Z +    pub rx_key: [u8; 32],
2025-09-08T23:46:52.1222064Z  }
2025-09-08T23:46:52.1222125Z  
2025-09-08T23:46:52.1222210Z  #[derive(Serialize)]
2025-09-08T23:46:52.1222376Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:49:
2025-09-08T23:46:52.1222496Z      compat: Option<&'a str>,
2025-09-08T23:46:52.1222554Z  }
2025-09-08T23:46:52.1222621Z  
2025-09-08T23:46:52.1222921Z -pub fn exporter_context_with_compat(template: &Template, caps: &Caps, compat: Option<&str>) -> Vec<u8> {
2025-09-08T23:46:52.1223023Z +pub fn exporter_context_with_compat(
2025-09-08T23:46:52.1223107Z +    template: &Template,
2025-09-08T23:46:52.1223182Z +    caps: &Caps,
2025-09-08T23:46:52.1223456Z +    compat: Option<&str>,
2025-09-08T23:46:52.1223540Z +) -> Vec<u8> {
2025-09-08T23:46:52.1223778Z      let tid = crate::tls_mirror::compute_template_id(template);
2025-09-08T23:46:52.1223922Z -    let ctx = BindCtx { template_id: &tid.0, caps, compat };
2025-09-08T23:46:52.1224000Z +    let ctx = BindCtx {
2025-09-08T23:46:52.1224086Z +        template_id: &tid.0,
2025-09-08T23:46:52.1224154Z +        caps,
2025-09-08T23:46:52.1224221Z +        compat,
2025-09-08T23:46:52.1224292Z +    };
2025-09-08T23:46:52.1224459Z      cbor::to_det_cbor(&ctx).expect("det-cbor")
2025-09-08T23:46:52.1224518Z  }
2025-09-08T23:46:52.1224577Z  
2025-09-08T23:46:52.1224745Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:59:
2025-09-08T23:46:52.1224934Z      exporter_context_with_compat(template, caps, None)
2025-09-08T23:46:52.1224991Z  }
2025-09-08T23:46:52.1225052Z  
2025-09-08T23:46:52.1225225Z -fn bind_key(base_key: &[u8;32], exporter: &[u8], ctx: &[u8]) -> [u8;32] {
2025-09-08T23:46:52.1225397Z +fn bind_key(base_key: &[u8; 32], exporter: &[u8], ctx: &[u8]) -> [u8; 32] {
2025-09-08T23:46:52.1225701Z      // prk = HKDF-Extract(salt=exporter, ikm=base_key)
2025-09-08T23:46:52.1225894Z      let prk = crypto::hkdf::extract(exporter, base_key);
2025-09-08T23:46:52.1226217Z      // info = "qnet/inner/v1|key|" + ctx (constant label ensures both ends match per base key)
2025-09-08T23:46:52.1226379Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:112:
2025-09-08T23:46:52.1226525Z      use curve25519_dalek::scalar::Scalar;
2025-09-08T23:46:52.1226583Z  
2025-09-08T23:46:52.1226805Z      // Dummy TLS exporter for tests using HKDF over a fixed secret
2025-09-08T23:46:52.1226903Z -    struct DummyTls { master: [u8;32] }
2025-09-08T23:46:52.1226980Z +    struct DummyTls {
2025-09-08T23:46:52.1227056Z +        master: [u8; 32],
2025-09-08T23:46:52.1227119Z +    }
2025-09-08T23:46:52.1227245Z      impl Exporter for DummyTls {
2025-09-08T23:46:52.1227620Z          fn export(&self, label: &[u8], context: &[u8], len: usize) -> Result<Vec<u8>, Error> {
2025-09-08T23:46:52.1227924Z              // prk = HKDF-Extract(salt=master, ikm=label||context)
2025-09-08T23:46:52.1228085Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:120:
2025-09-08T23:46:52.1228276Z              ikm.extend_from_slice(label);
2025-09-08T23:46:52.1228478Z              ikm.extend_from_slice(context);
2025-09-08T23:46:52.1228776Z              let prk = crypto::hkdf::extract(&self.master, &ikm);
2025-09-08T23:46:52.1228936Z -            let out: [u8;32] = crypto::hkdf::expand(&prk, b"inner-exporter");
2025-09-08T23:46:52.1229258Z +            let out: [u8; 32] = crypto::hkdf::expand(&prk, b"inner-exporter");
2025-09-08T23:46:52.1229641Z              Ok(out[..len.min(32)].to_vec())
2025-09-08T23:46:52.1229790Z          }
2025-09-08T23:46:52.1229912Z      }
2025-09-08T23:46:52.1230182Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:136:
2025-09-08T23:46:52.1230293Z  
2025-09-08T23:46:52.1230583Z      fn do_noise_xk() -> (Handshake, Handshake) {
2025-09-08T23:46:52.1230845Z          // Deterministic statics
2025-09-08T23:46:52.1231056Z -        let si = Scalar::from_bytes_mod_order([1u8;32]);
2025-09-08T23:46:52.1231252Z -        let sr = Scalar::from_bytes_mod_order([2u8;32]);
2025-09-08T23:46:52.1231665Z +        let si = Scalar::from_bytes_mod_order([1u8; 32]);
2025-09-08T23:46:52.1231865Z +        let sr = Scalar::from_bytes_mod_order([2u8; 32]);
2025-09-08T23:46:52.1232237Z          let rs = (sr * X25519_BASEPOINT).to_bytes();
2025-09-08T23:46:52.1232564Z          let mut init = Handshake::init_initiator(si, rs);
2025-09-08T23:46:52.1232777Z          let mut resp = Handshake::init_responder(sr);
2025-09-08T23:46:52.1232946Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:153:
2025-09-08T23:46:52.1233029Z      #[test]
2025-09-08T23:46:52.1233163Z      fn bound_keys_match_and_work() {
2025-09-08T23:46:52.1233335Z          let (init, resp) = do_noise_xk();
2025-09-08T23:46:52.1233623Z -        let tls = TlsStream::new(DummyTls { master: [7u8;32] });
2025-09-08T23:46:52.1233777Z +        let tls = TlsStream::new(DummyTls { master: [7u8; 32] });
2025-09-08T23:46:52.1233935Z          let caps = Caps::default();
2025-09-08T23:46:52.1234062Z          let tpl = mk_tpl();
2025-09-08T23:46:52.1234307Z          let ic = open_inner(&tls, &caps, &tpl, &init).unwrap();
2025-09-08T23:46:52.1234462Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:162:
2025-09-08T23:46:52.1234633Z          assert_eq!(ic.tx_key, rc.rx_key);
2025-09-08T23:46:52.1234792Z          assert_eq!(ic.rx_key, rc.tx_key);
2025-09-08T23:46:52.1234908Z          // Seal/decrypt
2025-09-08T23:46:52.1234991Z -        let n = [0u8;12];
2025-09-08T23:46:52.1235067Z +        let n = [0u8; 12];
2025-09-08T23:46:52.1235184Z          let aad = b"aad";
2025-09-08T23:46:52.1235306Z          let pt = b"hello";
2025-09-08T23:46:52.1235558Z          let ct = crypto::aead::seal(&ic.tx_key, &n, aad, pt);
2025-09-08T23:46:52.1235727Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:172:
2025-09-08T23:46:52.1235936Z      #[test]
2025-09-08T23:46:52.1236097Z      fn mismatch_context_breaks_decryption() {
2025-09-08T23:46:52.1236261Z          let (init, resp) = do_noise_xk();
2025-09-08T23:46:52.1236401Z -        let tls = TlsStream::new(DummyTls { master: [7u8;32] });
2025-09-08T23:46:52.1236547Z +        let tls = TlsStream::new(DummyTls { master: [7u8; 32] });
2025-09-08T23:46:52.1236699Z          let caps1 = Caps::default();
2025-09-08T23:46:52.1236862Z          let mut caps2 = Caps::default();
2025-09-08T23:46:52.1237094Z          caps2.features.push("no_h2".into()); // mismatch
2025-09-08T23:46:52.1237254Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:180:
2025-09-08T23:46:52.1237498Z          let ic = open_inner(&tls, &caps1, &tpl, &init).unwrap();
2025-09-08T23:46:52.1237739Z          let rc = open_inner(&tls, &caps2, &tpl, &resp).unwrap();
2025-09-08T23:46:52.1238035Z          // Seal with initiator, try open with responder (mismatch caps)
2025-09-08T23:46:52.1238123Z -        let n = [0u8;12];
2025-09-08T23:46:52.1238198Z +        let n = [0u8; 12];
2025-09-08T23:46:52.1238320Z          let aad = b"aad";
2025-09-08T23:46:52.1238442Z          let pt = b"hello";
2025-09-08T23:46:52.1238675Z          let ct = crypto::aead::seal(&ic.tx_key, &n, aad, pt);
2025-09-08T23:46:52.1238840Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:190:
2025-09-08T23:46:52.1238918Z      #[test]
2025-09-08T23:46:52.1239075Z      fn compat_flag_changes_binding_context() {
2025-09-08T23:46:52.1239239Z          let (init, resp) = do_noise_xk();
2025-09-08T23:46:52.1239373Z -        let tls = TlsStream::new(DummyTls { master: [7u8;32] });
2025-09-08T23:46:52.1239507Z +        let tls = TlsStream::new(DummyTls { master: [7u8; 32] });
2025-09-08T23:46:52.1239654Z          let caps = Caps::default();
2025-09-08T23:46:52.1239784Z          let tpl = mk_tpl();
2025-09-08T23:46:52.1240176Z          let ic = open_inner_with_compat(&tls, &caps, &tpl, &init, Some("compat=1.1")).unwrap();
2025-09-08T23:46:52.1240337Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/inner.rs:197:
2025-09-08T23:46:52.1240670Z          let rc = open_inner_with_compat(&tls, &caps, &tpl, &resp, None).unwrap();
2025-09-08T23:46:52.1240745Z -        let n = [0u8;12];
2025-09-08T23:46:52.1240819Z +        let n = [0u8; 12];
2025-09-08T23:46:52.1240935Z          let aad = b"aad";
2025-09-08T23:46:52.1241060Z          let pt = b"hello";
2025-09-08T23:46:52.1241454Z          let ct = crypto::aead::seal(&ic.tx_key, &n, aad, pt);
2025-09-08T23:46:52.1241718Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:1:
2025-09-08T23:46:52.1242023Z  //! HTX Noise XK handshake primitives and placeholders for future APIs.
2025-09-08T23:46:52.1242086Z  
2025-09-08T23:46:52.1242178Z  use core_crypto as crypto;
2025-09-08T23:46:52.1242298Z -use ring::digest::{Context as Sha256, SHA256};
2025-09-08T23:46:52.1242437Z  use curve25519_dalek::constants::X25519_BASEPOINT;
2025-09-08T23:46:52.1242698Z  use curve25519_dalek::montgomery::MontgomeryPoint;
2025-09-08T23:46:52.1242817Z  use curve25519_dalek::scalar::Scalar;
2025-09-08T23:46:52.1242969Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:8:
2025-09-08T23:46:52.1243065Z -use rand::{SeedableRng, RngCore};
2025-09-08T23:46:52.1243156Z +use rand::{RngCore, SeedableRng};
2025-09-08T23:46:52.1243270Z +use ring::digest::{Context as Sha256, SHA256};
2025-09-08T23:46:52.1243328Z  
2025-09-08T23:46:52.1243448Z  #[derive(Debug, Clone, Copy, PartialEq, Eq)]
2025-09-08T23:46:52.1243549Z -pub enum Role { Initiator, Responder }
2025-09-08T23:46:52.1243621Z +pub enum Role {
2025-09-08T23:46:52.1243691Z +    Initiator,
2025-09-08T23:46:52.1243760Z +    Responder,
2025-09-08T23:46:52.1243823Z +}
2025-09-08T23:46:52.1243881Z  
2025-09-08T23:46:52.1243995Z  #[derive(Debug, Clone, Copy, PartialEq, Eq)]
2025-09-08T23:46:52.1244091Z -pub enum State { InProgress, Done }
2025-09-08T23:46:52.1244165Z +pub enum State {
2025-09-08T23:46:52.1244236Z +    InProgress,
2025-09-08T23:46:52.1244314Z +    Done,
2025-09-08T23:46:52.1244490Z +}
2025-09-08T23:46:52.1244547Z  
2025-09-08T23:46:52.1244634Z  #[derive(Debug, Clone)]
2025-09-08T23:46:52.1244721Z  pub struct Handshake {
2025-09-08T23:46:52.1244879Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:20:
2025-09-08T23:46:52.1244966Z      h: [u8; 32],
2025-09-08T23:46:52.1245051Z      ck: [u8; 32],
2025-09-08T23:46:52.1245138Z      // DH keys
2025-09-08T23:46:52.1245268Z -    s: Option<(Scalar, [u8;32])>, // local static (sk, pk)
2025-09-08T23:46:52.1245395Z +    s: Option<(Scalar, [u8; 32])>, // local static (sk, pk)
2025-09-08T23:46:52.1245569Z      rs: [u8; 32],                  // remote static public
2025-09-08T23:46:52.1245704Z -    e: Option<(Scalar, [u8;32])>, // local ephemeral (sk, pk)
2025-09-08T23:46:52.1245839Z +    e: Option<(Scalar, [u8; 32])>, // local ephemeral (sk, pk)
2025-09-08T23:46:52.1246008Z      re: Option<[u8; 32]>,          // remote ephemeral
2025-09-08T23:46:52.1246122Z      // cipherstate nonces
2025-09-08T23:46:52.1246220Z      _n_send: u64,
2025-09-08T23:46:52.1246376Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:46:
2025-09-08T23:46:52.1246606Z          Self::new(Role::Responder, Some((sr, spk)), spk)
2025-09-08T23:46:52.1246676Z      }
2025-09-08T23:46:52.1246735Z  
2025-09-08T23:46:52.1246906Z -    fn new(role: Role, s: Option<(Scalar,[u8;32])>, rs: [u8;32]) -> Self {
2025-09-08T23:46:52.1247067Z +    fn new(role: Role, s: Option<(Scalar, [u8; 32])>, rs: [u8; 32]) -> Self {
2025-09-08T23:46:52.1247301Z          let proto = b"Noise_XK_25519_ChaChaPoly_SHA256";
2025-09-08T23:46:52.1247428Z -        let (mut h, mut ck) = (sha256_init(proto), [0u8;32]);
2025-09-08T23:46:52.1247554Z +        let (mut h, mut ck) = (sha256_init(proto), [0u8; 32]);
2025-09-08T23:46:52.1247698Z          ck.copy_from_slice(&h);
2025-09-08T23:46:52.1247848Z -    // pre-messages: <- s (responder static)
2025-09-08T23:46:52.1247936Z -    h = mix_hash(&h, &rs);
2025-09-08T23:46:52.1248206Z -        Self { role, h, ck, s, rs, e: None, re: None, _n_send: 0, _n_recv: 0, tx_key: None, rx_key: None, stage: 0, cur_k: None }
2025-09-08T23:46:52.1248326Z +        // pre-messages: <- s (responder static)
2025-09-08T23:46:52.1248417Z +        h = mix_hash(&h, &rs);
2025-09-08T23:46:52.1248484Z +        Self {
2025-09-08T23:46:52.1248551Z +            role,
2025-09-08T23:46:52.1248617Z +            h,
2025-09-08T23:46:52.1248691Z +            ck,
2025-09-08T23:46:52.1248756Z +            s,
2025-09-08T23:46:52.1248820Z +            rs,
2025-09-08T23:46:52.1248899Z +            e: None,
2025-09-08T23:46:52.1248970Z +            re: None,
2025-09-08T23:46:52.1249043Z +            _n_send: 0,
2025-09-08T23:46:52.1249119Z +            _n_recv: 0,
2025-09-08T23:46:52.1249193Z +            tx_key: None,
2025-09-08T23:46:52.1249266Z +            rx_key: None,
2025-09-08T23:46:52.1249334Z +            stage: 0,
2025-09-08T23:46:52.1249416Z +            cur_k: None,
2025-09-08T23:46:52.1249480Z +        }
2025-09-08T23:46:52.1249553Z      }
2025-09-08T23:46:52.1249701Z  
2025-09-08T23:46:52.1250073Z      // Next step in handshake. Returns Some(message_out) when sending; None when a send isn't needed.
2025-09-08T23:46:52.1250230Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:60:
2025-09-08T23:46:52.1250534Z      pub fn next(&mut self, msg_in: Option<&[u8]>) -> Result<Option<Vec<u8>>, &'static str> {
2025-09-08T23:46:52.1250662Z          match self.role {
2025-09-08T23:46:52.1250934Z              Role::Initiator => match (self.stage, msg_in) {
2025-09-08T23:46:52.1251099Z -                (0, None) => { let r = self.initiator_msg1()?; self.stage = 1; Ok(r) }
2025-09-08T23:46:52.1251272Z -                (1, Some(m2)) => { let r = self.initiator_msg3(m2)?; self.stage = 2; Ok(r) }
2025-09-08T23:46:52.1251508Z +                (0, None) => {
2025-09-08T23:46:52.1251620Z +                    let r = self.initiator_msg1()?;
2025-09-08T23:46:52.1251710Z +                    self.stage = 1;
2025-09-08T23:46:52.1251782Z +                    Ok(r)
2025-09-08T23:46:52.1251982Z +                }
2025-09-08T23:46:52.1252064Z +                (1, Some(m2)) => {
2025-09-08T23:46:52.1252176Z +                    let r = self.initiator_msg3(m2)?;
2025-09-08T23:46:52.1252258Z +                    self.stage = 2;
2025-09-08T23:46:52.1252329Z +                    Ok(r)
2025-09-08T23:46:52.1252399Z +                }
2025-09-08T23:46:52.1252560Z                  _ => Ok(None),
2025-09-08T23:46:52.1252658Z              },
2025-09-08T23:46:52.1252932Z              Role::Responder => match (self.stage, msg_in) {
2025-09-08T23:46:52.1253095Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:68:
2025-09-08T23:46:52.1253264Z -                (0, Some(m1)) => { let r = self.responder_msg2(m1)?; self.stage = 1; Ok(r) }
2025-09-08T23:46:52.1253454Z -                (1, Some(m3)) => { self.responder_finalize_msg3(m3)?; self.stage = 2; Ok(None) }
2025-09-08T23:46:52.1253539Z +                (0, Some(m1)) => {
2025-09-08T23:46:52.1253651Z +                    let r = self.responder_msg2(m1)?;
2025-09-08T23:46:52.1253737Z +                    self.stage = 1;
2025-09-08T23:46:52.1253815Z +                    Ok(r)
2025-09-08T23:46:52.1253883Z +                }
2025-09-08T23:46:52.1253959Z +                (1, Some(m3)) => {
2025-09-08T23:46:52.1254070Z +                    self.responder_finalize_msg3(m3)?;
2025-09-08T23:46:52.1254147Z +                    self.stage = 2;
2025-09-08T23:46:52.1254223Z +                    Ok(None)
2025-09-08T23:46:52.1254288Z +                }
2025-09-08T23:46:52.1254455Z                  _ => Ok(None),
2025-09-08T23:46:52.1254549Z              },
2025-09-08T23:46:52.1254629Z          }
2025-09-08T23:46:52.1254788Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:73:
2025-09-08T23:46:52.1254858Z      }
2025-09-08T23:46:52.1254917Z  
2025-09-08T23:46:52.1255116Z -    pub fn is_done(&self) -> bool { self.tx_key.is_some() && self.rx_key.is_some() }
2025-09-08T23:46:52.1255216Z +    pub fn is_done(&self) -> bool {
2025-09-08T23:46:52.1255335Z +        self.tx_key.is_some() && self.rx_key.is_some()
2025-09-08T23:46:52.1255402Z +    }
2025-09-08T23:46:52.1255468Z  
2025-09-08T23:46:52.1255615Z -    pub fn transport_keys(&self) -> Option<([u8;32],[u8;32])> {
2025-09-08T23:46:52.1255815Z -        match (self.tx_key, self.rx_key) { (Some(tx), Some(rx)) => Some((tx, rx)), _ => None }
2025-09-08T23:46:52.1255969Z +    pub fn transport_keys(&self) -> Option<([u8; 32], [u8; 32])> {
2025-09-08T23:46:52.1256071Z +        match (self.tx_key, self.rx_key) {
2025-09-08T23:46:52.1256172Z +            (Some(tx), Some(rx)) => Some((tx, rx)),
2025-09-08T23:46:52.1256243Z +            _ => None,
2025-09-08T23:46:52.1256311Z +        }
2025-09-08T23:46:52.1256382Z      }
2025-09-08T23:46:52.1256440Z  
2025-09-08T23:46:52.1256596Z      // Exporter that binds to transcript hash
2025-09-08T23:46:52.1256748Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:82:
2025-09-08T23:46:52.1256885Z -    pub fn exporter(&self, label: &[u8]) -> Option<[u8;32]> {
2025-09-08T23:46:52.1257098Z -        if !self.is_done() { return None; }
2025-09-08T23:46:52.1257245Z +    pub fn exporter(&self, label: &[u8]) -> Option<[u8; 32]> {
2025-09-08T23:46:52.1257325Z +        if !self.is_done() {
2025-09-08T23:46:52.1257401Z +            return None;
2025-09-08T23:46:52.1257470Z +        }
2025-09-08T23:46:52.1257716Z          let mut info = Vec::with_capacity(9 + label.len() + 32);
2025-09-08T23:46:52.1257899Z          info.extend_from_slice(b"exporter:");
2025-09-08T23:46:52.1258060Z          info.extend_from_slice(label);
2025-09-08T23:46:52.1258211Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:92:
2025-09-08T23:46:52.1258310Z      // Initiator: -> e
2025-09-08T23:46:52.1258561Z      fn initiator_msg1(&mut self) -> Result<Option<Vec<u8>>, &'static str> {
2025-09-08T23:46:52.1258786Z          let mut rng = rand::rngs::StdRng::seed_from_u64(7);
2025-09-08T23:46:52.1258924Z -        let mut ei_bytes = [0u8;32]; rng.fill_bytes(&mut ei_bytes);
2025-09-08T23:46:52.1259018Z +        let mut ei_bytes = [0u8; 32];
2025-09-08T23:46:52.1259194Z +        rng.fill_bytes(&mut ei_bytes);
2025-09-08T23:46:52.1259524Z          let ei = Scalar::from_bytes_mod_order(ei_bytes); // deterministic for tests
2025-09-08T23:46:52.1259728Z          let eipk = (ei * X25519_BASEPOINT).to_bytes();
2025-09-08T23:46:52.1259895Z          self.h = mix_hash(&self.h, &eipk);
2025-09-08T23:46:52.1260045Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:102:
2025-09-08T23:46:52.1260104Z  
2025-09-08T23:46:52.1260235Z      // Responder: <- e, -> e, ee, s, es
2025-09-08T23:46:52.1260520Z      fn responder_msg2(&mut self, m1: &[u8]) -> Result<Option<Vec<u8>>, &'static str> {
2025-09-08T23:46:52.1260634Z -        if m1.len() != 32 { return Err("bad m1 len"); }
2025-09-08T23:46:52.1260751Z -        let ei = <[u8;32]>::try_from(m1).map_err(|_| "m1")?;
2025-09-08T23:46:52.1260833Z +        if m1.len() != 32 {
2025-09-08T23:46:52.1260918Z +            return Err("bad m1 len");
2025-09-08T23:46:52.1260986Z +        }
2025-09-08T23:46:52.1261109Z +        let ei = <[u8; 32]>::try_from(m1).map_err(|_| "m1")?;
2025-09-08T23:46:52.1261267Z          self.h = mix_hash(&self.h, &ei);
2025-09-08T23:46:52.1261637Z          self.re = Some(ei);
2025-09-08T23:46:52.1261697Z  
2025-09-08T23:46:52.1261859Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:110:
2025-09-08T23:46:52.1261951Z -    // Generate responder ephemeral
2025-09-08T23:46:52.1262081Z -    let mut rng = rand::rngs::StdRng::seed_from_u64(13);
2025-09-08T23:46:52.1262221Z -    let mut er_bytes = [0u8;32]; rng.fill_bytes(&mut er_bytes);
2025-09-08T23:46:52.1262334Z -    let er = Scalar::from_bytes_mod_order(er_bytes);
2025-09-08T23:46:52.1262441Z -    let erpk = (er * X25519_BASEPOINT).to_bytes();
2025-09-08T23:46:52.1262538Z +        // Generate responder ephemeral
2025-09-08T23:46:52.1262659Z +        let mut rng = rand::rngs::StdRng::seed_from_u64(13);
2025-09-08T23:46:52.1262748Z +        let mut er_bytes = [0u8; 32];
2025-09-08T23:46:52.1262841Z +        rng.fill_bytes(&mut er_bytes);
2025-09-08T23:46:52.1262966Z +        let er = Scalar::from_bytes_mod_order(er_bytes);
2025-09-08T23:46:52.1263078Z +        let erpk = (er * X25519_BASEPOINT).to_bytes();
2025-09-08T23:46:52.1263243Z          self.h = mix_hash(&self.h, &erpk);
2025-09-08T23:46:52.1263389Z          self.e = Some((er, erpk));
2025-09-08T23:46:52.1263448Z  
2025-09-08T23:46:52.1263597Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:118:
2025-09-08T23:46:52.1263750Z          // ck, k = MixKey(DH(e_r, e_i))
2025-09-08T23:46:52.1263898Z          let dh_ee = x25519(&er, &ei);
2025-09-08T23:46:52.1263997Z -    let (ck1, k1) = mix_key(self.ck, &dh_ee);
2025-09-08T23:46:52.1264070Z -    self.ck = ck1;
2025-09-08T23:46:52.1264177Z +        let (ck1, k1) = mix_key(self.ck, &dh_ee);
2025-09-08T23:46:52.1264251Z +        self.ck = ck1;
2025-09-08T23:46:52.1264391Z          // Encrypt s_r with key k1
2025-09-08T23:46:52.1264510Z -    let (sr, srpk) = self.s.as_ref().ok_or("no sr")?;
2025-09-08T23:46:52.1264727Z -    let aad = self.h; // AAD is h
2025-09-08T23:46:52.1264823Z -        let mut nonce = [0u8;12]; // n=0
2025-09-08T23:46:52.1264941Z +        let (sr, srpk) = self.s.as_ref().ok_or("no sr")?;
2025-09-08T23:46:52.1265029Z +        let aad = self.h; // AAD is h
2025-09-08T23:46:52.1265116Z +        let mut nonce = [0u8; 12]; // n=0
2025-09-08T23:46:52.1265377Z          let ct_s = aead_seal(&k1, &mut nonce, &aad, srpk.as_slice());
2025-09-08T23:46:52.1265544Z          self.h = mix_hash(&self.h, &ct_s);
2025-09-08T23:46:52.1265603Z  
2025-09-08T23:46:52.1265753Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:129:
2025-09-08T23:46:52.1265844Z -    // MixKey with es = DH(e_i, s_r)
2025-09-08T23:46:52.1265926Z -    let dh_es = x25519(sr, &ei);
2025-09-08T23:46:52.1266022Z -    let (ck2, k2) = mix_key(self.ck, &dh_es);
2025-09-08T23:46:52.1266094Z -    self.ck = ck2;
2025-09-08T23:46:52.1266241Z -    self.cur_k = Some(k2); // save k2 for decrypting s_i in m3
2025-09-08T23:46:52.1266334Z +        // MixKey with es = DH(e_i, s_r)
2025-09-08T23:46:52.1266525Z +        let dh_es = x25519(sr, &ei);
2025-09-08T23:46:52.1266628Z +        let (ck2, k2) = mix_key(self.ck, &dh_es);
2025-09-08T23:46:52.1266704Z +        self.ck = ck2;
2025-09-08T23:46:52.1266843Z +        self.cur_k = Some(k2); // save k2 for decrypting s_i in m3
2025-09-08T23:46:52.1266902Z  
2025-09-08T23:46:52.1267063Z          // Build message2: er || enc(s_r)
2025-09-08T23:46:52.1267284Z          let mut out = Vec::with_capacity(32 + ct_s.len());
2025-09-08T23:46:52.1267434Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:141:
2025-09-08T23:46:52.1267496Z  
2025-09-08T23:46:52.1267624Z      // Initiator: receive m2, -> s, se
2025-09-08T23:46:52.1267903Z      fn initiator_msg3(&mut self, m2: &[u8]) -> Result<Option<Vec<u8>>, &'static str> {
2025-09-08T23:46:52.1268024Z -        if m2.len() < 32 + 16 { return Err("bad m2 len"); }
2025-09-08T23:46:52.1268165Z -        let er = <[u8;32]>::try_from(&m2[..32]).map_err(|_| "m2 er")?;
2025-09-08T23:46:52.1268250Z +        if m2.len() < 32 + 16 {
2025-09-08T23:46:52.1268336Z +            return Err("bad m2 len");
2025-09-08T23:46:52.1268405Z +        }
2025-09-08T23:46:52.1268532Z +        let er = <[u8; 32]>::try_from(&m2[..32]).map_err(|_| "m2 er")?;
2025-09-08T23:46:52.1268688Z          self.h = mix_hash(&self.h, &er);
2025-09-08T23:46:52.1268817Z          self.re = Some(er);
2025-09-08T23:46:52.1268944Z          let ct_s = &m2[32..];
2025-09-08T23:46:52.1269095Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:149:
2025-09-08T23:46:52.1269159Z  
2025-09-08T23:46:52.1269276Z          // MixKey with ee
2025-09-08T23:46:52.1269384Z -    let (ei, _) = self.e.as_ref().ok_or("no ei")?;
2025-09-08T23:46:52.1269491Z +        let (ei, _) = self.e.as_ref().ok_or("no ei")?;
2025-09-08T23:46:52.1269640Z          let dh_ee = x25519(ei, &er);
2025-09-08T23:46:52.1269736Z -    let (ck1, k1) = mix_key(self.ck, &dh_ee);
2025-09-08T23:46:52.1269809Z -    self.ck = ck1;
2025-09-08T23:46:52.1269920Z +        let (ck1, k1) = mix_key(self.ck, &dh_ee);
2025-09-08T23:46:52.1269995Z +        self.ck = ck1;
2025-09-08T23:46:52.1270054Z  
2025-09-08T23:46:52.1270163Z          // Decrypt s_r
2025-09-08T23:46:52.1270241Z -    let aad = self.h;
2025-09-08T23:46:52.1270328Z -        let mut nonce = [0u8;12];
2025-09-08T23:46:52.1270403Z +        let aad = self.h;
2025-09-08T23:46:52.1270489Z +        let mut nonce = [0u8; 12];
2025-09-08T23:46:52.1270821Z          let srpk = aead_open(&k1, &mut nonce, &aad, ct_s).map_err(|_| "decrypt s_r")?;
2025-09-08T23:46:52.1270981Z          self.h = mix_hash(&self.h, ct_s);
2025-09-08T23:46:52.1271241Z          self.rs = srpk.as_slice().try_into().map_err(|_| "srpk")?;
2025-09-08T23:46:52.1271606Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:162:
2025-09-08T23:46:52.1271704Z  
2025-09-08T23:46:52.1271972Z          // MixKey with es = DH(e_i, s_r)
2025-09-08T23:46:52.1272136Z          let dh_es = x25519(ei, &self.rs);
2025-09-08T23:46:52.1272363Z -    let (ck2, k2) = mix_key(self.ck, &dh_es);
2025-09-08T23:46:52.1272445Z -    self.ck = ck2;
2025-09-08T23:46:52.1272574Z -    self.cur_k = Some(k2); // save k2 for encrypting s_i
2025-09-08T23:46:52.1272671Z +        let (ck2, k2) = mix_key(self.ck, &dh_es);
2025-09-08T23:46:52.1272744Z +        self.ck = ck2;
2025-09-08T23:46:52.1272866Z +        self.cur_k = Some(k2); // save k2 for encrypting s_i
2025-09-08T23:46:52.1272929Z  
2025-09-08T23:46:52.1273091Z          // Now send s_i and MixKey with se
2025-09-08T23:46:52.1273205Z -    let (si, sipk) = self.s.as_ref().ok_or("no si")?;
2025-09-08T23:46:52.1273297Z -    // Encrypt s_i with current k2
2025-09-08T23:46:52.1273387Z -    let k2 = self.cur_k.ok_or("no k2")?;
2025-09-08T23:46:52.1273459Z -    let aad2 = self.h;
2025-09-08T23:46:52.1273544Z -    let mut nonce2 = [0u8;12];
2025-09-08T23:46:52.1273703Z -    let ct_si = aead_seal(&k2, &mut nonce2, &aad2, sipk.as_slice());
2025-09-08T23:46:52.1273818Z +        let (si, sipk) = self.s.as_ref().ok_or("no si")?;
2025-09-08T23:46:52.1274025Z +        // Encrypt s_i with current k2
2025-09-08T23:46:52.1274124Z +        let k2 = self.cur_k.ok_or("no k2")?;
2025-09-08T23:46:52.1274200Z +        let aad2 = self.h;
2025-09-08T23:46:52.1274282Z +        let mut nonce2 = [0u8; 12];
2025-09-08T23:46:52.1274432Z +        let ct_si = aead_seal(&k2, &mut nonce2, &aad2, sipk.as_slice());
2025-09-08T23:46:52.1274597Z          self.h = mix_hash(&self.h, &ct_si);
2025-09-08T23:46:52.1274657Z  
2025-09-08T23:46:52.1274752Z -    // Then MixKey with se = DH(s_i, e_r)
2025-09-08T23:46:52.1274835Z -    let dh_se = x25519(si, &er);
2025-09-08T23:46:52.1274933Z -    let (ck3, _k3) = mix_key(self.ck, &dh_se);
2025-09-08T23:46:52.1275003Z -    self.ck = ck3;
2025-09-08T23:46:52.1275101Z +        // Then MixKey with se = DH(s_i, e_r)
2025-09-08T23:46:52.1275182Z +        let dh_se = x25519(si, &er);
2025-09-08T23:46:52.1275279Z +        let (ck3, _k3) = mix_key(self.ck, &dh_se);
2025-09-08T23:46:52.1275355Z +        self.ck = ck3;
2025-09-08T23:46:52.1275423Z  
2025-09-08T23:46:52.1275552Z          // Split traffic keys
2025-09-08T23:46:52.1275714Z          let (k_tx, k_rx) = split(self.ck);
2025-09-08T23:46:52.1275869Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:189:
2025-09-08T23:46:52.1275928Z  
2025-09-08T23:46:52.1276115Z      // Responder: receive m3 (enc s_i), finalize and split
2025-09-08T23:46:52.1276398Z      fn responder_finalize_msg3(&mut self, m3: &[u8]) -> Result<(), &'static str> {
2025-09-08T23:46:52.1276509Z -        if m3.len() < 16 { return Err("bad m3 len"); }
2025-09-08T23:46:52.1276594Z -    // Decrypt s_i with current k2
2025-09-08T23:46:52.1276690Z -    let k2 = self.cur_k.ok_or("no k2")?;
2025-09-08T23:46:52.1276762Z -    let aad = self.h;
2025-09-08T23:46:52.1276843Z -    let mut nonce = [0u8;12];
2025-09-08T23:46:52.1277020Z -    let sipk = aead_open(&k2, &mut nonce, &aad, m3).map_err(|_| "decrypt s_i")?;
2025-09-08T23:46:52.1277102Z +        if m3.len() < 16 {
2025-09-08T23:46:52.1277194Z +            return Err("bad m3 len");
2025-09-08T23:46:52.1277263Z +        }
2025-09-08T23:46:52.1277356Z +        // Decrypt s_i with current k2
2025-09-08T23:46:52.1277450Z +        let k2 = self.cur_k.ok_or("no k2")?;
2025-09-08T23:46:52.1277527Z +        let aad = self.h;
2025-09-08T23:46:52.1277609Z +        let mut nonce = [0u8; 12];
2025-09-08T23:46:52.1277790Z +        let sipk = aead_open(&k2, &mut nonce, &aad, m3).map_err(|_| "decrypt s_i")?;
2025-09-08T23:46:52.1277943Z          self.h = mix_hash(&self.h, m3);
2025-09-08T23:46:52.1278148Z -    self.rs = sipk.as_slice().try_into().map_err(|_| "sipk")?; // store initiator static
2025-09-08T23:46:52.1278248Z -    // Then MixKey with se = DH(e_r, s_i)
2025-09-08T23:46:52.1278364Z -    let (er, _erpk) = self.e.as_ref().ok_or("no er")?;
2025-09-08T23:46:52.1278451Z -    let dh_se = x25519(er, &self.rs);
2025-09-08T23:46:52.1278556Z -    let (ck3, _k3) = mix_key(self.ck, &dh_se);
2025-09-08T23:46:52.1278628Z -    self.ck = ck3;
2025-09-08T23:46:52.1278910Z +        self.rs = sipk.as_slice().try_into().map_err(|_| "sipk")?; // store initiator static
2025-09-08T23:46:52.1279057Z +                                                                   // Then MixKey with se = DH(e_r, s_i)
2025-09-08T23:46:52.1279175Z +        let (er, _erpk) = self.e.as_ref().ok_or("no er")?;
2025-09-08T23:46:52.1279265Z +        let dh_se = x25519(er, &self.rs);
2025-09-08T23:46:52.1279367Z +        let (ck3, _k3) = mix_key(self.ck, &dh_se);
2025-09-08T23:46:52.1279445Z +        self.ck = ck3;
2025-09-08T23:46:52.1279643Z          // Split keys; responder.tx == initiator.rx
2025-09-08T23:46:52.1279797Z          let (k1, k2) = split(self.ck);
2025-09-08T23:46:52.1279937Z          self.tx_key = Some(k2);
2025-09-08T23:46:52.1280094Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:210:
2025-09-08T23:46:52.1280163Z      }
2025-09-08T23:46:52.1280222Z  }
2025-09-08T23:46:52.1280285Z  
2025-09-08T23:46:52.1280481Z -fn aead_seal(key: &[u8;32], nonce12: &mut [u8;12], aad: &[u8], pt: &[u8]) -> Vec<u8> {
2025-09-08T23:46:52.1280744Z +fn aead_seal(key: &[u8; 32], nonce12: &mut [u8; 12], aad: &[u8], pt: &[u8]) -> Vec<u8> {
2025-09-08T23:46:52.1280904Z      crypto::aead::seal(key, nonce12, aad, pt)
2025-09-08T23:46:52.1280964Z  }
2025-09-08T23:46:52.1281169Z -fn aead_open(key: &[u8;32], nonce12: &mut [u8;12], aad: &[u8], ct: &[u8]) -> Result<Vec<u8>, ()> {
2025-09-08T23:46:52.1281613Z +fn aead_open(key: &[u8; 32], nonce12: &mut [u8; 12], aad: &[u8], ct: &[u8]) -> Result<Vec<u8>, ()> {
2025-09-08T23:46:52.1281827Z      crypto::aead::open(key, nonce12, aad, ct).map_err(|_| ())
2025-09-08T23:46:52.1281886Z  }
2025-09-08T23:46:52.1281945Z  
2025-09-08T23:46:52.1282102Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:220:
2025-09-08T23:46:52.1282223Z -fn x25519(sk: &Scalar, peer_pk: &[u8;32]) -> [u8;32] {
2025-09-08T23:46:52.1282344Z +fn x25519(sk: &Scalar, peer_pk: &[u8; 32]) -> [u8; 32] {
2025-09-08T23:46:52.1282488Z      let p = MontgomeryPoint(*peer_pk);
2025-09-08T23:46:52.1282603Z      let shared = sk * p;
2025-09-08T23:46:52.1282705Z      shared.to_bytes()
2025-09-08T23:46:52.1282859Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:236:
2025-09-08T23:46:52.1282929Z      }
2025-09-08T23:46:52.1282987Z  }
2025-09-08T23:46:52.1283045Z  
2025-09-08T23:46:52.1283160Z -fn mix_hash(h: &[u8;32], data: &[u8]) -> [u8;32] {
2025-09-08T23:46:52.1283271Z +fn mix_hash(h: &[u8; 32], data: &[u8]) -> [u8; 32] {
2025-09-08T23:46:52.1283399Z      let mut c = Sha256::new(&SHA256);
2025-09-08T23:46:52.1283498Z      c.update(h);
2025-09-08T23:46:52.1283588Z      c.update(data);
2025-09-08T23:46:52.1283734Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:244:
2025-09-08T23:46:52.1283885Z      <[u8; 32]>::try_from(d.as_ref()).unwrap()
2025-09-08T23:46:52.1283944Z  }
2025-09-08T23:46:52.1284003Z  
2025-09-08T23:46:52.1284139Z -fn mix_key(mut ck: [u8;32], ikm: &[u8]) -> ([u8;32], [u8;32]) {
2025-09-08T23:46:52.1284280Z +fn mix_key(mut ck: [u8; 32], ikm: &[u8]) -> ([u8; 32], [u8; 32]) {
2025-09-08T23:46:52.1284441Z      let prk = crypto::hkdf::extract(&ck, ikm);
2025-09-08T23:46:52.1284620Z      let out: [u8; 64] = crypto::hkdf::expand(&prk, b"");
2025-09-08T23:46:52.1284753Z      ck.copy_from_slice(&out[..32]);
2025-09-08T23:46:52.1284901Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:251:
2025-09-08T23:46:52.1284980Z -    let mut k = [0u8;32];
2025-09-08T23:46:52.1285056Z +    let mut k = [0u8; 32];
2025-09-08T23:46:52.1285190Z      k.copy_from_slice(&out[32..64]);
2025-09-08T23:46:52.1285268Z      (ck, k)
2025-09-08T23:46:52.1285326Z  }
2025-09-08T23:46:52.1285478Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:255:
2025-09-08T23:46:52.1285537Z  
2025-09-08T23:46:52.1285635Z -fn split(ck: [u8;32]) -> ([u8;32],[u8;32]) {
2025-09-08T23:46:52.1285739Z +fn split(ck: [u8; 32]) -> ([u8; 32], [u8; 32]) {
2025-09-08T23:46:52.1285885Z      let prk = crypto::hkdf::extract(&ck, &[]);
2025-09-08T23:46:52.1286069Z      let out: [u8; 64] = crypto::hkdf::expand(&prk, b"split");
2025-09-08T23:46:52.1286334Z -    let mut k1 = [0u8;32]; let mut k2 = [0u8;32];
2025-09-08T23:46:52.1286418Z +    let mut k1 = [0u8; 32];
2025-09-08T23:46:52.1286492Z +    let mut k2 = [0u8; 32];
2025-09-08T23:46:52.1286614Z      k1.copy_from_slice(&out[..32]);
2025-09-08T23:46:52.1286743Z      k2.copy_from_slice(&out[32..64]);
2025-09-08T23:46:52.1286819Z      (k1, k2)
2025-09-08T23:46:52.1286966Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:266:
2025-09-08T23:46:52.1287044Z  pub struct Client;
2025-09-08T23:46:52.1287123Z  pub struct Server;
2025-09-08T23:46:52.1287178Z  
2025-09-08T23:46:52.1287365Z -impl Client { pub fn dial(_addr: &str) -> Result<(), &'static str> { Ok(()) } }
2025-09-08T23:46:52.1287554Z -impl Server { pub fn accept(_bind: &str) -> Result<(), &'static str> { Ok(()) } }
2025-09-08T23:46:52.1287623Z +impl Client {
2025-09-08T23:46:52.1287745Z +    pub fn dial(_addr: &str) -> Result<(), &'static str> {
2025-09-08T23:46:52.1287812Z +        Ok(())
2025-09-08T23:46:52.1287871Z +    }
2025-09-08T23:46:52.1288041Z +}
2025-09-08T23:46:52.1288109Z +impl Server {
2025-09-08T23:46:52.1288244Z +    pub fn accept(_bind: &str) -> Result<(), &'static str> {
2025-09-08T23:46:52.1288308Z +        Ok(())
2025-09-08T23:46:52.1288368Z +    }
2025-09-08T23:46:52.1288425Z +}
2025-09-08T23:46:52.1288482Z  
2025-09-08T23:46:52.1288555Z -pub mod tls_mirror;
2025-09-08T23:46:52.1288622Z +pub mod api;
2025-09-08T23:46:52.1288696Z  pub mod inner;
2025-09-08T23:46:52.1288764Z  pub mod mux;
2025-09-08T23:46:52.1288829Z -pub mod api;
2025-09-08T23:46:52.1288905Z -pub mod transition;
2025-09-08T23:46:52.1288973Z  pub mod tl;
2025-09-08T23:46:52.1289042Z +pub mod tls_mirror;
2025-09-08T23:46:52.1289114Z +pub mod transition;
2025-09-08T23:46:52.1289172Z  
2025-09-08T23:46:52.1289239Z  #[cfg(test)]
2025-09-08T23:46:52.1289305Z  mod tests {
2025-09-08T23:46:52.1289459Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:282:
2025-09-08T23:46:52.1289517Z  
2025-09-08T23:46:52.1289662Z      // Deterministic static keys for test
2025-09-08T23:46:52.1289800Z      fn static_keys() -> (Scalar, Scalar) {
2025-09-08T23:46:52.1289923Z -    let si = Scalar::from_bytes_mod_order([1u8;32]);
2025-09-08T23:46:52.1290036Z -    let sr = Scalar::from_bytes_mod_order([2u8;32]);
2025-09-08T23:46:52.1290153Z +        let si = Scalar::from_bytes_mod_order([1u8; 32]);
2025-09-08T23:46:52.1290271Z +        let sr = Scalar::from_bytes_mod_order([2u8; 32]);
2025-09-08T23:46:52.1290364Z          (si, sr)
2025-09-08T23:46:52.1290432Z      }
2025-09-08T23:46:52.1290490Z  
2025-09-08T23:46:52.1290646Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:290:
2025-09-08T23:46:52.1290723Z      #[test]
2025-09-08T23:46:52.1290862Z      fn noise_xk_roundtrip_and_tamper() {
2025-09-08T23:46:52.1291013Z          let (si, sr) = static_keys();
2025-09-08T23:46:52.1291117Z -    let rs = (sr * X25519_BASEPOINT).to_bytes();
2025-09-08T23:46:52.1291219Z +        let rs = (sr * X25519_BASEPOINT).to_bytes();
2025-09-08T23:46:52.1291422Z  
2025-09-08T23:46:52.1291679Z          let mut init = Handshake::init_initiator(si, rs);
2025-09-08T23:46:52.1291890Z          let mut resp = Handshake::init_responder(sr);
2025-09-08T23:46:52.1292038Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:302:
2025-09-08T23:46:52.1292129Z          // m3
2025-09-08T23:46:52.1292337Z          let m3 = init.next(Some(&m2)).unwrap().unwrap();
2025-09-08T23:46:52.1292396Z  
2025-09-08T23:46:52.1292484Z -    assert!(init.is_done());
2025-09-08T23:46:52.1292572Z -    // Normal responder finalize
2025-09-08T23:46:52.1292674Z -    let _ = resp.next(Some(&m3)).unwrap();
2025-09-08T23:46:52.1292758Z -    assert!(resp.is_done());
2025-09-08T23:46:52.1292883Z -    let (k_tx, k_rx) = init.transport_keys().unwrap();
2025-09-08T23:46:52.1293003Z -    let (rk_tx, rk_rx) = resp.transport_keys().unwrap();
2025-09-08T23:46:52.1293162Z -    // For XK, initiator.tx should match responder.rx and vice versa
2025-09-08T23:46:52.1293246Z -    assert_eq!(k_tx, rk_rx);
2025-09-08T23:46:52.1293444Z -    assert_eq!(k_rx, rk_tx);
2025-09-08T23:46:52.1293536Z +        assert!(init.is_done());
2025-09-08T23:46:52.1293629Z +        // Normal responder finalize
2025-09-08T23:46:52.1293734Z +        let _ = resp.next(Some(&m3)).unwrap();
2025-09-08T23:46:52.1293818Z +        assert!(resp.is_done());
2025-09-08T23:46:52.1293938Z +        let (k_tx, k_rx) = init.transport_keys().unwrap();
2025-09-08T23:46:52.1294072Z +        let (rk_tx, rk_rx) = resp.transport_keys().unwrap();
2025-09-08T23:46:52.1294231Z +        // For XK, initiator.tx should match responder.rx and vice versa
2025-09-08T23:46:52.1294312Z +        assert_eq!(k_tx, rk_rx);
2025-09-08T23:46:52.1294401Z +        assert_eq!(k_rx, rk_tx);
2025-09-08T23:46:52.1294729Z          // Use tx_key to encrypt message and decrypt with same key (loopback test)
2025-09-08T23:46:52.1294807Z -    let nonce = [0u8;12];
2025-09-08T23:46:52.1294892Z +        let nonce = [0u8; 12];
2025-09-08T23:46:52.1295012Z          let pt = b"hello";
2025-09-08T23:46:52.1295262Z          let ct = crypto::aead::seal(&k_tx, &nonce, b"aad", pt);
2025-09-08T23:46:52.1295660Z          let got = crypto::aead::open(&k_tx, &nonce, b"aad", &ct).unwrap();
2025-09-08T23:46:52.1295818Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:319:
2025-09-08T23:46:52.1295946Z          assert_eq!(got, pt);
2025-09-08T23:46:52.1296004Z  
2025-09-08T23:46:52.1296103Z          // Tamper
2025-09-08T23:46:52.1296183Z -    let mut bad = ct.clone();
2025-09-08T23:46:52.1296263Z -    let last = bad.len()-1;
2025-09-08T23:46:52.1296341Z -    bad[last] ^= 1;
2025-09-08T23:46:52.1296424Z +        let mut bad = ct.clone();
2025-09-08T23:46:52.1296506Z +        let last = bad.len() - 1;
2025-09-08T23:46:52.1296581Z +        bad[last] ^= 1;
2025-09-08T23:46:52.1296878Z          assert!(crypto::aead::open(&k_tx, &nonce, b"aad", &bad).is_err());
2025-09-08T23:46:52.1296937Z  
2025-09-08T23:46:52.1297106Z          // Exporter is stable and non-zero
2025-09-08T23:46:52.1297265Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/lib.rs:328:
2025-09-08T23:46:52.1297463Z          let exp = init.exporter(b"test").unwrap();
2025-09-08T23:46:52.1297562Z -        assert!(exp.iter().any(|&b| b!=0));
2025-09-08T23:46:52.1297658Z +        assert!(exp.iter().any(|&b| b != 0));
2025-09-08T23:46:52.1297733Z      }
2025-09-08T23:46:52.1297792Z  }
2025-09-08T23:46:52.1297849Z  
2025-09-08T23:46:52.1297997Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:1:
2025-09-08T23:46:52.1298092Z -use bytes::{Bytes, BytesMut, BufMut};
2025-09-08T23:46:52.1298186Z +use bytes::{BufMut, Bytes, BytesMut};
2025-09-08T23:46:52.1298285Z  use std::collections::HashMap;
2025-09-08T23:46:52.1298390Z -use std::sync::{Arc, Mutex, Condvar, mpsc};
2025-09-08T23:46:52.1298490Z +use std::sync::{mpsc, Arc, Condvar, Mutex};
2025-09-08T23:46:52.1298566Z  use std::thread;
2025-09-08T23:46:52.1298658Z  use std::time::Duration;
2025-09-08T23:46:52.1298717Z  
2025-09-08T23:46:52.1298861Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:7:
2025-09-08T23:46:52.1298956Z -use core_framing as framing;
2025-09-08T23:46:52.1299041Z -use core_crypto as crypto;
2025-09-08T23:46:52.1299147Z  use crate::transition::SignedControl;
2025-09-08T23:46:52.1299229Z +use core_crypto as crypto;
2025-09-08T23:46:52.1299316Z +use core_framing as framing;
2025-09-08T23:46:52.1299399Z  use serde_cbor as cbor;
2025-09-08T23:46:52.1299458Z  
2025-09-08T23:46:52.1299542Z  type StreamId = u32;
2025-09-08T23:46:52.1299691Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:21:
2025-09-08T23:46:52.1299750Z  
2025-09-08T23:46:52.1299822Z  struct Inner {
2025-09-08T23:46:52.1299920Z      // Wire channels
2025-09-08T23:46:52.1300018Z -    tx: mpsc::Sender<Bytes>, // to peer
2025-09-08T23:46:52.1300122Z +    tx: mpsc::Sender<Bytes>,          // to peer
2025-09-08T23:46:52.1300386Z      rx: Mutex<mpsc::Receiver<Bytes>>, // from peer (Mutex to make Inner Sync)
2025-09-08T23:46:52.1300567Z      // Optional encryption state (L2 AEAD + KEY_UPDATE)
2025-09-08T23:46:52.1300769Z      enc: Mutex<Option<EncState>>,
2025-09-08T23:46:52.1300928Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:51:
2025-09-08T23:46:52.1301002Z  #[derive(Clone)]
2025-09-08T23:46:52.1301079Z  struct EncState {
2025-09-08T23:46:52.1301171Z      // transmit state
2025-09-08T23:46:52.1301248Z -    tx_key: [u8;32],
2025-09-08T23:46:52.1301520Z +    tx_key: [u8; 32],
2025-09-08T23:46:52.1301627Z      tx_ctr: u64,
2025-09-08T23:46:52.1301756Z      // receive state (new/current)
2025-09-08T23:46:52.1301834Z -    rx_key: [u8;32],
2025-09-08T23:46:52.1301908Z +    rx_key: [u8; 32],
2025-09-08T23:46:52.1301990Z      rx_ctr: u64,
2025-09-08T23:46:52.1302245Z      // old key overlap window (accept with old key up to remaining frames)
2025-09-08T23:46:52.1302354Z      rx_old: Option<OldKey>,
2025-09-08T23:46:52.1302497Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:61:
2025-09-08T23:46:52.1302562Z  }
2025-09-08T23:46:52.1302620Z  
2025-09-08T23:46:52.1302694Z  #[derive(Clone)]
2025-09-08T23:46:52.1302843Z -struct OldKey { key: [u8;32], ctr: u64, remaining: usize }
2025-09-08T23:46:52.1303045Z +struct OldKey {
2025-09-08T23:46:52.1303114Z +    key: [u8; 32],
2025-09-08T23:46:52.1303182Z +    ctr: u64,
2025-09-08T23:46:52.1303259Z +    remaining: usize,
2025-09-08T23:46:52.1303318Z +}
2025-09-08T23:46:52.1303376Z  
2025-09-08T23:46:52.1303449Z  impl Mux {
2025-09-08T23:46:52.1303707Z      pub fn new(tx: mpsc::Sender<Bytes>, rx: mpsc::Receiver<Bytes>) -> Self {
2025-09-08T23:46:52.1303852Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:80:
2025-09-08T23:46:52.1304053Z              control_open: Mutex::new(true),
2025-09-08T23:46:52.1304142Z          });
2025-09-08T23:46:52.1304200Z  
2025-09-08T23:46:52.1304303Z -        let mux = Mux { inner: inner.clone() };
2025-09-08T23:46:52.1304383Z +        let mux = Mux {
2025-09-08T23:46:52.1304469Z +            inner: inner.clone(),
2025-09-08T23:46:52.1304533Z +        };
2025-09-08T23:46:52.1304657Z          mux.spawn_reader();
2025-09-08T23:46:52.1304748Z          mux
2025-09-08T23:46:52.1304821Z      }
2025-09-08T23:46:52.1304966Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:87:
2025-09-08T23:46:52.1305030Z  
2025-09-08T23:46:52.1305321Z -    pub fn new_encrypted(tx: mpsc::Sender<Bytes>, rx: mpsc::Receiver<Bytes>, tx_key: [u8;32], rx_key: [u8;32]) -> Self {
2025-09-08T23:46:52.1305404Z +    pub fn new_encrypted(
2025-09-08T23:46:52.1305488Z +        tx: mpsc::Sender<Bytes>,
2025-09-08T23:46:52.1305581Z +        rx: mpsc::Receiver<Bytes>,
2025-09-08T23:46:52.1305654Z +        tx_key: [u8; 32],
2025-09-08T23:46:52.1305727Z +        rx_key: [u8; 32],
2025-09-08T23:46:52.1305800Z +    ) -> Self {
2025-09-08T23:46:52.1305944Z          let mux = Mux::new(tx, rx);
2025-09-08T23:46:52.1306023Z          {
2025-09-08T23:46:52.1306278Z              let mut enc = mux.inner.enc.lock().unwrap();
2025-09-08T23:46:52.1306424Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:92:
2025-09-08T23:46:52.1306615Z -            *enc = Some(EncState { tx_key, tx_ctr: 0, rx_key, rx_ctr: 0, rx_old: None });
2025-09-08T23:46:52.1306702Z +            *enc = Some(EncState {
2025-09-08T23:46:52.1306778Z +                tx_key,
2025-09-08T23:46:52.1306853Z +                tx_ctr: 0,
2025-09-08T23:46:52.1306922Z +                rx_key,
2025-09-08T23:46:52.1306999Z +                rx_ctr: 0,
2025-09-08T23:46:52.1307078Z +                rx_old: None,
2025-09-08T23:46:52.1307144Z +            });
2025-09-08T23:46:52.1307224Z          }
2025-09-08T23:46:52.1307311Z          mux
2025-09-08T23:46:52.1307379Z      }
2025-09-08T23:46:52.1307529Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:101:
2025-09-08T23:46:52.1307642Z              loop {
2025-09-08T23:46:52.1307796Z                  let bytes = {
2025-09-08T23:46:52.1308118Z                      let rx = &mut *inner.rx.lock().unwrap();
2025-09-08T23:46:52.1308245Z -                    match rx.recv() { Ok(b) => b, Err(_) => break }
2025-09-08T23:46:52.1308329Z +                    match rx.recv() {
2025-09-08T23:46:52.1308551Z +                        Ok(b) => b,
2025-09-08T23:46:52.1308639Z +                        Err(_) => break,
2025-09-08T23:46:52.1308712Z +                    }
2025-09-08T23:46:52.1308818Z                  };
2025-09-08T23:46:52.1309345Z                  // If encrypted, attempt AEAD decode with current/new key, else fall back to plain
2025-09-08T23:46:52.1309520Z                  let frame_res = {
2025-09-08T23:46:52.1309669Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:111:
2025-09-08T23:46:52.1310070Z                          let nonce = Self::ctr_to_nonce(st.rx_ctr);
2025-09-08T23:46:52.1310504Z                          let keyctx = framing::KeyCtx { key: st.rx_key };
2025-09-08T23:46:52.1310928Z                          match framing::decode(&bytes, keyctx, nonce) {
2025-09-08T23:46:52.1311070Z -                            Ok(f) => { st.rx_ctr = st.rx_ctr.saturating_add(1); Ok(f) }
2025-09-08T23:46:52.1311152Z +                            Ok(f) => {
2025-09-08T23:46:52.1311278Z +                                st.rx_ctr = st.rx_ctr.saturating_add(1);
2025-09-08T23:46:52.1311686Z +                                Ok(f)
2025-09-08T23:46:52.1311765Z +                            }
2025-09-08T23:46:52.1312011Z                              Err(_) => {
2025-09-08T23:46:52.1312509Z                                  // Try old key if overlap window active
2025-09-08T23:46:52.1313001Z                                  if let Some(old) = st.rx_old.as_mut() {
2025-09-08T23:46:52.1313168Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:122:
2025-09-08T23:46:52.1313568Z                                              Ok(f) => {
2025-09-08T23:46:52.1314295Z                                                  old.ctr = old.ctr.saturating_add(1);
2025-09-08T23:46:52.1314849Z                                                  old.remaining -= 1;
2025-09-08T23:46:52.1314985Z -                                                if old.remaining == 0 { st.rx_old = None; }
2025-09-08T23:46:52.1315102Z +                                                if old.remaining == 0 {
2025-09-08T23:46:52.1315211Z +                                                    st.rx_old = None;
2025-09-08T23:46:52.1315303Z +                                                }
2025-09-08T23:46:52.1315691Z                                                  Ok(f)
2025-09-08T23:46:52.1315997Z                                              }
2025-09-08T23:46:52.1316672Z                                              Err(_) => Err(framing::Error::Crypto),
2025-09-08T23:46:52.1316830Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:139:
2025-09-08T23:46:52.1317185Z                          framing::Frame::decode_plain(&bytes)
2025-09-08T23:46:52.1317315Z                      }
2025-09-08T23:46:52.1317423Z                  };
2025-09-08T23:46:52.1317556Z -                if let Ok(frame) = frame_res { match frame.ty {
2025-09-08T23:46:52.1317660Z +                if let Ok(frame) = frame_res {
2025-09-08T23:46:52.1317748Z +                    match frame.ty {
2025-09-08T23:46:52.1318078Z                          framing::FrameType::Stream => {
2025-09-08T23:46:52.1318474Z                              // payload: stream_id (u32) || data
2025-09-08T23:46:52.1318598Z -                            if frame.payload.len() < 4 { continue; }
2025-09-08T23:46:52.1318884Z -                            let id = u32::from_be_bytes([frame.payload[0], frame.payload[1], frame.payload[2], frame.payload[3]]);
2025-09-08T23:46:52.1318991Z +                            if frame.payload.len() < 4 {
2025-09-08T23:46:52.1319081Z +                                continue;
2025-09-08T23:46:52.1319155Z +                            }
2025-09-08T23:46:52.1319257Z +                            let id = u32::from_be_bytes([
2025-09-08T23:46:52.1319356Z +                                frame.payload[0],
2025-09-08T23:46:52.1319447Z +                                frame.payload[1],
2025-09-08T23:46:52.1319535Z +                                frame.payload[2],
2025-09-08T23:46:52.1319736Z +                                frame.payload[3],
2025-09-08T23:46:52.1319825Z +                            ]);
2025-09-08T23:46:52.1320255Z                              let data = frame.payload[4..].to_vec();
2025-09-08T23:46:52.1320315Z  
2025-09-08T23:46:52.1320914Z                              // Stream 0 is reserved for control messages (CBOR-encoded)
2025-09-08T23:46:52.1321072Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:172:
2025-09-08T23:46:52.1321916Z                                      let mut rem = inner.remote_credit.lock().unwrap();
2025-09-08T23:46:52.1322403Z                                      rem.insert(id, INITIAL_WINDOW);
2025-09-08T23:46:52.1322604Z                                  }
2025-09-08T23:46:52.1322821Z -                                let handle = StreamHandle { id, mux: Mux { inner: inner.clone() }, rx: rx_data };
2025-09-08T23:46:52.1322931Z +                                let handle = StreamHandle {
2025-09-08T23:46:52.1323018Z +                                    id,
2025-09-08T23:46:52.1323232Z +                                    mux: Mux {
2025-09-08T23:46:52.1323332Z +                                        inner: inner.clone(),
2025-09-08T23:46:52.1323415Z +                                    },
2025-09-08T23:46:52.1323503Z +                                    rx: rx_data,
2025-09-08T23:46:52.1323581Z +                                };
2025-09-08T23:46:52.1324061Z                                  let _ = inner.accept_tx.send(handle);
2025-09-08T23:46:52.1324230Z                              }
2025-09-08T23:46:52.1324376Z                          }
2025-09-08T23:46:52.1324525Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:180:
2025-09-08T23:46:52.1325517Z                              // Update rx key: move current key to old window, derive new key, reset new ctr; accept up to 3 old frames
2025-09-08T23:46:52.1325952Z                              let mut enc = inner.enc.lock().unwrap();
2025-09-08T23:46:52.1326331Z                              if let Some(st) = enc.as_mut() {
2025-09-08T23:46:52.1326518Z -                                let old = OldKey { key: st.rx_key, ctr: st.rx_ctr, remaining: 3 };
2025-09-08T23:46:52.1326710Z -                                let prk = crypto::hkdf::extract(&st.rx_key, b"qnet/mux/key_update/v1");
2025-09-08T23:46:52.1326854Z -                                let newk: [u8;32] = crypto::hkdf::expand(&prk, b"key");
2025-09-08T23:46:52.1326952Z +                                let old = OldKey {
2025-09-08T23:46:52.1327046Z +                                    key: st.rx_key,
2025-09-08T23:46:52.1327141Z +                                    ctr: st.rx_ctr,
2025-09-08T23:46:52.1327237Z +                                    remaining: 3,
2025-09-08T23:46:52.1327314Z +                                };
2025-09-08T23:46:52.1327399Z +                                let prk =
2025-09-08T23:46:52.1327575Z +                                    crypto::hkdf::extract(&st.rx_key, b"qnet/mux/key_update/v1");
2025-09-08T23:46:52.1327732Z +                                let newk: [u8; 32] = crypto::hkdf::expand(&prk, b"key");
2025-09-08T23:46:52.1328098Z                                  st.rx_old = Some(old);
2025-09-08T23:46:52.1328411Z                                  st.rx_key = newk;
2025-09-08T23:46:52.1328707Z                                  st.rx_ctr = 0;
2025-09-08T23:46:52.1328858Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:196:
2025-09-08T23:46:52.1329004Z                          }
2025-09-08T23:46:52.1329371Z                          framing::FrameType::WindowUpdate => {
2025-09-08T23:46:52.1329822Z                              // payload: stream_id (u32) || credit (u32)
2025-09-08T23:46:52.1329939Z -                            if frame.payload.len() < 8 { continue; }
2025-09-08T23:46:52.1330218Z -                            let id = u32::from_be_bytes([frame.payload[0], frame.payload[1], frame.payload[2], frame.payload[3]]);
2025-09-08T23:46:52.1330622Z -                            let inc = u32::from_be_bytes([frame.payload[4], frame.payload[5], frame.payload[6], frame.payload[7]]) as usize;
2025-09-08T23:46:52.1330739Z +                            if frame.payload.len() < 8 {
2025-09-08T23:46:52.1330828Z +                                continue;
2025-09-08T23:46:52.1330902Z +                            }
2025-09-08T23:46:52.1331002Z +                            let id = u32::from_be_bytes([
2025-09-08T23:46:52.1331094Z +                                frame.payload[0],
2025-09-08T23:46:52.1331189Z +                                frame.payload[1],
2025-09-08T23:46:52.1331275Z +                                frame.payload[2],
2025-09-08T23:46:52.1331467Z +                                frame.payload[3],
2025-09-08T23:46:52.1331549Z +                            ]);
2025-09-08T23:46:52.1331650Z +                            let inc = u32::from_be_bytes([
2025-09-08T23:46:52.1331737Z +                                frame.payload[4],
2025-09-08T23:46:52.1331835Z +                                frame.payload[5],
2025-09-08T23:46:52.1332038Z +                                frame.payload[6],
2025-09-08T23:46:52.1332125Z +                                frame.payload[7],
2025-09-08T23:46:52.1332207Z +                            ]) as usize;
2025-09-08T23:46:52.1332727Z                              let mut rem = inner.remote_credit.lock().unwrap();
2025-09-08T23:46:52.1333125Z                              let e = rem.entry(id).or_insert(0);
2025-09-08T23:46:52.1333467Z                              *e = e.saturating_add(inc);
2025-09-08T23:46:52.1333625Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:205:
2025-09-08T23:46:52.1333984Z                              inner.credit_cv.notify_all();
2025-09-08T23:46:52.1334130Z                          }
2025-09-08T23:46:52.1334311Z                          _ => {}
2025-09-08T23:46:52.1334382Z -                    } }
2025-09-08T23:46:52.1334449Z +                    }
2025-09-08T23:46:52.1334516Z +                }
2025-09-08T23:46:52.1334610Z              }
2025-09-08T23:46:52.1334700Z          });
2025-09-08T23:46:52.1334767Z      }
2025-09-08T23:46:52.1334922Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:224:
2025-09-08T23:46:52.1335233Z              let mut incoming = self.inner.incoming.lock().unwrap();
2025-09-08T23:46:52.1335423Z              incoming.insert(id, tx_data);
2025-09-08T23:46:52.1335499Z          }
2025-09-08T23:46:52.1335634Z -        StreamHandle { id, mux: self.clone(), rx: rx_data }
2025-09-08T23:46:52.1335712Z +        StreamHandle {
2025-09-08T23:46:52.1335778Z +            id,
2025-09-08T23:46:52.1335866Z +            mux: self.clone(),
2025-09-08T23:46:52.1335939Z +            rx: rx_data,
2025-09-08T23:46:52.1336002Z +        }
2025-09-08T23:46:52.1336074Z      }
2025-09-08T23:46:52.1336134Z  
2025-09-08T23:46:52.1336400Z      pub fn accept_stream(&self, timeout: Duration) -> Option<StreamHandle> {
2025-09-08T23:46:52.1336551Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:233:
2025-09-08T23:46:52.1336626Z      }
2025-09-08T23:46:52.1336689Z  
2025-09-08T23:46:52.1336895Z      fn send_window_update(&self, id: StreamId, credit: usize) {
2025-09-08T23:46:52.1337013Z -    let mut payload = BytesMut::with_capacity(8);
2025-09-08T23:46:52.1337112Z -    payload.put_slice(&id.to_be_bytes());
2025-09-08T23:46:52.1337236Z -    payload.put_slice(&(credit as u32).to_be_bytes());
2025-09-08T23:46:52.1337484Z -    let frame = framing::Frame { ty: framing::FrameType::WindowUpdate, payload: payload.to_vec() };
2025-09-08T23:46:52.1337572Z -    self.send_frame(frame);
2025-09-08T23:46:52.1337688Z +        let mut payload = BytesMut::with_capacity(8);
2025-09-08T23:46:52.1337788Z +        payload.put_slice(&id.to_be_bytes());
2025-09-08T23:46:52.1337920Z +        payload.put_slice(&(credit as u32).to_be_bytes());
2025-09-08T23:46:52.1338010Z +        let frame = framing::Frame {
2025-09-08T23:46:52.1338112Z +            ty: framing::FrameType::WindowUpdate,
2025-09-08T23:46:52.1338207Z +            payload: payload.to_vec(),
2025-09-08T23:46:52.1338387Z +        };
2025-09-08T23:46:52.1338475Z +        self.send_frame(frame);
2025-09-08T23:46:52.1338543Z      }
2025-09-08T23:46:52.1338608Z  
2025-09-08T23:46:52.1338773Z      fn send_data(&self, id: StreamId, data: &[u8]) {
2025-09-08T23:46:52.1338927Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:244:
2025-09-08T23:46:52.1339287Z          // Enforce rekey-close: if control is closed, drop data frames until reopened
2025-09-08T23:46:52.1339438Z -    if id != 0 && !*self.inner.control_open.lock().unwrap() { return; }
2025-09-08T23:46:52.1339569Z +        if id != 0 && !*self.inner.control_open.lock().unwrap() {
2025-09-08T23:46:52.1339643Z +            return;
2025-09-08T23:46:52.1339707Z +        }
2025-09-08T23:46:52.1339966Z          let mut payload = BytesMut::with_capacity(4 + data.len());
2025-09-08T23:46:52.1340145Z          payload.put_slice(&id.to_be_bytes());
2025-09-08T23:46:52.1340292Z          payload.put_slice(data);
2025-09-08T23:46:52.1340447Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:249:
2025-09-08T23:46:52.1340757Z -    let frame = framing::Frame { ty: framing::FrameType::Stream, payload: payload.to_vec() };
2025-09-08T23:46:52.1340843Z -    self.send_frame(frame);
2025-09-08T23:46:52.1340932Z +        let frame = framing::Frame {
2025-09-08T23:46:52.1341028Z +            ty: framing::FrameType::Stream,
2025-09-08T23:46:52.1341123Z +            payload: payload.to_vec(),
2025-09-08T23:46:52.1341187Z +        };
2025-09-08T23:46:52.1341268Z +        self.send_frame(frame);
2025-09-08T23:46:52.1341432Z      }
2025-09-08T23:46:52.1341496Z  
2025-09-08T23:46:52.1341748Z      fn take_credit_blocking(&self, id: StreamId, needed: usize) -> usize {
2025-09-08T23:46:52.1341899Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:265:
2025-09-08T23:46:52.1341962Z  }
2025-09-08T23:46:52.1342021Z  
2025-09-08T23:46:52.1342107Z  impl StreamHandle {
2025-09-08T23:46:52.1342212Z -    pub fn id(&self) -> StreamId { self.id }
2025-09-08T23:46:52.1342310Z +    pub fn id(&self) -> StreamId {
2025-09-08T23:46:52.1342382Z +        self.id
2025-09-08T23:46:52.1342444Z +    }
2025-09-08T23:46:52.1342509Z  
2025-09-08T23:46:52.1342705Z      // Write all data, respecting remote credit and chunking.
2025-09-08T23:46:52.1342842Z      pub fn write(&self, mut data: &[u8]) {
2025-09-08T23:46:52.1342989Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:272:
2025-09-08T23:46:52.1343078Z -    while !data.is_empty() {
2025-09-08T23:46:52.1343162Z +        while !data.is_empty() {
2025-09-08T23:46:52.1343367Z              let need = data.len().min(CHUNK);
2025-09-08T23:46:52.1343680Z              let take = self.mux.take_credit_blocking(self.id, need);
2025-09-08T23:46:52.1343906Z              let (chunk, rest) = data.split_at(take);
2025-09-08T23:46:52.1344054Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:300:
2025-09-08T23:46:52.1344134Z      (a, b)
2025-09-08T23:46:52.1344195Z  }
2025-09-08T23:46:52.1344252Z  
2025-09-08T23:46:52.1344505Z -pub fn pair_encrypted(a_tx_key: [u8;32], a_rx_key: [u8;32], b_tx_key: [u8;32], b_rx_key: [u8;32]) -> (Mux, Mux) {
2025-09-08T23:46:52.1344598Z +pub fn pair_encrypted(
2025-09-08T23:46:52.1344673Z +    a_tx_key: [u8; 32],
2025-09-08T23:46:52.1344746Z +    a_rx_key: [u8; 32],
2025-09-08T23:46:52.1344822Z +    b_tx_key: [u8; 32],
2025-09-08T23:46:52.1344893Z +    b_rx_key: [u8; 32],
2025-09-08T23:46:52.1344967Z +) -> (Mux, Mux) {
2025-09-08T23:46:52.1345142Z      let (a_tx, a_rx_peer) = mpsc::channel::<Bytes>();
2025-09-08T23:46:52.1345308Z      let (b_tx, b_rx_peer) = mpsc::channel::<Bytes>();
2025-09-08T23:46:52.1345526Z      let a = Mux::new_encrypted(a_tx, b_rx_peer, a_tx_key, a_rx_key);
2025-09-08T23:46:52.1345675Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:328:
2025-09-08T23:46:52.1345759Z          }
2025-09-08T23:46:52.1345826Z      }
2025-09-08T23:46:52.1345885Z  
2025-09-08T23:46:52.1345985Z -    fn ctr_to_nonce(ctr: u64) -> [u8;12] {
2025-09-08T23:46:52.1346065Z -        let mut n = [0u8;12];
2025-09-08T23:46:52.1346279Z +    fn ctr_to_nonce(ctr: u64) -> [u8; 12] {
2025-09-08T23:46:52.1346361Z +        let mut n = [0u8; 12];
2025-09-08T23:46:52.1346569Z          n[4..12].copy_from_slice(&ctr.to_le_bytes());
2025-09-08T23:46:52.1346648Z          n
2025-09-08T23:46:52.1346715Z      }
2025-09-08T23:46:52.1346868Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:340:
2025-09-08T23:46:52.1346995Z          if enc.is_some() {
2025-09-08T23:46:52.1347252Z              // Send notification first (under current key)
2025-09-08T23:46:52.1347376Z              drop(enc);
2025-09-08T23:46:52.1347604Z -            let frame = framing::Frame { ty: framing::FrameType::KeyUpdate, payload: Vec::new() };
2025-09-08T23:46:52.1347696Z +            let frame = framing::Frame {
2025-09-08T23:46:52.1347833Z +                ty: framing::FrameType::KeyUpdate,
2025-09-08T23:46:52.1347936Z +                payload: Vec::new(),
2025-09-08T23:46:52.1348007Z +            };
2025-09-08T23:46:52.1348182Z              self.send_frame(frame);
2025-09-08T23:46:52.1348512Z              // Now rotate the tx key
2025-09-08T23:46:52.1348779Z              let mut enc2 = self.inner.enc.lock().unwrap();
2025-09-08T23:46:52.1348939Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:347:
2025-09-08T23:46:52.1349150Z              if let Some(st2) = enc2.as_mut() {
2025-09-08T23:46:52.1349637Z                  let prk = crypto::hkdf::extract(&st2.tx_key, b"qnet/mux/key_update/v1");
2025-09-08T23:46:52.1349781Z -                let newk: [u8;32] = crypto::hkdf::expand(&prk, b"key");
2025-09-08T23:46:52.1349920Z +                let newk: [u8; 32] = crypto::hkdf::expand(&prk, b"key");
2025-09-08T23:46:52.1350109Z                  st2.tx_key = newk;
2025-09-08T23:46:52.1350277Z                  st2.tx_ctr = 0;
2025-09-08T23:46:52.1350373Z              }
2025-09-08T23:46:52.1350541Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:364:
2025-09-08T23:46:52.1350613Z  #[cfg(test)]
2025-09-08T23:46:52.1350683Z  mod tests {
2025-09-08T23:46:52.1350787Z      use super::*;
2025-09-08T23:46:52.1350868Z -    use std::thread;
2025-09-08T23:46:52.1351016Z      use crate::transition::ControlRecord;
2025-09-08T23:46:52.1351089Z +    use std::thread;
2025-09-08T23:46:52.1351152Z  
2025-09-08T23:46:52.1351230Z      #[test]
2025-09-08T23:46:52.1351548Z      fn many_concurrent_streams_echo() {
2025-09-08T23:46:52.1351715Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:372:
2025-09-08T23:46:52.1351802Z -    let (a, b) = pair();
2025-09-08T23:46:52.1351882Z +        let (a, b) = pair();
2025-09-08T23:46:52.1352007Z          let streams = 100;
2025-09-08T23:46:52.1352223Z          let payload = vec![7u8; 8 * 1024]; // 8 KiB each
2025-09-08T23:46:52.1352281Z  
2025-09-08T23:46:52.1352430Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:384:
2025-09-08T23:46:52.1352767Z                          while let Some(buf) = sh.read() {
2025-09-08T23:46:52.1353057Z                              total += buf.len();
2025-09-08T23:46:52.1353326Z                              sh.write(&buf);
2025-09-08T23:46:52.1353433Z -                            if total >= 8 * 1024 { break; }
2025-09-08T23:46:52.1353533Z +                            if total >= 8 * 1024 {
2025-09-08T23:46:52.1353612Z +                                break;
2025-09-08T23:46:52.1353686Z +                            }
2025-09-08T23:46:52.1353837Z                          }
2025-09-08T23:46:52.1353970Z                      });
2025-09-08T23:46:52.1354072Z                  }
2025-09-08T23:46:52.1354220Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:402:
2025-09-08T23:46:52.1354416Z                  let mut got = 0usize;
2025-09-08T23:46:52.1354660Z                  while let Some(buf) = sh.read() {
2025-09-08T23:46:52.1354863Z                      got += buf.len();
2025-09-08T23:46:52.1354965Z -                    if got >= p.len() { break; }
2025-09-08T23:46:52.1355049Z +                    if got >= p.len() {
2025-09-08T23:46:52.1355124Z +                        break;
2025-09-08T23:46:52.1355325Z +                    }
2025-09-08T23:46:52.1355431Z                  }
2025-09-08T23:46:52.1355640Z                  assert_eq!(got, p.len());
2025-09-08T23:46:52.1355738Z              }));
2025-09-08T23:46:52.1355892Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:409:
2025-09-08T23:46:52.1355970Z          }
2025-09-08T23:46:52.1356029Z  
2025-09-08T23:46:52.1356136Z -        for h in handles { h.join().unwrap(); }
2025-09-08T23:46:52.1356215Z +        for h in handles {
2025-09-08T23:46:52.1356293Z +            h.join().unwrap();
2025-09-08T23:46:52.1356357Z +        }
2025-09-08T23:46:52.1356501Z          server.join().unwrap();
2025-09-08T23:46:52.1356568Z      }
2025-09-08T23:46:52.1356627Z  
2025-09-08T23:46:52.1356777Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:417:
2025-09-08T23:46:52.1356913Z          // Build encrypted pair
2025-09-08T23:46:52.1357130Z          let (a_tx, a_rx_peer) = mpsc::channel::<Bytes>();
2025-09-08T23:46:52.1357350Z          let (b_tx, b_rx_peer) = mpsc::channel::<Bytes>();
2025-09-08T23:46:52.1357612Z -        let a = Mux::new_encrypted(a_tx, b_rx_peer, [1u8;32], [2u8;32]);
2025-09-08T23:46:52.1357754Z -        let b = Mux::new_encrypted(b_tx, a_rx_peer, [2u8;32], [1u8;32]);
2025-09-08T23:46:52.1357904Z +        let a = Mux::new_encrypted(a_tx, b_rx_peer, [1u8; 32], [2u8; 32]);
2025-09-08T23:46:52.1358056Z +        let b = Mux::new_encrypted(b_tx, a_rx_peer, [2u8; 32], [1u8; 32]);
2025-09-08T23:46:52.1358116Z  
2025-09-08T23:46:52.1358256Z          // Start echo server on b
2025-09-08T23:46:52.1358436Z          let server = thread::spawn(move || {
2025-09-08T23:46:52.1358591Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:425:
2025-09-08T23:46:52.1358913Z              if let Some(sh) = b.accept_stream(Duration::from_secs(1)) {
2025-09-08T23:46:52.1359160Z                  while let Some(buf) = sh.read() {
2025-09-08T23:46:52.1359351Z                      sh.write(&buf);
2025-09-08T23:46:52.1359454Z -                    if buf.len() >= 1024 { break; }
2025-09-08T23:46:52.1359545Z +                    if buf.len() >= 1024 {
2025-09-08T23:46:52.1359625Z +                        break;
2025-09-08T23:46:52.1359696Z +                    }
2025-09-08T23:46:52.1359802Z                  }
2025-09-08T23:46:52.1359897Z              }
2025-09-08T23:46:52.1359977Z          });
2025-09-08T23:46:52.1360126Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:441:
2025-09-08T23:46:52.1360260Z          let mut got = 0usize;
2025-09-08T23:46:52.1360419Z          while let Some(buf) = sh.read() {
2025-09-08T23:46:52.1360561Z              got += buf.len();
2025-09-08T23:46:52.1360644Z -            if got >= 1024 { break; }
2025-09-08T23:46:52.1360725Z +            if got >= 1024 {
2025-09-08T23:46:52.1360794Z +                break;
2025-09-08T23:46:52.1360859Z +            }
2025-09-08T23:46:52.1360941Z          }
2025-09-08T23:46:52.1361070Z          assert_eq!(got, 1024);
2025-09-08T23:46:52.1361208Z          server.join().unwrap();
2025-09-08T23:46:52.1361470Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:450:
2025-09-08T23:46:52.1361555Z      #[test]
2025-09-08T23:46:52.1361736Z      fn key_update_accepts_up_to_3_old_then_rejects() {
2025-09-08T23:46:52.1361921Z          // Create encrypted pair with known keys
2025-09-08T23:46:52.1362097Z -        let (a, b) = super::pair_encrypted([1u8;32], [2u8;32], [2u8;32], [1u8;32]);
2025-09-08T23:46:52.1362269Z +        let (a, b) = super::pair_encrypted([1u8; 32], [2u8; 32], [2u8; 32], [1u8; 32]);
2025-09-08T23:46:52.1362329Z  
2025-09-08T23:46:52.1362514Z          // Helper to build nonce from counter
2025-09-08T23:46:52.1362616Z -        fn nonce_from_ctr(ctr: u64) -> [u8;12] {
2025-09-08T23:46:52.1362698Z -            let mut n = [0u8;12];
2025-09-08T23:46:52.1362798Z +        fn nonce_from_ctr(ctr: u64) -> [u8; 12] {
2025-09-08T23:46:52.1362884Z +            let mut n = [0u8; 12];
2025-09-08T23:46:52.1363141Z              n[4..12].copy_from_slice(&ctr.to_le_bytes());
2025-09-08T23:46:52.1363353Z              n
2025-09-08T23:46:52.1363439Z          }
2025-09-08T23:46:52.1363592Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:463:
2025-09-08T23:46:52.1363730Z          let stream_id: u32 = 42;
2025-09-08T23:46:52.1363790Z  
2025-09-08T23:46:52.1364084Z          // 1) Send KEY_UPDATE encoded under current key ([1;32]) with ctr=0
2025-09-08T23:46:52.1364165Z -        let key_old = [1u8;32];
2025-09-08T23:46:52.1364395Z -        let frame_ku = framing::Frame { ty: framing::FrameType::KeyUpdate, payload: Vec::new() };
2025-09-08T23:46:52.1364647Z -            let bytes_ku = framing::encode(&frame_ku, framing::KeyCtx { key: key_old }, nonce_from_ctr(0));
2025-09-08T23:46:52.1364729Z +        let key_old = [1u8; 32];
2025-09-08T23:46:52.1364819Z +        let frame_ku = framing::Frame {
2025-09-08T23:46:52.1364930Z +            ty: framing::FrameType::KeyUpdate,
2025-09-08T23:46:52.1365014Z +            payload: Vec::new(),
2025-09-08T23:46:52.1365079Z +        };
2025-09-08T23:46:52.1365283Z +        let bytes_ku = framing::encode(
2025-09-08T23:46:52.1365359Z +            &frame_ku,
2025-09-08T23:46:52.1365453Z +            framing::KeyCtx { key: key_old },
2025-09-08T23:46:52.1365532Z +            nonce_from_ctr(0),
2025-09-08T23:46:52.1365600Z +        );
2025-09-08T23:46:52.1365675Z          {
2025-09-08T23:46:52.1365941Z              let tx = &a.inner.tx; // child module can access
2025-09-08T23:46:52.1366041Z -                tx.send(bytes_ku).unwrap();
2025-09-08T23:46:52.1366130Z +            tx.send(bytes_ku).unwrap();
2025-09-08T23:46:52.1366206Z          }
2025-09-08T23:46:52.1366264Z  
2025-09-08T23:46:52.1366575Z          // 2) Send three STREAM frames under old key with ctr 1,2,3 (accepted)
2025-09-08T23:46:52.1366727Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:476:
2025-09-08T23:46:52.1366918Z              let mut payload = Vec::new();
2025-09-08T23:46:52.1367216Z              payload.extend_from_slice(&stream_id.to_be_bytes());
2025-09-08T23:46:52.1367481Z              payload.extend_from_slice(&[b'a' + (i as u8)]);
2025-09-08T23:46:52.1367652Z -            let f = framing::Frame { ty: framing::FrameType::Stream, payload };
2025-09-08T23:46:52.1367744Z +            let f = framing::Frame {
2025-09-08T23:46:52.1367844Z +                ty: framing::FrameType::Stream,
2025-09-08T23:46:52.1367921Z +                payload,
2025-09-08T23:46:52.1367987Z +            };
2025-09-08T23:46:52.1368461Z              let bytes = framing::encode(&f, framing::KeyCtx { key: key_old }, nonce_from_ctr(ctr));
2025-09-08T23:46:52.1368659Z              a.inner.tx.send(bytes).unwrap();
2025-09-08T23:46:52.1368735Z          }
2025-09-08T23:46:52.1368892Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:486:
2025-09-08T23:46:52.1369082Z              let mut payload = Vec::new();
2025-09-08T23:46:52.1369372Z              payload.extend_from_slice(&stream_id.to_be_bytes());
2025-09-08T23:46:52.1369576Z              payload.extend_from_slice(b"d");
2025-09-08T23:46:52.1369743Z -            let f = framing::Frame { ty: framing::FrameType::Stream, payload };
2025-09-08T23:46:52.1369832Z +            let f = framing::Frame {
2025-09-08T23:46:52.1369927Z +                ty: framing::FrameType::Stream,
2025-09-08T23:46:52.1370006Z +                payload,
2025-09-08T23:46:52.1370071Z +            };
2025-09-08T23:46:52.1370524Z              let bytes = framing::encode(&f, framing::KeyCtx { key: key_old }, nonce_from_ctr(4));
2025-09-08T23:46:52.1370726Z              a.inner.tx.send(bytes).unwrap();
2025-09-08T23:46:52.1370805Z          }
2025-09-08T23:46:52.1370957Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:493:
2025-09-08T23:46:52.1371023Z  
2025-09-08T23:46:52.1371499Z          // 4) Send a STREAM under the new key (derived as HKDF(old,"key")) with ctr=0 (accepted)
2025-09-08T23:46:52.1371808Z          let prk = crypto::hkdf::extract(&key_old, b"qnet/mux/key_update/v1");
2025-09-08T23:46:52.1371950Z -        let key_new: [u8;32] = crypto::hkdf::expand(&prk, b"key");
2025-09-08T23:46:52.1372220Z +        let key_new: [u8; 32] = crypto::hkdf::expand(&prk, b"key");
2025-09-08T23:46:52.1372301Z          {
2025-09-08T23:46:52.1372489Z              let mut payload = Vec::new();
2025-09-08T23:46:52.1372785Z              payload.extend_from_slice(&stream_id.to_be_bytes());
2025-09-08T23:46:52.1372935Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:500:
2025-09-08T23:46:52.1373137Z              payload.extend_from_slice(b"n");
2025-09-08T23:46:52.1373308Z -            let f = framing::Frame { ty: framing::FrameType::Stream, payload };
2025-09-08T23:46:52.1373393Z +            let f = framing::Frame {
2025-09-08T23:46:52.1373487Z +                ty: framing::FrameType::Stream,
2025-09-08T23:46:52.1373562Z +                payload,
2025-09-08T23:46:52.1373633Z +            };
2025-09-08T23:46:52.1374091Z              let bytes = framing::encode(&f, framing::KeyCtx { key: key_new }, nonce_from_ctr(0));
2025-09-08T23:46:52.1374293Z              a.inner.tx.send(bytes).unwrap();
2025-09-08T23:46:52.1374479Z          }
2025-09-08T23:46:52.1374628Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:507:
2025-09-08T23:46:52.1374891Z          if let Some(sh) = b.accept_stream(Duration::from_secs(1)) {
2025-09-08T23:46:52.1375073Z              let mut got = Vec::new();
2025-09-08T23:46:52.1375393Z              // Read four small chunks; the rejected one will not arrive
2025-09-08T23:46:52.1375574Z -            for _ in 0..4 { if let Some(buf) = sh.read() { got.extend_from_slice(&buf); } }
2025-09-08T23:46:52.1375658Z +            for _ in 0..4 {
2025-09-08T23:46:52.1375753Z +                if let Some(buf) = sh.read() {
2025-09-08T23:46:52.1375850Z +                    got.extend_from_slice(&buf);
2025-09-08T23:46:52.1375917Z +                }
2025-09-08T23:46:52.1375987Z +            }
2025-09-08T23:46:52.1376161Z              assert_eq!(got, b"abcn");
2025-09-08T23:46:52.1376251Z          } else {
2025-09-08T23:46:52.1376454Z              panic!("did not accept stream");
2025-09-08T23:46:52.1376618Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:517:
2025-09-08T23:46:52.1376695Z      #[test]
2025-09-08T23:46:52.1376891Z      fn control_rekey_close_blocks_data_until_keyupdate() {
2025-09-08T23:46:52.1377020Z          // Encrypted pair
2025-09-08T23:46:52.1377192Z -        let (a, b) = super::pair_encrypted([1u8;32], [2u8;32], [2u8;32], [1u8;32]);
2025-09-08T23:46:52.1377366Z +        let (a, b) = super::pair_encrypted([1u8; 32], [2u8; 32], [2u8; 32], [1u8; 32]);
2025-09-08T23:46:52.1377430Z  
2025-09-08T23:46:52.1377690Z          // Spawn server to accept data on stream 1 and count bytes
2025-09-08T23:46:52.1377862Z          let server = thread::spawn(move || {
2025-09-08T23:46:52.1378015Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:524:
2025-09-08T23:46:52.1378371Z              let sh = b.accept_stream(Duration::from_secs(1)).expect("accept");
2025-09-08T23:46:52.1378535Z              let mut total = 0usize;
2025-09-08T23:46:52.1379078Z              // First phase should read initial chunk only; after rekey-close, data is dropped until KeyUpdate
2025-09-08T23:46:52.1379216Z -            if let Some(buf) = sh.read() { total += buf.len(); }
2025-09-08T23:46:52.1379310Z +            if let Some(buf) = sh.read() {
2025-09-08T23:46:52.1379390Z +                total += buf.len();
2025-09-08T23:46:52.1379459Z +            }
2025-09-08T23:46:52.1379712Z              // Sleep waiting; no more until after re-open
2025-09-08T23:46:52.1379834Z -            if let Some(buf) = sh.read() { total += buf.len(); }
2025-09-08T23:46:52.1379929Z +            if let Some(buf) = sh.read() {
2025-09-08T23:46:52.1380008Z +                total += buf.len();
2025-09-08T23:46:52.1380072Z +            }
2025-09-08T23:46:52.1380181Z              total
2025-09-08T23:46:52.1380264Z          });
2025-09-08T23:46:52.1380323Z  
2025-09-08T23:46:52.1380475Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:533:
2025-09-08T23:46:52.1381228Z          // Client: open stream 1, send some data, then send a control message which triggers rekey-close, then send more data, then key_update to reopen
2025-09-08T23:46:52.1381501Z          let sh = a.open_stream();
2025-09-08T23:46:52.1381597Z -    sh.write(&[1u8; 64]); // should arrive
2025-09-08T23:46:52.1381697Z +        sh.write(&[1u8; 64]); // should arrive
2025-09-08T23:46:52.1381757Z  
2025-09-08T23:46:52.1381931Z          // Send control message on stream 0
2025-09-08T23:46:52.1382177Z -        let rec = ControlRecord { prev_as: 1, next_as: 2, ts: 1_700_000_000, flow: 42, nonce: vec![0u8;16] };
2025-09-08T23:46:52.1382257Z -        let seed = [7u8;32];
2025-09-08T23:46:52.1382346Z +        let rec = ControlRecord {
2025-09-08T23:46:52.1382424Z +            prev_as: 1,
2025-09-08T23:46:52.1382502Z +            next_as: 2,
2025-09-08T23:46:52.1382578Z +            ts: 1_700_000_000,
2025-09-08T23:46:52.1382647Z +            flow: 42,
2025-09-08T23:46:52.1382730Z +            nonce: vec![0u8; 16],
2025-09-08T23:46:52.1382793Z +        };
2025-09-08T23:46:52.1382991Z +        let seed = [7u8; 32];
2025-09-08T23:46:52.1383151Z          let sc = rec.sign_ed25519(&seed);
2025-09-08T23:46:52.1383284Z          a.send_control(&sc);
2025-09-08T23:46:52.1383341Z  
2025-09-08T23:46:52.1383495Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:543:
2025-09-08T23:46:52.1383703Z          // While control is closed, data is dropped
2025-09-08T23:46:52.1383781Z -    sh.write(&[2u8; 64]);
2025-09-08T23:46:52.1383860Z +        sh.write(&[2u8; 64]);
2025-09-08T23:46:52.1383918Z  
2025-09-08T23:46:52.1384076Z          // Now rotate keys to reopen
2025-09-08T23:46:52.1384191Z          a.key_update();
2025-09-08T23:46:52.1384338Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/mux.rs:548:
2025-09-08T23:46:52.1384404Z  
2025-09-08T23:46:52.1384584Z          // Data after reopen should pass again
2025-09-08T23:46:52.1384662Z -    sh.write(&[3u8; 64]);
2025-09-08T23:46:52.1384739Z +        sh.write(&[3u8; 64]);
2025-09-08T23:46:52.1384803Z  
2025-09-08T23:46:52.1384981Z          let total = server.join().unwrap();
2025-09-08T23:46:52.1385264Z          // Expect exactly 128 bytes (64 before close + 64 after reopen)
2025-09-08T23:46:52.1385417Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tl.rs:19:
2025-09-08T23:46:52.1385477Z  }
2025-09-08T23:46:52.1385536Z  
2025-09-08T23:46:52.1385628Z  impl PolicyTracker {
2025-09-08T23:46:52.1385829Z -    pub fn new(now: u64) -> Self { Self { frames_since_update: 0, last_update_ts: now } }
2025-09-08T23:46:52.1386180Z -    pub fn on_frame_sent(&mut self, _frame: &framing::Frame) { self.frames_since_update = self.frames_since_update.saturating_add(1); }
2025-09-08T23:46:52.1386432Z -    pub fn mark_updated(&mut self, now: u64) { self.frames_since_update = 0; self.last_update_ts = now; }
2025-09-08T23:46:52.1386526Z +    pub fn new(now: u64) -> Self {
2025-09-08T23:46:52.1386593Z +        Self {
2025-09-08T23:46:52.1386678Z +            frames_since_update: 0,
2025-09-08T23:46:52.1386765Z +            last_update_ts: now,
2025-09-08T23:46:52.1386837Z +        }
2025-09-08T23:46:52.1386901Z +    }
2025-09-08T23:46:52.1387044Z +    pub fn on_frame_sent(&mut self, _frame: &framing::Frame) {
2025-09-08T23:46:52.1387235Z +        self.frames_since_update = self.frames_since_update.saturating_add(1);
2025-09-08T23:46:52.1387298Z +    }
2025-09-08T23:46:52.1387401Z +    pub fn mark_updated(&mut self, now: u64) {
2025-09-08T23:46:52.1387497Z +        self.frames_since_update = 0;
2025-09-08T23:46:52.1387583Z +        self.last_update_ts = now;
2025-09-08T23:46:52.1387644Z +    }
2025-09-08T23:46:52.1387709Z  }
2025-09-08T23:46:52.1387767Z  
2025-09-08T23:46:52.1388047Z  pub fn should_key_update(policy: KeyUpdatePolicy, tracker: &PolicyTracker, now: u64) -> bool {
2025-09-08T23:46:52.1388193Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tl.rs:28:
2025-09-08T23:46:52.1388440Z -    if policy.max_frames > 0 && tracker.frames_since_update >= policy.max_frames { return true; }
2025-09-08T23:46:52.1388846Z -    if policy.max_seconds > 0 && now.saturating_sub(tracker.last_update_ts) >= policy.max_seconds { return true; }
2025-09-08T23:46:52.1389049Z +    if policy.max_frames > 0 && tracker.frames_since_update >= policy.max_frames {
2025-09-08T23:46:52.1389129Z +        return true;
2025-09-08T23:46:52.1389191Z +    }
2025-09-08T23:46:52.1389442Z +    if policy.max_seconds > 0 && now.saturating_sub(tracker.last_update_ts) >= policy.max_seconds {
2025-09-08T23:46:52.1389520Z +        return true;
2025-09-08T23:46:52.1389581Z +    }
2025-09-08T23:46:52.1389655Z      false
2025-09-08T23:46:52.1389714Z  }
2025-09-08T23:46:52.1389780Z  
2025-09-08T23:46:52.1389924Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tl.rs:33:
2025-09-08T23:46:52.1390166Z  // For PoC, v1.1 mapping is identity; this is a hook for future on-the-wire differences.
2025-09-08T23:46:52.1390528Z -pub fn map_frame_to_v11(frame: &framing::Frame) -> framing::Frame { framing::Frame { ty: frame.ty, payload: frame.payload.clone() } }
2025-09-08T23:46:52.1390694Z +pub fn map_frame_to_v11(frame: &framing::Frame) -> framing::Frame {
2025-09-08T23:46:52.1390848Z +    framing::Frame {
2025-09-08T23:46:52.1390925Z +        ty: frame.ty,
2025-09-08T23:46:52.1391022Z +        payload: frame.payload.clone(),
2025-09-08T23:46:52.1391085Z +    }
2025-09-08T23:46:52.1391143Z +}
2025-09-08T23:46:52.1391206Z  
2025-09-08T23:46:52.1391276Z  #[cfg(test)]
2025-09-08T23:46:52.1391442Z  mod tests {
2025-09-08T23:46:52.1391589Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tl.rs:39:
2025-09-08T23:46:52.1391648Z  
2025-09-08T23:46:52.1391722Z      #[test]
2025-09-08T23:46:52.1391864Z      fn identity_mapping_keeps_payload() {
2025-09-08T23:46:52.1392065Z -        let f = framing::Frame { ty: framing::FrameType::Stream, payload: vec![1,2,3] };
2025-09-08T23:46:52.1392148Z +        let f = framing::Frame {
2025-09-08T23:46:52.1392246Z +            ty: framing::FrameType::Stream,
2025-09-08T23:46:52.1392333Z +            payload: vec![1, 2, 3],
2025-09-08T23:46:52.1392397Z +        };
2025-09-08T23:46:52.1392560Z          let g = map_frame_to_v11(&f);
2025-09-08T23:46:52.1392728Z          assert_eq!(g.payload, f.payload);
2025-09-08T23:46:52.1392892Z          assert_eq!(g.ty as u8, f.ty as u8);
2025-09-08T23:46:52.1393032Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tl.rs:48:
2025-09-08T23:46:52.1393109Z      #[test]
2025-09-08T23:46:52.1393243Z      fn policy_triggers_on_limits() {
2025-09-08T23:46:52.1393421Z          let mut tr = PolicyTracker::new(100);
2025-09-08T23:46:52.1393578Z -        let pol = KeyUpdatePolicy { max_frames: 3, max_seconds: 10 };
2025-09-08T23:46:52.1393772Z -        let f = framing::Frame { ty: framing::FrameType::Ping, payload: vec![] };
2025-09-08T23:46:52.1393869Z -        for _ in 0..2 { tr.on_frame_sent(&f); }
2025-09-08T23:46:52.1393959Z +        let pol = KeyUpdatePolicy {
2025-09-08T23:46:52.1394041Z +            max_frames: 3,
2025-09-08T23:46:52.1394121Z +            max_seconds: 10,
2025-09-08T23:46:52.1394183Z +        };
2025-09-08T23:46:52.1394269Z +        let f = framing::Frame {
2025-09-08T23:46:52.1394373Z +            ty: framing::FrameType::Ping,
2025-09-08T23:46:52.1394450Z +            payload: vec![],
2025-09-08T23:46:52.1394514Z +        };
2025-09-08T23:46:52.1394592Z +        for _ in 0..2 {
2025-09-08T23:46:52.1394675Z +            tr.on_frame_sent(&f);
2025-09-08T23:46:52.1394738Z +        }
2025-09-08T23:46:52.1394938Z          assert!(!should_key_update(pol, &tr, 105));
2025-09-08T23:46:52.1395075Z          tr.on_frame_sent(&f);
2025-09-08T23:46:52.1395266Z          assert!(should_key_update(pol, &tr, 105));
2025-09-08T23:46:52.1395444Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tls_mirror.rs:7:
2025-09-08T23:46:52.1395582Z  use core_cbor as cbor; // for TemplateID (DET-CBOR)
2025-09-08T23:46:52.1395671Z  use once_cell::sync::Lazy;
2025-09-08T23:46:52.1395735Z  
2025-09-08T23:46:52.1395925Z -static GLOBAL_CACHE: Lazy<std::sync::Mutex<MirrorCache>> = Lazy::new(|| {
2025-09-08T23:46:52.1396237Z -    std::sync::Mutex::new(MirrorCache::new(Duration::from_secs(24*60*60)))
2025-09-08T23:46:52.1396305Z -});
2025-09-08T23:46:52.1396453Z +static GLOBAL_CACHE: Lazy<std::sync::Mutex<MirrorCache>> =
2025-09-08T23:46:52.1396673Z +    Lazy::new(|| std::sync::Mutex::new(MirrorCache::new(Duration::from_secs(24 * 60 * 60))));
2025-09-08T23:46:52.1396731Z  
2025-09-08T23:46:52.1396886Z  #[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
2025-09-08T23:46:52.1396975Z  pub struct Template {
2025-09-08T23:46:52.1397152Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tls_mirror.rs:20:
2025-09-08T23:46:52.1397212Z  }
2025-09-08T23:46:52.1397271Z  
2025-09-08T23:46:52.1397460Z  #[derive(Debug, Clone, PartialEq, Eq, Hash, Serialize, Deserialize)]
2025-09-08T23:46:52.1397541Z -pub struct TemplateId(
2025-09-08T23:46:52.1397644Z -    #[serde(with = "serde_bytes")] pub Vec<u8>
2025-09-08T23:46:52.1397710Z -);
2025-09-08T23:46:52.1397877Z +pub struct TemplateId(#[serde(with = "serde_bytes")] pub Vec<u8>);
2025-09-08T23:46:52.1397935Z  
2025-09-08T23:46:52.1398132Z  #[derive(Debug, Clone)]
2025-09-08T23:46:52.1398229Z  pub struct ClientConfig {
2025-09-08T23:46:52.1398399Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tls_mirror.rs:46:
2025-09-08T23:46:52.1398459Z  }
2025-09-08T23:46:52.1398521Z  
2025-09-08T23:46:52.1398600Z  impl MirrorCache {
2025-09-08T23:46:52.1398785Z -    pub fn new(ttl: Duration) -> Self { Self { entries: HashMap::new(), ttl } }
2025-09-08T23:46:52.1398885Z +    pub fn new(ttl: Duration) -> Self {
2025-09-08T23:46:52.1398951Z +        Self {
2025-09-08T23:46:52.1399041Z +            entries: HashMap::new(),
2025-09-08T23:46:52.1399108Z +            ttl,
2025-09-08T23:46:52.1399176Z +        }
2025-09-08T23:46:52.1399242Z +    }
2025-09-08T23:46:52.1399480Z      pub fn get(&mut self, host: &str) -> Option<(TemplateId, Template)> {
2025-09-08T23:46:52.1399678Z          if let Some(e) = self.entries.get(host) {
2025-09-08T23:46:52.1399873Z              if e.expires > Instant::now() {
2025-09-08T23:46:52.1400045Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tls_mirror.rs:69:
2025-09-08T23:46:52.1400173Z  pub fn compute_ja3(tpl: &Template) -> String {
2025-09-08T23:46:52.1400535Z      // JA3 = SSLVersion,CipherSuites,Extensions,EllipticCurves,EllipticCurvePointFormats
2025-09-08T23:46:52.1400842Z      // We approximate using extensions and groups; version/ciphers omitted in this PoC.
2025-09-08T23:46:52.1401066Z -    let exts = tpl.extensions.iter().map(|e| e.to_string()).collect::<Vec<_>>().join("-");
2025-09-08T23:46:52.1401142Z +    let exts = tpl
2025-09-08T23:46:52.1401214Z +        .extensions
2025-09-08T23:46:52.1401443Z +        .iter()
2025-09-08T23:46:52.1401603Z +        .map(|e| e.to_string())
2025-09-08T23:46:52.1401739Z +        .collect::<Vec<_>>()
2025-09-08T23:46:52.1401847Z +        .join("-");
2025-09-08T23:46:52.1402069Z      let groups = tpl.groups.join("-");
2025-09-08T23:46:52.1402448Z      let base = format!("{},,{},{}", "771", exts, groups); // TLS1.2/1.3ish placeholder
2025-09-08T23:46:52.1402608Z      let hash = md5::compute(base.as_bytes());
2025-09-08T23:46:52.1402787Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tls_mirror.rs:82:
2025-09-08T23:46:52.1402959Z      pub host_overrides: HashMap<String, Template>,
2025-09-08T23:46:52.1403019Z  }
2025-09-08T23:46:52.1403079Z  
2025-09-08T23:46:52.1403439Z -pub fn calibrate(origin: &str, mut cache: Option<&mut MirrorCache>, cfg: Option<&Config>) -> Result<(TemplateId, Template), String> {
2025-09-08T23:46:52.1403515Z +pub fn calibrate(
2025-09-08T23:46:52.1403586Z +    origin: &str,
2025-09-08T23:46:52.1403682Z +    mut cache: Option<&mut MirrorCache>,
2025-09-08T23:46:52.1403766Z +    cfg: Option<&Config>,
2025-09-08T23:46:52.1403870Z +) -> Result<(TemplateId, Template), String> {
2025-09-08T23:46:52.1404077Z      let url = Url::parse(origin).map_err(|_| "bad origin url")?;
2025-09-08T23:46:52.1404279Z      let host = url.host_str().ok_or("no host")?.to_string();
2025-09-08T23:46:52.1404341Z  
2025-09-08T23:46:52.1404655Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tls_mirror.rs:96:
2025-09-08T23:46:52.1404728Z  
2025-09-08T23:46:52.1404808Z      // cache
2025-09-08T23:46:52.1404932Z      if let Some(ref mut c) = cache {
2025-09-08T23:46:52.1405054Z -        if let Some(hit) = c.get(&host) { return Ok(hit); }
2025-09-08T23:46:52.1405151Z +        if let Some(hit) = c.get(&host) {
2025-09-08T23:46:52.1405229Z +            return Ok(hit);
2025-09-08T23:46:52.1405292Z +        }
2025-09-08T23:46:52.1405458Z      } else if let Ok(mut g) = GLOBAL_CACHE.lock() {
2025-09-08T23:46:52.1405574Z -        if let Some(hit) = g.get(&host) { return Ok(hit); }
2025-09-08T23:46:52.1405663Z +        if let Some(hit) = g.get(&host) {
2025-09-08T23:46:52.1405739Z +            return Ok(hit);
2025-09-08T23:46:52.1405808Z +        }
2025-09-08T23:46:52.1405877Z      }
2025-09-08T23:46:52.1405935Z  
2025-09-08T23:46:52.1406204Z      // Probe using reqwest (rustls backend). We don't depend on actual body.
2025-09-08T23:46:52.1406386Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tls_mirror.rs:109:
2025-09-08T23:46:52.1406586Z          .build()
2025-09-08T23:46:52.1406727Z          .map_err(|_| "client")?;
2025-09-08T23:46:52.1406786Z  
2025-09-08T23:46:52.1406873Z -    let resp = client.get(origin)
2025-09-08T23:46:52.1406946Z +    let resp = client
2025-09-08T23:46:52.1407020Z +        .get(origin)
2025-09-08T23:46:52.1407194Z          .header("User-Agent", "qnet-htx/0.1")
2025-09-08T23:46:52.1407284Z          .send()
2025-09-08T23:46:52.1407418Z          .map_err(|_| "send")?;
2025-09-08T23:46:52.1407593Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tls_mirror.rs:122:
2025-09-08T23:46:52.1407851Z          reqwest::Version::HTTP_3 => alpn.push("h3".to_string()),
2025-09-08T23:46:52.1407941Z          _ => {}
2025-09-08T23:46:52.1408013Z      }
2025-09-08T23:46:52.1408214Z -    if !alpn.contains(&"http/1.1".to_string()) { alpn.push("http/1.1".to_string()); }
2025-09-08T23:46:52.1408320Z +    if !alpn.contains(&"http/1.1".to_string()) {
2025-09-08T23:46:52.1408424Z +        alpn.push("http/1.1".to_string());
2025-09-08T23:46:52.1408492Z +    }
2025-09-08T23:46:52.1408550Z  
2025-09-08T23:46:52.1408885Z      // Synthesize conservative defaults for groups/extensions; refine later with tls probes.
2025-09-08T23:46:52.1408995Z      let tpl = Template {
2025-09-08T23:46:52.1409168Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tls_mirror.rs:129:
2025-09-08T23:46:52.1409257Z          alpn,
2025-09-08T23:46:52.1409452Z -        sig_algs: vec!["rsa_pss_rsae_sha256".into(), "ecdsa_secp256r1_sha256".into()],
2025-09-08T23:46:52.1409528Z +        sig_algs: vec![
2025-09-08T23:46:52.1409615Z +            "rsa_pss_rsae_sha256".into(),
2025-09-08T23:46:52.1409713Z +            "ecdsa_secp256r1_sha256".into(),
2025-09-08T23:46:52.1409777Z +        ],
2025-09-08T23:46:52.1409998Z          groups: vec!["x25519".into(), "secp256r1".into()],
2025-09-08T23:46:52.1410206Z          extensions: vec![0, 11, 10, 35, 16, 23, 43, 51],
2025-09-08T23:46:52.1410281Z      };
2025-09-08T23:46:52.1410460Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tls_mirror.rs:148:
2025-09-08T23:46:52.1410593Z      #[cfg(feature = "rustls-config")]
2025-09-08T23:46:52.1410665Z      {
2025-09-08T23:46:52.1410832Z          let cfg = build_rustls_config(tpl);
2025-09-08T23:46:52.1410960Z -    ClientConfig { ja3, template_id: tid, rustls: cfg }
2025-09-08T23:46:52.1411047Z +        ClientConfig {
2025-09-08T23:46:52.1411114Z +            ja3,
2025-09-08T23:46:52.1411197Z +            template_id: tid,
2025-09-08T23:46:52.1411270Z +            rustls: cfg,
2025-09-08T23:46:52.1411458Z +        }
2025-09-08T23:46:52.1411528Z      }
2025-09-08T23:46:52.1411669Z      #[cfg(not(feature = "rustls-config"))]
2025-09-08T23:46:52.1411740Z      {
2025-09-08T23:46:52.1411910Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tls_mirror.rs:155:
2025-09-08T23:46:52.1412011Z -        ClientConfig { ja3, template_id: tid }
2025-09-08T23:46:52.1412086Z +        ClientConfig {
2025-09-08T23:46:52.1412157Z +            ja3,
2025-09-08T23:46:52.1412354Z +            template_id: tid,
2025-09-08T23:46:52.1412420Z +        }
2025-09-08T23:46:52.1412492Z      }
2025-09-08T23:46:52.1412550Z  }
2025-09-08T23:46:52.1412607Z  
2025-09-08T23:46:52.1412778Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/tls_mirror.rs:179:
2025-09-08T23:46:52.1412841Z  
2025-09-08T23:46:52.1412916Z      #[test]
2025-09-08T23:46:52.1413062Z      fn template_id_stable_and_cache_works() {
2025-09-08T23:46:52.1417234Z -    let mut cache = MirrorCache::new(Duration::from_secs(1));
2025-09-08T23:46:52.1417509Z -    let (id1, tpl1) = calibrate("https://example.com", Some(&mut cache), None).unwrap();
2025-09-08T23:46:52.1417735Z -    let (id2, tpl2) = calibrate("https://example.com", Some(&mut cache), None).unwrap();
2025-09-08T23:46:52.1417895Z +        let mut cache = MirrorCache::new(Duration::from_secs(1));
2025-09-08T23:46:52.1418127Z +        let (id1, tpl1) = calibrate("https://example.com", Some(&mut cache), None).unwrap();
2025-09-08T23:46:52.1418341Z +        let (id2, tpl2) = calibrate("https://example.com", Some(&mut cache), None).unwrap();
2025-09-08T23:46:52.1418679Z          assert_eq!(id1, id2);
2025-09-08T23:46:52.1418826Z          assert_eq!(tpl1, tpl2);
2025-09-08T23:46:52.1419006Z          let cfg = build_client_hello(&tpl1);
2025-09-08T23:46:52.1419189Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/transition.rs:1:
2025-09-08T23:46:52.1419295Z -use serde::{Deserialize, Serialize};
2025-09-08T23:46:52.1419380Z -use core_crypto as crypto;
2025-09-08T23:46:52.1419465Z  use core_cbor as cbor;
2025-09-08T23:46:52.1419545Z +use core_crypto as crypto;
2025-09-08T23:46:52.1419647Z +use serde::{Deserialize, Serialize};
2025-09-08T23:46:52.1419708Z  
2025-09-08T23:46:52.1419809Z  #[derive(Debug, thiserror::Error)]
2025-09-08T23:46:52.1419890Z  pub enum Error {
2025-09-08T23:46:52.1420068Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/transition.rs:7:
2025-09-08T23:46:52.1420159Z -    #[error("crypto error")] Crypto,
2025-09-08T23:46:52.1420263Z -    #[error("invalid record")] Invalid,
2025-09-08T23:46:52.1420350Z -    #[error("replay")] Replay,
2025-09-08T23:46:52.1420429Z -    #[error("stale")] Stale,
2025-09-08T23:46:52.1420510Z +    #[error("crypto error")]
2025-09-08T23:46:52.1420580Z +    Crypto,
2025-09-08T23:46:52.1420661Z +    #[error("invalid record")]
2025-09-08T23:46:52.1420725Z +    Invalid,
2025-09-08T23:46:52.1420802Z +    #[error("replay")]
2025-09-08T23:46:52.1420867Z +    Replay,
2025-09-08T23:46:52.1420939Z +    #[error("stale")]
2025-09-08T23:46:52.1421002Z +    Stale,
2025-09-08T23:46:52.1421065Z  }
2025-09-08T23:46:52.1421122Z  
2025-09-08T23:46:52.1421448Z  #[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]
2025-09-08T23:46:52.1421640Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/transition.rs:17:
2025-09-08T23:46:52.1421756Z      #[serde(rename = "nextAS")]
2025-09-08T23:46:52.1421854Z      pub next_as: u64,
2025-09-08T23:46:52.1421962Z      #[serde(rename = "TS")]
2025-09-08T23:46:52.1422055Z -    pub ts: u64,        // seconds
2025-09-08T23:46:52.1422137Z +    pub ts: u64, // seconds
2025-09-08T23:46:52.1422247Z      #[serde(rename = "FLOW")]
2025-09-08T23:46:52.1422350Z -    pub flow: u64,      // flow identifier
2025-09-08T23:46:52.1422441Z +    pub flow: u64, // flow identifier
2025-09-08T23:46:52.1422613Z      #[serde(rename = "NONCE", with = "serde_bytes")]
2025-09-08T23:46:52.1422789Z      pub nonce: Vec<u8>, // arbitrary 16B recommended
2025-09-08T23:46:52.1422848Z  }
2025-09-08T23:46:52.1423023Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/transition.rs:34:
2025-09-08T23:46:52.1423109Z  impl ControlRecord {
2025-09-08T23:46:52.1423338Z      pub fn sign_ed25519(&self, seed32: &[u8; 32]) -> SignedControl {
2025-09-08T23:46:52.1423570Z          let msg = cbor::to_det_cbor(self).expect("cbor");
2025-09-08T23:46:52.1423680Z -    let sig = crypto::ed25519::sign(seed32, &msg);
2025-09-08T23:46:52.1423791Z -    SignedControl { rec: self.clone(), sig }
2025-09-08T23:46:52.1424020Z +        let sig = crypto::ed25519::sign(seed32, &msg);
2025-09-08T23:46:52.1424106Z +        SignedControl {
2025-09-08T23:46:52.1424187Z +            rec: self.clone(),
2025-09-08T23:46:52.1424258Z +            sig,
2025-09-08T23:46:52.1424323Z +        }
2025-09-08T23:46:52.1424395Z      }
2025-09-08T23:46:52.1424457Z  }
2025-09-08T23:46:52.1424514Z  
2025-09-08T23:46:52.1424689Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/transition.rs:44:
2025-09-08T23:46:52.1425115Z          // Timestamp skew window check (±skew_secs)
2025-09-08T23:46:52.1425273Z          let ts = self.rec.ts as i64;
2025-09-08T23:46:52.1425412Z          let now = now_ts as i64;
2025-09-08T23:46:52.1425557Z -    if (now - ts).abs() > skew_secs { return Err(Error::Stale); }
2025-09-08T23:46:52.1425655Z +        if (now - ts).abs() > skew_secs {
2025-09-08T23:46:52.1425741Z +            return Err(Error::Stale);
2025-09-08T23:46:52.1425802Z +        }
2025-09-08T23:46:52.1425926Z          // Verify signature
2025-09-08T23:46:52.1426237Z          let msg = cbor::to_det_cbor(&self.rec).map_err(|_| Error::Invalid)?;
2025-09-08T23:46:52.1426702Z          crypto::ed25519::verify(pubkey, &msg, &self.sig).map_err(|_| Error::Crypto)
2025-09-08T23:46:52.1426879Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/transition.rs:61:
2025-09-08T23:46:52.1426937Z  }
2025-09-08T23:46:52.1426993Z  
2025-09-08T23:46:52.1427073Z  impl ReplayCache {
2025-09-08T23:46:52.1427215Z -    pub fn new() -> Self { Self { entries: HashMap::new() } }
2025-09-08T23:46:52.1427295Z +    pub fn new() -> Self {
2025-09-08T23:46:52.1427360Z +        Self {
2025-09-08T23:46:52.1427451Z +            entries: HashMap::new(),
2025-09-08T23:46:52.1427512Z +        }
2025-09-08T23:46:52.1427573Z +    }
2025-09-08T23:46:52.1427630Z  
2025-09-08T23:46:52.1427978Z      // Reject duplicates within the window; also evict entries older than now_ts - window_secs
2025-09-08T23:46:52.1428260Z -    pub fn check_and_insert(&mut self, rec: &ControlRecord, now_ts: u64, window_secs: u64) -> Result<(), Error> {
2025-09-08T23:46:52.1428355Z +    pub fn check_and_insert(
2025-09-08T23:46:52.1428430Z +        &mut self,
2025-09-08T23:46:52.1428509Z +        rec: &ControlRecord,
2025-09-08T23:46:52.1428579Z +        now_ts: u64,
2025-09-08T23:46:52.1428655Z +        window_secs: u64,
2025-09-08T23:46:52.1428737Z +    ) -> Result<(), Error> {
2025-09-08T23:46:52.1428960Z          let min_ts = now_ts.saturating_sub(window_secs);
2025-09-08T23:46:52.1429076Z          // GC old entries
2025-09-08T23:46:52.1429294Z          self.entries.retain(|(_, ts), _| *ts >= min_ts);
2025-09-08T23:46:52.1429470Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/transition.rs:71:
2025-09-08T23:46:52.1429528Z  
2025-09-08T23:46:52.1429687Z          let key = (rec.flow, rec.ts);
2025-09-08T23:46:52.1429863Z -        if self.entries.contains_key(&key) { return Err(Error::Replay); }
2025-09-08T23:46:52.1429969Z +        if self.entries.contains_key(&key) {
2025-09-08T23:46:52.1430058Z +            return Err(Error::Replay);
2025-09-08T23:46:52.1430129Z +        }
2025-09-08T23:46:52.1430300Z          self.entries.insert(key, rec.ts);
2025-09-08T23:46:52.1430388Z          Ok(())
2025-09-08T23:46:52.1430462Z      }
2025-09-08T23:46:52.1430634Z Diff in /home/runner/work/qnet/qnet/crates/htx/src/transition.rs:83:
2025-09-08T23:46:52.1430693Z  
2025-09-08T23:46:52.1430770Z      #[test]
2025-09-08T23:46:52.1430915Z      fn control_sign_verify_and_replay() {
2025-09-08T23:46:52.1431157Z -        let rec = ControlRecord { prev_as: 1, next_as: 2, ts: 1_700_000_000, flow: 7, nonce: vec![0u8; 16] };
2025-09-08T23:46:52.1431245Z +        let rec = ControlRecord {
2025-09-08T23:46:52.1431433Z +            prev_as: 1,
2025-09-08T23:46:52.1431505Z +            next_as: 2,
2025-09-08T23:46:52.1431579Z +            ts: 1_700_000_000,
2025-09-08T23:46:52.1431651Z +            flow: 7,
2025-09-08T23:46:52.1431730Z +            nonce: vec![0u8; 16],
2025-09-08T23:46:52.1431793Z +        };
2025-09-08T23:46:52.1431921Z          let seed = [5u8; 32];
2025-09-08T23:46:52.1432127Z -    let s = rec.sign_ed25519(&seed);
2025-09-08T23:46:52.1432437Z -    let pk = ring::signature::Ed25519KeyPair::from_seed_unchecked(&seed).unwrap().public_key().as_ref().to_vec();
2025-09-08T23:46:52.1432526Z +        let s = rec.sign_ed25519(&seed);
2025-09-08T23:46:52.1432695Z +        let pk = ring::signature::Ed25519KeyPair::from_seed_unchecked(&seed)
2025-09-08T23:46:52.1432767Z +            .unwrap()
2025-09-08T23:46:52.1432842Z +            .public_key()
2025-09-08T23:46:52.1432911Z +            .as_ref()
2025-09-08T23:46:52.1432989Z +            .to_vec();
2025-09-08T23:46:52.1433188Z          // Verify with skew ±300s
2025-09-08T23:46:52.1433331Z -    assert!(s.verify_with_pk(1_700_000_100, 300, &pk).is_ok());
2025-09-08T23:46:52.1433470Z +        assert!(s.verify_with_pk(1_700_000_100, 300, &pk).is_ok());
2025-09-08T23:46:52.1433613Z          // Stale too far in future
2025-09-08T23:46:52.1433757Z -    assert!(s.verify_with_pk(1_700_000_401, 300, &pk).is_err());
2025-09-08T23:46:52.1433909Z +        assert!(s.verify_with_pk(1_700_000_401, 300, &pk).is_err());
2025-09-08T23:46:52.1434133Z          // Replay cache
2025-09-08T23:46:52.1434231Z -    let mut rc = ReplayCache::new();
2025-09-08T23:46:52.1434356Z -    rc.check_and_insert(&rec, 1_700_000_100, 300).unwrap();
2025-09-08T23:46:52.1434508Z -    assert!(rc.check_and_insert(&rec, 1_700_000_100, 300).is_err());
2025-09-08T23:46:52.1434600Z +        let mut rc = ReplayCache::new();
2025-09-08T23:46:52.1434722Z +        rc.check_and_insert(&rec, 1_700_000_100, 300).unwrap();
2025-09-08T23:46:52.1434873Z +        assert!(rc.check_and_insert(&rec, 1_700_000_100, 300).is_err());
2025-09-08T23:46:52.1434942Z      }
2025-09-08T23:46:52.1435000Z  }
2025-09-08T23:46:52.1435062Z +
2025-09-08T23:46:52.1435269Z Diff in /home/runner/work/qnet/qnet/crates/mixnode/src/lib.rs:1:
2025-09-08T23:46:52.1435399Z  // no external bytes usage needed in current PoC
2025-09-08T23:46:52.1435487Z  use parking_lot::Mutex;
2025-09-08T23:46:52.1435596Z  use rand::{Rng, RngCore, SeedableRng};
2025-09-08T23:46:52.1435701Z -use serde::{Serialize, Deserialize};
2025-09-08T23:46:52.1435793Z +use serde::{Deserialize, Serialize};
2025-09-08T23:46:52.1435885Z  use std::collections::HashMap;
2025-09-08T23:46:52.1435962Z  use std::sync::Arc;
2025-09-08T23:46:52.1436050Z  use std::time::Instant;
2025-09-08T23:46:52.1436210Z Diff in /home/runner/work/qnet/qnet/crates/mixnode/src/lib.rs:12:
2025-09-08T23:46:52.1436268Z  
2025-09-08T23:46:52.1436395Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-09-08T23:46:52.1436476Z  pub struct Packet {
2025-09-08T23:46:52.1436555Z -    pub header: [u8;32],
2025-09-08T23:46:52.1436636Z +    pub header: [u8; 32],
2025-09-08T23:46:52.1436735Z      pub body: Vec<u8>,
2025-09-08T23:46:52.1436793Z  }
2025-09-08T23:46:52.1436849Z  
2025-09-08T23:46:52.1437010Z Diff in /home/runner/work/qnet/qnet/crates/mixnode/src/lib.rs:25:
2025-09-08T23:46:52.1437068Z  
2025-09-08T23:46:52.1437145Z  impl RateLimiter {
2025-09-08T23:46:52.1437333Z      pub fn new(cap: u32, refill_per_sec: u32) -> Self {
2025-09-08T23:46:52.1437519Z -        Self { cap, refill_per_sec, state: Arc::new(Mutex::new(HashMap::new())) }
2025-09-08T23:46:52.1437586Z +        Self {
2025-09-08T23:46:52.1437653Z +            cap,
2025-09-08T23:46:52.1437735Z +            refill_per_sec,
2025-09-08T23:46:52.1437850Z +            state: Arc::new(Mutex::new(HashMap::new())),
2025-09-08T23:46:52.1437913Z +        }
2025-09-08T23:46:52.1437984Z      }
2025-09-08T23:46:52.1438091Z -    pub fn allow(&self, key: [u8;32]) -> bool {
2025-09-08T23:46:52.1438194Z +    pub fn allow(&self, key: [u8; 32]) -> bool {
2025-09-08T23:46:52.1438352Z          let mut m = self.state.lock();
2025-09-08T23:46:52.1438733Z          let (mut tokens, last) = m.get(&key).cloned().unwrap_or((self.cap, Instant::now()));
2025-09-08T23:46:52.1438879Z          let now = Instant::now();
2025-09-08T23:46:52.1439039Z Diff in /home/runner/work/qnet/qnet/crates/mixnode/src/lib.rs:35:
2025-09-08T23:46:52.1439366Z          let refill = (dt * self.refill_per_sec as f64) as u32;
2025-09-08T23:46:52.1439569Z          tokens = (tokens + refill).min(self.cap);
2025-09-08T23:46:52.1439699Z          let ok = tokens > 0;
2025-09-08T23:46:52.1439786Z -        if ok { tokens -= 1; }
2025-09-08T23:46:52.1439852Z +        if ok {
2025-09-08T23:46:52.1439927Z +            tokens -= 1;
2025-09-08T23:46:52.1439989Z +        }
2025-09-08T23:46:52.1440147Z          m.insert(key, (tokens, now));
2025-09-08T23:46:52.1440230Z          ok
2025-09-08T23:46:52.1440297Z      }
2025-09-08T23:46:52.1440461Z Diff in /home/runner/work/qnet/qnet/crates/mixnode/src/lib.rs:42:
2025-09-08T23:46:52.1440519Z  }
2025-09-08T23:46:52.1440576Z  
2025-09-08T23:46:52.1440658Z  #[derive(Debug, Clone)]
2025-09-08T23:46:52.1440776Z -pub struct MixConfig { pub cover_rate_hz: f64 }
2025-09-08T23:46:52.1440855Z +pub struct MixConfig {
2025-09-08T23:46:52.1440935Z +    pub cover_rate_hz: f64,
2025-09-08T23:46:52.1440997Z +}
2025-09-08T23:46:52.1441054Z  
2025-09-08T23:46:52.1441138Z  pub struct MixNode {
2025-09-08T23:46:52.1441411Z      rl: RateLimiter,
2025-09-08T23:46:52.1441576Z Diff in /home/runner/work/qnet/qnet/crates/mixnode/src/lib.rs:53:
2025-09-08T23:46:52.1441651Z  impl MixNode {
2025-09-08T23:46:52.1441843Z      pub fn new(rl: RateLimiter, cfg: MixConfig) -> Self {
2025-09-08T23:46:52.1442066Z          let rng = rand::rngs::StdRng::seed_from_u64(123);
2025-09-08T23:46:52.1442178Z -        Self { rl, rng: Arc::new(Mutex::new(rng)), cfg }
2025-09-08T23:46:52.1442242Z +        Self {
2025-09-08T23:46:52.1442314Z +            rl,
2025-09-08T23:46:52.1442408Z +            rng: Arc::new(Mutex::new(rng)),
2025-09-08T23:46:52.1442474Z +            cfg,
2025-09-08T23:46:52.1442536Z +        }
2025-09-08T23:46:52.1442608Z      }
2025-09-08T23:46:52.1442665Z  
2025-09-08T23:46:52.1442836Z -    pub fn process(&self, src: [u8;32], pkt: Packet) -> Option<Packet> {
2025-09-08T23:46:52.1442940Z -        if !self.rl.allow(src) { return None; }
2025-09-08T23:46:52.1443108Z +    pub fn process(&self, src: [u8; 32], pkt: Packet) -> Option<Packet> {
2025-09-08T23:46:52.1443200Z +        if !self.rl.allow(src) {
2025-09-08T23:46:52.1443274Z +            return None;
2025-09-08T23:46:52.1443340Z +        }
2025-09-08T23:46:52.1443676Z          // Placeholder Sphinx-like step: XOR first 32 bytes of body with header
2025-09-08T23:46:52.1443842Z          let mut body = pkt.body.clone();
2025-09-08T23:46:52.1443995Z -        for i in 0..body.len().min(32) { body[i] ^= pkt.header[i%32]; }
2025-09-08T23:46:52.1444103Z -        Some(Packet { header: pkt.header, body })
2025-09-08T23:46:52.1444190Z +        for i in 0..body.len().min(32) {
2025-09-08T23:46:52.1444287Z +            body[i] ^= pkt.header[i % 32];
2025-09-08T23:46:52.1444349Z +        }
2025-09-08T23:46:52.1444421Z +        Some(Packet {
2025-09-08T23:46:52.1444505Z +            header: pkt.header,
2025-09-08T23:46:52.1444576Z +            body,
2025-09-08T23:46:52.1444638Z +        })
2025-09-08T23:46:52.1444704Z      }
2025-09-08T23:46:52.1444765Z  
2025-09-08T23:46:52.1444933Z      pub fn maybe_cover(&self) -> Option<Packet> {
2025-09-08T23:46:52.1445098Z Diff in /home/runner/work/qnet/qnet/crates/mixnode/src/lib.rs:68:
2025-09-08T23:46:52.1445218Z -        if self.cfg.cover_rate_hz <= 0.0 { return None; }
2025-09-08T23:46:52.1445314Z +        if self.cfg.cover_rate_hz <= 0.0 {
2025-09-08T23:46:52.1445388Z +            return None;
2025-09-08T23:46:52.1445450Z +        }
2025-09-08T23:46:52.1445812Z          let p = self.cfg.cover_rate_hz.min(1000.0) / 1000.0; // cap probability per call
2025-09-08T23:46:52.1445966Z          let mut rng = self.rng.lock();
2025-09-08T23:46:52.1446105Z          if rng.gen::<f64>() < p {
2025-09-08T23:46:52.1446268Z Diff in /home/runner/work/qnet/qnet/crates/mixnode/src/lib.rs:72:
2025-09-08T23:46:52.1446389Z -            let mut hdr = [0u8;32]; rng.fill_bytes(&mut hdr);
2025-09-08T23:46:52.1446525Z -            let mut body = vec![0u8;256]; rng.fill_bytes(&mut body);
2025-09-08T23:46:52.1446609Z +            let mut hdr = [0u8; 32];
2025-09-08T23:46:52.1446820Z +            rng.fill_bytes(&mut hdr);
2025-09-08T23:46:52.1446910Z +            let mut body = vec![0u8; 256];
2025-09-08T23:46:52.1446998Z +            rng.fill_bytes(&mut body);
2025-09-08T23:46:52.1447214Z              Some(Packet { header: hdr, body })
2025-09-08T23:46:52.1447288Z -        } else { None }
2025-09-08T23:46:52.1447352Z +        } else {
2025-09-08T23:46:52.1447423Z +            None
2025-09-08T23:46:52.1447484Z +        }
2025-09-08T23:46:52.1447549Z      }
2025-09-08T23:46:52.1447607Z  }
2025-09-08T23:46:52.1447666Z  
2025-09-08T23:46:52.1447860Z Diff in /home/runner/work/qnet/qnet/crates/mixnode/src/lib.rs:83:
2025-09-08T23:46:52.1447963Z      fn rate_limits() {
2025-09-08T23:46:52.1448139Z          let rl = RateLimiter::new(2, 10);
2025-09-08T23:46:52.1448423Z          let node = MixNode::new(rl, MixConfig { cover_rate_hz: 0.0 });
2025-09-08T23:46:52.1448499Z -        let src = [1u8;32];
2025-09-08T23:46:52.1448641Z -        let pkt = Packet { header: [0u8;32], body: vec![1,2,3] };
2025-09-08T23:46:52.1448829Z +        let src = [1u8; 32];
2025-09-08T23:46:52.1448909Z +        let pkt = Packet {
2025-09-08T23:46:52.1448985Z +            header: [0u8; 32],
2025-09-08T23:46:52.1449066Z +            body: vec![1, 2, 3],
2025-09-08T23:46:52.1449129Z +        };
2025-09-08T23:46:52.1449368Z          assert!(node.process(src, pkt.clone()).is_some());
2025-09-08T23:46:52.1449595Z          assert!(node.process(src, pkt.clone()).is_some());
2025-09-08T23:46:52.1449744Z          // Third should be limited
2025-09-08T23:46:52.1449913Z Diff in /home/runner/work/qnet/qnet/crates/mixnode/src/lib.rs:94:
2025-09-08T23:46:52.1450022Z      fn transforms_body() {
2025-09-08T23:46:52.1450205Z          let rl = RateLimiter::new(100, 100);
2025-09-08T23:46:52.1450484Z          let node = MixNode::new(rl, MixConfig { cover_rate_hz: 0.0 });
2025-09-08T23:46:52.1450620Z -        let pkt = Packet { header: [7u8;32], body: vec![1,2,3,4] };
2025-09-08T23:46:52.1450760Z -        let out = node.process([0u8;32], pkt.clone()).unwrap();
2025-09-08T23:46:52.1450843Z +        let pkt = Packet {
2025-09-08T23:46:52.1450919Z +            header: [7u8; 32],
2025-09-08T23:46:52.1451004Z +            body: vec![1, 2, 3, 4],
2025-09-08T23:46:52.1451067Z +        };
2025-09-08T23:46:52.1451199Z +        let out = node.process([0u8; 32], pkt.clone()).unwrap();
2025-09-08T23:46:52.1451472Z          assert_ne!(out.body, pkt.body);
2025-09-08T23:46:52.1451551Z      }
2025-09-08T23:46:52.1451608Z  }
2025-09-08T23:46:52.1451766Z Diff in /home/runner/work/qnet/qnet/crates/voucher/src/lib.rs:1:
2025-09-08T23:46:52.1451866Z -use serde::{Serialize, Deserialize};
2025-09-08T23:46:52.1451957Z +use serde::{Deserialize, Serialize};
2025-09-08T23:46:52.1452015Z  
2025-09-08T23:46:52.1452111Z  #[derive(Debug, thiserror::Error)]
2025-09-08T23:46:52.1452191Z  pub enum Error {
2025-09-08T23:46:52.1452343Z Diff in /home/runner/work/qnet/qnet/crates/voucher/src/lib.rs:5:
2025-09-08T23:46:52.1452550Z -    #[error("invalid length: expected 128 bytes, got {0}")] InvalidLength(usize),
2025-09-08T23:46:52.1452693Z +    #[error("invalid length: expected 128 bytes, got {0}")]
2025-09-08T23:46:52.1452773Z +    InvalidLength(usize),
2025-09-08T23:46:52.1452831Z  }
2025-09-08T23:46:52.1452893Z  
2025-09-08T23:46:52.1452988Z  #[derive(Clone, PartialEq, Eq)]
2025-09-08T23:46:52.1453140Z Diff in /home/runner/work/qnet/qnet/crates/voucher/src/lib.rs:9:
2025-09-08T23:46:52.1453224Z -pub struct Voucher([u8;128]);
2025-09-08T23:46:52.1453311Z +pub struct Voucher([u8; 128]);
2025-09-08T23:46:52.1453368Z  
2025-09-08T23:46:52.1453468Z  impl std::fmt::Debug for Voucher {
2025-09-08T23:46:52.1453707Z      fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
2025-09-08T23:46:52.1453877Z Diff in /home/runner/work/qnet/qnet/crates/voucher/src/lib.rs:16:
2025-09-08T23:46:52.1453935Z  
2025-09-08T23:46:52.1454011Z  impl Voucher {
2025-09-08T23:46:52.1454203Z      pub fn from_bytes(b: &[u8]) -> Result<Self, Error> {
2025-09-08T23:46:52.1454471Z -        if b.len() != 128 { return Err(Error::InvalidLength(b.len())); }
2025-09-08T23:46:52.1454557Z -        let mut arr = [0u8;128];
2025-09-08T23:46:52.1454638Z +        if b.len() != 128 {
2025-09-08T23:46:52.1454751Z +            return Err(Error::InvalidLength(b.len()));
2025-09-08T23:46:52.1454815Z +        }
2025-09-08T23:46:52.1454899Z +        let mut arr = [0u8; 128];
2025-09-08T23:46:52.1455036Z          arr.copy_from_slice(b);
2025-09-08T23:46:52.1455143Z          Ok(Self(arr))
2025-09-08T23:46:52.1455212Z      }
2025-09-08T23:46:52.1455375Z Diff in /home/runner/work/qnet/qnet/crates/voucher/src/lib.rs:24:
2025-09-08T23:46:52.1455486Z -    pub fn as_bytes(&self) -> &[u8;128] { &self.0 }
2025-09-08T23:46:52.1455613Z -    pub fn to_hex(&self) -> String { hex::encode(self.0) }
2025-09-08T23:46:52.1455712Z +    pub fn as_bytes(&self) -> &[u8; 128] {
2025-09-08T23:46:52.1455778Z +        &self.0
2025-09-08T23:46:52.1455838Z +    }
2025-09-08T23:46:52.1455931Z +    pub fn to_hex(&self) -> String {
2025-09-08T23:46:52.1456120Z +        hex::encode(self.0)
2025-09-08T23:46:52.1456181Z +    }
2025-09-08T23:46:52.1456351Z      pub fn from_hex(s: &str) -> Result<Self, Error> {
2025-09-08T23:46:52.1456525Z -        let v = hex::decode(s).map_err(|_| Error::InvalidLength(s.len()/2))?;
2025-09-08T23:46:52.1456693Z +        let v = hex::decode(s).map_err(|_| Error::InvalidLength(s.len() / 2))?;
2025-09-08T23:46:52.1456823Z          Self::from_bytes(&v)
2025-09-08T23:46:52.1456895Z      }
2025-09-08T23:46:52.1456953Z  }
2025-09-08T23:46:52.1457113Z Diff in /home/runner/work/qnet/qnet/crates/voucher/src/lib.rs:35:
2025-09-08T23:46:52.1457171Z  }
2025-09-08T23:46:52.1457232Z  
2025-09-08T23:46:52.1457330Z  impl AggregatePlaceholder {
2025-09-08T23:46:52.1457530Z -    pub fn add(&mut self, _v: &Voucher) { self.count = self.count.saturating_add(1); }
2025-09-08T23:46:52.1457631Z +    pub fn add(&mut self, _v: &Voucher) {
2025-09-08T23:46:52.1457744Z +        self.count = self.count.saturating_add(1);
2025-09-08T23:46:52.1457815Z +    }
2025-09-08T23:46:52.1457875Z  }
2025-09-08T23:46:52.1457936Z  
2025-09-08T23:46:52.1458006Z  #[cfg(test)]
2025-09-08T23:46:52.1458177Z Diff in /home/runner/work/qnet/qnet/crates/voucher/src/lib.rs:44:
2025-09-08T23:46:52.1458239Z  
2025-09-08T23:46:52.1458319Z      #[test]
2025-09-08T23:46:52.1458416Z      fn round_trip() {
2025-09-08T23:46:52.1458490Z -        let v = [7u8;128];
2025-09-08T23:46:52.1458567Z +        let v = [7u8; 128];
2025-09-08T23:46:52.1458790Z          let voucher = Voucher::from_bytes(&v).unwrap();
2025-09-08T23:46:52.1458969Z          assert_eq!(voucher.as_bytes(), &v);
2025-09-08T23:46:52.1459117Z          let h = voucher.to_hex();
2025-09-08T23:46:52.1459276Z Diff in /home/runner/work/qnet/qnet/crates/voucher/src/lib.rs:54:
2025-09-08T23:46:52.1459333Z  
2025-09-08T23:46:52.1459409Z      #[test]
2025-09-08T23:46:52.1459512Z      fn invalid_len() {
2025-09-08T23:46:52.1459634Z -        assert!(Voucher::from_bytes(&[0u8;127]).is_err());
2025-09-08T23:46:52.1459755Z -        assert!(Voucher::from_bytes(&[0u8;129]).is_err());
2025-09-08T23:46:52.1459886Z +        assert!(Voucher::from_bytes(&[0u8; 127]).is_err());
2025-09-08T23:46:52.1460000Z +        assert!(Voucher::from_bytes(&[0u8; 129]).is_err());
2025-09-08T23:46:52.1460071Z      }
2025-09-08T23:46:52.1460133Z  
2025-09-08T23:46:52.1460208Z      #[test]
2025-09-08T23:46:52.1460372Z Diff in /home/runner/work/qnet/qnet/crates/voucher/src/lib.rs:62:
2025-09-08T23:46:52.1460520Z      fn aggregate_placeholder_increments() {
2025-09-08T23:46:52.1460735Z          let mut a = AggregatePlaceholder::default();
2025-09-08T23:46:52.1460850Z -        let v = Voucher::from_bytes(&[1u8;128]).unwrap();
2025-09-08T23:46:52.1460959Z +        let v = Voucher::from_bytes(&[1u8; 128]).unwrap();
2025-09-08T23:46:52.1461064Z          a.add(&v);
2025-09-08T23:46:52.1461160Z          a.add(&v);
2025-09-08T23:46:52.1461392Z          assert_eq!(a.count, 2);
2025-09-08T23:46:52.1464013Z ##[error]Process completed with exit code 1.
2025-09-08T23:46:52.1534542Z Post job cleanup.
2025-09-08T23:46:52.2486730Z [command]/usr/bin/git version
2025-09-08T23:46:52.2527480Z git version 2.51.0
2025-09-08T23:46:52.2573417Z Temporarily overriding HOME='/home/runner/work/_temp/c8bc3931-cfb3-4c1b-9aee-cd3ca95b03c4' before making global git config changes
2025-09-08T23:46:52.2575595Z Adding repository directory to the temporary git global config as a safe directory
2025-09-08T23:46:52.2580224Z [command]/usr/bin/git config --global --add safe.directory /home/runner/work/qnet/qnet
2025-09-08T23:46:52.2624502Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-09-08T23:46:52.2659676Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-09-08T23:46:52.2898851Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-09-08T23:46:52.2922500Z http.https://github.com/.extraheader
2025-09-08T23:46:52.2935284Z [command]/usr/bin/git config --local --unset-all http.https://github.com/.extraheader
2025-09-08T23:46:52.2968352Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-09-08T23:46:52.3380064Z Evaluate and set job outputs
2025-09-08T23:46:52.3387607Z Cleaning up orphan processes