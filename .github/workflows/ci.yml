name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache-dependency-path: linter/go.sum
      - name: Build Rust
        run: |
          cargo build --workspace --all-targets
          cargo build -p htx --features rustls-config --examples
      - name: Build Go Linter
        run: |
          cd linter
          go build -o qnet-lint ./cmd/qnet-lint/
      - name: Test
        run: |
          cargo test --workspace --all-features
          cargo test -p htx --features rustls-config
      - name: Lint
        run: |
          cargo clippy --workspace --all-targets --all-features -- -D warnings
          cargo fmt --all -- --check
      - name: Generate SBOM
        continue-on-error: true
        run: |
          # Install syft for SBOM generation
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft packages . -o json --file sbom.json
      - name: Generate checksums
        run: |
          cd target/debug
          # Only hash regular files in this directory
          find . -maxdepth 1 -type f -exec sha256sum {} + > checksums.txt
          cd ../../linter
          sha256sum qnet-lint >> ../target/debug/checksums.txt
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qnet-artifacts
          path: |
            target/debug/
            linter/qnet-lint
            sbom.json

  fuzz-and-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - name: Install cargo-fuzz and tarpaulin
        run: |
          cargo install --locked cargo-fuzz
          cargo install --locked cargo-tarpaulin
      - name: Build fuzz targets
        if: ${{ hashFiles('fuzz/**/Cargo.toml') != '' }}
        run: |
          cd fuzz
          cargo +nightly fuzz build
      - name: Run fuzzers (time-boxed)
        if: ${{ hashFiles('fuzz/**/Cargo.toml') != '' }}
        run: |
          set -e
          cd fuzz
          # Each for ~15 minutes => ~30 minutes total
          set +e
          timeout 15m cargo +nightly fuzz run framing_decode -- -runs=0
          code=$?
          if [ $code -ne 0 ] && [ $code -ne 124 ]; then echo "framing_decode crashed (exit $code)"; exit $code; fi
          timeout 15m cargo +nightly fuzz run noise_handshake -- -runs=0
          code=$?
          if [ $code -ne 0 ] && [ $code -ne 124 ]; then echo "noise_handshake crashed (exit $code)"; exit $code; fi
          set -e
      - name: Coverage (core-framing)
        run: |
          # Focus coverage on core-framing; allow test-only instrumentation. Do not fail build on low coverage.
          cargo tarpaulin -p core-framing --engine=llvm --line --out Xml --timeout 180 --ignore-tests || true
          if [ -f cobertura.xml ]; then mv cobertura.xml cobertura-core-framing.xml; fi
          if [ -f cobertura-core-framing.xml ]; then
            cov=$(grep -o 'line-rate="[0-9.]*"' cobertura-core-framing.xml | head -n1 | sed -E 's/.*="([0-9.]+)"/\1/')
            echo "core-framing line coverage: $cov"
          fi
      - name: Coverage (htx)
        run: |
          cargo tarpaulin -p htx --engine=llvm --line --out Xml --timeout 180 --ignore-tests || true
          if [ -f cobertura.xml ]; then mv cobertura.xml cobertura-htx.xml; fi
          if [ -f cobertura-htx.xml ]; then
            cov=$(grep -o 'line-rate="[0-9.]*"' cobertura-htx.xml | head -n1 | sed -E 's/.*="([0-9.]+)"/\1/')
            echo "htx line coverage: $cov"
          fi

  slsa-provenance:
    # Run only for public repos, or when the owner is an Organization (feature not available for user-owned private repos)
    if: ${{ !github.event.repository.private || github.repository_owner_type != 'User' }}
    needs: build
    runs-on: ubuntu-latest
    permissions:
      actions: read
      id-token: write
      attestations: write
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: qnet-artifacts
      - name: Attest build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: |
            target/debug/checksums.txt
            linter/qnet-lint
            sbom.json
